<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Gmet&#39;s Blog</title>
  
  <subtitle>Eureka!</subtitle>
  <link href="https://guoyujian.github.io/atom.xml" rel="self"/>
  
  <link href="https://guoyujian.github.io/"/>
  <updated>2025-06-10T11:42:18.411Z</updated>
  <id>https://guoyujian.github.io/</id>
  
  <author>
    <name>Met Guo</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>å¤æ•°çš„å·¥å­¦åº”ç”¨</title>
    <link href="https://guoyujian.github.io/2025/06/10/%E5%A4%8D%E6%95%B0%E7%9A%84%E5%B7%A5%E5%AD%A6%E5%BA%94%E7%94%A8/"/>
    <id>https://guoyujian.github.io/2025/06/10/%E5%A4%8D%E6%95%B0%E7%9A%84%E5%B7%A5%E5%AD%A6%E5%BA%94%E7%94%A8/</id>
    <published>2025-06-10T11:18:03.000Z</published>
    <updated>2025-06-10T11:42:18.411Z</updated>
    
    <content type="html"><![CDATA[<object data="/pdfs/complex_application.pdf" type="application/pdf" width="100%" height="800px">]]></content>
    
    
      
      
    <summary type="html">&lt;object data=&quot;/pdfs/complex_application.pdf&quot; type=&quot;application/pdf&quot; width=&quot;100%&quot; height=&quot;800px&quot;&gt;



</summary>
      
    
    
    
    <category term="æ•°å­¦" scheme="https://guoyujian.github.io/categories/%E6%95%B0%E5%AD%A6/"/>
    
    
    <category term="æ•°å­¦" scheme="https://guoyujian.github.io/tags/%E6%95%B0%E5%AD%A6/"/>
    
    <category term="pdf" scheme="https://guoyujian.github.io/tags/pdf/"/>
    
  </entry>
  
  <entry>
    <title>ã€æ‘˜æŠ„ã€‘æ•™ç§‘ä¹¦ä¸Šæœ‰å“ªäº›ä»¤ä½ è§¦åŠ¨çš„è¯</title>
    <link href="https://guoyujian.github.io/2025/03/28/%E3%80%90%E6%91%98%E6%8A%84%E3%80%91%E6%95%99%E7%A7%91%E4%B9%A6%E4%B8%8A%E6%9C%89%E5%93%AA%E4%BA%9B%E4%BB%A4%E4%BD%A0%E8%A7%A6%E5%8A%A8%E7%9A%84%E8%AF%9D/"/>
    <id>https://guoyujian.github.io/2025/03/28/%E3%80%90%E6%91%98%E6%8A%84%E3%80%91%E6%95%99%E7%A7%91%E4%B9%A6%E4%B8%8A%E6%9C%89%E5%93%AA%E4%BA%9B%E4%BB%A4%E4%BD%A0%E8%A7%A6%E5%8A%A8%E7%9A%84%E8%AF%9D/</id>
    <published>2025-03-28T15:24:39.000Z</published>
    <updated>2025-03-28T15:27:08.299Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>â€œæ•°å­¦æ˜¯æˆ‘å›½äººæ°‘æ‰€æ“…é•¿çš„å­¦ç§‘ã€‚â€</p><p>â€”â€”åç½—åºš</p><p>â€œç‰©ç†å­¦çš„æ®¿å ‚ä¸­ï¼Œæ²¡æœ‰è¯¡è¾©è€…çš„ä½ç½®â€</p><p>â€”â€”ç‰©ç†å¿…ä¿®ä¸€</p><p>â€œæ²¡æœ‰å­¦æœ¯çš„æ°‘ä¸»å’Œæ€æƒ³çš„è‡ªç”±ï¼Œç§‘å­¦å°±ä¸èƒ½ç¹è£ã€‚â€</p><p>â€”â€”ç‰©ç†å¿…ä¿®ä¸€ï¼ˆäººæ•™ç‰ˆï¼‰</p><p>â€œç°åœ¨æˆ‘è¦æ¼”ç¤ºä¸–ç•Œä½“ç³»çš„æ¡†æ¶â€</p><p>â€”â€”ã€Šè‡ªç„¶å“²å­¦çš„æ•°å­¦åŸç†ã€‹ç¬¬ä¸‰å·å‰è¨€ï¼Œç‰›é¡¿</p><p>â€œä½ èƒ½è®¤å‡ºçœŸç†ï¼Œå› ä¸ºå¥¹æ—¢ç¾åˆç®€å•ã€‚â€</p><p>â€”â€”è´¹æ›¼</p></blockquote><h2 id="Refs"><a href="#Refs" class="headerlink" title="Refs"></a>Refs</h2><p>çŸ¥ä¹åŒåé—®é¢˜å›ç­”</p>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;â€œæ•°å­¦æ˜¯æˆ‘å›½äººæ°‘æ‰€æ“…é•¿çš„å­¦ç§‘ã€‚â€&lt;/p&gt;
&lt;p&gt;â€”â€”åç½—åºš&lt;/p&gt;
&lt;p&gt;â€œç‰©ç†å­¦çš„æ®¿å ‚ä¸­ï¼Œæ²¡æœ‰è¯¡è¾©è€…çš„ä½ç½®â€&lt;/p&gt;
&lt;p&gt;â€”â€”ç‰©ç†å¿…ä¿®ä¸€&lt;/p&gt;
&lt;p&gt;â€œæ²¡æœ‰å­¦æœ¯çš„æ°‘ä¸»å’Œæ€æƒ³çš„è‡ªç”±ï¼Œç§‘å­¦å°±ä¸èƒ½ç¹è£ã€‚â€&lt;/p&gt;
&lt;p&gt;â€”â€”ç‰©ç†å¿…ä¿®ä¸€ï¼ˆäººæ•™ç‰ˆï¼‰&lt;/</summary>
      
    
    
    
    <category term="å…¶ä»–" scheme="https://guoyujian.github.io/categories/%E5%85%B6%E4%BB%96/"/>
    
    
    <category term="å…¶ä»–" scheme="https://guoyujian.github.io/tags/%E5%85%B6%E4%BB%96/"/>
    
  </entry>
  
  <entry>
    <title>å¹³é¢æ–¹ç¨‹çš„å››ç§è¡¨è¾¾æ–¹å¼æ€»ç»“</title>
    <link href="https://guoyujian.github.io/2025/03/27/%E5%B9%B3%E9%9D%A2%E6%96%B9%E7%A8%8B%E7%9A%84%E5%9B%9B%E7%A7%8D%E8%A1%A8%E8%BE%BE%E6%96%B9%E5%BC%8F%E6%80%BB%E7%BB%93/"/>
    <id>https://guoyujian.github.io/2025/03/27/%E5%B9%B3%E9%9D%A2%E6%96%B9%E7%A8%8B%E7%9A%84%E5%9B%9B%E7%A7%8D%E8%A1%A8%E8%BE%BE%E6%96%B9%E5%BC%8F%E6%80%BB%E7%BB%93/</id>
    <published>2025-03-27T02:42:16.000Z</published>
    <updated>2025-03-27T02:43:11.461Z</updated>
    
    <content type="html"><![CDATA[<p>å¹³é¢æ–¹ç¨‹æœ‰å››ç§è¡¨è¾¾æ–¹å¼åˆ†åˆ«æ˜¯ï¼šæˆªè·å¼ï¼Œç‚¹æ³•å¼ï¼Œä¸€èˆ¬å¼ï¼Œæ³•çº¿å¼ã€‚</p><h3 id="ç‚¹æ³•å¼"><a href="#ç‚¹æ³•å¼" class="headerlink" title="ç‚¹æ³•å¼"></a>ç‚¹æ³•å¼</h3><script type="math/tex; mode=display">A(x-x_0)+B(y-y_0)+C(z-z_0)=0</script><p>å‡è®¾$\vec{n}=(A,B,C)$ä¸ºå¹³é¢çš„æ³•å‘é‡ï¼Œ$M=(x,y,z)$ä¸ºå¹³é¢ä¸Šä»»æ„ä¸€ç‚¹ï¼Œ$Mâ€™=(x_0,y_0,z_0)$ï¼Œåˆ™æœ‰$\vec{n}Â·\vec{MMâ€™}=0$ï¼Œåˆ™æœ‰</p><script type="math/tex; mode=display">A(x-x_0)+B(y-y_0)+C(z-z_0)=0</script><h3 id="ä¸€èˆ¬å¼"><a href="#ä¸€èˆ¬å¼" class="headerlink" title="ä¸€èˆ¬å¼"></a>ä¸€èˆ¬å¼</h3><script type="math/tex; mode=display">Ax+By+Cz+D=0</script><p>ç”±ç‚¹æ³•å¼æ¨å‡º</p><script type="math/tex; mode=display">Ax + By + Cz - Ax_0 - By_0 - Cz_0 = 0</script><p>ä»¤</p><script type="math/tex; mode=display">D =  - Ax_0 - By_0 - Cz_0</script><p>å³æ¨å¯¼å‡ºä¸€èˆ¬å¼</p><h3 id="æˆªè·å¼"><a href="#æˆªè·å¼" class="headerlink" title="æˆªè·å¼"></a>æˆªè·å¼</h3><p>è®¾å¹³é¢æ–¹ç¨‹ä¸º</p><script type="math/tex; mode=display">Ax+By+Cz+D=0</script><p>è‹¥$D\ne0$ï¼Œå–$a=-\frac{D}{A}$,$b=-\frac{D}{B}$,$c=-\frac{D}{C}$ï¼Œåˆ™å¾—å¹³é¢çš„æˆªè·å¼æ–¹ç¨‹</p><script type="math/tex; mode=display">\frac{x}{a} + \frac{y}{b} + \frac{c}{z} = 1</script><p>å¹³é¢ä¸ä¸‰ä¸ªè½´çš„åæ ‡åˆ†åˆ«ä¸º$P(a,0,0)$,$Q(0,b,0)$,$R(0,0,c)$ï¼Œå…¶ä¸­a,b,cä¾æ¬¡ç§°ä¸ºè¯¥å¹³é¢åœ¨x,y,zè½´ä¸Šçš„æˆªè·ã€‚</p><p>æ¨å¯¼è¿‡ç¨‹å¾ˆç®€å•å¹³é¢ä¸xè½´çš„äº¤ç‚¹å°±æ˜¯ä»¤$y=0$,$z=0$,æ‰€ä»¥$a=-\frac{D}{A}$ï¼Œä»¥æ­¤ç±»æ¨ã€‚</p><h3 id="æ³•çº¿å¼"><a href="#æ³•çº¿å¼" class="headerlink" title="æ³•çº¿å¼"></a>æ³•çº¿å¼</h3><script type="math/tex; mode=display">x\cos\alpha + y\cos\beta + z\cos\gamma = d</script><p>å…¶ä¸­$\cos\alpha$ã€$\cos\beta$ã€$\cos\gamma$æ˜¯å¹³é¢æ³•å‘é‡çš„æ–¹å‘ä½™å¼¦ï¼Œ$d$ä¸ºåŸç‚¹åˆ°å¹³é¢çš„è·ç¦»ã€‚</p><p>å…¶ä¸­</p><script type="math/tex; mode=display">\cos^2\alpha+\cos^2\beta+\cos^2\gamma=1</script><p>å‡è®¾åŸç‚¹åˆ°å¹³é¢çš„æ³•çº¿ä¸º$\vec{on}$ï¼Œå¹³é¢ä¸Šä»»æ„ä¸€ç‚¹$p(x,y,z)$ï¼Œå¹³é¢ä¸Šä¸€ç‚¹$p_0,(x_0,y_0,z_0)$ï¼Œåˆ™æœ‰</p><script type="math/tex; mode=display">\vec{on}Â·\vec{pp_0} = 0</script><p>åˆ$\vec{pp_0} = \vec{op} - \vec{op_0}$ï¼Œåˆ™</p><script type="math/tex; mode=display">\vec{on}Â·\vec{op}-\vec{on}Â·\vec{op_0}  = 0</script><p>è®¾$\vec{on_0}$ä¸ºå•ä½æ³•å‘é‡</p><script type="math/tex; mode=display">\vec{on_0}=(\cos\alpha, \cos\beta, \cos\gamma)</script><p>ä¸”</p><script type="math/tex; mode=display">\cos^2\alpha+\cos^2\beta+\cos^2\gamma=1</script><p>åˆ™</p><script type="math/tex; mode=display">\vec{on}Â·\vec{op}-\vec{on}Â·\vec{op_0}  = \vec{on_0}Â·\vec{op}-\vec{on_0}Â·\vec{op_0}</script><p>å…¶ä¸­</p><script type="math/tex; mode=display">\vec{on_0}Â·\vec{op_0}=d</script><p>ï¼ˆ$\vec{on_0}Â·\vec{op_0}$ç›¸å½“äº$\vec{op_0}$åœ¨æ³•çº¿æ–¹å‘ä¸Šçš„ä½™å¼¦ï¼Œå³åŸç‚¹åˆ°å¹³é¢è·ç¦»$d$ï¼‰</p><p>å¹¶ä¸”</p><script type="math/tex; mode=display">\vec{on_0}Â·\vec{op} = x\cos\alpha + y\cos\beta + z\cos\gamma</script><p>æ‰€ä»¥</p><script type="math/tex; mode=display">x\cos\alpha + y\cos\beta + z\cos\gamma = d</script><p>â€</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;å¹³é¢æ–¹ç¨‹æœ‰å››ç§è¡¨è¾¾æ–¹å¼åˆ†åˆ«æ˜¯ï¼šæˆªè·å¼ï¼Œç‚¹æ³•å¼ï¼Œä¸€èˆ¬å¼ï¼Œæ³•çº¿å¼ã€‚&lt;/p&gt;
&lt;h3 id=&quot;ç‚¹æ³•å¼&quot;&gt;&lt;a href=&quot;#ç‚¹æ³•å¼&quot; class=&quot;headerlink&quot; title=&quot;ç‚¹æ³•å¼&quot;&gt;&lt;/a&gt;ç‚¹æ³•å¼&lt;/h3&gt;&lt;script type=&quot;math/tex; mode=d</summary>
      
    
    
    
    
    <category term="æ•°å­¦" scheme="https://guoyujian.github.io/tags/%E6%95%B0%E5%AD%A6/"/>
    
  </entry>
  
  <entry>
    <title>Python å…ƒç±»åŸºç¡€</title>
    <link href="https://guoyujian.github.io/2025/03/26/Python-%E5%85%83%E7%B1%BB%E5%9F%BA%E7%A1%80/"/>
    <id>https://guoyujian.github.io/2025/03/26/Python-%E5%85%83%E7%B1%BB%E5%9F%BA%E7%A1%80/</id>
    <published>2025-03-26T03:53:51.000Z</published>
    <updated>2025-03-26T14:39:43.143Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä»€ä¹ˆæ˜¯å…ƒç±»"><a href="#ä»€ä¹ˆæ˜¯å…ƒç±»" class="headerlink" title="ä»€ä¹ˆæ˜¯å…ƒç±»"></a>ä»€ä¹ˆæ˜¯å…ƒç±»</h2><p>åœ¨Pythonä¸­â€œä¸‡ç‰©â€çš†æ˜¯å¯¹è±¡ï¼Œå½“ç„¶<strong>ç±»</strong>ä¹Ÿæ˜¯å¯¹è±¡ã€‚</p><p>é€šè¿‡ç±»æˆ‘ä»¬å¯ä»¥åˆ›å»ºå®ä¾‹å¯¹è±¡ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">A</span>:</span><br><span class="line">  <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">a = A()</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆé€šè¿‡ä»€ä¹ˆæˆ‘ä»¬åˆ›å»ºç±»å‘¢ï¼Ÿç­”æ¡ˆæ˜¯<strong>å…ƒç±»</strong>ã€‚</p><p>å³ï¼šç±»æ˜¯å…ƒç±»çš„å®ä¾‹</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">A</span>:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">isinstance</span>(A, <span class="built_in">type</span>)) <span class="comment"># True</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">issubclass</span>(A, <span class="built_in">object</span>)) <span class="comment"># True</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="å…ƒç±»çš„ä½œç”¨"><a href="#å…ƒç±»çš„ä½œç”¨" class="headerlink" title="å…ƒç±»çš„ä½œç”¨"></a>å…ƒç±»çš„ä½œç”¨</h2><p>å…ƒç±»å¯ä»¥å®šåˆ¶åŒ–ç±»çš„åˆ›å»ºè¿‡ç¨‹ã€‚ä¾‹å¦‚ä¿®æ”¹ç±»çš„å±æ€§ã€æ–¹æ³•ï¼Œæ·»åŠ æ–°çš„å±æ€§ã€æ–¹æ³•ï¼Œç”šè‡³å¯ä»¥æ‹¦æˆªç±»çš„åˆ›å»ºè¿‡ç¨‹ã€‚</p><h2 id="ä½¿ç”¨typeåˆ›å»ºç±»"><a href="#ä½¿ç”¨typeåˆ›å»ºç±»" class="headerlink" title="ä½¿ç”¨typeåˆ›å»ºç±»"></a>ä½¿ç”¨typeåˆ›å»ºç±»</h2><p><code>type</code>æ—¢å¯ä»¥åˆ¤æ–­å¯¹è±¡çš„ç±»å‹</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">type</span>(<span class="number">123</span>) <span class="comment"># &lt;class &#x27;int&#x27;&gt;</span></span><br></pre></td></tr></table></figure><p>ä¹Ÿæ˜¯æ‰€æœ‰ç±»çš„é¡¶å±‚å…ƒç±»</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(<span class="built_in">int</span>))    <span class="comment"># &lt;class &#x27;type&#x27;&gt;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(<span class="built_in">str</span>))    <span class="comment"># &lt;class &#x27;type&#x27;&gt;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(<span class="built_in">object</span>)) <span class="comment"># &lt;class &#x27;type&#x27;&gt;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(<span class="built_in">type</span>))   <span class="comment"># &lt;class &#x27;type&#x27;&gt; ï¼ˆtype ä¹Ÿæ˜¯å®ƒè‡ªå·±çš„å®ä¾‹ï¼‰</span></span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥é€šè¿‡<code>type(name, bases, attrs)</code>åŠ¨æ€åˆ›å»ºç±»ï¼Œ</p><p>å…¶ä¸­ï¼Œ</p><ul><li><code>name</code>ï¼šç±»çš„åå­—ï¼›</li><li><code>bases</code>ï¼šç±»ç»§æ‰¿çš„çˆ¶ç±»é›†åˆ</li><li><code>attrs</code>ï¼šç±»çš„å±æ€§ã€æ–¹æ³•å­—å…¸</li></ul><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person1</span>:</span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name</span>):</span><br><span class="line">    self.name = name</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init</span>(<span class="params">self, name</span>):</span><br><span class="line">  self.name = name</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Person2 = <span class="built_in">type</span>(<span class="string">&#x27;Person&#x27;</span>, (), &#123;<span class="string">&#x27;__init__&#x27;</span>: init&#125;)</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼ŒPerson2å’ŒPerson1çš„æ•ˆæœä¸€æ¨¡ä¸€æ ·ï¼Œå› ä¸ºPythonè§£é‡Šå™¨åœ¨è¯»åˆ°<code>class Person1</code>çš„å®šä¹‰æ—¶å°±æ˜¯è°ƒç”¨çš„typeã€‚å› æ­¤é€šè¿‡Person2åˆ›å»ºå®ä¾‹ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">p = Person2(<span class="string">&#x27;John&#x27;</span>)</span><br><span class="line">p.name <span class="comment"># John</span></span><br></pre></td></tr></table></figure><h2 id="è‡ªå®šä¹‰å…ƒç±»"><a href="#è‡ªå®šä¹‰å…ƒç±»" class="headerlink" title="è‡ªå®šä¹‰å…ƒç±»"></a>è‡ªå®šä¹‰å…ƒç±»</h2><p>æ‰€æœ‰ç±»é»˜è®¤æƒ…å†µä¸‹ï¼Œå…ƒç±»æ˜¯typeï¼Œå½“ç„¶ä¹Ÿå¯ä»¥æŒ‡å®šç±»çš„å…ƒç±»ï¼ˆå½“ç„¶äº†ï¼Œæ‰€æœ‰ç±»çš„å…ƒç±»æœ€ç»ˆéƒ½æŒ‡å‘äº†typeï¼‰</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AMetaClass</span>(<span class="title class_ inherited__">type</span>):</span><br><span class="line">  <span class="comment">#ç»§æ‰¿äº†typeçš„æ—¢æ˜¯å…ƒç±»</span></span><br><span class="line">  <span class="comment">#å…ƒç±»å‘½åæœ€å¥½æ˜¯MetaClassåç¼€</span></span><br><span class="line">  <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span>(metaclass = AMetaClass):</span><br><span class="line">  <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªä¾‹å­ä¸­Açš„å…ƒç±»æ˜¯AMetaClassã€‚</p><p>æˆ‘ä»¬çŸ¥é“ï¼Œåˆ›å»ºä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼Œä¼šè°ƒç”¨ç±»çš„<code>__new__</code>æ–¹æ³•ã€‚åŒæ ·çš„ï¼Œåˆ›å»ºä¸€ä¸ªç±»ï¼Œä¼šè°ƒç”¨å…¶å…ƒç±»çš„<code>__new__</code>æ–¹æ³•ã€‚å› æ­¤åœ¨å…ƒç±»ä¸­é‡å†™<code>__new__</code>æ–¹æ³•å³å¯æ‹¦æˆªç±»çš„ç”Ÿæˆæ–¹å¼ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AMetaClass</span>(<span class="title class_ inherited__">type</span>):</span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">__new__</span>(<span class="params">cls, name, bases, attrs</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>().__new__(cls, name, bases, attrs)</span><br><span class="line">  </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span>(metaclass = AMetaClass):</span><br><span class="line">  <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆè¿™æ ·åšçš„æ„ä¹‰æ˜¯ä»€ä¹ˆï¼Ÿ</p><p>é€šå¸¸æ¥è®²ï¼Œå¯¹äºæ™®é€šå¼€å‘è€…ï¼Œå¹¶ä¸éœ€è¦å…ƒç±»ç¼–ç¨‹ã€‚ä½†å‡¡äº‹æ€»æœ‰ä¾‹å¤–ã€‚</p><p>å…ƒç±»ç¼–ç¨‹çš„æœ€å¤§ä½œç”¨ä¹‹ä¸€ï¼Œæ˜¯å¯ä»¥å¼€å‘æ¡†æ¶ã€‚</p><h2 id="ä½¿ç”¨å…ƒç±»åˆ›å»ºç®€å•çš„ORMæ¡†æ¶"><a href="#ä½¿ç”¨å…ƒç±»åˆ›å»ºç®€å•çš„ORMæ¡†æ¶" class="headerlink" title="ä½¿ç”¨å…ƒç±»åˆ›å»ºç®€å•çš„ORMæ¡†æ¶"></a>ä½¿ç”¨å…ƒç±»åˆ›å»ºç®€å•çš„ORMæ¡†æ¶</h2><p>è¿™é‡Œä½¿ç”¨å…ƒç±»åˆ›å»ºç®€å•çš„ORMæ¡†æ¶ä½œä¸ºæ¡ˆä¾‹ã€‚</p><p>æˆ‘å¸Œæœ›å¯¹äºè‡ªå®šä¹‰ç»§æ‰¿è‡ªBaseModelçš„ç±»ï¼Œå…¶åŒ…å«ä¸€ä¸ªç±»å˜é‡<code>table_name</code>ï¼Œå˜é‡åä¸ºå°å†™çš„ç±»åã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">  <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(User.table_name) <span class="comment"># user</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œå°±è¦ç”¨åˆ°å…ƒç±»ï¼Œæˆ‘ä»¬è¦æ‹¦æˆªBaseModelç±»çš„ç”Ÿæˆï¼Œåœ¨ç”Ÿæˆå…¶å­ç±»çš„æ—¶å€™ç»™å®ƒæ·»åŠ å±æ€§table_nameï¼Œå› æ­¤å®Œæ•´çš„ä»£ç æ˜¯ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ModelMetaClass</span>(<span class="title class_ inherited__">type</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__new__</span>(<span class="params">cls, name, bases, attrs</span>):</span><br><span class="line">        <span class="keyword">if</span> name != <span class="string">&#x27;BaseModel&#x27;</span>:</span><br><span class="line">            attrs[<span class="string">&#x27;table_name&#x27;</span>] = name.lower()</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>().__new__(cls, name, bases, attrs)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BaseModel</span>(metaclass=ModelMetaClass):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(User.table_name)  <span class="comment"># è¾“å‡ºï¼šuser</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;ä»€ä¹ˆæ˜¯å…ƒç±»&quot;&gt;&lt;a href=&quot;#ä»€ä¹ˆæ˜¯å…ƒç±»&quot; class=&quot;headerlink&quot; title=&quot;ä»€ä¹ˆæ˜¯å…ƒç±»&quot;&gt;&lt;/a&gt;ä»€ä¹ˆæ˜¯å…ƒç±»&lt;/h2&gt;&lt;p&gt;åœ¨Pythonä¸­â€œä¸‡ç‰©â€çš†æ˜¯å¯¹è±¡ï¼Œå½“ç„¶&lt;strong&gt;ç±»&lt;/strong&gt;ä¹Ÿæ˜¯å¯¹è±¡ã€‚&lt;/p&gt;
&lt;p&gt;é€šè¿‡ç±»æˆ‘ä»¬å¯ä»¥åˆ›</summary>
      
    
    
    
    <category term="Python" scheme="https://guoyujian.github.io/categories/Python/"/>
    
    <category term="åŸºç¡€" scheme="https://guoyujian.github.io/categories/Python/%E5%9F%BA%E7%A1%80/"/>
    
    
    <category term="Python" scheme="https://guoyujian.github.io/tags/Python/"/>
    
    <category term="å…ƒç±»" scheme="https://guoyujian.github.io/tags/%E5%85%83%E7%B1%BB/"/>
    
  </entry>
  
  <entry>
    <title>Pythonå•ä¾‹æ¨¡å¼æ€»ç»“</title>
    <link href="https://guoyujian.github.io/2025/03/21/Python%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F%E6%80%BB%E7%BB%93/"/>
    <id>https://guoyujian.github.io/2025/03/21/Python%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F%E6%80%BB%E7%BB%93/</id>
    <published>2025-03-21T08:06:46.000Z</published>
    <updated>2025-03-21T10:27:17.131Z</updated>
    
    <content type="html"><![CDATA[<p>å•ä¾‹æ¨¡å¼çš„ä¸»è¦ç›®çš„æ˜¯ä¿è¯åœ¨ç³»ç»Ÿä¸­ï¼Œ<strong>æŸä¸ªç±»åªèƒ½æœ‰ä¸€ä¸ªå®ä¾‹å­˜åœ¨</strong>ã€‚æ¯”å¦‚ä¿å­˜ç³»ç»ŸåŸºæœ¬é…ç½®ä¿¡æ¯çš„ç±»ï¼Œåœ¨å¾ˆå¤šåœ°æ–¹éƒ½è¦ç”¨åˆ°ï¼Œæ²¡æœ‰å¿…è¦é¢‘ç¹åˆ›å»ºå®ä¾‹ä¸é”€æ¯å®ä¾‹ï¼Œåªéœ€è¦ä¿å­˜ä¸€ä¸ªå…¨å±€çš„å®ä¾‹å¯¹è±¡å³å¯ï¼Œè¿™æ ·å¯ä»¥å‡å°‘å¯¹å†…å­˜èµ„æºçš„å ç”¨ã€‚</p><h2 id="Pythonæ¨¡å—å®ç°å•ä¾‹"><a href="#Pythonæ¨¡å—å®ç°å•ä¾‹" class="headerlink" title="Pythonæ¨¡å—å®ç°å•ä¾‹"></a>Pythonæ¨¡å—å®ç°å•ä¾‹</h2><p><strong>Python çš„æ¨¡å—å°±æ˜¯å¤©ç„¶çš„å•ä¾‹æ¨¡å¼</strong>ï¼Œå› ä¸ºæ¨¡å—åœ¨ç¬¬ä¸€æ¬¡å¯¼å…¥æ—¶ï¼Œä¼šç”Ÿæˆ <code>.pyc</code> æ–‡ä»¶ï¼Œå½“ç¬¬äºŒæ¬¡å¯¼å…¥æ—¶ï¼Œå°±ä¼šç›´æ¥åŠ è½½ <code>.pyc</code> æ–‡ä»¶ï¼Œè€Œä¸ä¼šå†æ¬¡æ‰§è¡Œæ¨¡å—ä»£ç ã€‚å› æ­¤ï¼Œæˆ‘ä»¬åªéœ€æŠŠç›¸å…³çš„å‡½æ•°å’Œæ•°æ®å®šä¹‰åœ¨ä¸€ä¸ªæ¨¡å—ä¸­ï¼Œå°±å¯ä»¥è·å¾—ä¸€ä¸ªå•ä¾‹å¯¹è±¡äº†ã€‚å¦‚æœæˆ‘ä»¬çœŸçš„æƒ³è¦ä¸€ä¸ªå•ä¾‹ç±»ï¼Œå¯ä»¥è€ƒè™‘è¿™æ ·åšï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Singleton</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">foo</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">singleton = Singleton()</span><br></pre></td></tr></table></figure><p>å°†ä¸Šé¢çš„ä»£ç ä¿å­˜åœ¨æ–‡ä»¶ <code>mysingleton.py</code> ä¸­ï¼Œè¦ä½¿ç”¨æ—¶ï¼Œç›´æ¥åœ¨å…¶ä»–æ–‡ä»¶ä¸­å¯¼å…¥æ­¤æ–‡ä»¶ä¸­çš„å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å³æ˜¯å•ä¾‹æ¨¡å¼çš„å¯¹è±¡</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> mysingleton <span class="keyword">import</span> singleton</span><br></pre></td></tr></table></figure><h2 id="ä½¿ç”¨è£…é¥°å™¨å®ç°å•ä¾‹"><a href="#ä½¿ç”¨è£…é¥°å™¨å®ç°å•ä¾‹" class="headerlink" title="ä½¿ç”¨è£…é¥°å™¨å®ç°å•ä¾‹"></a>ä½¿ç”¨è£…é¥°å™¨å®ç°å•ä¾‹</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">def singleton(cls):</span><br><span class="line">    _instance = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    def _singleton(*args, **kwargs):</span><br><span class="line">        if cls not in _instance:</span><br><span class="line">            _instance[cls] = cls(*args, **kwargs)</span><br><span class="line">        return _instance[cls]</span><br><span class="line">    return _singleton</span><br><span class="line"></span><br><span class="line">@singleton</span><br><span class="line">class A(object):</span><br><span class="line">    a = 1</span><br><span class="line">    def __init__(self, x = 0):</span><br><span class="line">        self.x = x</span><br><span class="line"></span><br><span class="line">a1 = A(1)</span><br><span class="line">a2 = A(2)</span><br><span class="line">print(a1 == a2)</span><br></pre></td></tr></table></figure><blockquote><p>ä½¿ç”¨è£…é¥°å™¨å®ç°çš„å•ä¾‹æ¨¡å¼åœ¨<strong>å¤šçº¿ç¨‹ç¯å¢ƒ</strong>ä¸‹å¯èƒ½ä¼šå¼•å‘ç«äº‰æ¡ä»¶ï¼ˆrace conditionï¼‰ï¼Œå¯¼è‡´åˆ›å»ºå¤šä¸ªå®ä¾‹ã€‚å› æ­¤ï¼Œåœ¨<strong>å¹¶å‘è®¿é—®çš„åœºæ™¯</strong>ä¸‹ï¼Œ<strong>éœ€è¦åŠ é”</strong>æ¥ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚</p><hr><p><strong>ä¸ºä»€ä¹ˆéœ€è¦åŠ é”ï¼Ÿ</strong></p><p>å‡è®¾å¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œ _singleton() æ–¹æ³•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">if cls not in _instance:</span><br><span class="line">    _instance[cls] = cls(*args, **kwargs)</span><br></pre></td></tr></table></figure><ul><li><strong>çº¿ç¨‹ A</strong> åˆ¤æ–­ _instance ä¸­æ²¡æœ‰ clsï¼Œä½†æ­¤æ—¶ <strong>çº¿ç¨‹ B</strong> å¯èƒ½ä¹Ÿæ‰§è¡Œåˆ°æ­¤å¤„ã€‚</li><li>ä¸¤ä¸ªçº¿ç¨‹å¯èƒ½åŒæ—¶åˆ›å»º cls()ï¼Œæœ€ç»ˆ _instance å¯èƒ½å­˜å‚¨å¤šä¸ªå®ä¾‹ã€‚</li></ul><p>è¿™ç§ç«äº‰æ¡ä»¶ä¼šå¯¼è‡´<strong>å•ä¾‹æ¨¡å¼å¤±æ•ˆ</strong>ã€‚</p><hr><p><strong>å¦‚ä½•åŠ é”ï¼Ÿ</strong></p><p>å¯ä»¥ä½¿ç”¨ threading.Lock() æ¥ç¡®ä¿åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½åˆ›å»ºå®ä¾‹ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">singleton</span>(<span class="params">cls</span>):</span><br><span class="line">    _instance = &#123;&#125;</span><br><span class="line">    _lock = threading.Lock()  <span class="comment"># çº¿ç¨‹é”</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @wraps(<span class="params">cls</span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">inner</span>(<span class="params">*args, **kwargs</span>):</span><br><span class="line">        <span class="keyword">if</span> cls <span class="keyword">not</span> <span class="keyword">in</span> _instance:  <span class="comment"># ç¬¬ä¸€æ¬¡åˆ¤æ–­ï¼ˆéä¸¥æ ¼ä¿è¯ï¼‰</span></span><br><span class="line">            <span class="keyword">with</span> _lock:  <span class="comment"># è¿›å…¥é”å®šåŒºé—´</span></span><br><span class="line">                <span class="keyword">if</span> cls <span class="keyword">not</span> <span class="keyword">in</span> _instance:  <span class="comment"># å†æ¬¡åˆ¤æ–­ï¼Œé¿å…å¤šä¸ªçº¿ç¨‹é‡å¤åˆ›å»º</span></span><br><span class="line">                    _instance[cls] = cls(*args, **kwargs)</span><br><span class="line">        <span class="keyword">return</span> _instance[cls]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> inner</span><br><span class="line"></span><br><span class="line"><span class="meta">@singleton</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Cls</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, value=<span class="number">0</span></span>):</span><br><span class="line">        self.value = value</span><br><span class="line"></span><br><span class="line"><span class="comment"># æµ‹è¯•å¤šçº¿ç¨‹ç¯å¢ƒ</span></span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_singleton</span>():</span><br><span class="line">    obj = Cls()</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">id</span>(obj))</span><br><span class="line"></span><br><span class="line">threads = [threading.Thread(target=test_singleton) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)]</span><br><span class="line"><span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">    t.start()</span><br><span class="line"><span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">    t.join()</span><br></pre></td></tr></table></figure><p><strong>è¦ç‚¹</strong></p><ol><li><em>åŒé‡æ£€æŸ¥*</em>ï¼ˆDouble-Checked Lockingï¼‰ï¼š<ol><li>å…ˆæ£€æŸ¥ _instance æ˜¯å¦å­˜åœ¨ï¼ˆä¸åŠ é”ï¼‰ã€‚</li><li><strong>è¿›å…¥é”å®šåŒºé—´</strong>åï¼Œ<strong>å†æ¬¡æ£€æŸ¥</strong> _instance æ˜¯å¦å·²åˆ›å»ºã€‚</li><li>è¿™æ ·å¯é¿å…å¤šä¸ªçº¿ç¨‹é‡å¤åˆ›å»ºå®ä¾‹ã€‚</li></ol></li><li><strong>ä½¿ç”¨ with _lock è¯­æ³•</strong>ç¡®ä¿é”åœ¨ä½œç”¨åŸŸç»“æŸåè‡ªåŠ¨é‡Šæ”¾ã€‚</li></ol></blockquote><h2 id="ä½¿ç”¨ç±»å®ç°å•ä¾‹"><a href="#ä½¿ç”¨ç±»å®ç°å•ä¾‹" class="headerlink" title="ä½¿ç”¨ç±»å®ç°å•ä¾‹"></a>ä½¿ç”¨ç±»å®ç°å•ä¾‹</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Singleton</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">instance</span>(<span class="params">cls, *args, **kwargs</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(Singleton, <span class="string">&quot;_instance&quot;</span>):</span><br><span class="line">            Singleton._instance = Singleton(*args, **kwargs)</span><br><span class="line">        <span class="keyword">return</span> Singleton._instance</span><br></pre></td></tr></table></figure><p>å’Œä½¿ç”¨è£…é¥°å™¨çš„æ–¹æ³•ä¸€æ ·ï¼Œä½¿ç”¨ç±»çš„å•ä¾‹æ¨¡å¼åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä¼šå¤±æ•ˆã€‚</p><p>è§£å†³æ–¹æ³•ä¹Ÿå’Œâ€œä½¿ç”¨è£…é¥°å™¨çš„æ–¹æ³•â€ä¸€æ ·ï¼ŒåŠ é”ã€‚</p><h2 id="ã€æ¨èã€‘-new-å®ç°å•ä¾‹"><a href="#ã€æ¨èã€‘-new-å®ç°å•ä¾‹" class="headerlink" title="ã€æ¨èã€‘__new__å®ç°å•ä¾‹"></a>ã€æ¨èã€‘<code>__new__</code>å®ç°å•ä¾‹</h2><p><code>__new__</code>æ–¹æ³•åœ¨å®ä¾‹åˆ›å»ºå‰è¢«è°ƒç”¨ï¼Œå¯ç¡®ä¿åªåˆ›å»ºä¸€ä¸ªå®ä¾‹ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Singleton</span>:</span><br><span class="line">    _instance = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__new__</span>(<span class="params">cls, *args, **kwargs</span>):</span><br><span class="line">        <span class="keyword">if</span> cls._instance <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            cls._instance = <span class="built_in">super</span>().__new__(cls)</span><br><span class="line">        <span class="keyword">return</span> cls._instance</span><br><span class="line"></span><br><span class="line"><span class="comment"># æµ‹è¯•</span></span><br><span class="line">a = Singleton()</span><br><span class="line">b = Singleton()</span><br><span class="line"><span class="built_in">print</span>(a <span class="keyword">is</span> b)  <span class="comment"># True</span></span><br></pre></td></tr></table></figure><p>å’Œä½¿ç”¨è£…é¥°å™¨çš„æ–¹æ³•ä¸€æ ·ï¼Œä½¿ç”¨<strong>new</strong>çš„å•ä¾‹æ¨¡å¼åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä¼šå¤±æ•ˆã€‚</p><p>è§£å†³æ–¹æ³•ä¹Ÿå’Œâ€œä½¿ç”¨è£…é¥°å™¨çš„æ–¹æ³•â€ä¸€æ ·ã€‚ï¼ˆåŠ é”ï¼ŒDouble-Checkï¼‰</p><h2 id="ã€æ¨èã€‘metaclasså®ç°å•ä¾‹"><a href="#ã€æ¨èã€‘metaclasså®ç°å•ä¾‹" class="headerlink" title="ã€æ¨èã€‘metaclasså®ç°å•ä¾‹"></a>ã€æ¨èã€‘metaclasså®ç°å•ä¾‹</h2><blockquote><p>åœ¨Pythonä¸­ï¼Œå¯¹è±¡æ˜¯ç±»çš„å®ä¾‹ï¼Œè€Œç±»æ˜¯å…ƒç±»çš„å®ä¾‹ã€‚åœ¨æ²¡æœ‰æŒ‡å®šçš„æƒ…å†µä¸‹ï¼Œtypeæ˜¯æ‰€æœ‰ç±»çš„å…ƒç±»ã€‚</p><p>è‡ªå®šä¹‰ç±»çš„å…ƒç±»ï¼Œå¯ä»¥æ‹¦æˆªç±»çš„åˆ›å»ºè¿‡ç¨‹ï¼Œè¿™æ˜¯metaclasså®ç°å•ä¾‹æ¨¡å¼çš„åŸºç¡€ã€‚</p><p>è¿™é‡Œä¸æ‡‚çš„è¯ï¼Œéœ€è¦ä»”ç»†çœ‹ä¸€ä¸‹Pythonå…ƒç±»çš„çŸ¥è¯†ï½</p></blockquote><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SingletonMeta</span>(<span class="title class_ inherited__">type</span>):</span><br><span class="line">    _instances = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">cls, *args, **kwargs</span>):</span><br><span class="line">        <span class="keyword">if</span> cls <span class="keyword">not</span> <span class="keyword">in</span> cls._instances:</span><br><span class="line">            cls._instances[cls] = <span class="built_in">super</span>().__call__(*args, **kwargs)</span><br><span class="line">        <span class="keyword">return</span> cls._instances[cls]</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Singleton</span>(metaclass=SingletonMeta):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">obj1 = Singleton()</span><br><span class="line">obj2 = Singleton()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(obj1 <span class="keyword">is</span> obj2)  <span class="comment"># Trueï¼Œè¯´æ˜ obj1 å’Œ obj2 æ˜¯åŒä¸€ä¸ªå®ä¾‹</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>éš¾ç‚¹è§£é‡Šï¼š</p><ol><li>å½“è°ƒç”¨ <code>Singleton()</code> æ—¶ï¼Œå®é™…ä¸Šè°ƒç”¨çš„æ˜¯ <code>SingletonMeta</code> çš„ <code>__call__</code> æ–¹æ³•ã€‚</li><li><code>cls</code> æ˜¯ <code>Singleton</code> ç±»ï¼Œè€Œä¸æ˜¯ <code>SingletonMeta</code> å…ƒç±»</li><li>å…ƒç±»å±æ€§ä¼šè‡ªåŠ¨æˆä¸ºç±»çš„å±æ€§ï¼Œæ‰€ä»¥<code>cls._instances</code>æŒ‡å‘äº†SingletonMeta._instances</li><li><code>super().__call__(*args, **kwargs)</code>çš„ç­‰ä»·æ“ä½œ<code>type.__call__(cls, *args, **kwargs)</code></li><li>è€Œ<code>type.__call__</code>ä¼šè°ƒç”¨ç±»çš„<code>__new__</code>å’Œ<code>__init__</code>æ–¹æ³•ï¼Œä»è€Œåˆ›å»ºSingletonçš„å®ä¾‹å¯¹è±¡ã€‚</li></ol><h2 id="ä½¿ç”¨-functools-lru-cache"><a href="#ä½¿ç”¨-functools-lru-cache" class="headerlink" title="ä½¿ç”¨ functools.lru_cache"></a>ä½¿ç”¨ <code>functools.lru_cache</code></h2><p><code>lru_cache</code> å¯ä»¥ç¼“å­˜å®ä¾‹ï¼Œä»è€Œå®ç°å•ä¾‹ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> lru_cache</span><br><span class="line"></span><br><span class="line"><span class="meta">@lru_cache(<span class="params">maxsize=<span class="number">1</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_instance</span>():</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Singleton</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">return</span> Singleton()</span><br><span class="line"></span><br><span class="line"><span class="comment"># æµ‹è¯•</span></span><br><span class="line">a = get_instance()</span><br><span class="line">b = get_instance()</span><br><span class="line"><span class="built_in">print</span>(a <span class="keyword">is</span> b)  <span class="comment"># True</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;å•ä¾‹æ¨¡å¼çš„ä¸»è¦ç›®çš„æ˜¯ä¿è¯åœ¨ç³»ç»Ÿä¸­ï¼Œ&lt;strong&gt;æŸä¸ªç±»åªèƒ½æœ‰ä¸€ä¸ªå®ä¾‹å­˜åœ¨&lt;/strong&gt;ã€‚æ¯”å¦‚ä¿å­˜ç³»ç»ŸåŸºæœ¬é…ç½®ä¿¡æ¯çš„ç±»ï¼Œåœ¨å¾ˆå¤šåœ°æ–¹éƒ½è¦ç”¨åˆ°ï¼Œæ²¡æœ‰å¿…è¦é¢‘ç¹åˆ›å»ºå®ä¾‹ä¸é”€æ¯å®ä¾‹ï¼Œåªéœ€è¦ä¿å­˜ä¸€ä¸ªå…¨å±€çš„å®ä¾‹å¯¹è±¡å³å¯ï¼Œè¿™æ ·å¯ä»¥å‡å°‘å¯¹å†…å­˜èµ„æºçš„å ç”¨ã€‚&lt;/p&gt;
&lt;h2 id=&quot;Pyth</summary>
      
    
    
    
    <category term="Python" scheme="https://guoyujian.github.io/categories/Python/"/>
    
    <category term="åŸºç¡€" scheme="https://guoyujian.github.io/categories/Python/%E5%9F%BA%E7%A1%80/"/>
    
    
    <category term="Python" scheme="https://guoyujian.github.io/tags/Python/"/>
    
    <category term="è®¾è®¡æ¨¡å¼" scheme="https://guoyujian.github.io/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>æ¯”è¾ƒPCLä½¿ç”¨CPUå’ŒNvidia GPUè®¡ç®—æ•ˆç‡é—®é¢˜</title>
    <link href="https://guoyujian.github.io/2024/06/20/%E6%AF%94%E8%BE%83PCL%E4%BD%BF%E7%94%A8CPU%E5%92%8CNvidia-GPU%E8%AE%A1%E7%AE%97%E6%95%88%E7%8E%87%E9%97%AE%E9%A2%98/"/>
    <id>https://guoyujian.github.io/2024/06/20/%E6%AF%94%E8%BE%83PCL%E4%BD%BF%E7%94%A8CPU%E5%92%8CNvidia-GPU%E8%AE%A1%E7%AE%97%E6%95%88%E7%8E%87%E9%97%AE%E9%A2%98/</id>
    <published>2024-06-20T10:11:19.000Z</published>
    <updated>2024-06-24T10:00:49.973Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å‰ç¯‡æ–‡ç« æåˆ°ï¼Œå¯¹æ¯”PCLä½¿ç”¨CPUå’ŒNvidia GPUè¿›è¡Œæ¬§å¼èšç±»å‘ç°ï¼Œå°´å°¬å‘ç°ä½¿ç”¨CPUçš„è®¡ç®—æ•ˆç‡åè€Œæ›´é«˜ã€‚</p><p>æœ¬ç¯‡æ–‡ç« æ¢è®¨ä¸€ä¸‹åŸå› ã€‚</p><h2 id="æ­£æ–‡"><a href="#æ­£æ–‡" class="headerlink" title="æ­£æ–‡"></a>æ­£æ–‡</h2><p>è§‚å¯Ÿ<a href="https://github.com/PointCloudLibrary/pcl/blob/master/gpu/examples/segmentation/src/seg.cpp">ä»£ç </a>å¯ä»¥å‘ç°ï¼Œä»£ç ä¸­ä½¿ç”¨CPUæ¬§å¼èšç±»çš„æœç´¢æ–¹æ³•é€‰ç”¨çš„æ˜¯kdtreeï¼Œä½¿ç”¨GPUæ¬§å¼èšç±»çš„æœç´¢æ–¹æ³•é€‰ç”¨çš„æ˜¯octreeã€‚æ„Ÿè§‰æœ‰å¯èƒ½æ˜¯è¿™é‡Œçš„åŸå› å¯¼è‡´CPUè®¡ç®—æ•ˆç‡æ›´é«˜ã€‚äºæ˜¯å°è¯•å°†CPUçš„æœç´¢æ–¹æ³•ä¹Ÿæ”¹ä¸ºoctreeã€‚</p><p>ä½†æ˜¯ç¼–è¯‘ç¡®ä¿é”™äº†ï¼Œç»†çœ‹å®˜æ–¹æ–‡æ¡£å‘ç°</p><p><img src="image-20240620154924-1r4baou.png" alt="image">â€‹</p><p><img src="image-20240620154931-xs2ku8t.png" alt="image">â€‹</p><p>pcl::search::octreeçš„æ„é€ æ–¹æ³•ä¸­æœ‰ä¸€ä¸ªresolutionçš„å‚æ•°ï¼Œè€Œåœ¨pcl::gpu::octreeçš„æ„é€ æ–¹æ³•ä¸­å¹¶æ²¡æœ‰æä¾›å¸¦æœ‰resolutionå‚æ•°çš„æ„é€ æ–¹æ³•ã€‚</p><p>å°´å°¬ã€‚è¿™æ ·ä¸€æ¥å°±æ²¡æœ‰ä¿è¯cpuå’Œgpuè®¡ç®—æ—¶åŒæ—¶ä½¿ç”¨octreeã€‚</p><p>äºæ˜¯æˆ‘è½¬å¤´å»å®ç°<strong>æ³•çº¿ä¼°è®¡çš„cpuå’Œgpuæ¯”è¾ƒã€‚</strong> å‘ç°è¿˜æ˜¯åŒæ ·çš„é—®é¢˜ï¼šåŒæ ·çš„æ–¹æ³•ï¼Œå…¶å‚æ•°åœ¨CPUå’ŒGPUä¸Šçš„å®ç°ä¸èƒ½ä¿æŒä¸€è‡´ã€‚</p><p><img src="image-20240620155643-sp9v2fk.png" alt="image">â€‹</p><p><img src="image-20240620155701-b0q1yif.png" alt="image">â€‹</p><p>åœ¨æ³•çº¿ä¼°è®¡çš„å‚æ•°ä¸Šï¼Œæˆ‘è®¾ç½®radius=0.03f, max_results=1000</p><p>å¾—åˆ°ç»“æœä½¿ç”¨gpuæ¶ˆè€—çš„æ—¶é—´&lt;&lt;cpuæ¶ˆè€—çš„æ—¶é—´ï¼Œä½†æ˜¯æˆ‘å¯¹æ¯”äº†ä¸¤è€…ç»“æœï¼Œå‘ç°è®¡ç®—ç»“æœçš„æ³•çº¿å‘é‡å®Œå…¨ä¸ä¸€æ ·ã€‚</p><p>å¦‚æœå‚æ•°ä¸ä¸€æ ·ã€ç»“æœä¸ä¸€æ ·ï¼Œé‚£ä¹ˆå³ä½¿è®¡ç®—æ•ˆç‡gpuæ›´é«˜ï¼Œä¹Ÿä¸èƒ½è¯´æ˜ä»€ä¹ˆé—®é¢˜ã€‚</p><p>åæ¥åˆå‘ç°äº†åœ¨pcl/gpuä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªpcl/cudaï¼Œè¿™ä¸‹é¢æœ‰ä¸€ä¸ªvoxelgridï¼Œç»“æœä»£ç ä¸­è¯´does not workâ€¦</p><p><img src="image-20240620170456-9u3gr2y.png" alt="image">â€‹</p><p>æ€»ç»“ä¸€ä¸‹å‰è¿°ï¼š</p><ol><li>å¯¹äºæ¬§å¼èšç±»ï¼Œä¿®æ”¹å‚æ•°resolutionä¸ä¼šå¯¼è‡´ç»“æœå‘ç”Ÿæ”¹å˜ï¼›</li><li>å¯¹äºæ¬§å¼èšç±»ï¼Œgpuå’Œcpuè®¡ç®—ç»“æœä¸€è‡´ï¼›</li><li>å¯¹äºæ¬§å¼èšç±»ï¼Œcpuè®¡ç®—æ•ˆç‡ç•¥é«˜äºgpuï¼›</li><li>å¯¹äºæ³•çº¿ä¼°è®¡ï¼Œä¿®æ”¹å‚æ•°ä¼šå¯¼è‡´è®¡ç®—ç»“æœæ”¹å˜ï¼›</li><li>å¯¹äºæ¬§å¼èšç±»ï¼Œgpuå’Œcpuè®¡ç®—ç»“æœä¸ä¸€è‡´ï¼›</li><li>å¯¹äºæ¬§å¼èšç±»ï¼Œcpuè®¡ç®—æ•ˆç‡è¿œä½äºGPUï¼›</li><li>æ— è®ºæ˜¯æ¬§å¼èšç±»è¿˜æ˜¯æ³•çº¿ä¼°è®¡ï¼Œcpuå’Œgpuæä¾›çš„æ¥å£éƒ½æœ‰å·®å¼‚ï¼Œä»¥è‡³äºæ‰¾ä¸åˆ°å®Œå…¨ä¸€è‡´çš„å‚æ•°è¿›è¡Œæ¯”è¾ƒã€‚</li><li>é™¤pcl/gpuå¤–ï¼Œè¿˜æœ‰pcl/cudaï¼Œä½†æ˜¯ä¹Ÿæ²¡ä»€ä¹ˆç”¨ã€‚</li></ol><hr><p>åæ¥æˆ‘æ‰¾åˆ°äº†Nvidiaå®˜æ–¹æä¾›çš„PCL cpuå’Œgpuè®¡ç®—æ¯”è¾ƒä»£ç ï¼š</p><p><a href="https://github.com/NVIDIA-AI-IOT/cuPCL/tree/main">https://github.com/NVIDIA-AI-IOT/cuPCL/tree/main</a></p><p>å…¶ä¸­æä¾›äº†èšç±»ã€æ»¤æ³¢ã€ICPã€NDTã€Octreeå’Œsegmentationçš„æ¼”ç¤ºä»£ç </p><p><img src="image-20240620170650-m33j5l9.png" alt="image">â€‹</p><p>cloneå’Œè‡ªå·±ç¡¬ä»¶ç¯å¢ƒå¯¹åº”çš„ä»£ç åˆ†æ”¯</p><p>æ ¹æ®å®˜æ–¹çš„è¯´æ˜ï¼Œé…ç½®å¥½ä¾èµ–ç¯å¢ƒï¼Œç›´æ¥è¿›åˆ°å­ç›®å½•ä¸‹makeï¼Œå°±å¯ä»¥ã€‚ä½†æ˜¯æˆ‘å°è¯•æ­»æ´»ç¼–è¯‘ä¸é€šã€‚</p><p><img src="WX20240624-175840@2x.png" alt="WX20240624-175840@2x"></p><p>æ£€æŸ¥PCLå„é¡¹ç¯å¢ƒé…ç½®çš„éƒ½æ²¡é—®é¢˜ï¼Œäºæ˜¯åˆ›å»ºCMakeListsï¼Œé€šè¿‡cmakeç”Ÿæˆmakefileï¼Œå†makeã€‚æˆåŠŸäº†â€¦</p><p>æœ€åç¼–è¯‘æ‰§è¡Œäº†cuFilterï¼Œå¾—åˆ°ç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">GPU has cuda devices: 1</span><br><span class="line">----device id: 0 info----</span><br><span class="line">  GPU : Orin </span><br><span class="line">  Capbility: 8.7</span><br><span class="line">  Global memory: 15420MB</span><br><span class="line">  Const memory: 64KB</span><br><span class="line">  SM in a block: 48KB</span><br><span class="line">  warp size: 32</span><br><span class="line">  threads in a block: 1024</span><br><span class="line">  block dim: (1024,1024,64)</span><br><span class="line">  grid dim: (2147483647,65535,65535)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">------------checking CUDA ---------------- </span><br><span class="line">CUDA Loaded 119978 data points from PCD file with the following fields: x y z</span><br><span class="line"></span><br><span class="line">------------checking CUDA PassThrough ---------------- </span><br><span class="line">CUDA PassThrough by Time: 0.999257 ms.</span><br><span class="line">CUDA PassThrough before filtering: 119978</span><br><span class="line">CUDA PassThrough after filtering: 5110</span><br><span class="line"></span><br><span class="line">------------checking CUDA VoxelGrid---------------- </span><br><span class="line">CUDA VoxelGrid by Time: 6.46314 ms.</span><br><span class="line">CUDA VoxelGrid before filtering: 119978</span><br><span class="line">CUDA VoxelGrid after filtering: 3440</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">------------checking PCL ---------------- </span><br><span class="line">PCL(CPU) Loaded 119978 data points from PCD file with the following fields: x y z</span><br><span class="line"></span><br><span class="line">------------checking PCL(CPU) PassThrough ---------------- </span><br><span class="line">PCL(CPU) PassThrough by Time: 3.08542 ms.</span><br><span class="line">PointCloud before filtering: 119978 data points (x y z).</span><br><span class="line">PointCloud after filtering: 5110 data points (x y z).</span><br><span class="line"></span><br><span class="line">------------checking PCL VoxelGrid---------------- </span><br><span class="line">PCL VoxelGrid by Time: 11.5708 ms.</span><br><span class="line">PointCloud before filtering: 119978 data points (x y z).</span><br><span class="line">PointCloud after filtering: 3440 data points (x y z).</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ç›®å‰è¯¥é¡¹ç›®æºç å°šæœªå¼€æºï¼Œä½†æ˜¯ä»ç»“æœå’Œéƒ¨åˆ†è°ƒç”¨çš„ä»£ç æ¥çœ‹ï¼Œå‚æ•°ä¸€è‡´ã€ç»“æœä¸€è‡´ï¼ŒğŸˆ¶å¯æ¯”è¾ƒæ€§ã€‚</p><p>æµ‹è¯•ç»“æœå¯ä»¥å‘ç°ä½¿ç”¨CUDAå¯ä»¥åŠ é€ŸPCLå¯¹ç‚¹äº‘çš„æ»¤æ³¢è®¡ç®—ã€‚</p><p>è¡¥å……CMakeLists.txt</p><figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.16</span>)</span><br><span class="line"><span class="keyword">project</span>(cupcl)</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD <span class="number">17</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†èµ„æºæ–‡ä»¶å¤åˆ¶åˆ°buildç›®å½•ä¸­</span></span><br><span class="line"><span class="comment"># configure_file($&#123;CMAKE_SOURCE_DIR&#125;/cuFilter/lib  $&#123;CMAKE_BINARY_DIR&#125;/  COPYONLY)</span></span><br><span class="line"><span class="comment"># configure_file($&#123;CMAKE_SOURCE_DIR&#125;/table_scene_lms400.pcd  $&#123;CMAKE_BINARY_DIR&#125;/table_scene_lms400.pcd  COPYONLY)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">find_package</span>(PCL <span class="number">1.14</span> REQUIRED)</span><br><span class="line"><span class="keyword">find_package</span>(CUDA  REQUIRED)</span><br><span class="line"></span><br><span class="line"><span class="keyword">message</span>(STATUS <span class="string">&quot;PCL INCLUDE DIRS : $&#123;PCL_INCLUDE_DIRS&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">include_directories</span>(</span><br><span class="line">    <span class="variable">$&#123;PCL_INCLUDE_DIRS&#125;</span></span><br><span class="line">    <span class="variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>/cuFilter/lib   </span><br><span class="line">)</span><br><span class="line"><span class="keyword">link_directories</span>(</span><br><span class="line">    <span class="variable">$&#123;PCL_LIBRARY_DIRS&#125;</span></span><br><span class="line">    <span class="variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>/cuFilter/lib    </span><br><span class="line">)</span><br><span class="line"><span class="keyword">add_definitions</span>(<span class="variable">$&#123;PCL_DEFINITIONS&#125;</span>)</span><br><span class="line"><span class="keyword">add_executable</span>(cupcl </span><br><span class="line">    <span class="comment"># seg1.cpp</span></span><br><span class="line">    cuFilter/main.cpp</span><br><span class="line">)</span><br><span class="line"><span class="keyword">target_link_libraries</span>(cupcl <span class="variable">$&#123;PCL_LIBRARIES&#125;</span> cudafilter <span class="variable">$&#123;CUDA_LIBRARIES&#125;</span>)</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;å‰ç¯‡æ–‡ç« æåˆ°ï¼Œå¯¹æ¯”PCLä½¿ç”¨CPUå’ŒNvidia GPUè¿›è¡Œæ¬§å¼èšç±»å‘ç°ï¼Œå°´å°¬å‘ç°ä½¿ç”¨CPUçš„è®¡ç®—æ•ˆç‡åè€Œæ›´é«˜ã€‚&lt;/p&gt;
&lt;p&gt;æœ¬ç¯‡æ–‡ç« æ¢è®¨</summary>
      
    
    
    
    <category term="ç‚¹äº‘å¤„ç†" scheme="https://guoyujian.github.io/categories/%E7%82%B9%E4%BA%91%E5%A4%84%E7%90%86/"/>
    
    
    <category term="PCL" scheme="https://guoyujian.github.io/tags/PCL/"/>
    
    <category term="ç‚¹äº‘å¤„ç†" scheme="https://guoyujian.github.io/tags/%E7%82%B9%E4%BA%91%E5%A4%84%E7%90%86/"/>
    
  </entry>
  
  <entry>
    <title>PCL-CUDAç‰ˆæœ¬ç¼–è¯‘å®‰è£…</title>
    <link href="https://guoyujian.github.io/2024/06/20/PCL-CUDA%E7%89%88%E6%9C%AC%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85/"/>
    <id>https://guoyujian.github.io/2024/06/20/PCL-CUDA%E7%89%88%E6%9C%AC%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85/</id>
    <published>2024-06-20T10:05:16.000Z</published>
    <updated>2024-06-20T10:10:27.827Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>pclæ˜¯ä¸€ä¸ªc++ç¼–å†™çš„ç‚¹äº‘æ•°æ®å¤„ç†åº“ã€‚</p><p>å¤§é‡ç‚¹äº‘æ•°æ®å¤„ç†é€šå¸¸éœ€è¦æ¶ˆè€—CPUå¤§é‡æ—¶é—´ï¼Œè€Œä½¿ç”¨cudaå¯ä»¥åŠ é€Ÿè®¡ç®—ã€‚</p><p>ç›®å‰pclæœ€æ–°ç‰ˆæœ¬ï¼ˆ1.14ï¼‰æ”¯æŒcudaè®¡ç®—åŠ é€Ÿï¼ˆå°½ç®¡è¿˜ä¸å®Œå–„ï¼‰ï¼Œä½†æ˜¯éœ€è¦é¢å¤–çš„æ­¥éª¤è¿›è¡Œç¼–è¯‘å®‰è£…ã€‚</p><p>å¦‚æœè¦ç¼–è¯‘å®‰è£…çš„æ˜¯PCLæ™®é€šç‰ˆæœ¬ï¼ˆå³åªä½¿ç”¨CPUè¿›è¡Œè®¡ç®—çš„ç‰ˆæœ¬ï¼‰æ¯”è¾ƒç®€å•ï¼Œåœ¨æ­¤ç•¥è¿‡ã€‚</p><p>æœ¬æ–‡ä»‹ç»PCL-CUDAçš„ç¼–è¯‘å®‰è£…ã€‚â€</p><h2 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h2><p>æˆ‘çš„OSæ˜¯Ubuntuï¼Œè¯¦ç»†ç¡¬ä»¶ç¯å¢ƒå¦‚ä¸‹å›¾ï¼Œé€šè¿‡jtopå‘½ä»¤è·å¾—</p><p><img src="image-20240620114138-83b047k.png" alt="image">â€‹</p><p>æˆ‘çš„è½¯ä»¶ç¯å¢ƒï¼š</p><div class="table-container"><table><thead><tr><th>software</th><th><br /></th><th>cmd</th></tr></thead><tbody><tr><td>cuda</td><td>11.4</td><td>nvcc â€”version</td></tr><tr><td>gcc</td><td>9</td><td>gcc -dumpversion</td></tr><tr><td>clang</td><td>10</td><td>clang â€”version</td></tr><tr><td>Eigen</td><td>3.3.7</td><td>dpkg -s libeigen3-dev \</td><td>grep Version</td></tr><tr><td>cmake vtk qt</td><td></td></tr></tbody></table></div><p>å®‰è£…å‘½ä»¤è‡ªå·±æ‰¾ï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯apt installï¼Œè¿™é‡Œæ‰¾åˆ°ä¸€ä¸ªæ¯”è¾ƒå…¨çš„</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install git build-essential linux-libc-dev</span><br><span class="line">sudo apt-get install cmake cmake-gui</span><br><span class="line">sudo apt-get install libusb-1.0-0-dev libusb-dev libudev-dev</span><br><span class="line">sudo apt-get install mpi-default-dev openmpi-bin openmpi-common</span><br><span class="line">sudo apt-get install libflann1.9 libflann-dev # ubuntu20.4å¯¹åº”1.9</span><br><span class="line">sudo apt-get install libeigen3-dev</span><br><span class="line">sudo apt-get install libboost-all-dev</span><br><span class="line">sudo apt-get install libqhull* libgtest-dev</span><br><span class="line">sudo apt-get install freeglut3-dev pkg-config</span><br><span class="line">sudo apt-get install libxmu-dev libxi-dev</span><br><span class="line">sudo apt-get install mono-complete</span><br><span class="line">sudo apt-get install libopenni-dev</span><br><span class="line">sudo apt-get install libopenni2-dev</span><br></pre></td></tr></table></figure><h2 id="ç¼–è¯‘å®‰è£…PCL"><a href="#ç¼–è¯‘å®‰è£…PCL" class="headerlink" title="ç¼–è¯‘å®‰è£…PCL"></a>ç¼–è¯‘å®‰è£…PCL</h2><p>ä¸‹è½½PCLæºç ï¼Œæˆ‘çš„æ˜¯pcl-1.14ã€‚</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">git clone https://github.com/PointCloudLibrary/pcl.git</span><br><span class="line">cd pcl &amp;&amp; mkdir build &amp;&amp; cd build</span><br><span class="line">cmake -DBUILD_GPU=ON -DBUILD_CUDA=ON -DBUILD_apps=ON -DBUILD_examples=ON ..</span><br><span class="line">make -j2</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ³¨æ„<code>-DBUILD_GPU=ON -DBUILD_CUDA=ON</code>â€‹</p><p>åœ¨makeçš„æ—¶å€™ -j2æŒ‡å®šä½¿ç”¨2ä¸ªçº¿ç¨‹makeï¼Œå¦‚æœæœºå™¨å¥½ï¼Œå¯ä»¥æŠŠ2æ”¹å¤§ä¸€ç‚¹ï¼ŒåŠ é€Ÿç¼–è¯‘ã€‚</p><hr><p>æˆ–è€…æ‰“å¼€cmake-guiå›¾å½¢åŒ–ç•Œé¢ï¼Œé€‰æ‹©sourceå’Œbuildç›®å½•ï¼Œ</p><p>æŠŠBUILDä¸‹å’Œgpu or cudaæœ‰å…³çš„å‹¾é€‰ä¸Šï¼Œç‚¹æŒ‰configueå’Œgenerateï¼Œ</p><p>å¦‚æœç¼ºä»€ä¹ˆcmakeä¼šé£˜çº¢ï¼Œè¡¥å…¨åå†æ¬¡ç‚¹æŒ‰configueå’Œgenerateå³å¯ã€‚</p><p>ä»¥ä¸‹æ˜¯æˆ‘çš„å‹¾é€‰</p><p><img src="image-20240620142315-h54igmb.png" alt="image">â€‹</p><h2 id="è¸©å‘"><a href="#è¸©å‘" class="headerlink" title="è¸©å‘"></a>è¸©å‘</h2><p>åœ¨<code>make</code>â€‹çš„æ—¶å€™æŠ¥é”™ï¼ŒæŠ¥é”™å†…å®¹å’ŒåŸå› å¿˜è®°äº†ï¼Œä½†æ˜¯æˆ‘ä¿®æ”¹äº†pclçš„æºç ã€‚</p><p>ä¸€ä¸ªæ˜¯ä¿®æ”¹äº†æºç ä¸­çš„å¤´æ–‡ä»¶ï¼Œå¹¶åˆ é™¤äº†ä¸€éƒ¨åˆ†ä»£ç ï¼Œè¯¦è§ä¸‹ä¸¤å›¾</p><p><img src="image-20240620143054-3kgru5v.png" alt="image">â€‹</p><p><img src="image-20240620143604-hb6fnpc.png" alt="image">â€‹</p><p>ä¸€ä¸ªæ˜¯å¢åŠ äº†å¯¹åº”çš„å¤´æ–‡ä»¶sse2neon.hï¼Œè¯¥æ–‡ä»¶ä¸‹è½½åœ°å€ï¼š</p><p><a href="https://github.com/DLTcollab/sse2neon/blob/master/sse2neon.h">https://github.com/DLTcollab/sse2neon/blob/master/sse2neon.h</a></p><p><img src="image-20240620143135-mor11yo.png" alt="image">â€‹</p><p>è¿™ä¹ˆæ”¹çš„å…·ä½“æŠ¥é”™å¿˜è®°äº†â€¦â€¦</p><p>ç°åœ¨çœ‹æ¥ï¼Œè¿™éƒ¨åˆ†ä»£ç ä¹Ÿä¸æ˜¯å¿…é¡»çš„ï¼Œåªè¦åœ¨cmakeçš„æ—¶å€™æŒ‡å®š<code>cmake -DBUILD_gpu_people=OFF ..</code>â€‹å°±è¡Œã€‚</p><h2 id="éªŒè¯ç¼–è¯‘æ˜¯å¦æˆåŠŸ"><a href="#éªŒè¯ç¼–è¯‘æ˜¯å¦æˆåŠŸ" class="headerlink" title="éªŒè¯ç¼–è¯‘æ˜¯å¦æˆåŠŸ"></a>éªŒè¯ç¼–è¯‘æ˜¯å¦æˆåŠŸ</h2><p>åœ¨æºç ä¸­ï¼Œæ‰¾åˆ°gpu/examples/segmentation/src/seg.cppï¼Œè¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒcpuå’Œgpuå¯¹ç‚¹äº‘è¿›è¡Œæ¬§å¼èšç±»çš„è¯¥ä»£ç å¼•å…¥äº†pcl/gpuçš„å¤´æ–‡ä»¶</p><p>å¦‚æœèƒ½ç¼–è¯‘è¿è¡Œseg.cppæˆåŠŸï¼Œè¯´æ˜pcl-gpuç‰ˆæœ¬å®‰è£…æˆåŠŸã€‚</p><p><img src="assets/image-20240620153624-0klfssb.png" alt="image">â€‹</p><p>ä¸è¿‡æˆ‘åœ¨æ‰§è¡Œä»£ç å¾—åˆ°çš„ç»“æœå‘ç°ï¼Œä½¿ç”¨CPUçš„æ•ˆç‡åè€Œä¼šæ›´é«˜ã€‚</p><p>æ£€æŸ¥ä»£ç å‘ç°ï¼Œåœ¨ä½¿ç”¨CPUè¿›è¡Œèšç±»çš„æ—¶å€™ä½¿ç”¨çš„searchMethonæ˜¯kdtreeï¼Œè€Œä½¿ç”¨GPUè¿›è¡Œèšç±»çš„æ—¶å€™ä½¿ç”¨çš„searchMethonæ˜¯octreeã€‚åç»­æ–‡ç« ç»†è¯´ã€‚</p><h2 id="Refs"><a href="#Refs" class="headerlink" title="Refs"></a>Refs</h2><ol><li><a href="https://pcl.readthedocs.io/projects/tutorials/en/pcl-1.12.0/gpu_install.html">https://pcl.readthedocs.io/projects/tutorials/en/pcl-1.12.0/gpu_install.html</a></li><li><a href="https://blog.csdn.net/qq_64006507/article/details/135824915">https://blog.csdn.net/qq_64006507/article/details/135824915</a></li><li><a href="https://github.com/PointCloudLibrary/pcl">https://github.com/PointCloudLibrary/pcl</a></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;pclæ˜¯ä¸€ä¸ªc++ç¼–å†™çš„ç‚¹äº‘æ•°æ®å¤„ç†åº“ã€‚&lt;/p&gt;
&lt;p&gt;å¤§é‡ç‚¹äº‘æ•°æ®å¤„ç†é€šå¸¸éœ€è¦æ¶ˆè€—CPUå¤§é‡æ—¶é—´ï¼Œè€Œä½¿ç”¨cudaå¯ä»¥åŠ é€Ÿè®¡ç®—ã€‚&lt;/p&gt;
&lt;</summary>
      
    
    
    
    <category term="ç‚¹äº‘å¤„ç†" scheme="https://guoyujian.github.io/categories/%E7%82%B9%E4%BA%91%E5%A4%84%E7%90%86/"/>
    
    
    <category term="PCL" scheme="https://guoyujian.github.io/tags/PCL/"/>
    
    <category term="ç‚¹äº‘" scheme="https://guoyujian.github.io/tags/%E7%82%B9%E4%BA%91/"/>
    
  </entry>
  
  <entry>
    <title>åç¨‹ï¼Œä»yieldè¯´èµ·</title>
    <link href="https://guoyujian.github.io/2024/03/14/%E5%8D%8F%E7%A8%8B%EF%BC%8C%E4%BB%8Eyield%E8%AF%B4%E8%B5%B7/"/>
    <id>https://guoyujian.github.io/2024/03/14/%E5%8D%8F%E7%A8%8B%EF%BC%8C%E4%BB%8Eyield%E8%AF%B4%E8%B5%B7/</id>
    <published>2024-03-14T02:52:33.000Z</published>
    <updated>2024-03-14T02:58:39.795Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>Ref: ã€ŠFluent Pythonã€‹ ç¬¬16ç«  åç¨‹</p></blockquote><p>åç¨‹æ˜¯æŒ‡ä¸€ä¸ªè¿‡ç¨‹ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸è°ƒç”¨æ–¹åä½œï¼Œäº§å‡ºç”±è°ƒç”¨æ–¹æä¾›çš„å€¼ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">simple_coroutine</span>(<span class="params">a</span>): <span class="comment"># åç¨‹ç”¨ç”Ÿæˆå™¨å‡½æ•°å®šä¹‰ï¼Œé‡Œé¢æœ‰yield</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;-&gt; Started: a = <span class="subst">&#123;a&#125;</span>&#x27;</span>)</span><br><span class="line">    b = <span class="keyword">yield</span> a <span class="comment"># yieldå·¦è¾¹æ˜¯æ¥æ”¶å€¼ï¼Œå³è¾¹æ˜¯äº§å‡ºå€¼</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;-&gt; Received:&#x27;</span>, b)</span><br><span class="line"></span><br><span class="line">my_coro = simple_coroutine(<span class="number">14</span>)</span><br><span class="line">my_coro <span class="comment"># è°ƒç”¨å¾—åˆ°åç¨‹</span></span><br></pre></td></tr></table></figure><pre><code>&lt;generator object simple_coroutine at 0x1069e5230&gt;</code></pre><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">next</span>(my_coro) <span class="comment"># é¢„æ¿€æ´»åç¨‹ï¼Œè®©åç¨‹å‘å‰æ‰§è¡Œåˆ°ç¬¬ä¸€ä¸ªyield</span></span><br></pre></td></tr></table></figure><pre><code>-&gt; Started: a = 14</code></pre><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">my_coro.send(<span class="number">42</span>) <span class="comment"># æ§åˆ¶æƒæµåŠ¨åˆ°åç¨‹æœ«å°¾ï¼ŒæŠ›å‡ºStopIteration</span></span><br></pre></td></tr></table></figure><pre><code>-&gt; Received: 42---------------------------------------------------------------------------StopIteration                             Traceback (most recent call last)Cell In[3], line 1----&gt; 1 my_coro.send(42) # æ§åˆ¶æƒæµåŠ¨åˆ°åç¨‹æœ«å°¾ï¼ŒæŠ›å‡ºStopIteration</code></pre><p>å¯ä»¥é€šè¿‡<code>inspect.getgeneratorstate()</code>ç¡®å®šåç¨‹çš„çŠ¶æ€ï¼š</p><ul><li>GEN_CREATED</li><li>GEN_RUNNING</li><li>GEN_SUSPENDED</li><li>GEN_CLOSED</li></ul><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> inspect <span class="keyword">import</span> getgeneratorstate</span><br><span class="line">getgeneratorstate(my_coro)</span><br></pre></td></tr></table></figure><pre><code>&#39;GEN_CLOSED&#39;</code></pre><p><strong>ä½¿ç”¨åç¨‹è®¡ç®—ç§»åŠ¨å¹³å‡å€¼</strong></p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">averager</span>():</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    å‘åç¨‹ä¸æ–­ä¼ å…¥å€¼ï¼Œè®¡ç®—ç»“æŸï¼Œåç¨‹å†ä¼ å‡º</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    total = <span class="number">0</span></span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    average = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        term = <span class="keyword">yield</span> average</span><br><span class="line">        total += term</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        average = total / count</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">avg = averager()</span><br><span class="line"><span class="built_in">next</span>(avg) <span class="comment"># é¢„æ¿€æ´»</span></span><br><span class="line">avg.send(<span class="number">10</span>)</span><br></pre></td></tr></table></figure><pre><code>10.0</code></pre><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">avg.send(<span class="number">11</span>)</span><br></pre></td></tr></table></figure><pre><code>10.5</code></pre><p>ä¸‹é¢è§£å†³ä¸¤ä¸ªé—®é¢˜ï¼š</p><ol><li>ç”¨è£…é¥°å™¨è§£å†³æ¯æ¬¡éƒ½è¦å…ˆé¢„æ¿€æ´»åç¨‹çš„é—®é¢˜ï¼ˆç•¥ï¼‰</li><li>å¦‚ä½•ç»“æŸåç¨‹çš„é—®é¢˜</li></ol><p>ç¬¬ä¸€ä¸ªé—®é¢˜çš„ä»£ç å¿½ç•¥ï¼Œé¢„æ¿€åç¨‹è£…é¥°å™¨</p><p><strong>ç»ˆæ­¢åç¨‹å’Œå¼‚å¸¸å¤„ç†</strong></p><p>å®¢æˆ·ä»£ç å¯ä»¥åœ¨ç”Ÿæˆå™¨å¯¹è±¡ä¸Šè°ƒç”¨ä¸¤ä¸ªæ–¹æ³•ï¼Œæ˜¾å¼åœ°æŠŠå¼‚å¸¸å‘ç»™åç¨‹ã€‚è¿™ä¸¤ä¸ªæ–¹æ³•æ˜¯ throw å’Œ closeã€‚</p><p><code>generator.throw(exc_type[, exc_value[, traceback]])</code></p><p>è‡´ä½¿ç”Ÿæˆå™¨åœ¨æš‚åœçš„ yield è¡¨è¾¾å¼å¤„æŠ›å‡ºæŒ‡å®šçš„å¼‚å¸¸ã€‚å¦‚æœç”Ÿæˆå™¨å¤„ç†äº†æŠ›å‡ºçš„å¼‚å¸¸ï¼Œä»£ç ä¼šå‘å‰æ‰§è¡Œåˆ°ä¸‹ä¸€ä¸ª yield è¡¨è¾¾å¼ï¼Œè€Œäº§å‡ºçš„å€¼ä¼šæˆä¸ºè°ƒç”¨ generator.throw æ–¹æ³•å¾—åˆ°çš„è¿”å›å€¼ã€‚å¦‚æœç”Ÿæˆå™¨æ²¡æœ‰å¤„ç†æŠ›å‡ºçš„å¼‚å¸¸ï¼Œå¼‚å¸¸ä¼šå‘ä¸Šå†’æ³¡ï¼Œä¼ åˆ°è°ƒç”¨æ–¹çš„ä¸Šä¸‹æ–‡ä¸­ã€‚</p><p><code>generator.close()</code></p><p>è‡´ä½¿ç”Ÿæˆå™¨åœ¨æš‚åœçš„ yield è¡¨è¾¾å¼å¤„æŠ›å‡º GeneratorExit å¼‚å¸¸ã€‚å¦‚æœç”Ÿæˆå™¨æ²¡æœ‰å¤„ç†è¿™ä¸ªå¼‚å¸¸ï¼Œæˆ–è€…æŠ›å‡ºäº† StopIteration å¼‚å¸¸ï¼ˆé€šå¸¸æ˜¯æŒ‡è¿è¡Œåˆ°ç»“å°¾ï¼‰ï¼Œè°ƒç”¨æ–¹ä¸ä¼šæŠ¥é”™ã€‚å¦‚æœæ”¶åˆ° GeneratorExit å¼‚å¸¸ï¼Œç”Ÿæˆå™¨ä¸€å®šä¸èƒ½äº§å‡ºå€¼ï¼Œå¦åˆ™è§£é‡Šå™¨ä¼šæŠ›å‡ºRuntimeError å¼‚å¸¸ã€‚ç”Ÿæˆå™¨æŠ›å‡ºçš„å…¶ä»–å¼‚å¸¸ä¼šå‘ä¸Šå†’æ³¡ï¼Œä¼ ç»™è°ƒç”¨æ–¹ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DemoException</span>(<span class="title class_ inherited__">Exception</span>):</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">demo_exc_handling</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;started&#x27;</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>: </span><br><span class="line">            x = <span class="keyword">yield</span></span><br><span class="line">        <span class="keyword">except</span> DemoException:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;DemoException Handled, Continuing...&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;received: <span class="subst">&#123;x&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">exe_coro = demo_exc_handling()</span><br><span class="line"><span class="built_in">next</span>(exe_coro)</span><br><span class="line">exe_coro.send(<span class="number">11</span>)</span><br><span class="line">exe_coro.send(<span class="number">11</span>)</span><br><span class="line"><span class="comment"># ä¼ å…¥DemoExceptionä¸ä¼šå¯¼è‡´åç¨‹ç»ˆæ­¢</span></span><br><span class="line">exe_coro.throw(DemoException())</span><br><span class="line"><span class="comment"># ä¼ å…¥å…¶ä»–æœªå¤„ç†çš„å¼‚å¸¸ï¼Œåç¨‹ä¼šç»ˆæ­¢</span></span><br><span class="line">exe_coro.close()</span><br></pre></td></tr></table></figure><pre><code>startedreceived: 11received: 11DemoException Handled, Continuing...</code></pre><p><strong>ä½¿ç”¨yield from</strong></p><p>é¦–å…ˆyield from å¯ä»¥ç®€åŒ–forå¾ªç¯ä¸­çš„yieldè¡¨è¾¾å¼ï¼Œ</p><p>yield from x è¡¨è¾¾å¼å¯¹ x å¯¹è±¡æ‰€åšçš„ç¬¬ä¸€ä»¶äº‹æ˜¯ï¼Œè°ƒç”¨ iter(x)ï¼Œä»ä¸­è·å–è¿­ä»£å™¨ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">gen</span>():</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> <span class="string">&#x27;AB&#x27;</span>:</span><br><span class="line">        <span class="keyword">yield</span> c</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">        <span class="keyword">yield</span> i</span><br><span class="line"></span><br><span class="line"><span class="built_in">list</span>(gen())</span><br></pre></td></tr></table></figure><pre><code>[&#39;A&#39;, &#39;B&#39;, 0, 1, 2]</code></pre><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">gen</span>():</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;use yield from&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">from</span> <span class="string">&#x27;AB&#x27;</span></span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">from</span> <span class="built_in">range</span>(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">list</span>(gen())</span><br></pre></td></tr></table></figure><pre><code>[&#39;A&#39;, &#39;B&#39;, 0, 1, 2]</code></pre><p><strong>ä½†yield from çš„ä¸»è¦åŠŸèƒ½æ˜¯æ‰“å¼€åŒå‘é€šé“ï¼ŒæŠŠæœ€å¤–å±‚çš„è°ƒç”¨æ–¹ä¸æœ€å†…å±‚çš„å­ç”Ÿæˆå™¨è¿æ¥èµ·æ¥ï¼Œè¿™æ ·äºŒè€…å¯ä»¥ç›´æ¥å‘é€å’Œäº§å‡ºå€¼ï¼Œè¿˜å¯ä»¥ç›´æ¥ä¼ å…¥å¼‚å¸¸ï¼Œè€Œä¸ç”¨åœ¨ä½äºä¸­é—´çš„åç¨‹ä¸­æ·»åŠ å¤§é‡å¤„ç†å¼‚å¸¸çš„æ ·æ¿ä»£ç ã€‚æœ‰äº†è¿™ä¸ªç»“æ„ï¼Œåç¨‹å¯ä»¥é€šè¿‡ä»¥å‰ä¸å¯èƒ½çš„æ–¹å¼å§”æ‰˜èŒè´£ã€‚</strong>ç”¨è„šæœ¬ä¾‹å­è¯´æ˜ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">è„šæœ¬ä»ä¸€ä¸ªå­—å…¸ä¸­è¯»å–è™šæ„çš„ä¸ƒå¹´çº§ç”·å¥³å­¦ç”Ÿçš„ä½“é‡å’Œèº«é«˜ã€‚ä¾‹å¦‚ï¼Œ&#x27;boys;m&#x27; é”®å¯¹åº”äº 9 ä¸ªç”·å­¦ç”Ÿçš„èº«é«˜ï¼ˆå•ä½æ˜¯ç±³ï¼‰ï¼Œ &#x27;girls;kg&#x27; é”®å¯¹åº”äº 10 ä¸ªå¥³å­¦ç”Ÿçš„ä½“é‡ï¼ˆå•ä½æ˜¯åƒå…‹ï¼‰ã€‚è¿™ä¸ªè„šæœ¬æŠŠå„ç»„æ•°æ®ä¼ ç»™å‰é¢å®šä¹‰çš„ averager åç¨‹ï¼Œç„¶åç”Ÿæˆä¸€ä¸ªæŠ¥å‘Š</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> namedtuple</span><br><span class="line">Result = namedtuple(<span class="string">&#x27;Result&#x27;</span>, <span class="string">&#x27;count average&#x27;</span>)</span><br><span class="line"><span class="comment"># å­ç”Ÿæˆå™¨</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">averager</span>():</span><br><span class="line">    total = <span class="number">0.0</span></span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    average = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        term = <span class="keyword">yield</span> </span><br><span class="line">        <span class="keyword">if</span> term <span class="keyword">is</span> <span class="literal">None</span>: </span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        total += term</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        average = total/count</span><br><span class="line">    <span class="keyword">return</span> Result(count, average) <span class="comment"># è¿”å›çš„resultä¼šæˆä¸ºgrouperå‡½æ•°ä¸­yield fromè¡¨è¾¾å¼çš„å€¼</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å§”æ´¾ç”Ÿæˆå™¨</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">grouper</span>(<span class="params">results, key</span>):</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>: <span class="comment"># æ¯æ¬¡å¾ªç¯æ–°å»ºä¸€ä¸ªaverageå®ä¾‹</span></span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        grouper å‘ é€ çš„ æ¯ ä¸ª å€¼ éƒ½ ä¼š ç» ç”± yield from å¤„ ç†ï¼Œ é€š è¿‡ ç®¡ é“ ä¼  ç»™ averager å® ä¾‹ã€‚</span></span><br><span class="line"><span class="string">        grouper ä¼šåœ¨ yield from è¡¨è¾¾å¼å¤„æš‚åœï¼Œç­‰å¾… averager å®ä¾‹å¤„ç†å®¢æˆ·ç«¯å‘æ¥çš„å€¼ã€‚</span></span><br><span class="line"><span class="string">        averager å®ä¾‹è¿è¡Œå®Œæ¯•åï¼Œè¿”å›çš„å€¼ç»‘å®šåˆ° results[key] ä¸Šã€‚ while å¾ªç¯ä¼šä¸æ–­åˆ›å»º</span></span><br><span class="line"><span class="string">        averager å®ä¾‹ï¼Œå¤„ç†æ›´å¤šçš„å€¼ã€‚</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        results[key] = <span class="keyword">yield</span> <span class="keyword">from</span> averager() <span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®¢æˆ·ç«¯ä»£ç ï¼Œå³è°ƒç”¨æ–¹</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">data</span>):</span><br><span class="line">    results = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> key, values <span class="keyword">in</span> data.items():</span><br><span class="line">        group = grouper(results, key)</span><br><span class="line">        <span class="built_in">next</span>(group)</span><br><span class="line">        <span class="keyword">for</span> value <span class="keyword">in</span> values:</span><br><span class="line">            group.send(value) <span class="comment"># æŠŠå„ä¸ª value ä¼ ç»™ grouperã€‚ä¼ å…¥çš„å€¼æœ€ç»ˆåˆ°è¾¾ averager å‡½æ•°ä¸­ term = yield é‚£ä¸€è¡Œï¼›grouper æ°¸è¿œä¸çŸ¥é“ä¼ å…¥çš„å€¼æ˜¯ä»€ä¹ˆã€‚</span></span><br><span class="line">        group.send(<span class="literal">None</span>) <span class="comment"># é‡è¦ï¼ æŠŠ None ä¼ å…¥ grouperï¼Œå¯¼è‡´å½“å‰çš„ averager å®ä¾‹ç»ˆæ­¢ï¼Œä¹Ÿè®© grouper ç»§ç»­è¿è¡Œï¼Œå†åˆ›å»ºä¸€ä¸ª averager å®ä¾‹ï¼Œå¤„ç†ä¸‹ä¸€ç»„å€¼</span></span><br><span class="line">    <span class="comment"># print(results) # å¦‚æœè¦è°ƒè¯•ï¼Œå»æ‰æ³¨é‡Š</span></span><br><span class="line">    report(results)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å‡ºæŠ¥å‘Š</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">report</span>(<span class="params">results</span>):</span><br><span class="line">    <span class="keyword">for</span> key, result <span class="keyword">in</span> <span class="built_in">sorted</span>(results.items()):</span><br><span class="line">        group, unit = key.split(<span class="string">&#x27;;&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;&#123;:2&#125; &#123;:5&#125; averaging &#123;:.2f&#125;&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(</span><br><span class="line">            result.count, group, result.average, unit))</span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">&#x27;girls;kg&#x27;</span>:</span><br><span class="line">        [<span class="number">40.9</span>, <span class="number">38.5</span>, <span class="number">44.3</span>, <span class="number">42.2</span>, <span class="number">45.2</span>, <span class="number">41.7</span>, <span class="number">44.5</span>, <span class="number">38.0</span>, <span class="number">40.6</span>, <span class="number">44.5</span>],</span><br><span class="line">    <span class="string">&#x27;girls;m&#x27;</span>:</span><br><span class="line">        [<span class="number">1.6</span>, <span class="number">1.51</span>, <span class="number">1.4</span>, <span class="number">1.3</span>, <span class="number">1.41</span>, <span class="number">1.39</span>, <span class="number">1.33</span>, <span class="number">1.46</span>, <span class="number">1.45</span>, <span class="number">1.43</span>],</span><br><span class="line">    <span class="string">&#x27;boys;kg&#x27;</span>:</span><br><span class="line">        [<span class="number">39.0</span>, <span class="number">40.8</span>, <span class="number">43.2</span>, <span class="number">40.8</span>, <span class="number">43.1</span>, <span class="number">38.6</span>, <span class="number">41.4</span>, <span class="number">40.6</span>, <span class="number">36.3</span>],</span><br><span class="line">    <span class="string">&#x27;boys;m&#x27;</span>:</span><br><span class="line">        [<span class="number">1.38</span>, <span class="number">1.5</span>, <span class="number">1.32</span>, <span class="number">1.25</span>, <span class="number">1.37</span>, <span class="number">1.48</span>, <span class="number">1.25</span>, <span class="number">1.49</span>, <span class="number">1.46</span>],</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main(data)</span><br></pre></td></tr></table></figure><pre><code> 9 boys  averaging 40.42kg 9 boys  averaging 1.39m10 girls averaging 42.04kg10 girls averaging 1.43m</code></pre><p>è§£é‡Šä¸€ä¸‹ä¸Šé¢ä»£ç å‘ç”Ÿäº†ä»€ä¹ˆï¼š<br><img src="image.png" alt="image.png"></p><ul><li>å¤–å±‚forå¾ªç¯æ¯æ¬¡è¿­ä»£ä¼šæ–°å»ºä¸€ä¸ªgrouperå®ä¾‹ï¼Œèµ‹å€¼ç»™groupå˜é‡ï¼› groupæ˜¯å§”æ´¾ç”Ÿæˆå™¨ã€‚</li><li>è°ƒç”¨ next(group)ï¼Œé¢„æ¿€å§”æ´¾ç”Ÿæˆå™¨ grouperï¼Œæ­¤æ—¶è¿›å…¥ while True å¾ªç¯ï¼Œè°ƒç”¨å­ç”Ÿæˆå™¨ averager åï¼Œåœ¨ yield from è¡¨è¾¾å¼å¤„æš‚åœã€‚</li><li>å†…å±‚ for å¾ªç¯è°ƒç”¨ group.send(value)ï¼Œç›´æ¥æŠŠå€¼ä¼ ç»™å­ç”Ÿæˆå™¨ averagerã€‚åŒæ—¶ï¼Œå½“å‰çš„ grouper å®ä¾‹ï¼ˆgroupï¼‰åœ¨ yield from è¡¨è¾¾å¼å¤„æš‚åœã€‚</li><li>å†…å±‚å¾ªç¯ç»“æŸåï¼Œ group å®ä¾‹ä¾æ—§åœ¨ yield from è¡¨è¾¾å¼å¤„æš‚åœï¼Œå› æ­¤ï¼Œ grouper å‡½æ•°å®šä¹‰ä½“ä¸­ä¸º results[key] èµ‹å€¼çš„è¯­å¥è¿˜æ²¡æœ‰æ‰§è¡Œã€‚</li><li>å¦‚æœå¤–å±‚ for å¾ªç¯çš„æœ«å°¾æ²¡æœ‰ group.send(None)ï¼Œé‚£ä¹ˆ averager å­ç”Ÿæˆå™¨æ°¸è¿œä¸ä¼šç»ˆæ­¢ï¼Œå§”æ´¾ç”Ÿæˆå™¨ group æ°¸è¿œä¸ä¼šå†æ¬¡æ¿€æ´»ï¼Œå› æ­¤æ°¸è¿œä¸ä¼šä¸º results[key] èµ‹å€¼ã€‚</li><li>å¤–å±‚ for å¾ªç¯é‡æ–°è¿­ä»£æ—¶ä¼šæ–°å»ºä¸€ä¸ª grouper å®ä¾‹ï¼Œç„¶åç»‘å®šåˆ° group å˜é‡ä¸Šã€‚å‰ä¸€ä¸ªgrouper å®ä¾‹ï¼ˆä»¥åŠå®ƒåˆ›å»ºçš„å°šæœªç»ˆæ­¢çš„ averager å­ç”Ÿæˆå™¨å®ä¾‹ï¼‰è¢«åƒåœ¾å›æ”¶ç¨‹åºå›æ”¶ã€‚</li></ul><p>yield from æ„ä¹‰</p><ul><li>å­ç”Ÿæˆå™¨äº§å‡ºçš„å€¼éƒ½ç›´æ¥ä¼ ç»™å§”æ´¾ç”Ÿæˆå™¨çš„è°ƒç”¨æ–¹ï¼ˆå³å®¢æˆ·ç«¯ä»£ç ï¼‰ã€‚</li><li>ä½¿ç”¨ send() æ–¹æ³•å‘ç»™å§”æ´¾ç”Ÿæˆå™¨çš„å€¼éƒ½ç›´æ¥ä¼ ç»™å­ç”Ÿæˆå™¨ã€‚å¦‚æœå‘é€çš„å€¼æ˜¯ Noneï¼Œé‚£ä¹ˆä¼šè°ƒç”¨å­ç”Ÿæˆå™¨çš„ <strong>next</strong>() æ–¹æ³•ã€‚å¦‚æœå‘é€çš„å€¼ä¸æ˜¯ Noneï¼Œé‚£ä¹ˆä¼šè°ƒç”¨å­ç”Ÿæˆå™¨çš„ send() æ–¹æ³•ã€‚å¦‚æœè°ƒç”¨çš„æ–¹æ³•æŠ›å‡º StopIteration å¼‚å¸¸ï¼Œé‚£ä¹ˆå§”æ´¾ç”Ÿæˆå™¨æ¢å¤è¿è¡Œã€‚ä»»ä½•å…¶ä»–å¼‚å¸¸éƒ½ä¼šå‘ä¸Šå†’æ³¡ï¼Œä¼ ç»™å§”æ´¾ç”Ÿæˆå™¨ã€‚</li><li>ç”Ÿæˆå™¨é€€å‡ºæ—¶ï¼Œç”Ÿæˆå™¨ï¼ˆæˆ–å­ç”Ÿæˆå™¨ï¼‰ä¸­çš„ return expr è¡¨è¾¾å¼ä¼šè§¦å‘ StopIteration(expr)å¼‚å¸¸æŠ›å‡ºã€‚</li><li>yield from è¡¨è¾¾å¼çš„å€¼æ˜¯å­ç”Ÿæˆå™¨ç»ˆæ­¢æ—¶ä¼ ç»™ StopIteration å¼‚å¸¸çš„ç¬¬ä¸€ä¸ªå‚æ•°</li></ul><p>å¯¹äº<code>RESULT = yield from EXPR</code>çš„ä¼ªä»£ç ï¼š(è¿™å—çœ‹çœ‹å°±è¡Œäº†)</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">_i = <span class="built_in">iter</span>(EXPR) <span class="comment"># EXPRæ˜¯ä»»ä½•å¯è¿­ä»£çš„å¯¹è±¡</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    _y = <span class="built_in">next</span>(_i) <span class="comment"># é¢„æ¿€å­ç”Ÿæˆå™¨ï¼Œç»“æœä¿å­˜åœ¨_yä½œä¸ºäº§å‡ºçš„ç¬¬ä¸€ä¸ªå€¼</span></span><br><span class="line"><span class="keyword">except</span> StopIteration <span class="keyword">as</span> _e:</span><br><span class="line">    _r = _e.value <span class="comment">#å¦‚æœæŠ›å‡º StopIteration å¼‚å¸¸ï¼Œè·å–å¼‚å¸¸å¯¹è±¡çš„ value å±æ€§ï¼Œèµ‹å€¼ç»™ _r</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>: <span class="comment"># è¿è¡Œè¿™ä¸ªå¾ªç¯æ—¶ï¼Œå§”æ´¾ç”Ÿæˆå™¨ä¼šé˜»å¡ï¼Œåªä½œä¸ºè°ƒç”¨æ–¹å’Œå­ç”Ÿæˆå™¨ä¹‹é—´çš„é€šé“ã€‚</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            _s = <span class="keyword">yield</span> _y <span class="comment"># äº§å‡ºå­ç”Ÿæˆå™¨å½“å‰äº§å‡ºçš„å…ƒç´ ï¼›ç­‰å¾…è°ƒç”¨æ–¹å‘é€ _s ä¸­ä¿å­˜çš„å€¼ã€‚</span></span><br><span class="line">        <span class="keyword">except</span> GeneratorExit <span class="keyword">as</span> _e: <span class="comment"># è¿™ä¸€éƒ¨åˆ†ç”¨äºå…³é—­å§”æ´¾ç”Ÿæˆå™¨å’Œå­ç”Ÿæˆå™¨ã€‚å› ä¸ºå­ç”Ÿæˆå™¨å¯ä»¥æ˜¯ä»»ä½•å¯è¿­ä»£çš„å¯¹è±¡ï¼Œæ‰€ä»¥å¯èƒ½æ²¡æœ‰ close æ–¹æ³•ã€‚</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                _m = _i.close</span><br><span class="line">            <span class="keyword">except</span> AttributeError:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                _m()</span><br><span class="line">            <span class="keyword">raise</span> _e</span><br><span class="line">        <span class="keyword">except</span> BaseException <span class="keyword">as</span> _e: <span class="comment"># è¿™ä¸€éƒ¨åˆ†å¤„ç†è°ƒç”¨æ–¹é€šè¿‡ .throw(...) æ–¹æ³•ä¼ å…¥çš„å¼‚å¸¸ã€‚</span></span><br><span class="line">            _x = sys.exc_info()</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                _m = _i.throw</span><br><span class="line">            <span class="keyword">except</span> AttributeError:</span><br><span class="line">                <span class="keyword">raise</span> _e</span><br><span class="line">            <span class="keyword">else</span>: <span class="comment"># å¦‚æœå­ç”Ÿæˆå™¨æœ‰ throw æ–¹æ³•ï¼Œè°ƒç”¨å®ƒå¹¶ä¼ å…¥è°ƒç”¨æ–¹å‘æ¥çš„å¼‚å¸¸ã€‚</span></span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    _y = _m(*_x)</span><br><span class="line">                <span class="keyword">except</span> StopIteration <span class="keyword">as</span> _e:</span><br><span class="line">                    _r = _e.value</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>: <span class="comment"># å¦‚æœäº§å‡ºå€¼æ—¶æ²¡æœ‰å¼‚å¸¸</span></span><br><span class="line">            <span class="keyword">try</span>: <span class="comment"># å°è¯•è®©å­ç”Ÿæˆå™¨å‘å‰æ‰§è¡Œ</span></span><br><span class="line">                <span class="keyword">if</span> _s <span class="keyword">is</span> <span class="literal">None</span>: <span class="comment"># å¦‚æœè°ƒç”¨æ–¹æœ€åå‘é€çš„å€¼æ˜¯ Noneï¼Œåœ¨å­ç”Ÿæˆå™¨ä¸Šè°ƒç”¨ next å‡½æ•°ï¼Œå¦åˆ™è°ƒç”¨ send æ–¹æ³•</span></span><br><span class="line">                    _y = <span class="built_in">next</span>(_i)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    _y = _i.send(_s)</span><br><span class="line">            <span class="keyword">except</span> StopIteration <span class="keyword">as</span> _e: <span class="comment"># å¦‚æœå­ç”Ÿæˆå™¨æŠ›å‡º StopIteration å¼‚å¸¸ï¼Œè·å– value å±æ€§çš„å€¼ï¼Œèµ‹å€¼ç»™ _rï¼Œç„¶åé€€å‡ºå¾ªç¯ï¼Œè®©å§”æ´¾ç”Ÿæˆå™¨æ¢å¤è¿è¡Œ</span></span><br><span class="line">                    _r = _e.value</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">RESULT = _r <span class="comment"># è¿”å›çš„ç»“æœï¼ˆRESULTï¼‰æ˜¯ _rï¼Œå³æ•´ä¸ª yield from è¡¨è¾¾å¼çš„å€¼ã€‚</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;Ref: ã€ŠFluent Pythonã€‹ ç¬¬16ç«  åç¨‹&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;åç¨‹æ˜¯æŒ‡ä¸€ä¸ªè¿‡ç¨‹ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸è°ƒç”¨æ–¹åä½œï¼Œäº§å‡ºç”±è°ƒç”¨æ–¹æä¾›çš„å€¼ã€‚&lt;/p&gt;
&lt;figure class=&quot;highlight python&quot;&gt;&lt;tabl</summary>
      
    
    
    
    <category term="Python" scheme="https://guoyujian.github.io/categories/Python/"/>
    
    <category term="åŸºç¡€" scheme="https://guoyujian.github.io/categories/Python/%E5%9F%BA%E7%A1%80/"/>
    
    
    <category term="Python" scheme="https://guoyujian.github.io/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>Python å¹¶å‘ç¼–ç¨‹å°ç»“1</title>
    <link href="https://guoyujian.github.io/2024/03/08/Python-%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%B0%8F%E7%BB%931/"/>
    <id>https://guoyujian.github.io/2024/03/08/Python-%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%B0%8F%E7%BB%931/</id>
    <published>2024-03-08T07:23:02.000Z</published>
    <updated>2024-03-08T07:40:53.849Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>KeyWords:</p><ul><li>threading.Thread</li><li>threading.Event</li><li>ä½¿ç”¨é˜Ÿåˆ—queue.Queueï¼Œtask_down()ã€join()å®ç°çº¿ç¨‹é€šä¿¡</li><li>Lockçš„ä¸Šä¸‹æ–‡ç®¡ç†ã€RLockã€ä¿¡å·é‡Semaphore</li><li>æ­»é”</li><li>åˆ›å»ºå¯¹å…¶ä»–çº¿ç¨‹ä¸å¯è§çš„çº¿ç¨‹çŠ¶æ€ï¼šthreading.local()</li><li>çº¿ç¨‹æ± : concurrent.futures.ThreadPoolExecutor</li><li>å¹¶è¡Œç¼–ç¨‹ï¼šconcurrent.futures.ProcessPoolExecutorã€multiprocessing</li><li>GILå…¨å±€è§£é‡Šå™¨çš„å½±å“å’Œè§£å†³æ–¹æ¡ˆ</li><li>Actoræ¨¡å¼</li><li>ï¼ˆæœ¬æ–‡æœªæåˆ°çš„ï¼‰ç”Ÿæˆå™¨ã€åç¨‹ä¸asyncio</li><li>ï¼ˆæœ¬æ–‡æœªæåˆ°çš„ï¼‰æ¶ˆæ¯å‘å¸ƒ/è®¢é˜…æ¨¡å‹ã€å¤šçº¿ç¨‹è½®è¯¢</li></ul></blockquote><h1 id="å¯åŠ¨å’Œåœæ­¢çº¿ç¨‹"><a href="#å¯åŠ¨å’Œåœæ­¢çº¿ç¨‹" class="headerlink" title="å¯åŠ¨å’Œåœæ­¢çº¿ç¨‹"></a>å¯åŠ¨å’Œåœæ­¢çº¿ç¨‹</h1><p><code>threading</code>â€‹ åº“å¯ä»¥åœ¨å•ç‹¬çš„çº¿ç¨‹ä¸­æ‰§è¡Œä»»ä½•çš„åœ¨ Python ä¸­å¯ä»¥è°ƒç”¨çš„å¯¹è±¡ã€‚ä½ å¯ä»¥åˆ›å»ºä¸€ä¸ª <code>Thread</code>â€‹ å¯¹è±¡å¹¶å°†ä½ è¦æ‰§è¡Œçš„å¯¹è±¡ä»¥ target å‚æ•°çš„å½¢å¼æä¾›ç»™è¯¥å¯¹è±¡ã€‚ ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Code to execute in an independent thread</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">countdown</span>(<span class="params">n</span>):</span><br><span class="line">    <span class="keyword">while</span> n &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;T-minus&#x27;</span>, n)</span><br><span class="line">        n -= <span class="number">1</span></span><br><span class="line">        time.sleep(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create and launch a thread</span></span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line">t = Thread(target=countdown, args=(<span class="number">10</span>,))</span><br><span class="line">t.start()</span><br></pre></td></tr></table></figure><p>å½“ä½ åˆ›å»ºå¥½ä¸€ä¸ªçº¿ç¨‹å¯¹è±¡åï¼Œè¯¥å¯¹è±¡å¹¶ä¸ä¼šç«‹å³æ‰§è¡Œï¼Œé™¤éä½ è°ƒç”¨å®ƒçš„ <code>&lt;span class=&quot;pre&quot;&gt;start()&lt;/span&gt;</code>â€‹ æ–¹æ³•ï¼ˆå½“ä½ è°ƒç”¨ <code>&lt;span class=&quot;pre&quot;&gt;start()&lt;/span&gt;</code>â€‹ æ–¹æ³•æ—¶ï¼Œå®ƒä¼šè°ƒç”¨ä½ ä¼ é€’è¿›æ¥çš„å‡½æ•°ï¼Œå¹¶æŠŠä½ ä¼ é€’è¿›æ¥çš„å‚æ•°ä¼ é€’ç»™è¯¥å‡½æ•°ï¼‰ã€‚Pythonä¸­çš„çº¿ç¨‹ä¼šåœ¨ä¸€ä¸ªå•ç‹¬çš„ç³»ç»Ÿçº§çº¿ç¨‹ä¸­æ‰§è¡Œï¼ˆæ¯”å¦‚è¯´ä¸€ä¸ª POSIX çº¿ç¨‹æˆ–è€…ä¸€ä¸ª Windows çº¿ç¨‹ï¼‰ï¼Œè¿™äº›çº¿ç¨‹å°†ç”±æ“ä½œç³»ç»Ÿæ¥å…¨æƒç®¡ç†ã€‚çº¿ç¨‹ä¸€æ—¦å¯åŠ¨ï¼Œå°†ç‹¬ç«‹æ‰§è¡Œç›´åˆ°ç›®æ ‡å‡½æ•°è¿”å›ã€‚ä½ å¯ä»¥æŸ¥è¯¢ä¸€ä¸ªçº¿ç¨‹å¯¹è±¡çš„çŠ¶æ€ï¼Œçœ‹å®ƒæ˜¯å¦è¿˜åœ¨æ‰§è¡Œï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">if t.is_alive():</span><br><span class="line">    print(&#x27;Still running&#x27;)</span><br><span class="line">else:</span><br><span class="line">    print(&#x27;Completed&#x27;)</span><br></pre></td></tr></table></figure><p>ä½ ä¹Ÿå¯ä»¥å°†ä¸€ä¸ªçº¿ç¨‹åŠ å…¥åˆ°å½“å‰çº¿ç¨‹ï¼Œå¹¶ç­‰å¾…å®ƒç»ˆæ­¢ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">t.join()</span><br></pre></td></tr></table></figure><p>Pythonè§£é‡Šå™¨ç›´åˆ°æ‰€æœ‰çº¿ç¨‹éƒ½ç»ˆæ­¢å‰ä»ä¿æŒè¿è¡Œã€‚å¯¹äºéœ€è¦é•¿æ—¶é—´è¿è¡Œçš„çº¿ç¨‹æˆ–è€…éœ€è¦ä¸€ç›´è¿è¡Œçš„åå°ä»»åŠ¡ï¼Œä½ åº”å½“è€ƒè™‘ä½¿ç”¨åå°çº¿ç¨‹ã€‚ ä¾‹å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">t = Thread(target=countdown, args=(10,), daemon=True)</span><br><span class="line">t.start()</span><br></pre></td></tr></table></figure><p>åå°çº¿ç¨‹æ— æ³•ç­‰å¾…ï¼Œä¸è¿‡ï¼Œè¿™äº›çº¿ç¨‹ä¼šåœ¨ä¸»çº¿ç¨‹ç»ˆæ­¢æ—¶è‡ªåŠ¨é”€æ¯ã€‚ é™¤äº†å¦‚ä¸Šæ‰€ç¤ºçš„ä¸¤ä¸ªæ“ä½œï¼Œå¹¶æ²¡æœ‰å¤ªå¤šå¯ä»¥å¯¹çº¿ç¨‹åšçš„äº‹æƒ…ã€‚ä½ æ— æ³•ç»“æŸä¸€ä¸ªçº¿ç¨‹ï¼Œæ— æ³•ç»™å®ƒå‘é€ä¿¡å·ï¼Œæ— æ³•è°ƒæ•´å®ƒçš„è°ƒåº¦ï¼Œä¹Ÿæ— æ³•æ‰§è¡Œå…¶ä»–é«˜çº§æ“ä½œã€‚å¦‚æœéœ€è¦è¿™äº›ç‰¹æ€§ï¼Œä½ éœ€è¦è‡ªå·±æ·»åŠ ã€‚æ¯”å¦‚è¯´ï¼Œå¦‚æœä½ éœ€è¦ç»ˆæ­¢çº¿ç¨‹ï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹å¿…é¡»é€šè¿‡ç¼–ç¨‹åœ¨æŸä¸ªç‰¹å®šç‚¹è½®è¯¢æ¥é€€å‡ºã€‚ä½ å¯ä»¥åƒä¸‹è¾¹è¿™æ ·æŠŠçº¿ç¨‹æ”¾å…¥ä¸€ä¸ªç±»ä¸­ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CountdownTask</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self._running = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">terminate</span>(<span class="params">self</span>):</span><br><span class="line">        self._running = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self, n</span>):</span><br><span class="line">        <span class="keyword">while</span> self._running <span class="keyword">and</span> n &gt; <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;T-minus&#x27;</span>, n)</span><br><span class="line">            n -= <span class="number">1</span></span><br><span class="line">            time.sleep(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">c = CountdownTask()</span><br><span class="line">t = Thread(target=c.run, args=(<span class="number">10</span>,))</span><br><span class="line">t.start()</span><br><span class="line">c.terminate() <span class="comment"># Signal termination</span></span><br><span class="line">t.join()      <span class="comment"># Wait for actual termination (if needed)</span></span><br></pre></td></tr></table></figure><p>å¦‚æœçº¿ç¨‹æ‰§è¡Œä¸€äº›åƒI/Oè¿™æ ·çš„é˜»å¡æ“ä½œï¼Œé‚£ä¹ˆé€šè¿‡è½®è¯¢æ¥ç»ˆæ­¢çº¿ç¨‹å°†ä½¿å¾—çº¿ç¨‹ä¹‹é—´çš„åè°ƒå˜å¾—éå¸¸æ£˜æ‰‹ã€‚æ¯”å¦‚ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹ä¸€ç›´é˜»å¡åœ¨ä¸€ä¸ªI/Oæ“ä½œä¸Šï¼Œå®ƒå°±æ°¸è¿œæ— æ³•è¿”å›ï¼Œä¹Ÿå°±æ— æ³•æ£€æŸ¥è‡ªå·±æ˜¯å¦å·²ç»è¢«ç»“æŸäº†ã€‚è¦æ­£ç¡®å¤„ç†è¿™äº›é—®é¢˜ï¼Œä½ éœ€è¦åˆ©ç”¨è¶…æ—¶å¾ªç¯æ¥å°å¿ƒæ“ä½œçº¿ç¨‹ã€‚ ä¾‹å­å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">IOTask</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">terminate</span>(<span class="params">self</span>):</span><br><span class="line">        self._running = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self, sock</span>):</span><br><span class="line">        <span class="comment"># sock is a socket</span></span><br><span class="line">        sock.settimeout(<span class="number">5</span>)        <span class="comment"># Set timeout period</span></span><br><span class="line">        <span class="keyword">while</span> self._running:</span><br><span class="line">            <span class="comment"># Perform a blocking I/O operation w/ timeout</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                data = sock.recv(<span class="number">8192</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">except</span> socket.timeout:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="comment"># Continued processing</span></span><br><span class="line">            ...</span><br><span class="line">        <span class="comment"># Terminated</span></span><br><span class="line">        <span class="keyword">return</span></span><br></pre></td></tr></table></figure><h2 id="è®¨è®º"><a href="#è®¨è®º" class="headerlink" title="è®¨è®º"></a>è®¨è®º</h2><p>ç”±äºå…¨å±€è§£é‡Šé”ï¼ˆGILï¼‰çš„åŸå› ï¼ŒPython çš„çº¿ç¨‹è¢«é™åˆ¶åˆ°åŒä¸€æ—¶åˆ»åªå…è®¸ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œè¿™æ ·ä¸€ä¸ªæ‰§è¡Œæ¨¡å‹ã€‚æ‰€ä»¥ï¼ŒPython çš„çº¿ç¨‹æ›´é€‚ç”¨äºå¤„ç†I/Oå’Œå…¶ä»–éœ€è¦å¹¶å‘æ‰§è¡Œçš„é˜»å¡æ“ä½œï¼ˆæ¯”å¦‚ç­‰å¾…I/Oã€ç­‰å¾…ä»æ•°æ®åº“è·å–æ•°æ®ç­‰ç­‰ï¼‰ï¼Œè€Œä¸æ˜¯éœ€è¦å¤šå¤„ç†å™¨å¹¶è¡Œçš„è®¡ç®—å¯†é›†å‹ä»»åŠ¡ã€‚</p><p>æœ‰æ—¶ä½ ä¼šçœ‹åˆ°ä¸‹è¾¹è¿™ç§é€šè¿‡ç»§æ‰¿ <code>Thread</code>â€‹ ç±»æ¥å®ç°çš„çº¿ç¨‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from threading import Thread</span><br><span class="line"></span><br><span class="line">class CountdownThread(Thread):</span><br><span class="line">    def __init__(self, n):</span><br><span class="line">        super().__init__()</span><br><span class="line">        self.n = n</span><br><span class="line">    def run(self):</span><br><span class="line">        while self.n &gt; 0:</span><br><span class="line"></span><br><span class="line">            print(&#x27;T-minus&#x27;, self.n)</span><br><span class="line">            self.n -= 1</span><br><span class="line">            time.sleep(5)</span><br><span class="line"></span><br><span class="line">c = CountdownThread(5)</span><br><span class="line">c.start()</span><br></pre></td></tr></table></figure><p>å°½ç®¡è¿™æ ·ä¹Ÿå¯ä»¥å·¥ä½œï¼Œä½†è¿™ä½¿å¾—ä½ çš„ä»£ç ä¾èµ–äº <code>threading</code>â€‹ åº“ï¼Œæ‰€ä»¥ä½ çš„è¿™äº›ä»£ç åªèƒ½åœ¨çº¿ç¨‹ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨ã€‚ä¸Šæ–‡æ‰€å†™çš„é‚£äº›ä»£ç ã€å‡½æ•°éƒ½æ˜¯ä¸ <code>threading</code>â€‹ åº“æ— å…³çš„ï¼Œè¿™æ ·å°±ä½¿å¾—è¿™äº›ä»£ç å¯ä»¥è¢«ç”¨åœ¨å…¶ä»–çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œå¯èƒ½ä¸çº¿ç¨‹æœ‰å…³ï¼Œä¹Ÿå¯èƒ½ä¸çº¿ç¨‹æ— å…³ã€‚æ¯”å¦‚ï¼Œä½ å¯ä»¥é€šè¿‡ <code>multiprocessing</code>â€‹ æ¨¡å—åœ¨ä¸€ä¸ªå•ç‹¬çš„è¿›ç¨‹ä¸­æ‰§è¡Œä½ çš„ä»£ç ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import multiprocessing</span><br><span class="line">c = CountdownTask(5)</span><br><span class="line">p = multiprocessing.Process(target=c.run)</span><br><span class="line">p.start()</span><br></pre></td></tr></table></figure><p>å†æ¬¡é‡ç”³ï¼Œè¿™æ®µä»£ç ä»…é€‚ç”¨äº CountdownTask ç±»æ˜¯ä»¥ç‹¬ç«‹äºå®é™…çš„å¹¶å‘æ‰‹æ®µï¼ˆå¤šçº¿ç¨‹ã€å¤šè¿›ç¨‹ç­‰ç­‰ï¼‰å®ç°çš„æƒ…å†µã€‚</p><h1 id="åˆ¤æ–­çº¿ç¨‹æ˜¯å¦å¯åŠ¨"><a href="#åˆ¤æ–­çº¿ç¨‹æ˜¯å¦å¯åŠ¨" class="headerlink" title="åˆ¤æ–­çº¿ç¨‹æ˜¯å¦å¯åŠ¨"></a>åˆ¤æ–­çº¿ç¨‹æ˜¯å¦å¯åŠ¨</h1><p>ä½ å·²ç»å¯åŠ¨äº†ä¸€ä¸ªçº¿ç¨‹ï¼Œä½†æ˜¯ä½ æƒ³çŸ¥é“å®ƒæ˜¯ä¸æ˜¯çœŸçš„å·²ç»å¼€å§‹è¿è¡Œäº†ã€‚</p><p>çº¿ç¨‹çš„ä¸€ä¸ªå…³é”®ç‰¹æ€§æ˜¯æ¯ä¸ªçº¿ç¨‹éƒ½æ˜¯ç‹¬ç«‹è¿è¡Œä¸”çŠ¶æ€ä¸å¯é¢„æµ‹ã€‚å¦‚æœç¨‹åºä¸­çš„å…¶ä»–çº¿ç¨‹éœ€è¦é€šè¿‡åˆ¤æ–­æŸä¸ªçº¿ç¨‹çš„çŠ¶æ€æ¥ç¡®å®šè‡ªå·±ä¸‹ä¸€æ­¥çš„æ“ä½œï¼Œè¿™æ—¶çº¿ç¨‹åŒæ­¥é—®é¢˜å°±ä¼šå˜å¾—éå¸¸æ£˜æ‰‹ã€‚ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ <code>threading</code>â€‹ åº“ä¸­çš„ <code>Event</code>â€‹ å¯¹è±¡ã€‚ <code>Event</code>â€‹ å¯¹è±¡åŒ…å«ä¸€ä¸ªå¯ç”±çº¿ç¨‹è®¾ç½®çš„ä¿¡å·æ ‡å¿—ï¼Œå®ƒå…è®¸çº¿ç¨‹ç­‰å¾…æŸäº›äº‹ä»¶çš„å‘ç”Ÿã€‚åœ¨åˆå§‹æƒ…å†µä¸‹ï¼Œevent å¯¹è±¡ä¸­çš„ä¿¡å·æ ‡å¿—è¢«è®¾ç½®ä¸ºå‡ã€‚å¦‚æœæœ‰çº¿ç¨‹ç­‰å¾…ä¸€ä¸ª event å¯¹è±¡ï¼Œè€Œè¿™ä¸ª event å¯¹è±¡çš„æ ‡å¿—ä¸ºå‡ï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹å°†ä¼šè¢«ä¸€ç›´é˜»å¡ç›´è‡³è¯¥æ ‡å¿—ä¸ºçœŸã€‚ä¸€ä¸ªçº¿ç¨‹å¦‚æœå°†ä¸€ä¸ª event å¯¹è±¡çš„ä¿¡å·æ ‡å¿—è®¾ç½®ä¸ºçœŸï¼Œå®ƒå°†å”¤é†’æ‰€æœ‰ç­‰å¾…è¿™ä¸ª event å¯¹è±¡çš„çº¿ç¨‹ã€‚å¦‚æœä¸€ä¸ªçº¿ç¨‹ç­‰å¾…ä¸€ä¸ªå·²ç»è¢«è®¾ç½®ä¸ºçœŸçš„ event å¯¹è±¡ï¼Œé‚£ä¹ˆå®ƒå°†å¿½ç•¥è¿™ä¸ªäº‹ä»¶ï¼Œç»§ç»­æ‰§è¡Œã€‚ ä¸‹è¾¹çš„ä»£ç å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ <code>Event</code>â€‹ æ¥åè°ƒçº¿ç¨‹çš„å¯åŠ¨ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread, Event</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment"># Code to execute in an independent thread</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">countdown</span>(<span class="params">n, started_evt</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;countdown starting&#x27;</span>)</span><br><span class="line">    started_evt.<span class="built_in">set</span>()</span><br><span class="line">    <span class="keyword">while</span> n &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;T-minus&#x27;</span>, n)</span><br><span class="line">        n -= <span class="number">1</span></span><br><span class="line">        time.sleep(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create the event object that will be used to signal startup</span></span><br><span class="line">started_evt = Event()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Launch the thread and pass the startup event</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Launching countdown&#x27;</span>)</span><br><span class="line">t = Thread(target=countdown, args=(<span class="number">10</span>,started_evt))</span><br><span class="line">t.start()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Wait for the thread to start</span></span><br><span class="line">started_evt.wait()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;countdown is running&#x27;</span>)</span><br></pre></td></tr></table></figure><p>å½“ä½ æ‰§è¡Œè¿™æ®µä»£ç ï¼Œâ€œcountdown is runningâ€ æ€»æ˜¯æ˜¾ç¤ºåœ¨ â€œcountdown startingâ€ ä¹‹åæ˜¾ç¤ºã€‚è¿™æ˜¯ç”±äºä½¿ç”¨ event æ¥åè°ƒçº¿ç¨‹ï¼Œä½¿å¾—ä¸»çº¿ç¨‹è¦ç­‰åˆ° <code>countdown()</code>â€‹ å‡½æ•°è¾“å‡ºå¯åŠ¨ä¿¡æ¯åï¼Œæ‰èƒ½ç»§ç»­æ‰§è¡Œã€‚</p><h2 id="è®¨è®º-1"><a href="#è®¨è®º-1" class="headerlink" title="è®¨è®º"></a>è®¨è®º</h2><p>event å¯¹è±¡æœ€å¥½å•æ¬¡ä½¿ç”¨ï¼Œå°±æ˜¯è¯´ï¼Œä½ åˆ›å»ºä¸€ä¸ª event å¯¹è±¡ï¼Œè®©æŸä¸ªçº¿ç¨‹ç­‰å¾…è¿™ä¸ªå¯¹è±¡ï¼Œä¸€æ—¦è¿™ä¸ªå¯¹è±¡è¢«è®¾ç½®ä¸ºçœŸï¼Œä½ å°±åº”è¯¥ä¸¢å¼ƒå®ƒã€‚å°½ç®¡å¯ä»¥é€šè¿‡ <code>clear()</code>â€‹ æ–¹æ³•æ¥é‡ç½® event å¯¹è±¡ï¼Œä½†æ˜¯å¾ˆéš¾ç¡®ä¿å®‰å…¨åœ°æ¸…ç† event å¯¹è±¡å¹¶å¯¹å®ƒé‡æ–°èµ‹å€¼ã€‚å¾ˆå¯èƒ½ä¼šå‘ç”Ÿé”™è¿‡äº‹ä»¶ã€æ­»é”æˆ–è€…å…¶ä»–é—®é¢˜ï¼ˆç‰¹åˆ«æ˜¯ï¼Œä½ æ— æ³•ä¿è¯é‡ç½® event å¯¹è±¡çš„ä»£ç ä¼šåœ¨çº¿ç¨‹å†æ¬¡ç­‰å¾…è¿™ä¸ª event å¯¹è±¡ä¹‹å‰æ‰§è¡Œï¼‰ã€‚å¦‚æœä¸€ä¸ªçº¿ç¨‹éœ€è¦ä¸åœåœ°é‡å¤ä½¿ç”¨ event å¯¹è±¡ï¼Œä½ æœ€å¥½ä½¿ç”¨ <code>Condition</code>â€‹ å¯¹è±¡æ¥ä»£æ›¿ã€‚ä¸‹é¢çš„ä»£ç ä½¿ç”¨ <code>Condition</code>â€‹ å¯¹è±¡å®ç°äº†ä¸€ä¸ªå‘¨æœŸå®šæ—¶å™¨ï¼Œæ¯å½“å®šæ—¶å™¨è¶…æ—¶çš„æ—¶å€™ï¼Œå…¶ä»–çº¿ç¨‹éƒ½å¯ä»¥ç›‘æµ‹åˆ°ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PeriodicTimer</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, interval</span>):</span><br><span class="line">        self._interval = interval</span><br><span class="line">        self._flag = <span class="number">0</span></span><br><span class="line">        self._cv = threading.Condition()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">start</span>(<span class="params">self</span>):</span><br><span class="line">        t = threading.Thread(target=self.run)</span><br><span class="line">        t.daemon = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        t.start()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        Run the timer and notify waiting threads after each interval</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            time.sleep(self._interval)</span><br><span class="line">            <span class="keyword">with</span> self._cv:</span><br><span class="line">                 self._flag ^= <span class="number">1</span></span><br><span class="line">                 self._cv.notify_all()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">wait_for_tick</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        Wait for the next tick of the timer</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">with</span> self._cv:</span><br><span class="line">            last_flag = self._flag</span><br><span class="line">            <span class="keyword">while</span> last_flag == self._flag:</span><br><span class="line">                self._cv.wait()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Example use of the timer</span></span><br><span class="line">ptimer = PeriodicTimer(<span class="number">5</span>)</span><br><span class="line">ptimer.start()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Two threads that synchronize on the timer</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">countdown</span>(<span class="params">nticks</span>):</span><br><span class="line">    <span class="keyword">while</span> nticks &gt; <span class="number">0</span>:</span><br><span class="line">        ptimer.wait_for_tick()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;T-minus&#x27;</span>, nticks)</span><br><span class="line">        nticks -= <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">countup</span>(<span class="params">last</span>):</span><br><span class="line">    n = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> n &lt; last:</span><br><span class="line">        ptimer.wait_for_tick()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Counting&#x27;</span>, n)</span><br><span class="line">        n += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">threading.Thread(target=countdown, args=(<span class="number">10</span>,)).start()</span><br><span class="line">threading.Thread(target=countup, args=(<span class="number">5</span>,)).start()</span><br></pre></td></tr></table></figure><p>eventå¯¹è±¡çš„ä¸€ä¸ªé‡è¦ç‰¹ç‚¹æ˜¯å½“å®ƒè¢«è®¾ç½®ä¸ºçœŸæ—¶ä¼šå”¤é†’æ‰€æœ‰ç­‰å¾…å®ƒçš„çº¿ç¨‹ã€‚å¦‚æœä½ åªæƒ³å”¤é†’å•ä¸ªçº¿ç¨‹ï¼Œæœ€å¥½æ˜¯ä½¿ç”¨ä¿¡å·é‡æˆ–è€… <code>Condition</code>â€‹ å¯¹è±¡æ¥æ›¿ä»£ã€‚è€ƒè™‘ä¸€ä¸‹è¿™æ®µä½¿ç”¨ä¿¡å·é‡å®ç°çš„ä»£ç ï¼š</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Worker thread</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">worker</span>(<span class="params">n, sema</span>):</span><br><span class="line">    <span class="comment"># Wait to be signaled</span></span><br><span class="line">    sema.acquire()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Do some work</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Working&#x27;</span>, n)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create some threads</span></span><br><span class="line">sema = threading.Semaphore(<span class="number">0</span>)</span><br><span class="line">nworkers = <span class="number">10</span></span><br><span class="line"><span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(nworkers):</span><br><span class="line">    t = threading.Thread(target=worker, args=(n, sema,))</span><br><span class="line">    t.start()</span><br></pre></td></tr></table></figure><p>è¿è¡Œä¸Šè¾¹çš„ä»£ç å°†ä¼šå¯åŠ¨ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰ä»€ä¹ˆäº‹æƒ…å‘ç”Ÿã€‚è¿™æ˜¯å› ä¸ºæ‰€æœ‰çš„çº¿ç¨‹éƒ½åœ¨ç­‰å¾…è·å–ä¿¡å·é‡ã€‚æ¯æ¬¡ä¿¡å·é‡è¢«é‡Šæ”¾ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹ä¼šè¢«å”¤é†’å¹¶æ‰§è¡Œï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; sema.release()</span><br><span class="line">Working 0</span><br><span class="line">&gt;&gt;&gt; sema.release()</span><br><span class="line">Working 1</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><p>ç¼–å†™æ¶‰åŠåˆ°å¤§é‡çš„çº¿ç¨‹é—´åŒæ­¥é—®é¢˜çš„ä»£ç ä¼šè®©ä½ ç—›ä¸æ¬²ç”Ÿã€‚æ¯”è¾ƒåˆé€‚çš„æ–¹å¼æ˜¯ä½¿ç”¨é˜Ÿåˆ—æ¥è¿›è¡Œçº¿ç¨‹é—´é€šä¿¡æˆ–è€…æ¯ä¸ªæŠŠçº¿ç¨‹å½“ä½œä¸€ä¸ªActorï¼Œåˆ©ç”¨Actoræ¨¡å‹æ¥æ§åˆ¶å¹¶å‘ã€‚ä¸‹ä¸€èŠ‚å°†ä¼šä»‹ç»åˆ°é˜Ÿåˆ—ï¼Œè€ŒActoræ¨¡å‹å°†åœ¨12.10èŠ‚ä»‹ç»ã€‚</p><h1 id="çº¿ç¨‹é—´é€šä¿¡"><a href="#çº¿ç¨‹é—´é€šä¿¡" class="headerlink" title="çº¿ç¨‹é—´é€šä¿¡"></a>çº¿ç¨‹é—´é€šä¿¡</h1><p>ä»ä¸€ä¸ªçº¿ç¨‹å‘å¦ä¸€ä¸ªçº¿ç¨‹å‘é€æ•°æ®æœ€å®‰å…¨çš„æ–¹å¼å¯èƒ½å°±æ˜¯ä½¿ç”¨ <code>queue</code>â€‹ åº“ä¸­çš„é˜Ÿåˆ—äº†ã€‚åˆ›å»ºä¸€ä¸ªè¢«å¤šä¸ªçº¿ç¨‹å…±äº«çš„ <code>Queue</code>â€‹ å¯¹è±¡ï¼Œè¿™äº›çº¿ç¨‹é€šè¿‡ä½¿ç”¨ <code>put()</code>â€‹ å’Œ <code>get()</code>â€‹ æ“ä½œæ¥å‘é˜Ÿåˆ—ä¸­æ·»åŠ æˆ–è€…åˆ é™¤å…ƒç´ ã€‚ ä¾‹å¦‚ï¼š</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> queue <span class="keyword">import</span> Queue</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"></span><br><span class="line"><span class="comment"># A thread that produces data</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">producer</span>(<span class="params">out_q</span>):</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="comment"># Produce some data</span></span><br><span class="line">        ...</span><br><span class="line">        out_q.put(data)</span><br><span class="line"></span><br><span class="line"><span class="comment"># A thread that consumes data</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">consumer</span>(<span class="params">in_q</span>):</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line"><span class="comment"># Get some data</span></span><br><span class="line">        data = in_q.get()</span><br><span class="line">        <span class="comment"># Process the data</span></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create the shared queue and launch both threads</span></span><br><span class="line">q = Queue()</span><br><span class="line">t1 = Thread(target=consumer, args=(q,))</span><br><span class="line">t2 = Thread(target=producer, args=(q,))</span><br><span class="line">t1.start()</span><br><span class="line">t2.start()</span><br></pre></td></tr></table></figure><p><code>Queue</code>â€‹ å¯¹è±¡å·²ç»åŒ…å«äº†å¿…è¦çš„é”ï¼Œæ‰€ä»¥ä½ å¯ä»¥é€šè¿‡å®ƒåœ¨å¤šä¸ªçº¿ç¨‹é—´å¤šå®‰å…¨åœ°å…±äº«æ•°æ®ã€‚ å½“ä½¿ç”¨é˜Ÿåˆ—æ—¶ï¼Œåè°ƒç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„å…³é—­é—®é¢˜å¯èƒ½ä¼šæœ‰ä¸€äº›éº»çƒ¦ã€‚ä¸€ä¸ªé€šç”¨çš„è§£å†³æ–¹æ³•æ˜¯åœ¨é˜Ÿåˆ—ä¸­æ”¾ç½®ä¸€ä¸ªç‰¹æ®Šçš„å€¼ï¼Œå½“æ¶ˆè´¹è€…è¯»åˆ°è¿™ä¸ªå€¼çš„æ—¶å€™ï¼Œç»ˆæ­¢æ‰§è¡Œã€‚</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> queue <span class="keyword">import</span> Queue</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"></span><br><span class="line"><span class="comment"># Object that signals shutdown</span></span><br><span class="line">_sentinel = <span class="built_in">object</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># A thread that produces data</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">producer</span>(<span class="params">out_q</span>):</span><br><span class="line">    <span class="keyword">while</span> running:</span><br><span class="line">        <span class="comment"># Produce some data</span></span><br><span class="line">        ...</span><br><span class="line">        out_q.put(data)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Put the sentinel on the queue to indicate completion</span></span><br><span class="line">    out_q.put(_sentinel)</span><br><span class="line"></span><br><span class="line"><span class="comment"># A thread that consumes data</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">consumer</span>(<span class="params">in_q</span>):</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="comment"># Get some data</span></span><br><span class="line">        data = in_q.get()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Check for termination</span></span><br><span class="line">        <span class="keyword">if</span> data <span class="keyword">is</span> _sentinel:</span><br><span class="line">            in_q.put(_sentinel)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Process the data</span></span><br><span class="line">        ...</span><br></pre></td></tr></table></figure><p>æœ¬ä¾‹ä¸­æœ‰ä¸€ä¸ªç‰¹æ®Šçš„åœ°æ–¹ï¼šæ¶ˆè´¹è€…åœ¨è¯»åˆ°è¿™ä¸ªç‰¹æ®Šå€¼ä¹‹åç«‹å³åˆæŠŠå®ƒæ”¾å›åˆ°é˜Ÿåˆ—ä¸­ï¼Œå°†ä¹‹ä¼ é€’ä¸‹å»ã€‚è¿™æ ·ï¼Œæ‰€æœ‰ç›‘å¬è¿™ä¸ªé˜Ÿåˆ—çš„æ¶ˆè´¹è€…çº¿ç¨‹å°±å¯ä»¥å…¨éƒ¨å…³é—­äº†ã€‚ å°½ç®¡é˜Ÿåˆ—æ˜¯æœ€å¸¸è§çš„çº¿ç¨‹é—´é€šä¿¡æœºåˆ¶ï¼Œä½†æ˜¯ä»ç„¶å¯ä»¥è‡ªå·±é€šè¿‡åˆ›å»ºè‡ªå·±çš„æ•°æ®ç»“æ„å¹¶æ·»åŠ æ‰€éœ€çš„é”å’ŒåŒæ­¥æœºåˆ¶æ¥å®ç°çº¿ç¨‹é—´é€šä¿¡ã€‚æœ€å¸¸è§çš„æ–¹æ³•æ˜¯ä½¿ç”¨ <code>Condition</code>â€‹ å˜é‡æ¥åŒ…è£…ä½ çš„æ•°æ®ç»“æ„ã€‚ä¸‹è¾¹è¿™ä¸ªä¾‹å­æ¼”ç¤ºäº†å¦‚ä½•åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œå¦‚åŒ1.5èŠ‚ä¸­ä»‹ç»çš„é‚£æ ·ã€‚</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> heapq</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PriorityQueue</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self._queue = []</span><br><span class="line">        self._count = <span class="number">0</span></span><br><span class="line">        self._cv = threading.Condition()</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">put</span>(<span class="params">self, item, priority</span>):</span><br><span class="line">        <span class="keyword">with</span> self._cv:</span><br><span class="line">            heapq.heappush(self._queue, (-priority, self._count, item))</span><br><span class="line">            self._count += <span class="number">1</span></span><br><span class="line">            self._cv.notify()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">with</span> self._cv:</span><br><span class="line">            <span class="keyword">while</span> <span class="built_in">len</span>(self._queue) == <span class="number">0</span>:</span><br><span class="line">                self._cv.wait()</span><br><span class="line">            <span class="keyword">return</span> heapq.heappop(self._queue)[-<span class="number">1</span>]</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨é˜Ÿåˆ—æ¥è¿›è¡Œçº¿ç¨‹é—´é€šä¿¡æ˜¯ä¸€ä¸ªå•å‘ã€ä¸ç¡®å®šçš„è¿‡ç¨‹ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œä½ æ²¡æœ‰åŠæ³•çŸ¥é“æ¥æ”¶æ•°æ®çš„çº¿ç¨‹æ˜¯ä»€ä¹ˆæ—¶å€™æ¥æ”¶åˆ°çš„æ•°æ®å¹¶å¼€å§‹å·¥ä½œçš„ã€‚ä¸è¿‡é˜Ÿåˆ—å¯¹è±¡æä¾›ä¸€äº›åŸºæœ¬å®Œæˆçš„ç‰¹æ€§ï¼Œæ¯”å¦‚ä¸‹è¾¹è¿™ä¸ªä¾‹å­ä¸­çš„ <code>**task_done()**</code> â€‹ å’Œ <code>**join()**</code> â€‹ ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from queue import Queue</span><br><span class="line">from threading import Thread</span><br><span class="line"></span><br><span class="line"># A thread that produces data</span><br><span class="line">def producer(out_q):</span><br><span class="line">    while running:</span><br><span class="line">        # Produce some data</span><br><span class="line">        ...</span><br><span class="line">        out_q.put(data)</span><br><span class="line"></span><br><span class="line"># A thread that consumes data</span><br><span class="line">def consumer(in_q):</span><br><span class="line">    while True:</span><br><span class="line">        # Get some data</span><br><span class="line">        data = in_q.get()</span><br><span class="line"></span><br><span class="line">        # Process the data</span><br><span class="line">        ...</span><br><span class="line">        # Indicate completion</span><br><span class="line">        in_q.task_done()</span><br><span class="line"></span><br><span class="line"># Create the shared queue and launch both threads</span><br><span class="line">q = Queue()</span><br><span class="line">t1 = Thread(target=consumer, args=(q,))</span><br><span class="line">t2 = Thread(target=producer, args=(q,))</span><br><span class="line">t1.start()</span><br><span class="line">t2.start()</span><br><span class="line"></span><br><span class="line"># Wait for all produced items to be consumed</span><br><span class="line">q.join()</span><br></pre></td></tr></table></figure><p>å¦‚æœä¸€ä¸ªçº¿ç¨‹éœ€è¦åœ¨ä¸€ä¸ªâ€œæ¶ˆè´¹è€…â€çº¿ç¨‹å¤„ç†å®Œç‰¹å®šçš„æ•°æ®é¡¹æ—¶ç«‹å³å¾—åˆ°é€šçŸ¥ï¼Œä½ å¯ä»¥æŠŠè¦å‘é€çš„æ•°æ®å’Œä¸€ä¸ª <code>Event</code>â€‹ æ”¾åˆ°ä¸€èµ·ä½¿ç”¨ï¼Œè¿™æ ·â€œç”Ÿäº§è€…â€å°±å¯ä»¥é€šè¿‡è¿™ä¸ªEventå¯¹è±¡æ¥ç›‘æµ‹å¤„ç†çš„è¿‡ç¨‹äº†ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from queue import Queue</span><br><span class="line">from threading import Thread, Event</span><br><span class="line"></span><br><span class="line"># A thread that produces data</span><br><span class="line">def producer(out_q):</span><br><span class="line">    while running:</span><br><span class="line">        # Produce some data</span><br><span class="line">        ...</span><br><span class="line">        # Make an (data, event) pair and hand it to the consumer</span><br><span class="line">        evt = Event()</span><br><span class="line">        out_q.put((data, evt))</span><br><span class="line">        ...</span><br><span class="line">        # Wait for the consumer to process the item</span><br><span class="line">        evt.wait()</span><br><span class="line"></span><br><span class="line"># A thread that consumes data</span><br><span class="line">def consumer(in_q):</span><br><span class="line">    while True:</span><br><span class="line">        # Get some data</span><br><span class="line">        data, evt = in_q.get()</span><br><span class="line">        # Process the data</span><br><span class="line">        ...</span><br><span class="line">        # Indicate completion</span><br><span class="line">        evt.set()</span><br></pre></td></tr></table></figure><h2 id="è®¨è®º-2"><a href="#è®¨è®º-2" class="headerlink" title="è®¨è®º"></a>è®¨è®º</h2><p>åŸºäºç®€å•é˜Ÿåˆ—ç¼–å†™å¤šçº¿ç¨‹ç¨‹åºåœ¨å¤šæ•°æƒ…å†µä¸‹æ˜¯ä¸€ä¸ªæ¯”è¾ƒæ˜æ™ºçš„é€‰æ‹©ã€‚ä»çº¿ç¨‹å®‰å…¨é˜Ÿåˆ—çš„åº•å±‚å®ç°æ¥çœ‹ï¼Œä½ æ— éœ€åœ¨ä½ çš„ä»£ç ä¸­ä½¿ç”¨é”å’Œå…¶ä»–åº•å±‚çš„åŒæ­¥æœºåˆ¶ï¼Œè¿™äº›åªä¼šæŠŠä½ çš„ç¨‹åºå¼„å¾—ä¹±ä¸ƒå…«ç³Ÿã€‚æ­¤å¤–ï¼Œä½¿ç”¨é˜Ÿåˆ—è¿™ç§åŸºäºæ¶ˆæ¯çš„é€šä¿¡æœºåˆ¶å¯ä»¥è¢«æ‰©å±•åˆ°æ›´å¤§çš„åº”ç”¨èŒƒç•´ï¼Œæ¯”å¦‚ï¼Œä½ å¯ä»¥æŠŠä½ çš„ç¨‹åºæ”¾å…¥å¤šä¸ªè¿›ç¨‹ç”šè‡³æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿè€Œæ— éœ€æ”¹å˜åº•å±‚çš„é˜Ÿåˆ—ç»“æ„ã€‚ ä½¿ç”¨çº¿ç¨‹é˜Ÿåˆ—æœ‰ä¸€ä¸ªè¦æ³¨æ„çš„é—®é¢˜æ˜¯ï¼Œå‘é˜Ÿåˆ—ä¸­æ·»åŠ æ•°æ®é¡¹æ—¶å¹¶ä¸ä¼šå¤åˆ¶æ­¤æ•°æ®é¡¹ï¼Œçº¿ç¨‹é—´é€šä¿¡å®é™…ä¸Šæ˜¯åœ¨çº¿ç¨‹é—´ä¼ é€’å¯¹è±¡å¼•ç”¨ã€‚å¦‚æœä½ æ‹…å¿ƒå¯¹è±¡çš„å…±äº«çŠ¶æ€ï¼Œé‚£ä½ æœ€å¥½åªä¼ é€’ä¸å¯ä¿®æ”¹çš„æ•°æ®ç»“æ„ï¼ˆå¦‚ï¼šæ•´å‹ã€å­—ç¬¦ä¸²æˆ–è€…å…ƒç»„ï¼‰æˆ–è€…ä¸€ä¸ªå¯¹è±¡çš„æ·±æ‹·è´ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from queue import Queue</span><br><span class="line">from threading import Thread</span><br><span class="line">import copy</span><br><span class="line"></span><br><span class="line"># A thread that produces data</span><br><span class="line">def producer(out_q):</span><br><span class="line">    while True:</span><br><span class="line">        # Produce some data</span><br><span class="line">        ...</span><br><span class="line">        out_q.put(copy.deepcopy(data))</span><br><span class="line"></span><br><span class="line"># A thread that consumes data</span><br><span class="line">def consumer(in_q):</span><br><span class="line">    while True:</span><br><span class="line">        # Get some data</span><br><span class="line">        data = in_q.get()</span><br><span class="line">        # Process the data</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure><p><code>Queue</code>â€‹ å¯¹è±¡æä¾›ä¸€äº›åœ¨å½“å‰ä¸Šä¸‹æ–‡å¾ˆæœ‰ç”¨çš„é™„åŠ ç‰¹æ€§ã€‚æ¯”å¦‚åœ¨åˆ›å»º Queue å¯¹è±¡æ—¶æä¾›å¯é€‰çš„ <code>size</code>â€‹ å‚æ•°æ¥é™åˆ¶å¯ä»¥æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­çš„å…ƒç´ æ•°é‡ã€‚å¯¹äºâ€œç”Ÿäº§è€…â€ä¸â€œæ¶ˆè´¹è€…â€é€Ÿåº¦æœ‰å·®å¼‚çš„æƒ…å†µï¼Œä¸ºé˜Ÿåˆ—ä¸­çš„å…ƒç´ æ•°é‡æ·»åŠ ä¸Šé™æ˜¯æœ‰æ„ä¹‰çš„ã€‚æ¯”å¦‚ï¼Œä¸€ä¸ªâ€œç”Ÿäº§è€…â€äº§ç”Ÿé¡¹ç›®çš„é€Ÿåº¦æ¯”â€œæ¶ˆè´¹è€…â€ â€œæ¶ˆè´¹â€çš„é€Ÿåº¦å¿«ï¼Œé‚£ä¹ˆä½¿ç”¨å›ºå®šå¤§å°çš„é˜Ÿåˆ—å°±å¯ä»¥åœ¨é˜Ÿåˆ—å·²æ»¡çš„æ—¶å€™é˜»å¡é˜Ÿåˆ—ï¼Œä»¥å…æœªé¢„æœŸçš„è¿é”æ•ˆåº”æ‰©æ•£æ•´ä¸ªç¨‹åºé€ æˆæ­»é”æˆ–è€…ç¨‹åºè¿è¡Œå¤±å¸¸ã€‚åœ¨é€šä¿¡çš„çº¿ç¨‹ä¹‹é—´è¿›è¡Œâ€œæµé‡æ§åˆ¶â€æ˜¯ä¸€ä¸ªçœ‹èµ·æ¥å®¹æ˜“å®ç°èµ·æ¥å›°éš¾çš„é—®é¢˜ã€‚å¦‚æœä½ å‘ç°è‡ªå·±æ›¾ç»è¯•å›¾é€šè¿‡æ‘†å¼„é˜Ÿåˆ—å¤§å°æ¥è§£å†³ä¸€ä¸ªé—®é¢˜ï¼Œè¿™ä¹Ÿè®¸å°±æ ‡å¿—ç€ä½ çš„ç¨‹åºå¯èƒ½å­˜åœ¨è„†å¼±è®¾è®¡æˆ–è€…å›ºæœ‰çš„å¯ä¼¸ç¼©é—®é¢˜ã€‚ <code>get()</code>â€‹ å’Œ <code>put()</code>â€‹ æ–¹æ³•éƒ½æ”¯æŒéé˜»å¡æ–¹å¼å’Œè®¾å®šè¶…æ—¶ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import queue</span><br><span class="line">q = queue.Queue()</span><br><span class="line"></span><br><span class="line">try:</span><br><span class="line">    data = q.get(block=False)</span><br><span class="line">except queue.Empty:</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">try:</span><br><span class="line">    q.put(item, block=False)</span><br><span class="line">except queue.Full:</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">try:</span><br><span class="line">    data = q.get(timeout=5.0)</span><br><span class="line">except queue.Empty:</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p>è¿™äº›æ“ä½œéƒ½å¯ä»¥ç”¨æ¥é¿å…å½“æ‰§è¡ŒæŸäº›ç‰¹å®šé˜Ÿåˆ—æ“ä½œæ—¶å‘ç”Ÿæ— é™é˜»å¡çš„æƒ…å†µï¼Œæ¯”å¦‚ï¼Œä¸€ä¸ªéé˜»å¡çš„ <code>put()</code>â€‹ æ–¹æ³•å’Œä¸€ä¸ªå›ºå®šå¤§å°çš„é˜Ÿåˆ—ä¸€èµ·ä½¿ç”¨ï¼Œè¿™æ ·å½“é˜Ÿåˆ—å·²æ»¡æ—¶å°±å¯ä»¥æ‰§è¡Œä¸åŒçš„ä»£ç ã€‚æ¯”å¦‚è¾“å‡ºä¸€æ¡æ—¥å¿—ä¿¡æ¯å¹¶ä¸¢å¼ƒã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">def producer(q):</span><br><span class="line">    ...</span><br><span class="line">    try:</span><br><span class="line">        q.put(item, block=False)</span><br><span class="line">    except queue.Full:</span><br><span class="line">        log.warning(&#x27;queued item %r discarded!&#x27;, item)</span><br></pre></td></tr></table></figure><p>å¦‚æœä½ è¯•å›¾è®©æ¶ˆè´¹è€…çº¿ç¨‹åœ¨æ‰§è¡Œåƒ <code>q.get()</code>â€‹ è¿™æ ·çš„æ“ä½œæ—¶ï¼Œè¶…æ—¶è‡ªåŠ¨ç»ˆæ­¢ä»¥ä¾¿æ£€æŸ¥ç»ˆæ­¢æ ‡å¿—ï¼Œä½ åº”è¯¥ä½¿ç”¨ <code>q.get()</code>â€‹ çš„å¯é€‰å‚æ•° <code>timeout</code>â€‹ ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">_running = True</span><br><span class="line"></span><br><span class="line">def consumer(q):</span><br><span class="line">    while _running:</span><br><span class="line">        try:</span><br><span class="line">            item = q.get(timeout=5.0)</span><br><span class="line">            # Process item</span><br><span class="line">            ...</span><br><span class="line">        except queue.Empty:</span><br><span class="line">            pass</span><br></pre></td></tr></table></figure><p>æœ€åï¼Œæœ‰ <code>q.qsize()</code>â€‹ ï¼Œ <code>q.full()</code>â€‹ ï¼Œ <code>q.empty()</code>â€‹ ç­‰å®ç”¨æ–¹æ³•å¯ä»¥è·å–ä¸€ä¸ªé˜Ÿåˆ—çš„å½“å‰å¤§å°å’ŒçŠ¶æ€ã€‚ä½†è¦æ³¨æ„ï¼Œè¿™äº›æ–¹æ³•éƒ½ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚å¯èƒ½ä½ å¯¹ä¸€ä¸ªé˜Ÿåˆ—ä½¿ç”¨ <code>empty()</code>â€‹ åˆ¤æ–­å‡ºè¿™ä¸ªé˜Ÿåˆ—ä¸ºç©ºï¼Œä½†åŒæ—¶å¦å¤–ä¸€ä¸ªçº¿ç¨‹å¯èƒ½å·²ç»å‘è¿™ä¸ªé˜Ÿåˆ—ä¸­æ’å…¥ä¸€ä¸ªæ•°æ®é¡¹ã€‚æ‰€ä»¥ï¼Œä½ æœ€å¥½ä¸è¦åœ¨ä½ çš„ä»£ç ä¸­ä½¿ç”¨è¿™äº›æ–¹æ³•ã€‚</p><h1 id="åŠ é”"><a href="#åŠ é”" class="headerlink" title="åŠ é”"></a>åŠ é”</h1><p>è¦åœ¨å¤šçº¿ç¨‹ç¨‹åºä¸­å®‰å…¨ä½¿ç”¨å¯å˜å¯¹è±¡ï¼Œä½ éœ€è¦ä½¿ç”¨ threading åº“ä¸­çš„ <code>&lt;span class=&quot;pre&quot;&gt;Lock&lt;/span&gt;</code>â€‹ å¯¹è±¡ï¼Œå°±åƒä¸‹è¾¹è¿™ä¸ªä¾‹å­è¿™æ ·ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import threading</span><br><span class="line"></span><br><span class="line">class SharedCounter:</span><br><span class="line">    &#x27;&#x27;&#x27;</span><br><span class="line">    A counter object that can be shared by multiple threads.</span><br><span class="line">    &#x27;&#x27;&#x27;</span><br><span class="line">    def __init__(self, initial_value = 0):</span><br><span class="line">        self._value = initial_value</span><br><span class="line">        self._value_lock = threading.Lock()</span><br><span class="line"></span><br><span class="line">    def incr(self,delta=1):</span><br><span class="line">        &#x27;&#x27;&#x27;</span><br><span class="line">        Increment the counter with locking</span><br><span class="line">        &#x27;&#x27;&#x27;</span><br><span class="line">        with self._value_lock:</span><br><span class="line">             self._value += delta</span><br><span class="line"></span><br><span class="line">    def decr(self,delta=1):</span><br><span class="line">        &#x27;&#x27;&#x27;</span><br><span class="line">        Decrement the counter with locking</span><br><span class="line">        &#x27;&#x27;&#x27;</span><br><span class="line">        with self._value_lock:</span><br><span class="line">             self._value -= delta</span><br></pre></td></tr></table></figure><p><code>&lt;span class=&quot;pre&quot;&gt;Lock&lt;/span&gt;</code>â€‹ å¯¹è±¡å’Œ <code>&lt;span class=&quot;pre&quot;&gt;with&lt;/span&gt;</code>â€‹ è¯­å¥å—ä¸€èµ·ä½¿ç”¨å¯ä»¥ä¿è¯äº’æ–¥æ‰§è¡Œï¼Œå°±æ˜¯æ¯æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æ‰§è¡Œ with è¯­å¥åŒ…å«çš„ä»£ç å—ã€‚with è¯­å¥ä¼šåœ¨è¿™ä¸ªä»£ç å—æ‰§è¡Œå‰è‡ªåŠ¨è·å–é”ï¼Œåœ¨æ‰§è¡Œç»“æŸåè‡ªåŠ¨é‡Šæ”¾é”ã€‚</p><h2 id="è®¨è®º-3"><a href="#è®¨è®º-3" class="headerlink" title="è®¨è®º"></a>è®¨è®º</h2><p>çº¿ç¨‹è°ƒåº¦æœ¬è´¨ä¸Šæ˜¯ä¸ç¡®å®šçš„ï¼Œå› æ­¤ï¼Œåœ¨å¤šçº¿ç¨‹ç¨‹åºä¸­é”™è¯¯åœ°ä½¿ç”¨é”æœºåˆ¶å¯èƒ½ä¼šå¯¼è‡´éšæœºæ•°æ®æŸåæˆ–è€…å…¶ä»–çš„å¼‚å¸¸è¡Œä¸ºï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºç«äº‰æ¡ä»¶ã€‚ä¸ºäº†é¿å…ç«äº‰æ¡ä»¶ï¼Œæœ€å¥½åªåœ¨ä¸´ç•ŒåŒºï¼ˆå¯¹ä¸´ç•Œèµ„æºè¿›è¡Œæ“ä½œçš„é‚£éƒ¨åˆ†ä»£ç ï¼‰ä½¿ç”¨é”ã€‚ åœ¨ä¸€äº›â€œè€çš„â€ Python ä»£ç ä¸­ï¼Œæ˜¾å¼è·å–å’Œé‡Šæ”¾é”æ˜¯å¾ˆå¸¸è§çš„ã€‚ä¸‹è¾¹æ˜¯ä¸€ä¸ªä¸Šä¸€ä¸ªä¾‹å­çš„å˜ç§ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import threading</span><br><span class="line"></span><br><span class="line">class SharedCounter:</span><br><span class="line">    &#x27;&#x27;&#x27;</span><br><span class="line">    A counter object that can be shared by multiple threads.</span><br><span class="line">    &#x27;&#x27;&#x27;</span><br><span class="line">    def __init__(self, initial_value = 0):</span><br><span class="line">        self._value = initial_value</span><br><span class="line">        self._value_lock = threading.Lock()</span><br><span class="line"></span><br><span class="line">    def incr(self,delta=1):</span><br><span class="line">        &#x27;&#x27;&#x27;</span><br><span class="line">        Increment the counter with locking</span><br><span class="line">        &#x27;&#x27;&#x27;</span><br><span class="line">        self._value_lock.acquire()</span><br><span class="line">        self._value += delta</span><br><span class="line">        self._value_lock.release()</span><br><span class="line"></span><br><span class="line">    def decr(self,delta=1):</span><br><span class="line">        &#x27;&#x27;&#x27;</span><br><span class="line">        Decrement the counter with locking</span><br><span class="line">        &#x27;&#x27;&#x27;</span><br><span class="line">        self._value_lock.acquire()</span><br><span class="line">        self._value -= delta</span><br><span class="line">        self._value_lock.release()</span><br></pre></td></tr></table></figure><p><strong>ç›¸æ¯”äºè¿™ç§æ˜¾å¼è°ƒç”¨çš„æ–¹æ³•ï¼Œwith è¯­å¥æ›´åŠ ä¼˜é›…ï¼Œä¹Ÿæ›´ä¸å®¹æ˜“å‡ºé”™</strong>ï¼Œç‰¹åˆ«æ˜¯ç¨‹åºå‘˜å¯èƒ½ä¼šå¿˜è®°è°ƒç”¨ release() æ–¹æ³•æˆ–è€…ç¨‹åºåœ¨è·å¾—é”ä¹‹åäº§ç”Ÿå¼‚å¸¸è¿™ä¸¤ç§æƒ…å†µï¼ˆä½¿ç”¨ with è¯­å¥å¯ä»¥ä¿è¯åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹ä»èƒ½æ­£ç¡®é‡Šæ”¾é”ï¼‰ã€‚ ä¸ºäº†é¿å…å‡ºç°æ­»é”çš„æƒ…å†µï¼Œä½¿ç”¨é”æœºåˆ¶çš„ç¨‹åºåº”è¯¥è®¾å®šä¸ºæ¯ä¸ªçº¿ç¨‹ä¸€æ¬¡åªå…è®¸è·å–ä¸€ä¸ªé”ã€‚å¦‚æœä¸èƒ½è¿™æ ·åšçš„è¯ï¼Œä½ å°±éœ€è¦æ›´é«˜çº§çš„æ­»é”é¿å…æœºåˆ¶ï¼Œæˆ‘ä»¬å°†åœ¨12.5èŠ‚ä»‹ç»ã€‚ åœ¨ <code>threading</code>â€‹ åº“ä¸­è¿˜æä¾›äº†å…¶ä»–çš„åŒæ­¥åŸè¯­ï¼Œæ¯”å¦‚ <code>RLock</code>â€‹ å’Œ <code>Semaphore</code>â€‹ å¯¹è±¡ã€‚ä½†æ˜¯æ ¹æ®ä»¥å¾€ç»éªŒï¼Œè¿™äº›åŸè¯­æ˜¯ç”¨äºä¸€äº›ç‰¹æ®Šçš„æƒ…å†µï¼Œå¦‚æœä½ åªæ˜¯éœ€è¦ç®€å•åœ°å¯¹å¯å˜å¯¹è±¡è¿›è¡Œé”å®šï¼Œé‚£å°±ä¸åº”è¯¥ä½¿ç”¨å®ƒä»¬ã€‚ä¸€ä¸ª <code>RLock</code>â€‹ ï¼ˆå¯é‡å…¥é”ï¼‰å¯ä»¥è¢«åŒä¸€ä¸ªçº¿ç¨‹å¤šæ¬¡è·å–ï¼Œä¸»è¦ç”¨æ¥å®ç°åŸºäºç›‘æµ‹å¯¹è±¡æ¨¡å¼çš„é”å®šå’ŒåŒæ­¥ã€‚åœ¨ä½¿ç”¨è¿™ç§é”çš„æƒ…å†µä¸‹ï¼Œå½“é”è¢«æŒæœ‰æ—¶ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥ä½¿ç”¨å®Œæ•´çš„å‡½æ•°æˆ–è€…ç±»ä¸­çš„æ–¹æ³•ã€‚æ¯”å¦‚ï¼Œä½ å¯ä»¥å®ç°ä¸€ä¸ªè¿™æ ·çš„ SharedCounter ç±»ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import threading</span><br><span class="line"></span><br><span class="line">class SharedCounter:</span><br><span class="line">    &#x27;&#x27;&#x27;</span><br><span class="line">    A counter object that can be shared by multiple threads.</span><br><span class="line">    &#x27;&#x27;&#x27;</span><br><span class="line">    _lock = threading.RLock()</span><br><span class="line">    def __init__(self, initial_value = 0):</span><br><span class="line">        self._value = initial_value</span><br><span class="line"></span><br><span class="line">    def incr(self,delta=1):</span><br><span class="line">        &#x27;&#x27;&#x27;</span><br><span class="line">        Increment the counter with locking</span><br><span class="line">        &#x27;&#x27;&#x27;</span><br><span class="line">        with SharedCounter._lock:</span><br><span class="line">            self._value += delta</span><br><span class="line"></span><br><span class="line">    def decr(self,delta=1):</span><br><span class="line">        &#x27;&#x27;&#x27;</span><br><span class="line">        Decrement the counter with locking</span><br><span class="line">        &#x27;&#x27;&#x27;</span><br><span class="line">        with SharedCounter._lock:</span><br><span class="line">             self.incr(-delta)</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šè¾¹è¿™ä¸ªä¾‹å­ä¸­ï¼Œæ²¡æœ‰å¯¹æ¯ä¸€ä¸ªå®ä¾‹ä¸­çš„å¯å˜å¯¹è±¡åŠ é”ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ä¸€ä¸ªè¢«æ‰€æœ‰å®ä¾‹å…±äº«çš„ç±»çº§é”ã€‚è¿™ä¸ªé”ç”¨æ¥åŒæ­¥ç±»æ–¹æ³•ï¼Œå…·ä½“æ¥è¯´å°±æ˜¯ï¼Œè¿™ä¸ªé”å¯ä»¥ä¿è¯ä¸€æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è°ƒç”¨è¿™ä¸ªç±»æ–¹æ³•ã€‚ä¸è¿‡ï¼Œä¸ä¸€ä¸ªæ ‡å‡†çš„é”ä¸åŒçš„æ˜¯ï¼Œå·²ç»æŒæœ‰è¿™ä¸ªé”çš„æ–¹æ³•åœ¨è°ƒç”¨åŒæ ·ä½¿ç”¨è¿™ä¸ªé”çš„æ–¹æ³•æ—¶ï¼Œæ— éœ€å†æ¬¡è·å–é”ã€‚æ¯”å¦‚ decr æ–¹æ³•ã€‚ è¿™ç§å®ç°æ–¹å¼çš„ä¸€ä¸ªç‰¹ç‚¹æ˜¯ï¼Œæ— è®ºè¿™ä¸ªç±»æœ‰å¤šå°‘ä¸ªå®ä¾‹éƒ½åªç”¨ä¸€ä¸ªé”ã€‚å› æ­¤åœ¨éœ€è¦å¤§é‡ä½¿ç”¨è®¡æ•°å™¨çš„æƒ…å†µä¸‹å†…å­˜æ•ˆç‡æ›´é«˜ã€‚ä¸è¿‡è¿™æ ·åšä¹Ÿæœ‰ç¼ºç‚¹ï¼Œå°±æ˜¯åœ¨ç¨‹åºä¸­ä½¿ç”¨å¤§é‡çº¿ç¨‹å¹¶é¢‘ç¹æ›´æ–°è®¡æ•°å™¨æ—¶ä¼šæœ‰äº‰ç”¨é”çš„é—®é¢˜ã€‚ ä¿¡å·é‡å¯¹è±¡æ˜¯ä¸€ä¸ªå»ºç«‹åœ¨å…±äº«è®¡æ•°å™¨åŸºç¡€ä¸Šçš„åŒæ­¥åŸè¯­ã€‚å¦‚æœè®¡æ•°å™¨ä¸ä¸º0ï¼Œwith è¯­å¥å°†è®¡æ•°å™¨å‡1ï¼Œçº¿ç¨‹è¢«å…è®¸æ‰§è¡Œã€‚with è¯­å¥æ‰§è¡Œç»“æŸåï¼Œè®¡æ•°å™¨åŠ ï¼‘ã€‚å¦‚æœè®¡æ•°å™¨ä¸º0ï¼Œçº¿ç¨‹å°†è¢«é˜»å¡ï¼Œç›´åˆ°å…¶ä»–çº¿ç¨‹ç»“æŸå°†è®¡æ•°å™¨åŠ 1ã€‚å°½ç®¡ä½ å¯ä»¥åœ¨ç¨‹åºä¸­åƒæ ‡å‡†é”ä¸€æ ·ä½¿ç”¨ä¿¡å·é‡æ¥åšçº¿ç¨‹åŒæ­¥ï¼Œä½†æ˜¯è¿™ç§æ–¹å¼å¹¶ä¸è¢«æ¨èï¼Œ<strong>å› ä¸ºä½¿ç”¨ä¿¡å·é‡ä¸ºç¨‹åºå¢åŠ çš„å¤æ‚æ€§ä¼šå½±å“ç¨‹åºæ€§èƒ½ã€‚</strong> ç›¸å¯¹äºç®€å•åœ°ä½œä¸ºé”ä½¿ç”¨ï¼Œä¿¡å·é‡æ›´é€‚ç”¨äºé‚£äº›éœ€è¦åœ¨çº¿ç¨‹ä¹‹é—´å¼•å…¥ä¿¡å·æˆ–è€…é™åˆ¶çš„ç¨‹åºã€‚æ¯”å¦‚ï¼Œä½ éœ€è¦é™åˆ¶ä¸€æ®µä»£ç çš„å¹¶å‘è®¿é—®é‡ï¼Œä½ å°±å¯ä»¥åƒä¸‹é¢è¿™æ ·ä½¿ç”¨ä¿¡å·é‡å®Œæˆï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from threading import Semaphore</span><br><span class="line">import urllib.request</span><br><span class="line"></span><br><span class="line"># At most, five threads allowed to run at once</span><br><span class="line">_fetch_url_sema = Semaphore(5)</span><br><span class="line"></span><br><span class="line">def fetch_url(url):</span><br><span class="line">    with _fetch_url_sema:</span><br><span class="line">        return urllib.request.urlopen(url)</span><br></pre></td></tr></table></figure><p>å¦‚æœä½ å¯¹çº¿ç¨‹åŒæ­¥åŸè¯­çš„åº•å±‚ç†è®ºå’Œå®ç°æ„Ÿå…´è¶£ï¼Œå¯ä»¥å‚è€ƒæ“ä½œç³»ç»Ÿç›¸å…³ä¹¦ç±ï¼Œç»å¤§å¤šæ•°éƒ½æœ‰æåŠã€‚</p><h1 id="é˜²æ­¢æ­»é”çš„åŠ é”æœºåˆ¶"><a href="#é˜²æ­¢æ­»é”çš„åŠ é”æœºåˆ¶" class="headerlink" title="é˜²æ­¢æ­»é”çš„åŠ é”æœºåˆ¶"></a>é˜²æ­¢æ­»é”çš„åŠ é”æœºåˆ¶</h1><p>ï¼ˆè¿™ä¸€ç« èŠ‚æˆ‘æ²¡çœ‹ï¼‰</p><p>åœ¨å¤šçº¿ç¨‹ç¨‹åºä¸­ï¼Œæ­»é”é—®é¢˜å¾ˆå¤§ä¸€éƒ¨åˆ†æ˜¯ç”±äºçº¿ç¨‹åŒæ—¶è·å–å¤šä¸ªé”é€ æˆçš„ã€‚ä¸¾ä¸ªä¾‹å­ï¼šä¸€ä¸ªçº¿ç¨‹è·å–äº†ç¬¬ä¸€ä¸ªé”ï¼Œç„¶ååœ¨è·å–ç¬¬äºŒä¸ªé”çš„ æ—¶å€™å‘ç”Ÿé˜»å¡ï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹å°±å¯èƒ½é˜»å¡å…¶ä»–çº¿ç¨‹çš„æ‰§è¡Œï¼Œä»è€Œå¯¼è‡´æ•´ä¸ªç¨‹åºå‡æ­»ã€‚ è§£å†³æ­»é”é—®é¢˜çš„ä¸€ç§æ–¹æ¡ˆæ˜¯ä¸ºç¨‹åºä¸­çš„æ¯ä¸€ä¸ªé”åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„idï¼Œç„¶ååªå…è®¸æŒ‰ç…§å‡åºè§„åˆ™æ¥ä½¿ç”¨å¤šä¸ªé”ï¼Œè¿™ä¸ªè§„åˆ™ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨ æ˜¯éå¸¸å®¹æ˜“å®ç°çš„ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import threading</span><br><span class="line">from contextlib import contextmanager</span><br><span class="line"></span><br><span class="line"># Thread-local state to stored information on locks already acquired</span><br><span class="line">_local = threading.local()</span><br><span class="line"></span><br><span class="line">@contextmanager</span><br><span class="line">def acquire(*locks):</span><br><span class="line">    # Sort locks by object identifier</span><br><span class="line">    locks = sorted(locks, key=lambda x: id(x))</span><br><span class="line"></span><br><span class="line">    # Make sure lock order of previously acquired locks is not violated</span><br><span class="line">    acquired = getattr(_local,&#x27;acquired&#x27;,[])</span><br><span class="line">    if acquired and max(id(lock) for lock in acquired) &gt;= id(locks[0]):</span><br><span class="line">        raise RuntimeError(&#x27;Lock Order Violation&#x27;)</span><br><span class="line"></span><br><span class="line">    # Acquire all of the locks</span><br><span class="line">    acquired.extend(locks)</span><br><span class="line">    _local.acquired = acquired</span><br><span class="line"></span><br><span class="line">    try:</span><br><span class="line">        for lock in locks:</span><br><span class="line">            lock.acquire()</span><br><span class="line">        yield</span><br><span class="line">    finally:</span><br><span class="line">        # Release locks in reverse order of acquisition</span><br><span class="line">        for lock in reversed(locks):</span><br><span class="line">            lock.release()</span><br><span class="line">        del acquired[-len(locks):]</span><br></pre></td></tr></table></figure><p>å¦‚ä½•ä½¿ç”¨è¿™ä¸ªä¸Šä¸‹æ–‡ç®¡ç†å™¨å‘¢ï¼Ÿä½ å¯ä»¥æŒ‰ç…§æ­£å¸¸é€”å¾„åˆ›å»ºä¸€ä¸ªé”å¯¹è±¡ï¼Œä½†ä¸è®ºæ˜¯å•ä¸ªé”è¿˜æ˜¯å¤šä¸ªé”ä¸­éƒ½ä½¿ç”¨ <code>&lt;span class=&quot;pre&quot;&gt;acquire()&lt;/span&gt;</code>â€‹ å‡½æ•°æ¥ç”³è¯·é”ï¼Œ ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import threading</span><br><span class="line">x_lock = threading.Lock()</span><br><span class="line">y_lock = threading.Lock()</span><br><span class="line"></span><br><span class="line">def thread_1():</span><br><span class="line">    while True:</span><br><span class="line">        with acquire(x_lock, y_lock):</span><br><span class="line">            print(&#x27;Thread-1&#x27;)</span><br><span class="line"></span><br><span class="line">def thread_2():</span><br><span class="line">    while True:</span><br><span class="line">        with acquire(y_lock, x_lock):</span><br><span class="line">            print(&#x27;Thread-2&#x27;)</span><br><span class="line"></span><br><span class="line">t1 = threading.Thread(target=thread_1)</span><br><span class="line">t1.daemon = True</span><br><span class="line">t1.start()</span><br><span class="line"></span><br><span class="line">t2 = threading.Thread(target=thread_2)</span><br><span class="line">t2.daemon = True</span><br><span class="line">t2.start()</span><br></pre></td></tr></table></figure><p>å¦‚æœä½ æ‰§è¡Œè¿™æ®µä»£ç ï¼Œä½ ä¼šå‘ç°å®ƒå³ä½¿åœ¨ä¸åŒçš„å‡½æ•°ä¸­ä»¥ä¸åŒçš„é¡ºåºè·å–é”ä¹Ÿæ²¡æœ‰å‘ç”Ÿæ­»é”ã€‚ å…¶å…³é”®åœ¨äºï¼Œåœ¨ç¬¬ä¸€æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬å¯¹è¿™äº›é”è¿›è¡Œäº†æ’åºã€‚é€šè¿‡æ’åºï¼Œä½¿å¾—ä¸ç®¡ç”¨æˆ·ä»¥ä»€ä¹ˆæ ·çš„é¡ºåºæ¥è¯·æ±‚é”ï¼Œè¿™äº›é”éƒ½ä¼šæŒ‰ç…§å›ºå®šçš„é¡ºåºè¢«è·å–ã€‚ å¦‚æœæœ‰å¤šä¸ª <code>&lt;span class=&quot;pre&quot;&gt;acquire()&lt;/span&gt;</code>â€‹ æ“ä½œè¢«åµŒå¥—è°ƒç”¨ï¼Œå¯ä»¥é€šè¿‡çº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼ˆTLSï¼‰æ¥æ£€æµ‹æ½œåœ¨çš„æ­»é”é—®é¢˜ã€‚ å‡è®¾ä½ çš„ä»£ç æ˜¯è¿™æ ·å†™çš„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import threading</span><br><span class="line">x_lock = threading.Lock()</span><br><span class="line">y_lock = threading.Lock()</span><br><span class="line"></span><br><span class="line">def thread_1():</span><br><span class="line"></span><br><span class="line">    while True:</span><br><span class="line">        with acquire(x_lock):</span><br><span class="line">            with acquire(y_lock):</span><br><span class="line">                print(&#x27;Thread-1&#x27;)</span><br><span class="line"></span><br><span class="line">def thread_2():</span><br><span class="line">    while True:</span><br><span class="line">        with acquire(y_lock):</span><br><span class="line">            with acquire(x_lock):</span><br><span class="line">                print(&#x27;Thread-2&#x27;)</span><br><span class="line"></span><br><span class="line">t1 = threading.Thread(target=thread_1)</span><br><span class="line">t1.daemon = True</span><br><span class="line">t1.start()</span><br><span class="line"></span><br><span class="line">t2 = threading.Thread(target=thread_2)</span><br><span class="line">t2.daemon = True</span><br><span class="line">t2.start()</span><br></pre></td></tr></table></figure><p>å¦‚æœä½ è¿è¡Œè¿™ä¸ªç‰ˆæœ¬çš„ä»£ç ï¼Œå¿…å®šä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹å‘ç”Ÿå´©æºƒï¼Œå¼‚å¸¸ä¿¡æ¯å¯èƒ½åƒè¿™æ ·ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Exception in thread Thread-1:</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;/usr/local/lib/python3.3/threading.py&quot;, line 639, in _bootstrap_inner</span><br><span class="line">    self.run()</span><br><span class="line">  File &quot;/usr/local/lib/python3.3/threading.py&quot;, line 596, in run</span><br><span class="line">    self._target(*self._args, **self._kwargs)</span><br><span class="line">  File &quot;deadlock.py&quot;, line 49, in thread_1</span><br><span class="line">    with acquire(y_lock):</span><br><span class="line">  File &quot;/usr/local/lib/python3.3/contextlib.py&quot;, line 48, in __enter__</span><br><span class="line">    return next(self.gen)</span><br><span class="line">  File &quot;deadlock.py&quot;, line 15, in acquire</span><br><span class="line">    raise RuntimeError(&quot;Lock Order Violation&quot;)</span><br><span class="line">RuntimeError: Lock Order Violation</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><p>å‘ç”Ÿå´©æºƒçš„åŸå› åœ¨äºï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½è®°å½•ç€è‡ªå·±å·²ç»è·å–åˆ°çš„é”ã€‚ <code>&lt;span class=&quot;pre&quot;&gt;acquire()&lt;/span&gt;</code>â€‹ å‡½æ•°ä¼šæ£€æŸ¥ä¹‹å‰å·²ç»è·å–çš„é”åˆ—è¡¨ï¼Œ ç”±äºé”æ˜¯æŒ‰ç…§å‡åºæ’åˆ—è·å–çš„ï¼Œæ‰€ä»¥å‡½æ•°ä¼šè®¤ä¸ºä¹‹å‰å·²è·å–çš„é”çš„idå¿…å®šå°äºæ–°ç”³è¯·åˆ°çš„é”ï¼Œè¿™æ—¶å°±ä¼šè§¦å‘å¼‚å¸¸ã€‚</p><h2 id="è®¨è®º-4"><a href="#è®¨è®º-4" class="headerlink" title="è®¨è®º"></a>è®¨è®º</h2><p>æ­»é”æ˜¯æ¯ä¸€ä¸ªå¤šçº¿ç¨‹ç¨‹åºéƒ½ä¼šé¢ä¸´çš„ä¸€ä¸ªé—®é¢˜ï¼ˆå°±åƒå®ƒæ˜¯æ¯ä¸€æœ¬æ“ä½œç³»ç»Ÿè¯¾æœ¬çš„å…±åŒè¯é¢˜ä¸€æ ·ï¼‰ã€‚æ ¹æ®ç»éªŒæ¥è®²ï¼Œå°½å¯èƒ½ä¿è¯æ¯ä¸€ä¸ª çº¿ç¨‹åªèƒ½åŒæ—¶ä¿æŒä¸€ä¸ªé”ï¼Œè¿™æ ·ç¨‹åºå°±ä¸ä¼šè¢«æ­»é”é—®é¢˜æ‰€å›°æ‰°ã€‚ä¸€æ—¦æœ‰çº¿ç¨‹åŒæ—¶ç”³è¯·å¤šä¸ªé”ï¼Œä¸€åˆ‡å°±ä¸å¯é¢„æ–™äº†ã€‚</p><p>æ­»é”çš„æ£€æµ‹ä¸æ¢å¤æ˜¯ä¸€ä¸ªå‡ ä¹æ²¡æœ‰ä¼˜é›…çš„è§£å†³æ–¹æ¡ˆçš„æ‰©å±•è¯é¢˜ã€‚ä¸€ä¸ªæ¯”è¾ƒå¸¸ç”¨çš„æ­»é”æ£€æµ‹ä¸æ¢å¤çš„æ–¹æ¡ˆæ˜¯å¼•å…¥çœ‹é—¨ç‹—è®¡æ•°å™¨ã€‚å½“çº¿ç¨‹æ­£å¸¸ è¿è¡Œçš„æ—¶å€™ä¼šæ¯éš”ä¸€æ®µæ—¶é—´é‡ç½®è®¡æ•°å™¨ï¼Œåœ¨æ²¡æœ‰å‘ç”Ÿæ­»é”çš„æƒ…å†µä¸‹ï¼Œä¸€åˆ‡éƒ½æ­£å¸¸è¿›è¡Œã€‚ä¸€æ—¦å‘ç”Ÿæ­»é”ï¼Œç”±äºæ— æ³•é‡ç½®è®¡æ•°å™¨å¯¼è‡´å®šæ—¶å™¨ è¶…æ—¶ï¼Œè¿™æ—¶ç¨‹åºä¼šé€šè¿‡é‡å¯è‡ªèº«æ¢å¤åˆ°æ­£å¸¸çŠ¶æ€ã€‚</p><p>é¿å…æ­»é”æ˜¯å¦å¤–ä¸€ç§è§£å†³æ­»é”é—®é¢˜çš„æ–¹å¼ï¼Œåœ¨è¿›ç¨‹è·å–é”çš„æ—¶å€™ä¼šä¸¥æ ¼æŒ‰ç…§å¯¹è±¡idå‡åºæ’åˆ—è·å–ï¼Œç»è¿‡æ•°å­¦è¯æ˜ï¼Œè¿™æ ·ä¿è¯ç¨‹åºä¸ä¼šè¿›å…¥ æ­»é”çŠ¶æ€ã€‚è¯æ˜å°±ç•™ç»™è¯»è€…ä½œä¸ºç»ƒä¹ äº†ã€‚é¿å…æ­»é”çš„ä¸»è¦æ€æƒ³æ˜¯ï¼Œå•çº¯åœ°æŒ‰ç…§å¯¹è±¡idé€’å¢çš„é¡ºåºåŠ é”ä¸ä¼šäº§ç”Ÿå¾ªç¯ä¾èµ–ï¼Œè€Œå¾ªç¯ä¾èµ–æ˜¯ æ­»é”çš„ä¸€ä¸ªå¿…è¦æ¡ä»¶ï¼Œä»è€Œé¿å…ç¨‹åºè¿›å…¥æ­»é”çŠ¶æ€ã€‚</p><p>ä¸‹é¢ä»¥ä¸€ä¸ªå…³äºçº¿ç¨‹æ­»é”çš„ç»å…¸é—®é¢˜ï¼šâ€œå“²å­¦å®¶å°±é¤é—®é¢˜â€ï¼Œä½œä¸ºæœ¬èŠ‚æœ€åä¸€ä¸ªä¾‹å­ã€‚é¢˜ç›®æ˜¯è¿™æ ·çš„ï¼šäº”ä½å“²å­¦å®¶å›´ååœ¨ä¸€å¼ æ¡Œå­å‰ï¼Œæ¯ä¸ªäºº é¢å‰æœ‰ä¸€ç¢—é¥­å’Œä¸€åªç­·å­ã€‚åœ¨è¿™é‡Œæ¯ä¸ªå“²å­¦å®¶å¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹ï¼Œè€Œæ¯åªç­·å­å¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªé”ã€‚æ¯ä¸ªå“²å­¦å®¶å¯ä»¥å¤„åœ¨é™åã€ æ€è€ƒã€åƒé¥­ä¸‰ç§çŠ¶æ€ä¸­çš„ä¸€ä¸ªã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ¯ä¸ªå“²å­¦å®¶åƒé¥­æ˜¯éœ€è¦ä¸¤åªç­·å­çš„ï¼Œè¿™æ ·é—®é¢˜å°±æ¥äº†ï¼šå¦‚æœæ¯ä¸ªå“²å­¦å®¶éƒ½æ‹¿èµ·è‡ªå·±å·¦è¾¹çš„ç­·å­ï¼Œ é‚£ä¹ˆä»–ä»¬äº”ä¸ªéƒ½åªèƒ½æ‹¿ç€ä¸€åªç­·å­ååœ¨é‚£å„¿ï¼Œç›´åˆ°é¥¿æ­»ã€‚æ­¤æ—¶ä»–ä»¬å°±è¿›å…¥äº†æ­»é”çŠ¶æ€ã€‚ ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä½¿ç”¨æ­»é”é¿å…æœºåˆ¶è§£å†³â€œå“²å­¦å®¶å°±é¤é—®é¢˜â€çš„å®ç°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import threading</span><br><span class="line"></span><br><span class="line"># The philosopher thread</span><br><span class="line">def philosopher(left, right):</span><br><span class="line">    while True:</span><br><span class="line">        with acquire(left,right):</span><br><span class="line">             print(threading.currentThread(), &#x27;eating&#x27;)</span><br><span class="line"></span><br><span class="line"># The chopsticks (represented by locks)</span><br><span class="line">NSTICKS = 5</span><br><span class="line">chopsticks = [threading.Lock() for n in range(NSTICKS)]</span><br><span class="line"></span><br><span class="line"># Create all of the philosophers</span><br><span class="line">for n in range(NSTICKS):</span><br><span class="line">    t = threading.Thread(target=philosopher,</span><br><span class="line">                         args=(chopsticks[n],chopsticks[(n+1) % NSTICKS]))</span><br><span class="line">    t.start()</span><br></pre></td></tr></table></figure><p>æœ€åï¼Œè¦ç‰¹åˆ«æ³¨æ„åˆ°ï¼Œä¸ºäº†é¿å…æ­»é”ï¼Œæ‰€æœ‰çš„åŠ é”æ“ä½œå¿…é¡»ä½¿ç”¨ <code>&lt;span class=&quot;pre&quot;&gt;acquire()&lt;/span&gt;</code>â€‹ å‡½æ•°ã€‚å¦‚æœä»£ç ä¸­çš„æŸéƒ¨åˆ†ç»•è¿‡acquire å‡½æ•°ç›´æ¥ç”³è¯·é”ï¼Œé‚£ä¹ˆæ•´ä¸ªæ­»é”é¿å…æœºåˆ¶å°±ä¸èµ·ä½œç”¨äº†ã€‚</p><p>â€</p><h1 id="ä¿å­˜çº¿ç¨‹çš„çŠ¶æ€ä¿¡æ¯"><a href="#ä¿å­˜çº¿ç¨‹çš„çŠ¶æ€ä¿¡æ¯" class="headerlink" title="ä¿å­˜çº¿ç¨‹çš„çŠ¶æ€ä¿¡æ¯"></a>ä¿å­˜çº¿ç¨‹çš„çŠ¶æ€ä¿¡æ¯</h1><blockquote><p>å’ŒJava ThreadLocalç±»ä¼¼ï¼Œä»‹ç»äº†æ€ä¹ˆç”¨</p></blockquote><h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><p>ä½ éœ€è¦ä¿å­˜æ­£åœ¨è¿è¡Œçº¿ç¨‹çš„çŠ¶æ€ï¼Œè¿™ä¸ªçŠ¶æ€å¯¹äºå…¶ä»–çš„çº¿ç¨‹æ˜¯ä¸å¯è§çš„ã€‚</p><h2 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h2><p>æœ‰æ—¶åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ï¼Œä½ éœ€è¦åªä¿å­˜å½“å‰è¿è¡Œçº¿ç¨‹çš„çŠ¶æ€ã€‚ è¦è¿™ä¹ˆåšï¼Œå¯ä½¿ç”¨ <code>&lt;span class=&quot;pre&quot;&gt;thread.local()&lt;/span&gt;</code>â€‹ åˆ›å»ºä¸€ä¸ªæœ¬åœ°çº¿ç¨‹å­˜å‚¨å¯¹è±¡ã€‚ å¯¹è¿™ä¸ªå¯¹è±¡çš„å±æ€§çš„ä¿å­˜å’Œè¯»å–æ“ä½œéƒ½åªä¼šå¯¹æ‰§è¡Œçº¿ç¨‹å¯è§ï¼Œè€Œå…¶ä»–çº¿ç¨‹å¹¶ä¸å¯è§ã€‚</p><p>ä½œä¸ºä½¿ç”¨æœ¬åœ°å­˜å‚¨çš„ä¸€ä¸ªæœ‰è¶£çš„å®é™…ä¾‹å­ï¼Œ è€ƒè™‘åœ¨8.3å°èŠ‚å®šä¹‰è¿‡çš„ <code>&lt;span class=&quot;pre&quot;&gt;LazyConnection&lt;/span&gt;</code>â€‹ ä¸Šä¸‹æ–‡ç®¡ç†å™¨ç±»ã€‚ ä¸‹é¢æˆ‘ä»¬å¯¹å®ƒè¿›è¡Œä¸€äº›å°çš„ä¿®æ”¹ä½¿å¾—å®ƒå¯ä»¥é€‚ç”¨äºå¤šçº¿ç¨‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from socket import socket, AF_INET, SOCK_STREAM</span><br><span class="line">import threading</span><br><span class="line"></span><br><span class="line">class LazyConnection:</span><br><span class="line">    def __init__(self, address, family=AF_INET, type=SOCK_STREAM):</span><br><span class="line">        self.address = address</span><br><span class="line">        self.family = AF_INET</span><br><span class="line">        self.type = SOCK_STREAM</span><br><span class="line">        self.local = threading.local()</span><br><span class="line"></span><br><span class="line">    def __enter__(self):</span><br><span class="line">        if hasattr(self.local, &#x27;sock&#x27;):</span><br><span class="line">            raise RuntimeError(&#x27;Already connected&#x27;)</span><br><span class="line">        self.local.sock = socket(self.family, self.type)</span><br><span class="line">        self.local.sock.connect(self.address)</span><br><span class="line">        return self.local.sock</span><br><span class="line"></span><br><span class="line">    def __exit__(self, exc_ty, exc_val, tb):</span><br><span class="line">        self.local.sock.close()</span><br><span class="line">        del self.local.sock</span><br></pre></td></tr></table></figure><p>ä»£ç ä¸­ï¼Œè‡ªå·±è§‚å¯Ÿå¯¹äº <code>&lt;span class=&quot;pre&quot;&gt;self.local&lt;/span&gt;</code>â€‹ å±æ€§çš„ä½¿ç”¨ã€‚ å®ƒè¢«åˆå§‹åŒ–ä¸ºä¸€ä¸ª <code>&lt;span class=&quot;pre&quot;&gt;threading.local()&lt;/span&gt;</code>â€‹ å®ä¾‹ã€‚ å…¶ä»–æ–¹æ³•æ“ä½œè¢«å­˜å‚¨ä¸º <code>&lt;span class=&quot;pre&quot;&gt;self.local.sock&lt;/span&gt;</code>â€‹ çš„å¥—æ¥å­—å¯¹è±¡ã€‚ æœ‰äº†è¿™äº›å°±å¯ä»¥åœ¨å¤šçº¿ç¨‹ä¸­å®‰å…¨çš„ä½¿ç”¨ <code>&lt;span class=&quot;pre&quot;&gt;LazyConnection&lt;/span&gt;</code>â€‹ å®ä¾‹äº†ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from functools import partial</span><br><span class="line">def test(conn):</span><br><span class="line">    with conn as s:</span><br><span class="line">        s.send(b&#x27;GET /index.html HTTP/1.0\r\n&#x27;)</span><br><span class="line">        s.send(b&#x27;Host: www.python.org\r\n&#x27;)</span><br><span class="line"></span><br><span class="line">        s.send(b&#x27;\r\n&#x27;)</span><br><span class="line">        resp = b&#x27;&#x27;.join(iter(partial(s.recv, 8192), b&#x27;&#x27;))</span><br><span class="line"></span><br><span class="line">    print(&#x27;Got &#123;&#125; bytes&#x27;.format(len(resp)))</span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    conn = LazyConnection((&#x27;www.python.org&#x27;, 80))</span><br><span class="line"></span><br><span class="line">    t1 = threading.Thread(target=test, args=(conn,))</span><br><span class="line">    t2 = threading.Thread(target=test, args=(conn,))</span><br><span class="line">    t1.start()</span><br><span class="line">    t2.start()</span><br><span class="line">    t1.join()</span><br><span class="line">    t2.join()</span><br></pre></td></tr></table></figure><p>å®ƒä¹‹æ‰€ä»¥è¡Œå¾—é€šçš„åŸå› æ˜¯æ¯ä¸ªçº¿ç¨‹ä¼šåˆ›å»ºä¸€ä¸ªè‡ªå·±ä¸“å±çš„å¥—æ¥å­—è¿æ¥ï¼ˆå­˜å‚¨ä¸ºself.local.sockï¼‰ã€‚ å› æ­¤ï¼Œå½“ä¸åŒçš„çº¿ç¨‹æ‰§è¡Œå¥—æ¥å­—æ“ä½œæ—¶ï¼Œç”±äºæ“ä½œçš„æ˜¯ä¸åŒçš„å¥—æ¥å­—ï¼Œå› æ­¤å®ƒä»¬ä¸ä¼šç›¸äº’å½±å“ã€‚</p><h2 id="è®¨è®º-5"><a href="#è®¨è®º-5" class="headerlink" title="è®¨è®º"></a>è®¨è®º</h2><p>åœ¨å¤§éƒ¨åˆ†ç¨‹åºä¸­åˆ›å»ºå’Œæ“ä½œçº¿ç¨‹ç‰¹å®šçŠ¶æ€å¹¶ä¸ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ã€‚ ä¸è¿‡ï¼Œå½“å‡ºäº†é—®é¢˜çš„æ—¶å€™ï¼Œé€šå¸¸æ˜¯å› ä¸ºæŸä¸ªå¯¹è±¡è¢«å¤šä¸ªçº¿ç¨‹ä½¿ç”¨åˆ°ï¼Œç”¨æ¥æ“ä½œä¸€äº›ä¸“ç”¨çš„ç³»ç»Ÿèµ„æºï¼Œ æ¯”å¦‚ä¸€ä¸ªå¥—æ¥å­—æˆ–æ–‡ä»¶ã€‚ä½ ä¸èƒ½è®©æ‰€æœ‰çº¿ç¨‹å…±äº«ä¸€ä¸ªå•ç‹¬å¯¹è±¡ï¼Œ å› ä¸ºå¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å’Œå†™çš„æ—¶å€™ä¼šäº§ç”Ÿæ··ä¹±ã€‚ æœ¬åœ°çº¿ç¨‹å­˜å‚¨é€šè¿‡è®©è¿™äº›èµ„æºåªèƒ½åœ¨è¢«ä½¿ç”¨çš„çº¿ç¨‹ä¸­å¯è§æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><p>æœ¬èŠ‚ä¸­ï¼Œä½¿ç”¨ <code>&lt;span class=&quot;pre&quot;&gt;thread.local()&lt;/span&gt;</code>â€‹ å¯ä»¥è®© <code>&lt;span class=&quot;pre&quot;&gt;LazyConnection&lt;/span&gt;</code>â€‹ ç±»æ”¯æŒä¸€ä¸ªçº¿ç¨‹ä¸€ä¸ªè¿æ¥ï¼Œ è€Œä¸æ˜¯å¯¹äºæ‰€æœ‰çš„è¿›ç¨‹éƒ½åªæœ‰ä¸€ä¸ªè¿æ¥ã€‚</p><p>å…¶åŸç†æ˜¯ï¼Œæ¯ä¸ª <code>&lt;span class=&quot;pre&quot;&gt;threading.local()&lt;/span&gt;</code>â€‹ å®ä¾‹ä¸ºæ¯ä¸ªçº¿ç¨‹ç»´æŠ¤ç€ä¸€ä¸ªå•ç‹¬çš„å®ä¾‹å­—å…¸ã€‚ æ‰€æœ‰æ™®é€šå®ä¾‹æ“ä½œæ¯”å¦‚è·å–ã€ä¿®æ”¹å’Œåˆ é™¤å€¼ä»…ä»…æ“ä½œè¿™ä¸ªå­—å…¸ã€‚ æ¯ä¸ªçº¿ç¨‹ä½¿ç”¨ä¸€ä¸ªç‹¬ç«‹çš„å­—å…¸å°±å¯ä»¥ä¿è¯æ•°æ®çš„éš”ç¦»äº†ã€‚</p><p>â€</p><h1 id="åˆ›å»ºçº¿ç¨‹æ± "><a href="#åˆ›å»ºçº¿ç¨‹æ± " class="headerlink" title="åˆ›å»ºçº¿ç¨‹æ± "></a>åˆ›å»ºçº¿ç¨‹æ± </h1><p><code>concurrent.futures</code>â€‹ å‡½æ•°åº“æœ‰ä¸€ä¸ª <code>ThreadPoolExecutor</code>â€‹ ç±»å¯ä»¥è¢«ç”¨æ¥å®Œæˆè¿™ä¸ªä»»åŠ¡ã€‚ ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„TCPæœåŠ¡å™¨ï¼Œä½¿ç”¨äº†ä¸€ä¸ªçº¿ç¨‹æ± æ¥å“åº”å®¢æˆ·ç«¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from socket import AF_INET, SOCK_STREAM, socket</span><br><span class="line">from concurrent.futures import ThreadPoolExecutor</span><br><span class="line"></span><br><span class="line">def echo_client(sock, client_addr):</span><br><span class="line">    &#x27;&#x27;&#x27;</span><br><span class="line">    Handle a client connection</span><br><span class="line">    &#x27;&#x27;&#x27;</span><br><span class="line">    print(&#x27;Got connection from&#x27;, client_addr)</span><br><span class="line">    while True:</span><br><span class="line">        msg = sock.recv(65536)</span><br><span class="line">        if not msg:</span><br><span class="line">            break</span><br><span class="line">        sock.sendall(msg)</span><br><span class="line">    print(&#x27;Client closed connection&#x27;)</span><br><span class="line">    sock.close()</span><br><span class="line"></span><br><span class="line">def echo_server(addr):</span><br><span class="line">    pool = ThreadPoolExecutor(128)</span><br><span class="line">    sock = socket(AF_INET, SOCK_STREAM)</span><br><span class="line">    sock.bind(addr)</span><br><span class="line">    sock.listen(5)</span><br><span class="line">    while True:</span><br><span class="line">        client_sock, client_addr = sock.accept()</span><br><span class="line">        pool.submit(echo_client, client_sock, client_addr)</span><br><span class="line"></span><br><span class="line">echo_server((&#x27;&#x27;,15000))</span><br></pre></td></tr></table></figure><p>å¦‚æœä½ æƒ³æ‰‹åŠ¨åˆ›å»ºä½ è‡ªå·±çš„çº¿ç¨‹æ± ï¼Œ é€šå¸¸å¯ä»¥ä½¿ç”¨ä¸€ä¸ªQueueæ¥è½»æ¾å®ç°ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç¨å¾®ä¸åŒä½†æ˜¯æ‰‹åŠ¨å®ç°çš„ä¾‹å­ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from socket import socket, AF_INET, SOCK_STREAM</span><br><span class="line">from threading import Thread</span><br><span class="line">from queue import Queue</span><br><span class="line"></span><br><span class="line">def echo_client(q):</span><br><span class="line">    &#x27;&#x27;&#x27;</span><br><span class="line">    Handle a client connection</span><br><span class="line">    &#x27;&#x27;&#x27;</span><br><span class="line">    sock, client_addr = q.get()</span><br><span class="line">    print(&#x27;Got connection from&#x27;, client_addr)</span><br><span class="line">    while True:</span><br><span class="line">        msg = sock.recv(65536)</span><br><span class="line">        if not msg:</span><br><span class="line">            break</span><br><span class="line">        sock.sendall(msg)</span><br><span class="line">    print(&#x27;Client closed connection&#x27;)</span><br><span class="line"></span><br><span class="line">    sock.close()</span><br><span class="line"></span><br><span class="line">def echo_server(addr, nworkers):</span><br><span class="line">    # Launch the client workers</span><br><span class="line">    q = Queue()</span><br><span class="line">    for n in range(nworkers):</span><br><span class="line">        t = Thread(target=echo_client, args=(q,))</span><br><span class="line">        t.daemon = True</span><br><span class="line">        t.start()</span><br><span class="line"></span><br><span class="line">    # Run the server</span><br><span class="line">    sock = socket(AF_INET, SOCK_STREAM)</span><br><span class="line">    sock.bind(addr)</span><br><span class="line">    sock.listen(5)</span><br><span class="line">    while True:</span><br><span class="line">        client_sock, client_addr = sock.accept()</span><br><span class="line">        q.put((client_sock, client_addr))</span><br><span class="line"></span><br><span class="line">echo_server((&#x27;&#x27;,15000), 128)</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>&lt;span class=&quot;pre&quot;&gt;ThreadPoolExecutor&lt;/span&gt;</code>â€‹ ç›¸å¯¹äºæ‰‹åŠ¨å®ç°çš„ä¸€ä¸ªå¥½å¤„åœ¨äºå®ƒä½¿å¾— ä»»åŠ¡æäº¤è€…æ›´æ–¹ä¾¿çš„ä»è¢«è°ƒç”¨å‡½æ•°ä¸­è·å–è¿”å›å€¼ã€‚ä¾‹å¦‚ï¼Œä½ å¯èƒ½ä¼šåƒä¸‹é¢è¿™æ ·å†™ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from concurrent.futures import ThreadPoolExecutor</span><br><span class="line">import urllib.request</span><br><span class="line"></span><br><span class="line">def fetch_url(url):</span><br><span class="line">    u = urllib.request.urlopen(url)</span><br><span class="line">    data = u.read()</span><br><span class="line">    return data</span><br><span class="line"></span><br><span class="line">pool = ThreadPoolExecutor(10)</span><br><span class="line"># Submit work to the pool</span><br><span class="line">a = pool.submit(fetch_url, &#x27;http://www.python.org&#x27;)</span><br><span class="line">b = pool.submit(fetch_url, &#x27;http://www.pypy.org&#x27;)</span><br><span class="line"></span><br><span class="line"># Get the results back</span><br><span class="line">x = a.result()</span><br><span class="line">y = b.result()</span><br></pre></td></tr></table></figure><p>ä¾‹å­ä¸­è¿”å›çš„handleå¯¹è±¡ä¼šå¸®ä½ å¤„ç†æ‰€æœ‰çš„é˜»å¡ä¸åä½œï¼Œç„¶åä»å·¥ä½œçº¿ç¨‹ä¸­è¿”å›æ•°æ®ç»™ä½ ã€‚ ç‰¹åˆ«çš„ï¼Œ<code>&lt;span class=&quot;pre&quot;&gt;a.result()&lt;/span&gt;</code>â€‹ æ“ä½œä¼šé˜»å¡è¿›ç¨‹ç›´åˆ°å¯¹åº”çš„å‡½æ•°æ‰§è¡Œå®Œæˆå¹¶è¿”å›ä¸€ä¸ªç»“æœã€‚</p><h2 id="è®¨è®º-6"><a href="#è®¨è®º-6" class="headerlink" title="è®¨è®º"></a>è®¨è®º</h2><p>é€šå¸¸æ¥è®²ï¼Œä½ åº”è¯¥é¿å…ç¼–å†™çº¿ç¨‹æ•°é‡å¯ä»¥æ— é™åˆ¶å¢é•¿çš„ç¨‹åºã€‚ä¾‹å¦‚ï¼Œçœ‹çœ‹ä¸‹é¢è¿™ä¸ªæœåŠ¡å™¨ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from threading import Thread</span><br><span class="line">from socket import socket, AF_INET, SOCK_STREAM</span><br><span class="line"></span><br><span class="line">def echo_client(sock, client_addr):</span><br><span class="line">    &#x27;&#x27;&#x27;</span><br><span class="line">    Handle a client connection</span><br><span class="line">    &#x27;&#x27;&#x27;</span><br><span class="line">    print(&#x27;Got connection from&#x27;, client_addr)</span><br><span class="line">    while True:</span><br><span class="line">        msg = sock.recv(65536)</span><br><span class="line">        if not msg:</span><br><span class="line">            break</span><br><span class="line">        sock.sendall(msg)</span><br><span class="line">    print(&#x27;Client closed connection&#x27;)</span><br><span class="line">    sock.close()</span><br><span class="line"></span><br><span class="line">def echo_server(addr, nworkers):</span><br><span class="line">    # Run the server</span><br><span class="line">    sock = socket(AF_INET, SOCK_STREAM)</span><br><span class="line">    sock.bind(addr)</span><br><span class="line">    sock.listen(5)</span><br><span class="line">    while True:</span><br><span class="line">        client_sock, client_addr = sock.accept()</span><br><span class="line">        t = Thread(target=echo_client, args=(client_sock, client_addr))</span><br><span class="line">        t.daemon = True</span><br><span class="line">        t.start()</span><br><span class="line"></span><br><span class="line">echo_server((&#x27;&#x27;,15000))</span><br></pre></td></tr></table></figure><p>å°½ç®¡è¿™ä¸ªä¹Ÿå¯ä»¥å·¥ä½œï¼Œ ä½†æ˜¯å®ƒä¸èƒ½æŠµå¾¡æœ‰äººè¯•å›¾é€šè¿‡åˆ›å»ºå¤§é‡çº¿ç¨‹è®©ä½ æœåŠ¡å™¨èµ„æºæ¯ç«­è€Œå´©æºƒçš„æ”»å‡»è¡Œä¸ºã€‚ é€šè¿‡ä½¿ç”¨é¢„å…ˆåˆå§‹åŒ–çš„çº¿ç¨‹æ± ï¼Œä½ å¯ä»¥è®¾ç½®åŒæ—¶è¿è¡Œçº¿ç¨‹çš„ä¸Šé™æ•°é‡ã€‚</p><p>ä½ å¯èƒ½ä¼šå…³å¿ƒåˆ›å»ºå¤§é‡çº¿ç¨‹ä¼šæœ‰ä»€ä¹ˆåæœã€‚ ç°ä»£æ“ä½œç³»ç»Ÿå¯ä»¥å¾ˆè½»æ¾çš„åˆ›å»ºå‡ åƒä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± ã€‚ ç”šè‡³ï¼ŒåŒæ—¶å‡ åƒä¸ªçº¿ç¨‹ç­‰å¾…å·¥ä½œå¹¶ä¸ä¼šå¯¹å…¶ä»–ä»£ç äº§ç”Ÿæ€§èƒ½å½±å“ã€‚ å½“ç„¶äº†ï¼Œå¦‚æœæ‰€æœ‰çº¿ç¨‹åŒæ—¶è¢«å”¤é†’å¹¶ç«‹å³åœ¨CPUä¸Šæ‰§è¡Œï¼Œé‚£å°±ä¸åŒäº†â€”â€”ç‰¹åˆ«æ˜¯æœ‰äº†å…¨å±€è§£é‡Šå™¨é”GILã€‚ é€šå¸¸ï¼Œä½ åº”è¯¥åªåœ¨I/Oå¤„ç†ç›¸å…³ä»£ç ä¸­ä½¿ç”¨çº¿ç¨‹æ± ã€‚</p><p>åˆ›å»ºå¤§çš„çº¿ç¨‹æ± çš„ä¸€ä¸ªå¯èƒ½éœ€è¦å…³æ³¨çš„é—®é¢˜æ˜¯å†…å­˜çš„ä½¿ç”¨ã€‚ ä¾‹å¦‚ï¼Œå¦‚æœä½ åœ¨OS Xç³»ç»Ÿä¸Šé¢åˆ›å»º2000ä¸ªçº¿ç¨‹ï¼Œç³»ç»Ÿæ˜¾ç¤ºPythonè¿›ç¨‹ä½¿ç”¨äº†è¶…è¿‡9GBçš„è™šæ‹Ÿå†…å­˜ã€‚ ä¸è¿‡ï¼Œè¿™ä¸ªè®¡ç®—é€šå¸¸æ˜¯æœ‰è¯¯å·®çš„ã€‚å½“åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šé¢„ç•™ä¸€ä¸ªè™šæ‹Ÿå†…å­˜åŒºåŸŸæ¥ æ”¾ç½®çº¿ç¨‹çš„æ‰§è¡Œæ ˆï¼ˆé€šå¸¸æ˜¯8MBå¤§å°ï¼‰ã€‚ä½†æ˜¯è¿™ä¸ªå†…å­˜åªæœ‰ä¸€å°ç‰‡æ®µè¢«å®é™…æ˜ å°„åˆ°çœŸå®å†…å­˜ä¸­ã€‚ å› æ­¤ï¼ŒPythonè¿›ç¨‹ä½¿ç”¨åˆ°çš„çœŸå®å†…å­˜å…¶å®å¾ˆå° ï¼ˆæ¯”å¦‚ï¼Œå¯¹äº2000ä¸ªçº¿ç¨‹æ¥è®²ï¼Œåªä½¿ç”¨åˆ°äº†70MBçš„çœŸå®å†…å­˜ï¼Œè€Œä¸æ˜¯9GBï¼‰ã€‚ å¦‚æœä½ æ‹…å¿ƒè™šæ‹Ÿå†…å­˜å¤§å°ï¼Œå¯ä»¥ä½¿ç”¨ <code>&lt;span class=&quot;pre&quot;&gt;threading.stack_size()&lt;/span&gt;</code>â€‹ å‡½æ•°æ¥é™ä½å®ƒã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import threading</span><br><span class="line">threading.stack_size(65536)</span><br></pre></td></tr></table></figure><p>å¦‚æœä½ åŠ ä¸Šè¿™æ¡è¯­å¥å¹¶å†æ¬¡è¿è¡Œå‰é¢çš„åˆ›å»º2000ä¸ªçº¿ç¨‹è¯•éªŒï¼Œ ä½ ä¼šå‘ç°Pythonè¿›ç¨‹åªä½¿ç”¨åˆ°äº†å¤§æ¦‚210MBçš„è™šæ‹Ÿå†…å­˜ï¼Œè€ŒçœŸå®å†…å­˜ä½¿ç”¨é‡æ²¡æœ‰å˜ã€‚ æ³¨æ„çº¿ç¨‹æ ˆå¤§å°å¿…é¡»è‡³å°‘ä¸º32768å­—èŠ‚ï¼Œé€šå¸¸æ˜¯ç³»ç»Ÿå†…å­˜é¡µå¤§å°ï¼ˆ4096ã€8192ç­‰ï¼‰çš„æ•´æ•°å€ã€‚</p><p>â€</p><h1 id="ç®€å•å¹¶è¡Œç¼–ç¨‹"><a href="#ç®€å•å¹¶è¡Œç¼–ç¨‹" class="headerlink" title="ç®€å•å¹¶è¡Œç¼–ç¨‹"></a>ç®€å•å¹¶è¡Œç¼–ç¨‹</h1><p>ä½ æœ‰ä¸ªç¨‹åºè¦æ‰§è¡ŒCPUå¯†é›†å‹å·¥ä½œï¼Œä½ æƒ³è®©ä»–åˆ©ç”¨å¤šæ ¸CPUçš„ä¼˜åŠ¿æ¥è¿è¡Œçš„å¿«ä¸€ç‚¹ã€‚</p><h2 id="è§£å†³æ–¹æ¡ˆ-1"><a href="#è§£å†³æ–¹æ¡ˆ-1" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h2><p><code>concurrent.futures</code>â€‹ åº“æä¾›äº†ä¸€ä¸ª <code>ProcessPoolExecutor</code>â€‹ ç±»ï¼Œ å¯è¢«ç”¨æ¥åœ¨ä¸€ä¸ªå•ç‹¬çš„Pythonè§£é‡Šå™¨ä¸­æ‰§è¡Œè®¡ç®—å¯†é›†å‹å‡½æ•°ã€‚ ä¸è¿‡ï¼Œè¦ä½¿ç”¨å®ƒï¼Œä½ é¦–å…ˆè¦æœ‰ä¸€äº›è®¡ç®—å¯†é›†å‹çš„ä»»åŠ¡ã€‚ æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•è€Œå®é™…çš„ä¾‹å­æ¥æ¼”ç¤ºå®ƒã€‚å‡å®šä½ æœ‰ä¸ªApache webæœåŠ¡å™¨æ—¥å¿—ç›®å½•çš„gzipå‹ç¼©åŒ…ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">logs/</span><br><span class="line">   20120701.log.gz</span><br><span class="line">   20120702.log.gz</span><br><span class="line">   20120703.log.gz</span><br><span class="line">   20120704.log.gz</span><br><span class="line">   20120705.log.gz</span><br><span class="line">   20120706.log.gz</span><br><span class="line">   ...</span><br></pre></td></tr></table></figure><p>è¿›ä¸€æ­¥å‡è®¾æ¯ä¸ªæ—¥å¿—æ–‡ä»¶å†…å®¹ç±»ä¼¼ä¸‹é¢è¿™æ ·ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">124.115.6.12 - - [10/Jul/2012:00:18:50 -0500] &quot;GET /robots.txt ...&quot; 200 71</span><br><span class="line">210.212.209.67 - - [10/Jul/2012:00:18:51 -0500] &quot;GET /ply/ ...&quot; 200 11875</span><br><span class="line">210.212.209.67 - - [10/Jul/2012:00:18:51 -0500] &quot;GET /favicon.ico ...&quot; 404 369</span><br><span class="line">61.135.216.105 - - [10/Jul/2012:00:20:04 -0500] &quot;GET /blog/atom.xml ...&quot; 304 -</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯ä¸€ä¸ªè„šæœ¬ï¼Œåœ¨è¿™äº›æ—¥å¿—æ–‡ä»¶ä¸­æŸ¥æ‰¾å‡ºæ‰€æœ‰è®¿é—®è¿‡robots.txtæ–‡ä»¶çš„ä¸»æœºï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># findrobots.py</span><br><span class="line"></span><br><span class="line">import gzip</span><br><span class="line">import io</span><br><span class="line">import glob</span><br><span class="line"></span><br><span class="line">def find_robots(filename):</span><br><span class="line">    &#x27;&#x27;&#x27;</span><br><span class="line">    Find all of the hosts that access robots.txt in a single log file</span><br><span class="line">    &#x27;&#x27;&#x27;</span><br><span class="line">    robots = set()</span><br><span class="line">    with gzip.open(filename) as f:</span><br><span class="line">        for line in io.TextIOWrapper(f,encoding=&#x27;ascii&#x27;):</span><br><span class="line">            fields = line.split()</span><br><span class="line">            if fields[6] == &#x27;/robots.txt&#x27;:</span><br><span class="line">                robots.add(fields[0])</span><br><span class="line">    return robots</span><br><span class="line"></span><br><span class="line">def find_all_robots(logdir):</span><br><span class="line">    &#x27;&#x27;&#x27;</span><br><span class="line">    Find all hosts across and entire sequence of files</span><br><span class="line">    &#x27;&#x27;&#x27;</span><br><span class="line">    files = glob.glob(logdir+&#x27;/*.log.gz&#x27;)</span><br><span class="line">    all_robots = set()</span><br><span class="line">    for robots in map(find_robots, files):</span><br><span class="line">        all_robots.update(robots)</span><br><span class="line">    return all_robots</span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    robots = find_all_robots(&#x27;logs&#x27;)</span><br><span class="line">    for ipaddr in robots:</span><br><span class="line">        print(ipaddr)</span><br></pre></td></tr></table></figure><p>å‰é¢çš„ç¨‹åºä½¿ç”¨äº†é€šå¸¸çš„map-reduceé£æ ¼æ¥ç¼–å†™ã€‚ å‡½æ•° <code>&lt;span class=&quot;pre&quot;&gt;find_robots()&lt;/span&gt;</code>â€‹ åœ¨ä¸€ä¸ªæ–‡ä»¶åé›†åˆä¸Šåšmapæ“ä½œï¼Œå¹¶å°†ç»“æœæ±‡æ€»ä¸ºä¸€ä¸ªå•ç‹¬çš„ç»“æœï¼Œ ä¹Ÿå°±æ˜¯ <code>&lt;span class=&quot;pre&quot;&gt;find_all_robots()&lt;/span&gt;</code>â€‹ å‡½æ•°ä¸­çš„ <code>&lt;span class=&quot;pre&quot;&gt;all_robots&lt;/span&gt;</code>â€‹ é›†åˆã€‚ ç°åœ¨ï¼Œå‡è®¾ä½ æƒ³è¦ä¿®æ”¹è¿™ä¸ªç¨‹åºè®©å®ƒä½¿ç”¨å¤šæ ¸CPUã€‚ å¾ˆç®€å•â€”â€”åªéœ€è¦å°†map()æ“ä½œæ›¿æ¢ä¸ºä¸€ä¸ª <code>&lt;span class=&quot;pre&quot;&gt;concurrent.futures&lt;/span&gt;</code>â€‹ åº“ä¸­ç”Ÿæˆçš„ç±»ä¼¼æ“ä½œå³å¯ã€‚ ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•ä¿®æ”¹ç‰ˆæœ¬ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># findrobots.py</span><br><span class="line"></span><br><span class="line">import gzip</span><br><span class="line">import io</span><br><span class="line">import glob</span><br><span class="line">from concurrent import futures</span><br><span class="line"></span><br><span class="line">def find_robots(filename):</span><br><span class="line">    &#x27;&#x27;&#x27;</span><br><span class="line">    Find all of the hosts that access robots.txt in a single log file</span><br><span class="line"></span><br><span class="line">    &#x27;&#x27;&#x27;</span><br><span class="line">    robots = set()</span><br><span class="line">    with gzip.open(filename) as f:</span><br><span class="line">        for line in io.TextIOWrapper(f,encoding=&#x27;ascii&#x27;):</span><br><span class="line">            fields = line.split()</span><br><span class="line">            if fields[6] == &#x27;/robots.txt&#x27;:</span><br><span class="line">                robots.add(fields[0])</span><br><span class="line">    return robots</span><br><span class="line"></span><br><span class="line">def find_all_robots(logdir):</span><br><span class="line">    &#x27;&#x27;&#x27;</span><br><span class="line">    Find all hosts across and entire sequence of files</span><br><span class="line">    &#x27;&#x27;&#x27;</span><br><span class="line">    files = glob.glob(logdir+&#x27;/*.log.gz&#x27;)</span><br><span class="line">    all_robots = set()</span><br><span class="line">    with futures.ProcessPoolExecutor() as pool:</span><br><span class="line">        for robots in pool.map(find_robots, files):</span><br><span class="line">            all_robots.update(robots)</span><br><span class="line">    return all_robots</span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    robots = find_all_robots(&#x27;logs&#x27;)</span><br><span class="line">    for ipaddr in robots:</span><br><span class="line">        print(ipaddr)</span><br></pre></td></tr></table></figure><p>é€šè¿‡è¿™ä¸ªä¿®æ”¹åï¼Œè¿è¡Œè¿™ä¸ªè„šæœ¬äº§ç”ŸåŒæ ·çš„ç»“æœï¼Œä½†æ˜¯åœ¨å››æ ¸æœºå™¨ä¸Šé¢æ¯”ä¹‹å‰å¿«äº†3.5å€ã€‚ å®é™…çš„æ€§èƒ½ä¼˜åŒ–æ•ˆæœæ ¹æ®ä½ çš„æœºå™¨CPUæ•°é‡çš„ä¸åŒè€Œä¸åŒã€‚</p><h2 id="è®¨è®º-7"><a href="#è®¨è®º-7" class="headerlink" title="è®¨è®º"></a>è®¨è®º</h2><p><code>&lt;span class=&quot;pre&quot;&gt;ProcessPoolExecutor&lt;/span&gt;</code>â€‹ çš„å…¸å‹ç”¨æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from concurrent.futures import ProcessPoolExecutor</span><br><span class="line"></span><br><span class="line">with ProcessPoolExecutor() as pool:</span><br><span class="line">    ...</span><br><span class="line">    do work in parallel using pool</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p>å…¶åŸç†æ˜¯ï¼Œä¸€ä¸ª <code>&lt;span class=&quot;pre&quot;&gt;ProcessPoolExecutor&lt;/span&gt;</code>â€‹ åˆ›å»ºNä¸ªç‹¬ç«‹çš„Pythonè§£é‡Šå™¨ï¼Œ Næ˜¯ç³»ç»Ÿä¸Šé¢å¯ç”¨CPUçš„ä¸ªæ•°ã€‚ä½ å¯ä»¥é€šè¿‡æä¾›å¯é€‰å‚æ•°ç»™ <code>&lt;span class=&quot;pre&quot;&gt;ProcessPoolExecutor(N)&lt;/span&gt;</code>â€‹ æ¥ä¿®æ”¹ å¤„ç†å™¨æ•°é‡ã€‚è¿™ä¸ªå¤„ç†æ± ä¼šä¸€ç›´è¿è¡Œåˆ°withå—ä¸­æœ€åä¸€ä¸ªè¯­å¥æ‰§è¡Œå®Œæˆï¼Œ ç„¶åå¤„ç†æ± è¢«å…³é—­ã€‚ä¸è¿‡ï¼Œç¨‹åºä¼šä¸€ç›´ç­‰å¾…ç›´åˆ°æ‰€æœ‰æäº¤çš„å·¥ä½œè¢«å¤„ç†å®Œæˆã€‚</p><p>è¢«æäº¤åˆ°æ± ä¸­çš„å·¥ä½œå¿…é¡»è¢«å®šä¹‰ä¸ºä¸€ä¸ªå‡½æ•°ã€‚æœ‰ä¸¤ç§æ–¹æ³•å»æäº¤ã€‚ å¦‚æœä½ æƒ³è®©ä¸€ä¸ªåˆ—è¡¨æ¨å¯¼æˆ–ä¸€ä¸ª <code>&lt;span class=&quot;pre&quot;&gt;map()&lt;/span&gt;</code>â€‹ æ“ä½œå¹¶è¡Œæ‰§è¡Œçš„è¯ï¼Œå¯ä½¿ç”¨ <code>&lt;span class=&quot;pre&quot;&gt;pool.map()&lt;/span&gt;</code>â€‹ :</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># A function that performs a lot of work</span><br><span class="line">def work(x):</span><br><span class="line">    ...</span><br><span class="line">    return result</span><br><span class="line"></span><br><span class="line"># Nonparallel code</span><br><span class="line">results = map(work, data)</span><br><span class="line"></span><br><span class="line"># Parallel implementation</span><br><span class="line">with ProcessPoolExecutor() as pool:</span><br><span class="line">    results = pool.map(work, data)</span><br></pre></td></tr></table></figure><p>å¦å¤–ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>&lt;span class=&quot;pre&quot;&gt;pool.submit()&lt;/span&gt;</code>â€‹ æ¥æ‰‹åŠ¨çš„æäº¤å•ä¸ªä»»åŠ¡ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># Some function</span><br><span class="line">def work(x):</span><br><span class="line">    ...</span><br><span class="line">    return result</span><br><span class="line"></span><br><span class="line">with ProcessPoolExecutor() as pool:</span><br><span class="line">    ...</span><br><span class="line">    # Example of submitting work to the pool</span><br><span class="line">    future_result = pool.submit(work, arg)</span><br><span class="line"></span><br><span class="line">    # Obtaining the result (blocks until done)</span><br><span class="line">    r = future_result.result()</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p>å¦‚æœä½ æ‰‹åŠ¨æäº¤ä¸€ä¸ªä»»åŠ¡ï¼Œç»“æœæ˜¯ä¸€ä¸ª <code>&lt;span class=&quot;pre&quot;&gt;Future&lt;/span&gt;</code>â€‹ å®ä¾‹ã€‚ è¦è·å–æœ€ç»ˆç»“æœï¼Œä½ éœ€è¦è°ƒç”¨å®ƒçš„ <code>&lt;span class=&quot;pre&quot;&gt;result()&lt;/span&gt;</code>â€‹ æ–¹æ³•ã€‚ å®ƒä¼šé˜»å¡è¿›ç¨‹ç›´åˆ°ç»“æœè¢«è¿”å›æ¥ã€‚</p><p>å¦‚æœä¸æƒ³é˜»å¡ï¼Œä½ è¿˜å¯ä»¥ä½¿ç”¨ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">def when_done(r):</span><br><span class="line">    print(&#x27;Got:&#x27;, r.result())</span><br><span class="line"></span><br><span class="line">with ProcessPoolExecutor() as pool:</span><br><span class="line">     future_result = pool.submit(work, arg)</span><br><span class="line">     future_result.add_done_callback(when_done)</span><br></pre></td></tr></table></figure><p>å›è°ƒå‡½æ•°æ¥å—ä¸€ä¸ª <code>&lt;span class=&quot;pre&quot;&gt;Future&lt;/span&gt;</code>â€‹ å®ä¾‹ï¼Œè¢«ç”¨æ¥è·å–æœ€ç»ˆçš„ç»“æœï¼ˆæ¯”å¦‚é€šè¿‡è°ƒç”¨å®ƒçš„result()æ–¹æ³•ï¼‰ã€‚ å°½ç®¡å¤„ç†æ± å¾ˆå®¹æ˜“ä½¿ç”¨ï¼Œåœ¨è®¾è®¡å¤§ç¨‹åºçš„æ—¶å€™è¿˜æ˜¯æœ‰å¾ˆå¤šéœ€è¦æ³¨æ„çš„åœ°æ–¹ï¼Œå¦‚ä¸‹å‡ ç‚¹ï¼š</p><ul><li>è¿™ç§å¹¶è¡Œå¤„ç†æŠ€æœ¯åªé€‚ç”¨äºé‚£äº›å¯ä»¥è¢«åˆ†è§£ä¸ºäº’ç›¸ç‹¬ç«‹éƒ¨åˆ†çš„é—®é¢˜ã€‚</li><li>è¢«æäº¤çš„ä»»åŠ¡å¿…é¡»æ˜¯ç®€å•å‡½æ•°å½¢å¼ã€‚å¯¹äºæ–¹æ³•ã€é—­åŒ…å’Œå…¶ä»–ç±»å‹çš„å¹¶è¡Œæ‰§è¡Œè¿˜ä¸æ”¯æŒã€‚</li><li>å‡½æ•°å‚æ•°å’Œè¿”å›å€¼å¿…é¡»å…¼å®¹pickleï¼Œå› ä¸ºè¦ä½¿ç”¨åˆ°è¿›ç¨‹é—´çš„é€šä¿¡ï¼Œæ‰€æœ‰è§£é‡Šå™¨ä¹‹é—´çš„äº¤æ¢æ•°æ®å¿…é¡»è¢«åºåˆ—åŒ–</li><li>è¢«æäº¤çš„ä»»åŠ¡å‡½æ•°ä¸åº”ä¿ç•™çŠ¶æ€æˆ–æœ‰å‰¯ä½œç”¨ã€‚é™¤äº†æ‰“å°æ—¥å¿—ä¹‹ç±»ç®€å•çš„äº‹æƒ…ï¼Œ</li></ul><p>ä¸€æ—¦å¯åŠ¨ä½ ä¸èƒ½æ§åˆ¶å­è¿›ç¨‹çš„ä»»ä½•è¡Œä¸ºï¼Œå› æ­¤æœ€å¥½ä¿æŒç®€å•å’Œçº¯æ´â€”â€”å‡½æ•°ä¸è¦å»ä¿®æ”¹ç¯å¢ƒã€‚</p><ul><li>åœ¨Unixä¸Šè¿›ç¨‹æ± é€šè¿‡è°ƒç”¨ <code>&lt;span class=&quot;pre&quot;&gt;fork()&lt;/span&gt;</code>â€‹ ç³»ç»Ÿè°ƒç”¨è¢«åˆ›å»ºï¼Œ</li></ul><p>å®ƒä¼šå…‹éš†Pythonè§£é‡Šå™¨ï¼ŒåŒ…æ‹¬forkæ—¶çš„æ‰€æœ‰ç¨‹åºçŠ¶æ€ã€‚ è€Œåœ¨Windowsä¸Šï¼Œå…‹éš†è§£é‡Šå™¨æ—¶ä¸ä¼šå…‹éš†çŠ¶æ€ã€‚ å®é™…çš„forkæ“ä½œä¼šåœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨ <code>&lt;span class=&quot;pre&quot;&gt;pool.map()&lt;/span&gt;</code>â€‹ æˆ– <code>&lt;span class=&quot;pre&quot;&gt;pool.submit()&lt;/span&gt;</code>â€‹ åå‘ç”Ÿã€‚</p><ul><li>å½“ä½ æ··åˆä½¿ç”¨è¿›ç¨‹æ± å’Œå¤šçº¿ç¨‹çš„æ—¶å€™è¦ç‰¹åˆ«å°å¿ƒã€‚</li></ul><p>ä½ åº”è¯¥åœ¨åˆ›å»ºä»»ä½•çº¿ç¨‹ä¹‹å‰å…ˆåˆ›å»ºå¹¶æ¿€æ´»è¿›ç¨‹æ± ï¼ˆæ¯”å¦‚åœ¨ç¨‹åºå¯åŠ¨çš„mainçº¿ç¨‹ä¸­åˆ›å»ºè¿›ç¨‹æ± ï¼‰ã€‚</p><h1 id="Pyçš„å…¨å±€é”é—®é¢˜"><a href="#Pyçš„å…¨å±€é”é—®é¢˜" class="headerlink" title="Pyçš„å…¨å±€é”é—®é¢˜"></a>Pyçš„å…¨å±€é”é—®é¢˜</h1><p>å°½ç®¡Pythonå®Œå…¨æ”¯æŒå¤šçº¿ç¨‹ç¼–ç¨‹ï¼Œ ä½†æ˜¯è§£é‡Šå™¨çš„Cè¯­è¨€å®ç°éƒ¨åˆ†åœ¨å®Œå…¨å¹¶è¡Œæ‰§è¡Œæ—¶å¹¶ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ å®é™…ä¸Šï¼Œè§£é‡Šå™¨è¢«ä¸€ä¸ªå…¨å±€è§£é‡Šå™¨é”ä¿æŠ¤ç€ï¼Œå®ƒç¡®ä¿ä»»ä½•æ—¶å€™éƒ½åªæœ‰ä¸€ä¸ªPythonçº¿ç¨‹æ‰§è¡Œã€‚ GILæœ€å¤§çš„é—®é¢˜å°±æ˜¯Pythonçš„å¤šçº¿ç¨‹ç¨‹åºå¹¶ä¸èƒ½åˆ©ç”¨å¤šæ ¸CPUçš„ä¼˜åŠ¿ ï¼ˆæ¯”å¦‚ä¸€ä¸ªä½¿ç”¨äº†å¤šä¸ªçº¿ç¨‹çš„è®¡ç®—å¯†é›†å‹ç¨‹åºåªä¼šåœ¨ä¸€ä¸ªå•CPUä¸Šé¢è¿è¡Œï¼‰ã€‚</p><p>åœ¨è®¨è®ºæ™®é€šçš„GILä¹‹å‰ï¼Œ<strong>æœ‰ä¸€ç‚¹è¦å¼ºè°ƒçš„æ˜¯GILåªä¼šå½±å“åˆ°é‚£äº›ä¸¥é‡ä¾èµ–CPUçš„ç¨‹åº</strong>ï¼ˆæ¯”å¦‚è®¡ç®—å‹çš„ï¼‰ã€‚ å¦‚æœä½ çš„ç¨‹åºå¤§éƒ¨åˆ†åªä¼šæ¶‰åŠåˆ°I/Oï¼Œæ¯”å¦‚ç½‘ç»œäº¤äº’ï¼Œé‚£ä¹ˆä½¿ç”¨å¤šçº¿ç¨‹å°±å¾ˆåˆé€‚ï¼Œ å› ä¸ºå®ƒä»¬å¤§éƒ¨åˆ†æ—¶é—´éƒ½åœ¨ç­‰å¾…ã€‚å®é™…ä¸Šï¼Œä½ å®Œå…¨å¯ä»¥æ”¾å¿ƒçš„åˆ›å»ºå‡ åƒä¸ªPythonçº¿ç¨‹ï¼Œ ç°ä»£æ“ä½œç³»ç»Ÿè¿è¡Œè¿™ä¹ˆå¤šçº¿ç¨‹æ²¡æœ‰ä»»ä½•å‹åŠ›ï¼Œæ²¡å•¥å¯æ‹…å¿ƒçš„ã€‚</p><p>è€Œå¯¹äºä¾èµ–CPUçš„ç¨‹åºï¼Œä½ éœ€è¦å¼„æ¸…æ¥šæ‰§è¡Œçš„è®¡ç®—çš„ç‰¹ç‚¹ã€‚ ä¾‹å¦‚ï¼Œä¼˜åŒ–åº•å±‚ç®—æ³•è¦æ¯”ä½¿ç”¨å¤šçº¿ç¨‹è¿è¡Œå¿«å¾—å¤šã€‚ ç±»ä¼¼çš„ï¼Œç”±äºPythonæ˜¯è§£é‡Šæ‰§è¡Œçš„ï¼Œå¦‚æœä½ å°†é‚£äº›æ€§èƒ½ç“¶é¢ˆä»£ç ç§»åˆ°ä¸€ä¸ªCè¯­è¨€æ‰©å±•æ¨¡å—ä¸­ï¼Œ é€Ÿåº¦ä¹Ÿä¼šæå‡çš„å¾ˆå¿«ã€‚å¦‚æœä½ è¦æ“ä½œæ•°ç»„ï¼Œé‚£ä¹ˆä½¿ç”¨NumPyè¿™æ ·çš„æ‰©å±•ä¼šéå¸¸çš„é«˜æ•ˆã€‚ æœ€åï¼Œä½ è¿˜å¯ä»¥è€ƒè™‘ä¸‹å…¶ä»–å¯é€‰å®ç°æ–¹æ¡ˆï¼Œæ¯”å¦‚PyPyï¼Œå®ƒé€šè¿‡ä¸€ä¸ªJITç¼–è¯‘å™¨æ¥ä¼˜åŒ–æ‰§è¡Œæ•ˆç‡ ï¼ˆä¸è¿‡åœ¨å†™è¿™æœ¬ä¹¦çš„æ—¶å€™å®ƒè¿˜ä¸èƒ½æ”¯æŒPython 3ï¼‰ã€‚</p><p>è¿˜æœ‰ä¸€ç‚¹è¦æ³¨æ„çš„æ˜¯ï¼Œçº¿ç¨‹ä¸æ˜¯ä¸“é—¨ç”¨æ¥ä¼˜åŒ–æ€§èƒ½çš„ã€‚ ä¸€ä¸ªCPUä¾èµ–å‹ç¨‹åºå¯èƒ½ä¼šä½¿ç”¨çº¿ç¨‹æ¥ç®¡ç†ä¸€ä¸ªå›¾å½¢ç”¨æˆ·ç•Œé¢ã€ä¸€ä¸ªç½‘ç»œè¿æ¥æˆ–å…¶ä»–æœåŠ¡ã€‚ è¿™æ—¶å€™ï¼ŒGILä¼šäº§ç”Ÿä¸€äº›é—®é¢˜ï¼Œå› ä¸ºå¦‚æœä¸€ä¸ªçº¿ç¨‹é•¿æœŸæŒæœ‰GILçš„è¯ä¼šå¯¼è‡´å…¶ä»–éCPUå‹çº¿ç¨‹ä¸€ç›´ç­‰å¾…ã€‚ äº‹å®ä¸Šï¼Œä¸€ä¸ªå†™çš„ä¸å¥½çš„Cè¯­è¨€æ‰©å±•ä¼šå¯¼è‡´è¿™ä¸ªé—®é¢˜æ›´åŠ ä¸¥é‡ï¼Œ å°½ç®¡ä»£ç çš„è®¡ç®—éƒ¨åˆ†ä¼šæ¯”ä¹‹å‰è¿è¡Œçš„æ›´å¿«äº›ã€‚</p><p>è¯´äº†è¿™ä¹ˆå¤šï¼Œç°åœ¨æƒ³è¯´çš„æ˜¯æˆ‘ä»¬æœ‰ä¸¤ç§ç­–ç•¥æ¥è§£å†³GILçš„ç¼ºç‚¹ã€‚ é¦–å…ˆï¼Œå¦‚æœä½ å®Œå…¨å·¥ä½œäºPythonç¯å¢ƒä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>&lt;span class=&quot;pre&quot;&gt;multiprocessing&lt;/span&gt;</code>â€‹ æ¨¡å—æ¥åˆ›å»ºä¸€ä¸ªè¿›ç¨‹æ± ï¼Œ å¹¶åƒååŒå¤„ç†å™¨ä¸€æ ·çš„ä½¿ç”¨å®ƒã€‚ä¾‹å¦‚ï¼Œå‡å¦‚ä½ æœ‰å¦‚ä¸‹çš„çº¿ç¨‹ä»£ç ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># Performs a large calculation (CPU bound)</span><br><span class="line">def some_work(args):</span><br><span class="line">    ...</span><br><span class="line">    return result</span><br><span class="line"></span><br><span class="line"># A thread that calls the above function</span><br><span class="line">def some_thread():</span><br><span class="line">    while True:</span><br><span class="line">        ...</span><br><span class="line">        r = some_work(args)</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ä»£ç ï¼Œä½¿ç”¨è¿›ç¨‹æ± ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># Processing pool (see below for initiazation)</span><br><span class="line">pool = None</span><br><span class="line"></span><br><span class="line"># Performs a large calculation (CPU bound)</span><br><span class="line">def some_work(args):</span><br><span class="line">    ...</span><br><span class="line">    return result</span><br><span class="line"></span><br><span class="line"># A thread that calls the above function</span><br><span class="line">def some_thread():</span><br><span class="line">    while True:</span><br><span class="line">        ...</span><br><span class="line">        r = pool.apply(some_work, (args))</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line"># Initiaze the pool</span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    import multiprocessing</span><br><span class="line">    pool = multiprocessing.Pool()</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªé€šè¿‡ä½¿ç”¨ä¸€ä¸ªæŠ€å·§åˆ©ç”¨è¿›ç¨‹æ± è§£å†³äº†GILçš„é—®é¢˜ã€‚ å½“ä¸€ä¸ªçº¿ç¨‹æƒ³è¦æ‰§è¡ŒCPUå¯†é›†å‹å·¥ä½œæ—¶ï¼Œä¼šå°†ä»»åŠ¡å‘ç»™è¿›ç¨‹æ± ã€‚ ç„¶åè¿›ç¨‹æ± ä¼šåœ¨å¦å¤–ä¸€ä¸ªè¿›ç¨‹ä¸­å¯åŠ¨ä¸€ä¸ªå•ç‹¬çš„Pythonè§£é‡Šå™¨æ¥å·¥ä½œã€‚ å½“çº¿ç¨‹ç­‰å¾…ç»“æœçš„æ—¶å€™ä¼šé‡Šæ”¾GILã€‚ å¹¶ä¸”ï¼Œç”±äºè®¡ç®—ä»»åŠ¡åœ¨å•ç‹¬è§£é‡Šå™¨ä¸­æ‰§è¡Œï¼Œé‚£ä¹ˆå°±ä¸ä¼šå—é™äºGILäº†ã€‚ åœ¨ä¸€ä¸ªå¤šæ ¸ç³»ç»Ÿä¸Šé¢ï¼Œä½ ä¼šå‘ç°è¿™ä¸ªæŠ€æœ¯å¯ä»¥è®©ä½ å¾ˆå¥½çš„åˆ©ç”¨å¤šCPUçš„ä¼˜åŠ¿ã€‚</p><p>å¦å¤–ä¸€ä¸ªè§£å†³GILçš„ç­–ç•¥æ˜¯ä½¿ç”¨<strong>Cæ‰©å±•ç¼–ç¨‹æŠ€æœ¯</strong>ã€‚ ä¸»è¦æ€æƒ³æ˜¯å°†è®¡ç®—å¯†é›†å‹ä»»åŠ¡è½¬ç§»ç»™Cï¼Œè·ŸPythonç‹¬ç«‹ï¼Œåœ¨å·¥ä½œçš„æ—¶å€™åœ¨Cä»£ç ä¸­é‡Šæ”¾GILã€‚ è¿™å¯ä»¥é€šè¿‡åœ¨Cä»£ç ä¸­æ’å…¥ä¸‹é¢è¿™æ ·çš„ç‰¹æ®Šå®æ¥å®Œæˆï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#include &quot;Python.h&quot;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">PyObject *pyfunc(PyObject *self, PyObject *args) &#123;</span><br><span class="line">   ...</span><br><span class="line">   Py_BEGIN_ALLOW_THREADS</span><br><span class="line">   // Threaded C code</span><br><span class="line">   ...</span><br><span class="line">   Py_END_ALLOW_THREADS</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœä½ ä½¿ç”¨å…¶ä»–å·¥å…·è®¿é—®Cè¯­è¨€ï¼Œæ¯”å¦‚å¯¹äºCythonçš„ctypesåº“ï¼Œä½ ä¸éœ€è¦åšä»»ä½•äº‹ã€‚ ä¾‹å¦‚ï¼Œctypesåœ¨è°ƒç”¨Cæ—¶ä¼šè‡ªåŠ¨é‡Šæ”¾GILã€‚</p><h2 id="è®¨è®º-8"><a href="#è®¨è®º-8" class="headerlink" title="è®¨è®º"></a>è®¨è®º</h2><p>è®¸å¤šç¨‹åºå‘˜åœ¨é¢å¯¹çº¿ç¨‹æ€§èƒ½é—®é¢˜çš„æ—¶å€™ï¼Œé©¬ä¸Šå°±ä¼šæ€ªç½ªGILï¼Œä»€ä¹ˆéƒ½æ˜¯å®ƒçš„é—®é¢˜ã€‚ å…¶å®è¿™æ ·å­å¤ªä¸åšé“ä¹Ÿå¤ªå¤©çœŸäº†ç‚¹ã€‚ ä½œä¸ºä¸€ä¸ªçœŸå®çš„ä¾‹å­ï¼Œåœ¨å¤šçº¿ç¨‹çš„ç½‘ç»œç¼–ç¨‹ä¸­ç¥ç§˜çš„ <code>&lt;span class=&quot;pre&quot;&gt;stalls&lt;/span&gt;</code>â€‹ å¯èƒ½æ˜¯å› ä¸ºå…¶ä»–åŸå› æ¯”å¦‚ä¸€ä¸ªDNSæŸ¥æ‰¾å»¶æ—¶ï¼Œè€Œè·ŸGILæ¯«æ— å…³ç³»ã€‚ æœ€åä½ çœŸçš„éœ€è¦å…ˆå»ææ‡‚ä½ çš„ä»£ç æ˜¯å¦çœŸçš„è¢«GILå½±å“åˆ°ã€‚ åŒæ—¶è¿˜è¦æ˜ç™½GILå¤§éƒ¨åˆ†éƒ½åº”è¯¥åªå…³æ³¨CPUçš„å¤„ç†è€Œä¸æ˜¯I/O.</p><p>å¦‚æœä½ å‡†å¤‡ä½¿ç”¨ä¸€ä¸ªå¤„ç†å™¨æ± ï¼Œæ³¨æ„çš„æ˜¯è¿™æ ·åšæ¶‰åŠåˆ°æ•°æ®åºåˆ—åŒ–å’Œåœ¨ä¸åŒPythonè§£é‡Šå™¨é€šä¿¡ã€‚ è¢«æ‰§è¡Œçš„æ“ä½œéœ€è¦æ”¾åœ¨ä¸€ä¸ªé€šè¿‡defè¯­å¥å®šä¹‰çš„Pythonå‡½æ•°ä¸­ï¼Œä¸èƒ½æ˜¯lambdaã€é—­åŒ…å¯è°ƒç”¨å®ä¾‹ç­‰ï¼Œ å¹¶ä¸”å‡½æ•°å‚æ•°å’Œè¿”å›å€¼å¿…é¡»è¦å…¼å®¹pickleã€‚ åŒæ ·ï¼Œè¦æ‰§è¡Œçš„ä»»åŠ¡é‡å¿…é¡»è¶³å¤Ÿå¤§ä»¥å¼¥è¡¥é¢å¤–çš„é€šä¿¡å¼€é”€ã€‚</p><p>å¦å¤–ä¸€ä¸ªéš¾ç‚¹æ˜¯å½“æ··åˆä½¿ç”¨çº¿ç¨‹å’Œè¿›ç¨‹æ± çš„æ—¶å€™ä¼šè®©ä½ å¾ˆå¤´ç–¼ã€‚ å¦‚æœä½ è¦åŒæ—¶ä½¿ç”¨ä¸¤è€…ï¼Œæœ€å¥½åœ¨ç¨‹åºå¯åŠ¨æ—¶ï¼Œåˆ›å»ºä»»ä½•çº¿ç¨‹ä¹‹å‰å…ˆåˆ›å»ºä¸€ä¸ªå•ä¾‹çš„è¿›ç¨‹æ± ã€‚ ç„¶åçº¿ç¨‹ä½¿ç”¨åŒæ ·çš„è¿›ç¨‹æ± æ¥è¿›è¡Œå®ƒä»¬çš„è®¡ç®—å¯†é›†å‹å·¥ä½œã€‚</p><p>Cæ‰©å±•æœ€é‡è¦çš„ç‰¹å¾æ˜¯å®ƒä»¬å’ŒPythonè§£é‡Šå™¨æ˜¯ä¿æŒç‹¬ç«‹çš„ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä½ å‡†å¤‡å°†Pythonä¸­çš„ä»»åŠ¡åˆ†é…åˆ°Cä¸­å»æ‰§è¡Œï¼Œ ä½ éœ€è¦ç¡®ä¿Cä»£ç çš„æ“ä½œè·ŸPythonä¿æŒç‹¬ç«‹ï¼Œ è¿™å°±æ„å‘³ç€ä¸è¦ä½¿ç”¨Pythonæ•°æ®ç»“æ„ä»¥åŠä¸è¦è°ƒç”¨Pythonçš„C APIã€‚ å¦å¤–ä¸€ä¸ªå°±æ˜¯ä½ è¦ç¡®ä¿Cæ‰©å±•æ‰€åšçš„å·¥ä½œæ˜¯è¶³å¤Ÿçš„ï¼Œå€¼å¾—ä½ è¿™æ ·åšã€‚ ä¹Ÿå°±æ˜¯è¯´Cæ‰©å±•æ‹…è´Ÿèµ·äº†å¤§é‡çš„è®¡ç®—ä»»åŠ¡ï¼Œè€Œä¸æ˜¯å°‘æ•°å‡ ä¸ªè®¡ç®—ã€‚</p><p>è¿™äº›è§£å†³GILçš„æ–¹æ¡ˆå¹¶ä¸èƒ½é€‚ç”¨äºæ‰€æœ‰é—®é¢˜ã€‚ ä¾‹å¦‚ï¼ŒæŸäº›ç±»å‹çš„åº”ç”¨ç¨‹åºå¦‚æœè¢«åˆ†è§£ä¸ºå¤šä¸ªè¿›ç¨‹å¤„ç†çš„è¯å¹¶ä¸èƒ½å¾ˆå¥½çš„å·¥ä½œï¼Œ ä¹Ÿä¸èƒ½å°†å®ƒçš„éƒ¨åˆ†ä»£ç æ”¹æˆCè¯­è¨€æ‰§è¡Œã€‚ å¯¹äºè¿™äº›åº”ç”¨ç¨‹åºï¼Œä½ å°±è¦è‡ªå·±éœ€æ±‚è§£å†³æ–¹æ¡ˆäº† ï¼ˆæ¯”å¦‚å¤šè¿›ç¨‹è®¿é—®å…±äº«å†…å­˜åŒºï¼Œå¤šè§£æå™¨è¿è¡ŒäºåŒä¸€ä¸ªè¿›ç¨‹ç­‰ï¼‰ã€‚ æˆ–è€…ï¼Œä½ è¿˜å¯ä»¥è€ƒè™‘ä¸‹å…¶ä»–çš„è§£é‡Šå™¨å®ç°ï¼Œæ¯”å¦‚PyPyã€‚</p><p>äº†è§£æ›´å¤šå…³äºåœ¨Cæ‰©å±•ä¸­é‡Šæ”¾GILï¼Œè¯·å‚è€ƒ15.7å’Œ15.10å°èŠ‚ã€‚</p><p>â€</p><h1 id="Actoræ¨¡å¼"><a href="#Actoræ¨¡å¼" class="headerlink" title="Actoræ¨¡å¼"></a>Actoræ¨¡å¼</h1><p><strong>actoræ¨¡å¼æ˜¯ä¸€ç§æœ€å¤è€çš„ä¹Ÿæ˜¯æœ€ç®€å•çš„å¹¶è¡Œå’Œåˆ†å¸ƒå¼è®¡ç®—è§£å†³æ–¹æ¡ˆã€‚</strong>  äº‹å®ä¸Šï¼Œå®ƒå¤©ç”Ÿçš„ç®€å•æ€§æ˜¯å®ƒå¦‚æ­¤å—æ¬¢è¿çš„é‡è¦åŸå› ä¹‹ä¸€ã€‚ ç®€å•æ¥è®²ï¼Œä¸€ä¸ªactorå°±æ˜¯ä¸€ä¸ªå¹¶å‘æ‰§è¡Œçš„ä»»åŠ¡ï¼Œåªæ˜¯ç®€å•çš„æ‰§è¡Œå‘é€ç»™å®ƒçš„æ¶ˆæ¯ä»»åŠ¡ã€‚ å“åº”è¿™äº›æ¶ˆæ¯æ—¶ï¼Œå®ƒå¯èƒ½è¿˜ä¼šç»™å…¶ä»–actorå‘é€æ›´è¿›ä¸€æ­¥çš„æ¶ˆæ¯ã€‚ actorä¹‹é—´çš„é€šä¿¡æ˜¯å•å‘å’Œå¼‚æ­¥çš„ã€‚å› æ­¤ï¼Œæ¶ˆæ¯å‘é€è€…ä¸çŸ¥é“æ¶ˆæ¯æ˜¯ä»€ä¹ˆæ—¶å€™è¢«å‘é€ï¼Œ ä¹Ÿä¸ä¼šæ¥æ”¶åˆ°ä¸€ä¸ªæ¶ˆæ¯å·²è¢«å¤„ç†çš„å›åº”æˆ–é€šçŸ¥ã€‚</p><p>ç»“åˆä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹å’Œä¸€ä¸ªé˜Ÿåˆ—å¯ä»¥å¾ˆå®¹æ˜“çš„å®šä¹‰actorï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> queue <span class="keyword">import</span> Queue</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread, Event</span><br><span class="line"></span><br><span class="line"><span class="comment"># Sentinel used for shutdown</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ActorExit</span>(<span class="title class_ inherited__">Exception</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Actor</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self._mailbox = Queue()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">send</span>(<span class="params">self, msg</span>):</span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        Send a message to the actor</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        self._mailbox.put(msg)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">recv</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        Receive an incoming message</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        msg = self._mailbox.get()</span><br><span class="line">        <span class="keyword">if</span> msg <span class="keyword">is</span> ActorExit:</span><br><span class="line">            <span class="keyword">raise</span> ActorExit()</span><br><span class="line">        <span class="keyword">return</span> msg</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">close</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        Close the actor, thus shutting it down</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        self.send(ActorExit)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">start</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        Start concurrent execution</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        self._terminated = Event()</span><br><span class="line">        t = Thread(target=self._bootstrap)</span><br><span class="line"></span><br><span class="line">        t.daemon = <span class="literal">True</span></span><br><span class="line">        t.start()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_bootstrap</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.run()</span><br><span class="line">        <span class="keyword">except</span> ActorExit:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            self._terminated.<span class="built_in">set</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">join</span>(<span class="params">self</span>):</span><br><span class="line">        self._terminated.wait()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        Run method to be implemented by the user</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            msg = self.recv()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Sample ActorTask</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PrintActor</span>(<span class="title class_ inherited__">Actor</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            msg = self.recv()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;Got:&#x27;</span>, msg)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Sample use</span></span><br><span class="line">p = PrintActor()</span><br><span class="line">p.start()</span><br><span class="line">p.send(<span class="string">&#x27;Hello&#x27;</span>)</span><br><span class="line">p.send(<span class="string">&#x27;World&#x27;</span>)</span><br><span class="line">p.close()</span><br><span class="line">p.join()</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªä¾‹å­ä¸­ï¼Œä½ ä½¿ç”¨actorå®ä¾‹çš„ <code>&lt;span class=&quot;pre&quot;&gt;send()&lt;/span&gt;</code>â€‹ æ–¹æ³•å‘é€æ¶ˆæ¯ç»™å®ƒä»¬ã€‚ å…¶æœºåˆ¶æ˜¯ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šå°†æ¶ˆæ¯æ”¾å…¥ä¸€ä¸ªé˜Ÿé‡Œä¸­ï¼Œ ç„¶åå°†å…¶è½¬äº¤ç»™å¤„ç†è¢«æ¥å—æ¶ˆæ¯çš„ä¸€ä¸ªå†…éƒ¨çº¿ç¨‹ã€‚ <code>&lt;span class=&quot;pre&quot;&gt;close()&lt;/span&gt;</code>â€‹ æ–¹æ³•é€šè¿‡åœ¨é˜Ÿåˆ—ä¸­æ”¾å…¥ä¸€ä¸ªç‰¹æ®Šçš„å“¨å…µå€¼ï¼ˆActorExitï¼‰æ¥å…³é—­è¿™ä¸ªactorã€‚ ç”¨æˆ·å¯ä»¥é€šè¿‡ç»§æ‰¿Actorå¹¶å®šä¹‰å®ç°è‡ªå·±å¤„ç†é€»è¾‘run()æ–¹æ³•æ¥å®šä¹‰æ–°çš„actorã€‚ <code>&lt;span class=&quot;pre&quot;&gt;ActorExit&lt;/span&gt;</code>â€‹ å¼‚å¸¸çš„ä½¿ç”¨å°±æ˜¯ç”¨æˆ·è‡ªå®šä¹‰ä»£ç å¯ä»¥åœ¨éœ€è¦çš„æ—¶å€™æ¥æ•è·ç»ˆæ­¢è¯·æ±‚ ï¼ˆå¼‚å¸¸è¢«get()æ–¹æ³•æŠ›å‡ºå¹¶ä¼ æ’­å‡ºå»ï¼‰ã€‚</p><p>å¦‚æœä½ æ”¾å®½å¯¹äºåŒæ­¥å’Œå¼‚æ­¥æ¶ˆæ¯å‘é€çš„è¦æ±‚ï¼Œ ç±»actorå¯¹è±¡è¿˜å¯ä»¥é€šè¿‡ç”Ÿæˆå™¨æ¥ç®€åŒ–å®šä¹‰ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">def print_actor():</span><br><span class="line">    while True:</span><br><span class="line"></span><br><span class="line">        try:</span><br><span class="line">            msg = yield      # Get a message</span><br><span class="line">            print(&#x27;Got:&#x27;, msg)</span><br><span class="line">        except GeneratorExit:</span><br><span class="line">            print(&#x27;Actor terminating&#x27;)</span><br><span class="line"></span><br><span class="line"># Sample use</span><br><span class="line">p = print_actor()</span><br><span class="line">next(p)     # Advance to the yield (ready to receive)</span><br><span class="line">p.send(&#x27;Hello&#x27;)</span><br><span class="line">p.send(&#x27;World&#x27;)</span><br><span class="line">p.close()</span><br></pre></td></tr></table></figure><h2 id="è®¨è®º-9"><a href="#è®¨è®º-9" class="headerlink" title="è®¨è®º"></a>è®¨è®º</h2><p>actoræ¨¡å¼çš„é­…åŠ›å°±åœ¨äºå®ƒçš„ç®€å•æ€§ã€‚ å®é™…ä¸Šï¼Œè¿™é‡Œä»…ä»…åªæœ‰ä¸€ä¸ªæ ¸å¿ƒæ“ä½œ <code>&lt;span class=&quot;pre&quot;&gt;send()&lt;/span&gt;</code>â€‹ . ç”šè‡³ï¼Œå¯¹äºåœ¨åŸºäºactorç³»ç»Ÿä¸­çš„â€œæ¶ˆæ¯â€çš„æ³›åŒ–æ¦‚å¿µå¯ä»¥å·²å¤šç§æ–¹å¼è¢«æ‰©å±•ã€‚ ä¾‹å¦‚ï¼Œä½ å¯ä»¥ä»¥å…ƒç»„å½¢å¼ä¼ é€’æ ‡ç­¾æ¶ˆæ¯ï¼Œè®©actoræ‰§è¡Œä¸åŒçš„æ“ä½œï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">class TaggedActor(Actor):</span><br><span class="line">    def run(self):</span><br><span class="line">        while True:</span><br><span class="line">             tag, *payload = self.recv()</span><br><span class="line">             getattr(self,&#x27;do_&#x27;+tag)(*payload)</span><br><span class="line"></span><br><span class="line">    # Methods correponding to different message tags</span><br><span class="line">    def do_A(self, x):</span><br><span class="line">        print(&#x27;Running A&#x27;, x)</span><br><span class="line"></span><br><span class="line">    def do_B(self, x, y):</span><br><span class="line">        print(&#x27;Running B&#x27;, x, y)</span><br><span class="line"></span><br><span class="line"># Example</span><br><span class="line">a = TaggedActor()</span><br><span class="line">a.start()</span><br><span class="line">a.send((&#x27;A&#x27;, 1))      # Invokes do_A(1)</span><br><span class="line">a.send((&#x27;B&#x27;, 2, 3))   # Invokes do_B(2,3)</span><br><span class="line">a.close()</span><br><span class="line">a.join()</span><br></pre></td></tr></table></figure><p>ä½œä¸ºå¦å¤–ä¸€ä¸ªä¾‹å­ï¼Œä¸‹é¢çš„actorå…è®¸åœ¨ä¸€ä¸ªå·¥ä½œè€…ä¸­è¿è¡Œä»»æ„çš„å‡½æ•°ï¼Œ å¹¶ä¸”é€šè¿‡ä¸€ä¸ªç‰¹æ®Šçš„Resultå¯¹è±¡è¿”å›ç»“æœï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from threading import Event</span><br><span class="line">class Result:</span><br><span class="line">    def __init__(self):</span><br><span class="line">        self._evt = Event()</span><br><span class="line">        self._result = None</span><br><span class="line"></span><br><span class="line">    def set_result(self, value):</span><br><span class="line">        self._result = value</span><br><span class="line"></span><br><span class="line">        self._evt.set()</span><br><span class="line"></span><br><span class="line">    def result(self):</span><br><span class="line">        self._evt.wait()</span><br><span class="line">        return self._result</span><br><span class="line"></span><br><span class="line">class Worker(Actor):</span><br><span class="line">    def submit(self, func, *args, **kwargs):</span><br><span class="line">        r = Result()</span><br><span class="line">        self.send((func, args, kwargs, r))</span><br><span class="line">        return r</span><br><span class="line"></span><br><span class="line">    def run(self):</span><br><span class="line">        while True:</span><br><span class="line">            func, args, kwargs, r = self.recv()</span><br><span class="line">            r.set_result(func(*args, **kwargs))</span><br><span class="line"></span><br><span class="line"># Example use</span><br><span class="line">worker = Worker()</span><br><span class="line">worker.start()</span><br><span class="line">r = worker.submit(pow, 2, 3)</span><br><span class="line">worker.close()</span><br><span class="line">worker.join()</span><br><span class="line">print(r.result())</span><br></pre></td></tr></table></figure><p>æœ€åï¼Œâ€œå‘é€â€ä¸€ä¸ªä»»åŠ¡æ¶ˆæ¯çš„æ¦‚å¿µå¯ä»¥è¢«æ‰©å±•åˆ°å¤šè¿›ç¨‹ç”šè‡³æ˜¯å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å»ã€‚ ä¾‹å¦‚ï¼Œä¸€ä¸ªç±»actorå¯¹è±¡çš„ <code>send()</code>â€‹ æ–¹æ³•å¯ä»¥è¢«ç¼–ç¨‹è®©å®ƒèƒ½åœ¨ä¸€ä¸ªå¥—æ¥å­—è¿æ¥ä¸Šä¼ è¾“æ•°æ® æˆ–é€šè¿‡æŸäº›æ¶ˆæ¯ä¸­é—´ä»¶ï¼ˆæ¯”å¦‚AMQPã€ZMQç­‰ï¼‰æ¥å‘é€ã€‚</p><h1 id="å®ç°æ¶ˆæ¯å‘å¸ƒ-è®¢é˜…æ¨¡å‹"><a href="#å®ç°æ¶ˆæ¯å‘å¸ƒ-è®¢é˜…æ¨¡å‹" class="headerlink" title="å®ç°æ¶ˆæ¯å‘å¸ƒ/è®¢é˜…æ¨¡å‹"></a>å®ç°æ¶ˆæ¯å‘å¸ƒ/è®¢é˜…æ¨¡å‹</h1><p>TODO</p><h1 id="ä½¿ç”¨ç”Ÿæˆå™¨ä»£æ›¿çº¿ç¨‹"><a href="#ä½¿ç”¨ç”Ÿæˆå™¨ä»£æ›¿çº¿ç¨‹" class="headerlink" title="ä½¿ç”¨ç”Ÿæˆå™¨ä»£æ›¿çº¿ç¨‹"></a>ä½¿ç”¨ç”Ÿæˆå™¨ä»£æ›¿çº¿ç¨‹</h1><p>TODO</p><h1 id="å¤šä¸ªçº¿ç¨‹é˜Ÿåˆ—è½®è¯¢"><a href="#å¤šä¸ªçº¿ç¨‹é˜Ÿåˆ—è½®è¯¢" class="headerlink" title="å¤šä¸ªçº¿ç¨‹é˜Ÿåˆ—è½®è¯¢"></a>å¤šä¸ªçº¿ç¨‹é˜Ÿåˆ—è½®è¯¢</h1><p>TODO</p><h1 id="åœ¨Unixç³»ç»Ÿä¸Šé¢å¯åŠ¨å®ˆæŠ¤çº¿ç¨‹"><a href="#åœ¨Unixç³»ç»Ÿä¸Šé¢å¯åŠ¨å®ˆæŠ¤çº¿ç¨‹" class="headerlink" title="åœ¨Unixç³»ç»Ÿä¸Šé¢å¯åŠ¨å®ˆæŠ¤çº¿ç¨‹"></a>åœ¨Unixç³»ç»Ÿä¸Šé¢å¯åŠ¨å®ˆæŠ¤çº¿ç¨‹</h1><p>TODO</p><h1 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h1><p><a href="https://python3-cookbook.readthedocs.io/zh-cn/latest/chapters/p12_concurrency.html">Python CookBook</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;KeyWords:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;threading.Thread&lt;/li&gt;
&lt;li&gt;threading.Event&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨é˜Ÿåˆ—queue.Queueï¼Œtask_down()ã€join()å®ç°çº¿ç¨‹é€šä¿¡&lt;/li&gt;
&lt;li&gt;</summary>
      
    
    
    
    <category term="Python" scheme="https://guoyujian.github.io/categories/Python/"/>
    
    <category term="å¹¶å‘" scheme="https://guoyujian.github.io/categories/Python/%E5%B9%B6%E5%8F%91/"/>
    
    
    <category term="Python" scheme="https://guoyujian.github.io/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>Fluent Pythonç¬”è®°æŒç»­æ•´ç†</title>
    <link href="https://guoyujian.github.io/2024/03/08/Fluent-Python%E7%AC%94%E8%AE%B0%E6%8C%81%E7%BB%AD%E6%95%B4%E7%90%86/"/>
    <id>https://guoyujian.github.io/2024/03/08/Fluent-Python%E7%AC%94%E8%AE%B0%E6%8C%81%E7%BB%AD%E6%95%B4%E7%90%86/</id>
    <published>2024-03-08T07:22:30.000Z</published>
    <updated>2024-03-14T03:00:25.978Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>åé¢å‡ èŠ‚æ²¡æ•´ç†ï¼›æ²¡æœ‰ç›®å½•ï¼›ä¸€äº›é‡è¦ç« èŠ‚ä¸æ˜¯å¾ˆå…¨ï¼Œä»…ä»…æ˜¯ä»‹ç»ã€‚<br>å¾…æ‹†åˆ†<br>Refï¼š<a href="https://www.52pojie.cn/thread-1816710-1-1.html">https://www.52pojie.cn/thread-1816710-1-1.html</a></p></blockquote><p>åœ¨Pythonä¸­ï¼Œå¦‚æœä¸€ä¸ªç±»å®šä¹‰äº†<code>__getitem__</code>æ–¹æ³•ï¼Œé‚£ä¹ˆè¯¥ç±»çš„å¯¹è±¡å¯ä»¥åƒåºåˆ—ï¼ˆå¦‚åˆ—è¡¨ã€å­—ç¬¦ä¸²ç­‰ï¼‰ä¸€æ ·ä½¿ç”¨ç´¢å¼•è¿ç®—ç¬¦[]æ¥è®¿é—®å…¶å…ƒç´ ã€‚ </p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Seq</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        self.data = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getitem__</span>(<span class="params">self, index</span>):</span><br><span class="line">        <span class="keyword">return</span> self.data[index]</span><br><span class="line">    </span><br><span class="line">seq = Seq()</span><br><span class="line">seq[<span class="number">0</span>:<span class="number">2</span>]</span><br></pre></td></tr></table></figure><p>è¿™ç±»æ–¹æ³•ç§°ä¸ºé­”æœ¯æ–¹æ³•ï¼Œç±»ä¼¼çš„è¿˜æœ‰<code>__len__</code>, <code>__setitem__</code>, <code>__str__</code>, <code>__repr__</code>, <code>__add__</code>, <code>__eq__</code>ç­‰</p><p><code>__str__</code>å’Œ<code>__repr__</code>ç”¨äºå®šä¹‰å¯¹è±¡çš„å­—ç¬¦ä¸²è¡¨ç¤ºå½¢å¼ã€‚<code>__str__</code>æ–¹æ³•ç”¨äºè¿”å›å¯¹è±¡çš„äººç±»å¯è¯»çš„å­—ç¬¦ä¸²è¡¨ç¤ºå½¢å¼ï¼Œé€šå¸¸ç”¨äºæ‰“å°è¾“å‡ºæˆ–æ˜¾ç¤ºç»™ç”¨æˆ·ã€‚ <code>__repr__</code>æ–¹æ³•ç”¨äºè¿”å›å¯¹è±¡çš„å®˜æ–¹å­—ç¬¦ä¸²è¡¨ç¤ºå½¢å¼ï¼Œé€šå¸¸ç”¨äºè°ƒè¯•å’Œå¼€å‘è¿‡ç¨‹ä¸­ã€‚ ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•åœ¨è‡ªå®šä¹‰ç±»ä¸­ä½¿ç”¨<code>__str__</code>å’Œ<code>__repr__</code>æ–¹æ³•ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Point</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, x, y</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;print..Point(<span class="subst">&#123;self.x&#125;</span>, <span class="subst">&#123;self.y&#125;</span>)&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;Point(<span class="subst">&#123;self.x&#125;</span>, <span class="subst">&#123;self.y&#125;</span>)&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">p = Point(<span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line"><span class="built_in">print</span>(p)</span><br><span class="line"><span class="built_in">repr</span>(p)</span><br></pre></td></tr></table></figure><p>æ€»ç»“é­”æœ¯æ–¹æ³• TODO</p><hr><p>åˆ—è¡¨æ¨å¯¼å¼ï¼š [expression for item in iterable if condition]<br>åœ¨å¤„ç†å¤§å‹æ•°æ®é›†æ—¶ï¼Œåˆ—è¡¨æ¨å¯¼å¼å¯èƒ½ä¼šå½±å“æ€§èƒ½ï¼Œè¿™æ—¶åº”è€ƒè™‘ä½¿ç”¨ç”Ÿæˆå™¨è¡¨è¾¾å¼æˆ–å…¶ä»–æ›´é€‚åˆçš„æ–¹æ³•ã€‚</p><p>åœ¨Pythonä¸­ï¼Œmap()å’Œfilter()æ˜¯ä¸¤ä¸ªå†…ç½®å‡½æ•°ï¼Œç”¨äºå¯¹å¯è¿­ä»£å¯¹è±¡è¿›è¡Œæ˜ å°„å’Œè¿‡æ»¤æ“ä½œã€‚ 1. map()å‡½æ•°ï¼š   map()å‡½æ•°æ¥å—ä¸€ä¸ªå‡½æ•°å’Œä¸€ä¸ªæˆ–å¤šä¸ªå¯è¿­ä»£å¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œå°†å‡½æ•°åº”ç”¨äºæ¯ä¸ªå¯è¿­ä»£å¯¹è±¡ä¸­çš„å…ƒç´ ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–°çš„è¿­ä»£å™¨ï¼ˆåœ¨Python 3ä¸­è¿”å›è¿­ä»£å™¨ï¼Œåœ¨Python 2ä¸­è¿”å›åˆ—è¡¨ï¼‰ã€‚    map()å‡½æ•°çš„è¯­æ³•å¦‚ä¸‹ï¼š<br>map(function, iterable, â€¦)  </p><p>filter()å‡½æ•°ï¼š   filter()å‡½æ•°æ¥å—ä¸€ä¸ªå‡½æ•°å’Œä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œæ ¹æ®å‡½æ•°çš„è¿”å›å€¼ï¼ˆTrueæˆ–Falseï¼‰æ¥è¿‡æ»¤å¯è¿­ä»£å¯¹è±¡ä¸­çš„å…ƒç´ ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–°çš„è¿­ä»£å™¨ï¼ˆåœ¨Python 3ä¸­è¿”å›è¿­ä»£å™¨ï¼Œåœ¨Python 2ä¸­è¿”å›åˆ—è¡¨ï¼‰ã€‚    filter()å‡½æ•°çš„è¯­æ³•å¦‚ä¸‹ï¼š   </p><p>filter(function, iterable)</p><p>ä½¿ç”¨map()å’Œfilter()å‡½æ•°å¯ä»¥ç®€åŒ–å¯¹åˆ—è¡¨çš„å¤„ç†ï¼Œä½¿ä»£ç æ›´ç®€æ´ã€å¯è¯»æ€§æ›´é«˜ã€‚ç„¶è€Œï¼Œè¯·æ³¨æ„åœ¨å¤„ç†å¤§å‹æ•°æ®é›†æ—¶ï¼Œè¿™äº›å‡½æ•°å¯èƒ½ä¼šå½±å“æ€§èƒ½ï¼Œè¿™æ—¶åº”è€ƒè™‘ä½¿ç”¨åˆ—è¡¨æ¨å¯¼å¼æˆ–å…¶ä»–æ›´é€‚åˆçš„æ–¹æ³•ã€‚</p><p>ç”Ÿæˆå™¨è¡¨è¾¾å¼ä¸åˆ—è¡¨æ¨å¯¼å¼çš„è¯­æ³•éå¸¸ç›¸ä¼¼ï¼Œåªæ˜¯å°†[]æ›¿æ¢ä¸º()ï¼Œä»è€Œåˆ›å»ºä¸€ä¸ªç”Ÿæˆå™¨å¯¹è±¡è€Œä¸æ˜¯åˆ—è¡¨å¯¹è±¡ã€‚ä»¥ä¸‹æ˜¯ç”Ÿæˆå™¨è¡¨è¾¾å¼çš„ä¸€èˆ¬è¯­æ³•æ ¼å¼</p><p>(expression for item in iterable if condition)</p><p>ä¸åˆ—è¡¨æ¨å¯¼å¼ä¸åŒï¼Œç”Ÿæˆå™¨è¡¨è¾¾å¼ç”Ÿæˆçš„æ˜¯ä¸€ä¸ªè¿­ä»£å™¨ï¼Œè€Œä¸æ˜¯ç«‹å³ç”Ÿæˆä¸€ä¸ªå®Œæ•´çš„åˆ—è¡¨ã€‚è¿™ç§å»¶è¿Ÿè®¡ç®—çš„ç‰¹æ€§ä½¿å¾—ç”Ÿæˆå™¨è¡¨è¾¾å¼éå¸¸é€‚åˆå¤„ç†å¤§æ•°æ®é›†æˆ–æ— é™åºåˆ—ã€‚</p><p>æ‹†åŒ…ï¼šæ‹†åŒ…ï¼ˆUnpackingï¼‰æ˜¯ä¸€ç§å°†åºåˆ—ï¼ˆå¦‚å…ƒç»„æˆ–åˆ—è¡¨ï¼‰ä¸­çš„å…ƒç´ åˆ†é…ç»™å˜é‡çš„æ“ä½œã€‚å®ƒå¯ä»¥æ–¹ä¾¿åœ°å°†åºåˆ—ä¸­çš„å…ƒç´ è§£åŒ…å¹¶èµ‹å€¼ç»™å¤šä¸ªå˜é‡ã€‚ æ‹†åŒ…å¯ä»¥åº”ç”¨äºä»»ä½•å¯è¿­ä»£å¯¹è±¡ï¼Œä¾‹å¦‚å…ƒç»„ã€åˆ—è¡¨ã€é›†åˆç­‰ã€‚è¦è¿›è¡Œæ‹†åŒ…ï¼Œåªéœ€å°†å¯è¿­ä»£å¯¹è±¡æ”¾åœ¨èµ‹å€¼è¯­å¥çš„å·¦ä¾§ï¼Œå¹¶ä½¿ç”¨ä¸å…ƒç´ æ•°é‡ç›¸åŒçš„å˜é‡è¿›è¡Œèµ‹å€¼ã€‚</p><p>ä½¿ç”¨æ‹†åŒ…å¯ä»¥ç®€åŒ–ä»£ç ï¼Œå¹¶ä½¿å…¶æ›´æ˜“è¯»ã€‚å®ƒå…è®¸ä¸€æ¬¡æ€§è®¿é—®å’Œæ“ä½œåºåˆ—ä¸­çš„å¤šä¸ªå…ƒç´ ï¼Œè€Œä¸éœ€è¦ä½¿ç”¨ç´¢å¼•æ¥é€ä¸ªè®¿é—®ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæ‹†åŒ…çš„å˜é‡æ•°é‡ä¸åºåˆ—ä¸­çš„å…ƒç´ æ•°é‡ä¸åŒ¹é…ï¼Œå°†ä¼šå¼•å‘ValueErrorå¼‚å¸¸ã€‚å¦‚æœåªæƒ³æ‹†åŒ…åºåˆ—ä¸­çš„ä¸€éƒ¨åˆ†å…ƒç´ ï¼Œå¯ä»¥ä½¿ç”¨å ä½ç¬¦ï¼ˆå¦‚_ï¼‰æ¥è¡¨ç¤ºä¸éœ€è¦çš„å…ƒç´ ã€‚</p><p>åœ¨Pythonä¸­ï¼Œ* å¯ä»¥ç”¨äºæ‹†åŒ…æ“ä½œï¼Œå®ƒå¯ä»¥å°†å¯è¿­ä»£å¯¹è±¡ä¸­çš„å‰©ä½™å…ƒç´ æ‰“åŒ…æˆä¸€ä¸ªåˆ—è¡¨ã€‚è¿™ç§ç”¨æ³•é€šå¸¸ç§°ä¸ºâ€œå¯å˜é•¿å‚æ•°â€æˆ–â€œå¯å˜é•¿å‚æ•°åˆ—è¡¨â€ã€‚ ä½¿ç”¨å·æ‹†åŒ…å¯ä»¥å¤„ç†å¯å˜é•¿åº¦çš„å‚æ•°åˆ—è¡¨ï¼Œæ— éœ€äº‹å…ˆçŸ¥é“å¯è¿­ä»£å¯¹è±¡ä¸­çš„å…ƒç´ ä¸ªæ•°ã€‚ </p><p>Pythonæ”¯æŒåµŒå¥—æ‹†åŒ…</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">lst = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]</span><br><span class="line">a, *rest, b = lst</span><br><span class="line">rest</span><br></pre></td></tr></table></figure><p>åºåˆ—æ¨¡å¼åŒ¹é…</p><p>ä» Python 3.10 ç‰ˆæœ¬å¼€å§‹ï¼Œå¼•å…¥äº† match è¡¨è¾¾å¼ï¼Œä»¥æä¾›æ›´å¼ºå¤§çš„æ¨¡å¼åŒ¹é…åŠŸèƒ½ã€‚match è¡¨è¾¾å¼å¯ä»¥ç”¨äºåŒ¹é…å’Œè§£æ„å„ç§æ•°æ®ç±»å‹ï¼ŒåŒ…æ‹¬åºåˆ—ç±»å‹ã€‚ ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•åœ¨ Python 3.10 ä¸­ä½¿ç”¨ match è¡¨è¾¾å¼è¿›è¡Œæ¨¡å¼åŒ¹é…ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">process_data</span>(<span class="params">data</span>):</span><br><span class="line">    match data:</span><br><span class="line">        case [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;åŒ¹é…åˆ° [1, 2, 3]&quot;</span>)</span><br><span class="line">        case [<span class="number">4</span>, x, y]:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;åŒ¹é…åˆ° [4, <span class="subst">&#123;x&#125;</span>, <span class="subst">&#123;y&#125;</span>]&quot;</span>)</span><br><span class="line">        case [a, b, c]:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;åŒ¹é…åˆ° [<span class="subst">&#123;a&#125;</span>, <span class="subst">&#123;b&#125;</span>, <span class="subst">&#123;c&#125;</span>]&quot;</span>)</span><br><span class="line">        case _:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;æœªåŒ¹é…åˆ°ä»»ä½•æ¨¡å¼&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æµ‹è¯•ç¤ºä¾‹</span></span><br><span class="line">process_data([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])  <span class="comment"># è¾“å‡º: åŒ¹é…åˆ° [1, 2, 3]</span></span><br><span class="line">process_data([<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>])  <span class="comment"># è¾“å‡º: åŒ¹é…åˆ° [4, 5, 6]</span></span><br><span class="line">process_data([<span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>])  <span class="comment"># è¾“å‡º: åŒ¹é…åˆ° [7, 8, 9]</span></span><br><span class="line">process_data([<span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">13</span>])  <span class="comment"># è¾“å‡º: æœªåŒ¹é…åˆ°ä»»ä½•æ¨¡å¼</span></span><br></pre></td></tr></table></figure><p>å­—å…¸æ¨å¯¼å¼ï¼šå®ƒç±»ä¼¼äºåˆ—è¡¨æ¨å¯¼å¼ï¼Œä½†æ˜¯ç”Ÿæˆçš„ç»“æœæ˜¯å­—å…¸è€Œä¸æ˜¯åˆ—è¡¨ã€‚</p><p>{key_expression: value_expression for item in iterable}</p><p>åœ¨Pythonä¸­ï¼Œdefaultdict æ˜¯ collections æ¨¡å—ä¸­çš„ä¸€ä¸ªç±»ï¼Œå®ƒæ˜¯ dict ç±»çš„ä¸€ä¸ªå­ç±»ï¼Œç”¨äºåˆ›å»ºå…·æœ‰é»˜è®¤å€¼çš„å­—å…¸ã€‚ ä¸æ™®é€šçš„å­—å…¸ä¸åŒï¼Œdefaultdict åœ¨åˆ›å»ºæ—¶éœ€è¦æŒ‡å®šä¸€ä¸ªé»˜è®¤å€¼çš„ç±»å‹ï¼Œå½“è®¿é—®ä¸€ä¸ªä¸å­˜åœ¨çš„é”®æ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨è¿”å›é»˜è®¤å€¼ï¼Œè€Œä¸ä¼šæŠ›å‡º KeyError å¼‚å¸¸ã€‚ ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ defaultdict åˆ›å»ºå…·æœ‰é»˜è®¤å€¼çš„å­—å…¸ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line"></span><br><span class="line">d = defaultdict(<span class="built_in">int</span>)</span><br><span class="line"></span><br><span class="line">d[<span class="string">&#x27;a&#x27;</span>] = <span class="number">1</span></span><br><span class="line">d[<span class="string">&#x27;b&#x27;</span>]  <span class="comment"># 0 </span></span><br></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªå­—å…¸è®¿é—®ä¸€ä¸ªä¸å­˜åœ¨çš„é”®æ—¶ï¼Œå¦‚æœå­—å…¸ç±»ä¸­å®šä¹‰äº† <code>__missing__</code> æ–¹æ³•ï¼Œé‚£ä¹ˆåœ¨è®¿é—®ä¸å­˜åœ¨çš„é”®æ—¶ï¼ŒPython ä¼šè‡ªåŠ¨è°ƒç”¨è¯¥æ–¹æ³•ï¼Œå¹¶å°†æ‰€è®¿é—®çš„é”®ä½œä¸ºå‚æ•°ä¼ é€’ç»™å®ƒã€‚ ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ <code>__missing__</code> æ–¹æ³•è‡ªå®šä¹‰å­—å…¸ä¸­è®¿é—®ä¸å­˜åœ¨çš„é”®çš„è¡Œä¸ºï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyDict</span>(<span class="title class_ inherited__">dict</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__missing__</span>(<span class="params">self, key</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;Key &#x27;<span class="subst">&#123;key&#125;</span>&#x27; is missing!&quot;</span></span><br><span class="line"></span><br><span class="line">d = MyDict()</span><br><span class="line">d[<span class="string">&#x27;a&#x27;</span>] = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(d[<span class="string">&#x27;a&#x27;</span>])  <span class="comment"># è¾“å‡º: 1</span></span><br><span class="line"><span class="built_in">print</span>(d[<span class="string">&#x27;b&#x27;</span>])  <span class="comment"># è¾“å‡º: Key &#x27;b&#x27; is missing!</span></span><br></pre></td></tr></table></figure><p>collections.ChainMap æ˜¯ Python ä¸­çš„ä¸€ä¸ªç±»ï¼Œå®ƒç”¨äºå°†å¤šä¸ªå­—å…¸æˆ–æ˜ å°„å¯¹è±¡é“¾æ¥åœ¨ä¸€èµ·ï¼Œå½¢æˆä¸€ä¸ªé€»è¾‘ä¸Šçš„å•ä¸€æ˜ å°„ã€‚ ChainMap æä¾›äº†ä¸€ç§æ–¹ä¾¿çš„æ–¹å¼æ¥å¤„ç†å¤šä¸ªå­—å…¸æˆ–æ˜ å°„å¯¹è±¡ï¼Œå¹¶å°†å®ƒä»¬ä½œä¸ºä¸€ä¸ªæ•´ä½“æ¥æ“ä½œã€‚å®ƒåœ¨é€»è¾‘ä¸Šå°†è¿™äº›å­—å…¸æˆ–æ˜ å°„å¯¹è±¡é“¾æ¥åœ¨ä¸€èµ·ï¼Œå½¢æˆä¸€ä¸ªæŸ¥æ‰¾é“¾ã€‚å½“æˆ‘ä»¬åœ¨ ChainMap å¯¹è±¡ä¸Šè¿›è¡Œé”®çš„æŸ¥æ‰¾æ—¶ï¼Œå®ƒä¼šæŒ‰ç…§é“¾æ¥é¡ºåºä¾æ¬¡åœ¨å„ä¸ªå­—å…¸æˆ–æ˜ å°„å¯¹è±¡ä¸­æŸ¥æ‰¾ã€‚ </p><p>collections.ChainMapçš„å¥½å¤„æ˜¯ä»–ä¸ä¼šçœŸçš„åˆå¹¶å¯¹è±¡ï¼Œè€Œåªæ˜¯å½¢æˆä¸€ä¸ªé“¾æ¥ï¼Œå› æ­¤ä»–ä¸ä¼šå ç”¨é¢å¤–çš„ç©ºé—´ã€‚å…·ä½“å¯çœ‹æºç :<a href="https://blog.csdn.net/weixin_37780776/article/details/123777723">https://blog.csdn.net/weixin_37780776/article/details/123777723</a></p><p>collections.Counter æ˜¯ Python ä¸­çš„ä¸€ä¸ªç±»ï¼Œå®ƒç”¨äºè®¡æ•°å¯å“ˆå¸Œå¯¹è±¡çš„å‡ºç°æ¬¡æ•°ã€‚å®ƒæ˜¯ä¸€ä¸ªæ— åºçš„é›†åˆï¼Œå…¶ä¸­å…ƒç´ å­˜å‚¨ä¸ºé”®ï¼Œå…¶è®¡æ•°å­˜å‚¨ä¸ºå€¼ã€‚ Counter ç±»æä¾›äº†ä¸€äº›æœ‰ç”¨çš„æ–¹æ³•ï¼Œç”¨äºå¯¹è®¡æ•°å™¨è¿›è¡Œæ“ä½œï¼Œå¦‚å¢åŠ ã€å‡å°‘å…ƒç´ çš„è®¡æ•°ã€è·å–æœ€å¸¸è§çš„å…ƒç´ ã€è®¡ç®—å…ƒç´ çš„æ€»æ•°ç­‰ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> Counter</span><br><span class="line"></span><br><span class="line">counter = Counter(<span class="string">&#x27;abcda&#x27;</span>)</span><br><span class="line">counter</span><br><span class="line">counter.values()</span><br></pre></td></tr></table></figure><p>åœ¨ Python ä¸­ï¼Œåˆ›å»ºå­ç±»æ—¶ï¼Œå¯ä»¥é€‰æ‹©ç»§æ‰¿å†…ç½®çš„ dict ç±»æˆ– collections.UserDict ç±»æ¥å®ç°è‡ªå®šä¹‰å­—å…¸ç±»çš„åŠŸèƒ½ã€‚ å°½ç®¡ dict ç±»æ˜¯ Python å†…ç½®çš„å­—å…¸ç±»ï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œç»§æ‰¿ collections.UserDict ç±»å¯èƒ½æ›´é€‚åˆã€‚collections.UserDict æ˜¯ä¸€ä¸ªå¯å˜å­—å…¸ç±»çš„åŒ…è£…å™¨ï¼Œå®ƒæä¾›äº†æ›´ç®€å•å’Œå®‰å…¨çš„æ–¹å¼æ¥åˆ›å»ºè‡ªå®šä¹‰å­—å…¸ç±»ã€‚ ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ collections.UserDict æ¥åˆ›å»ºè‡ªå®šä¹‰å­—å…¸ç±»ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> UserDict</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyDict</span>(<span class="title class_ inherited__">UserDict</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__setitem__</span>(<span class="params">self, key, value</span>):</span><br><span class="line">        <span class="comment"># è‡ªå®šä¹‰è®¾ç½®é”®å€¼çš„è¡Œä¸º</span></span><br><span class="line">        <span class="keyword">if</span> key == <span class="string">&#x27;special_key&#x27;</span>:</span><br><span class="line">            value += <span class="number">10</span></span><br><span class="line">        <span class="built_in">super</span>().__setitem__(key, value)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getitem__</span>(<span class="params">self, key</span>):</span><br><span class="line">        <span class="comment"># è‡ªå®šä¹‰è·å–é”®å€¼çš„è¡Œä¸º</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>().__getitem__(key)</span><br><span class="line"></span><br><span class="line">my_dict = MyDict()</span><br><span class="line">my_dict[<span class="string">&#x27;special_key&#x27;</span>] = <span class="number">5</span></span><br><span class="line"><span class="built_in">print</span>(my_dict[<span class="string">&#x27;special_key&#x27;</span>])  <span class="comment"># è¾“å‡º: 15</span></span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªåä¸º MyDict çš„è‡ªå®šä¹‰å­—å…¸ç±»ï¼Œå¹¶ç»§æ‰¿äº† UserDict ç±»ã€‚é€šè¿‡é‡å†™ <code>__setitem__</code> å’Œ <code>__getitem__</code> æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰è®¾ç½®å’Œè·å–é”®å€¼çš„è¡Œä¸ºã€‚ ç»§æ‰¿ UserDict ç±»å¯ä»¥å¸®åŠ©æˆ‘ä»¬é¿å…ç›´æ¥ä¿®æ”¹ dict å¯¹è±¡çš„å†…éƒ¨ç»“æ„ï¼Œä»è€Œæ›´å®‰å…¨åœ°åˆ›å»ºè‡ªå®šä¹‰å­—å…¸ç±»ã€‚ å½“ç„¶ï¼Œå¦‚æœä½ åªéœ€è¦åˆ›å»ºä¸€ä¸ªç®€å•çš„å­—å…¸ç±»ï¼Œè€Œä¸éœ€è¦è‡ªå®šä¹‰ç‰¹å®šçš„è¡Œä¸ºï¼Œé‚£ä¹ˆç»§æ‰¿ dict ç±»ä¹Ÿæ˜¯å¯è¡Œçš„ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">bytes_data = <span class="string">b&#x27;\xe4\xbd\xa0\xe5\xa5\xbd&#x27;</span></span><br><span class="line">decoded_text = bytes_data.decode(<span class="string">&#x27;utf-8&#x27;</span>)  </span><br><span class="line">decoded_text</span><br></pre></td></tr></table></figure><p>åœ¨ Python ä¸­ï¼Œå…·åå…ƒç»„ï¼ˆNamedTupleï¼‰æ˜¯ä¸€ç§ç‰¹æ®Šç±»å‹çš„å…ƒç»„ï¼Œå®ƒå…è®¸ä½ ç»™æ¯ä¸ªå…ƒç´ å‘½åï¼Œå¹¶é€šè¿‡åç§°è®¿é—®å…ƒç´ ï¼Œè€Œä¸ä»…ä»…æ˜¯é€šè¿‡ç´¢å¼•ã€‚ å…·åå…ƒç»„æ˜¯é€šè¿‡ collections æ¨¡å—ä¸­çš„ namedtuple å‡½æ•°åˆ›å»ºçš„ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> namedtuple</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºå…·åå…ƒç»„ç±»</span></span><br><span class="line">Person = namedtuple(<span class="string">&#x27;Person&#x27;</span>, [<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;age&#x27;</span>, <span class="string">&#x27;gender&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºå…·åå…ƒç»„å®ä¾‹</span></span><br><span class="line">person1 = Person(<span class="string">&#x27;Alice&#x27;</span>, <span class="number">25</span>, <span class="string">&#x27;female&#x27;</span>)</span><br><span class="line">person2 = Person(<span class="string">&#x27;Bob&#x27;</span>, <span class="number">30</span>, <span class="string">&#x27;male&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¿é—®å…ƒç´ </span></span><br><span class="line"><span class="built_in">print</span>(person1.name)      <span class="comment"># è¾“å‡ºï¼šAlice</span></span><br><span class="line"><span class="built_in">print</span>(person2.age)       <span class="comment"># è¾“å‡ºï¼š30</span></span><br><span class="line"><span class="built_in">print</span>(person1.gender)    <span class="comment"># è¾“å‡ºï¼šfemale</span></span><br></pre></td></tr></table></figure><p>@dataclass æ˜¯ Python 3.7 å¼•å…¥çš„ä¸€ä¸ªè£…é¥°å™¨ï¼Œç”¨äºç®€åŒ–åˆ›å»ºå’Œä½¿ç”¨æ•°æ®ç±»ï¼ˆdata classï¼‰çš„è¿‡ç¨‹ã€‚æ•°æ®ç±»æ˜¯ä¸€ç§ç”¨äºå­˜å‚¨æ•°æ®çš„ç‰¹æ®Šç±»ï¼Œå®ƒè‡ªåŠ¨ä¸ºæˆ‘ä»¬ç”Ÿæˆä¸€äº›å¸¸è§çš„æ–¹æ³•ï¼Œå¦‚ <code>__init__</code>ã€<code>__repr__</code>ã€<code>__eq__</code> ç­‰ï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥æ›´æ–¹ä¾¿åœ°åˆ›å»ºå’Œæ“ä½œæ•°æ®å¯¹è±¡ã€‚ ä½¿ç”¨ @dataclass è£…é¥°å™¨ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç±»å®šä¹‰ä¸­çœç•¥ä¸€äº›ç¹ççš„ä»£ç ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªä½¿ç”¨ @dataclass è£…é¥°å™¨åˆ›å»ºæ•°æ®ç±»çš„ç¤ºä¾‹</p><p>åœ¨ Python ä¸­ï¼Œåƒåœ¾å›æ”¶æ˜¯è‡ªåŠ¨è¿›è¡Œçš„ï¼Œå®ƒæ˜¯é€šè¿‡å¼•ç”¨è®¡æ•°å’Œå¾ªç¯åƒåœ¾æ”¶é›†æœºåˆ¶æ¥å®ç°çš„ã€‚ä¸‹é¢æ˜¯å¯¹è¿™ä¸¤ç§æœºåˆ¶çš„ç®€è¦è¯´æ˜ï¼š</p><ol><li>å¼•ç”¨è®¡æ•°ï¼ˆReference Countingï¼‰ï¼šPython ä½¿ç”¨å¼•ç”¨è®¡æ•°æ¥è¿½è¸ªæ¯ä¸ªå¯¹è±¡çš„å¼•ç”¨æ•°ã€‚å½“å¯¹è±¡çš„å¼•ç”¨æ•°å˜ä¸º 0 æ—¶ï¼Œè¯´æ˜æ²¡æœ‰ä»»ä½•å¼•ç”¨æŒ‡å‘è¯¥å¯¹è±¡ï¼ŒPython ä¼šç«‹å³å›æ”¶è¯¥å¯¹è±¡çš„å†…å­˜ç©ºé—´ã€‚è¿™æ˜¯ä¸€ç§é«˜æ•ˆçš„åƒåœ¾å›æ”¶æœºåˆ¶ï¼Œå¯ä»¥ç«‹å³å›æ”¶ä¸å†ä½¿ç”¨çš„å¯¹è±¡ã€‚</li></ol><p>ç„¶è€Œï¼Œå¼•ç”¨è®¡æ•°æœºåˆ¶æ— æ³•å¤„ç†å¾ªç¯å¼•ç”¨çš„æƒ…å†µï¼Œå³ä¸¤ä¸ªæˆ–å¤šä¸ªå¯¹è±¡å½¼æ­¤å¼•ç”¨ï¼Œä½†æ²¡æœ‰å…¶ä»–å¼•ç”¨æŒ‡å‘å®ƒä»¬ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå¼•ç”¨è®¡æ•°æ— æ³•å°†å¯¹è±¡çš„å¼•ç”¨æ•°é™ä¸º 0ï¼Œå¯¼è‡´å†…å­˜æ³„æ¼ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒPython æä¾›äº†å¾ªç¯åƒåœ¾æ”¶é›†æœºåˆ¶ã€‚</p><ol><li>å¾ªç¯åƒåœ¾æ”¶é›†ï¼ˆCycle Garbage Collectionï¼‰ï¼šPython ä½¿ç”¨å¾ªç¯åƒåœ¾æ”¶é›†æœºåˆ¶æ¥æ£€æµ‹å’Œå›æ”¶å¾ªç¯å¼•ç”¨çš„å¯¹è±¡ã€‚å¾ªç¯åƒåœ¾æ”¶é›†å™¨ä¼šå®šæœŸè¿è¡Œï¼Œå®ƒä¼šæ£€æŸ¥æ‰€æœ‰å¯¹è±¡çš„å¼•ç”¨å…³ç³»ï¼Œå¹¶æ ‡è®°é‚£äº›å¯ä»¥è¢«å›æ”¶çš„å¯¹è±¡ã€‚ç„¶åï¼Œå®ƒä¼šé‡Šæ”¾è¿™äº›å¯¹è±¡æ‰€å ç”¨çš„å†…å­˜ç©ºé—´ã€‚</li></ol><p>å¾ªç¯åƒåœ¾æ”¶é›†å™¨ä½¿ç”¨äº†æ›´å¤æ‚çš„ç®—æ³•ï¼Œå¦‚æ ‡è®°-æ¸…é™¤ï¼ˆmark and sweepï¼‰å’Œåˆ†ä»£å›æ”¶ï¼ˆgenerational collectionï¼‰ï¼Œä»¥æé«˜åƒåœ¾å›æ”¶çš„æ•ˆç‡å’Œæ€§èƒ½ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒPython çš„åƒåœ¾å›æ”¶æœºåˆ¶æ˜¯è‡ªåŠ¨çš„ï¼Œå¼€å‘è€…æ— éœ€æ‰‹åŠ¨ç®¡ç†å†…å­˜ã€‚ç„¶è€Œï¼Œå¯¹äºä¸€äº›ç‰¹æ®Šæƒ…å†µï¼Œå¦‚å¤§å‹æ•°æ®ç»“æ„æˆ–å¾ªç¯å¼•ç”¨çš„å¯¹è±¡ï¼Œå¯èƒ½éœ€è¦æ³¨æ„å†…å­˜çš„ä½¿ç”¨å’Œé‡Šæ”¾ï¼Œä»¥é¿å…æ½œåœ¨çš„å†…å­˜æ³„æ¼é—®é¢˜ã€‚</p><p>åœ¨ Python ä¸­ï¼Œå‡½æ•°çš„å‚æ•°ä¼ é€’æ–¹å¼æ˜¯é€šè¿‡å¼•ç”¨ä¼ é€’ï¼ˆpass-by-referenceï¼‰ï¼Œä¹Ÿå¯ä»¥ç§°ä¸ºå¯¹è±¡çš„å¼•ç”¨ä¼ é€’ã€‚è¿™æ„å‘³ç€å‡½æ•°å‚æ•°åœ¨ä¼ é€’è¿‡ç¨‹ä¸­ï¼Œå®é™…ä¸Šæ˜¯å°†å¯¹è±¡çš„å¼•ç”¨ä¼ é€’ç»™å‡½æ•°ï¼Œè€Œä¸æ˜¯å¯¹è±¡æœ¬èº«çš„å‰¯æœ¬ã€‚ </p><p>æ€»ç»“èµ·æ¥ï¼Œå½“å‡½æ•°å‚æ•°æ˜¯å¼•ç”¨ä¼ é€’æ—¶ï¼Œå‡½æ•°å†…éƒ¨å¯¹å‚æ•°å¯¹è±¡çš„ä¿®æ”¹ä¼šå½±å“åˆ°åŸå§‹å¯¹è±¡ï¼Œä½†æ˜¯å¯¹å‚æ•°è¿›è¡Œé‡æ–°èµ‹å€¼åˆ™ä¸ä¼šå½±å“åˆ°åŸå§‹å¯¹è±¡ã€‚</p><p>delæ˜¯ä¸€ä¸ªå…³é”®å­—ï¼Œå¸¸è§ç”¨æ³•ï¼š</p><ol><li>åˆ é™¤å¯¹è±¡</li><li>åˆ é™¤å¯¹è±¡çš„å±æ€§</li><li>åˆ é™¤åˆ—è¡¨ä¸­çš„å…ƒç´ </li><li>åˆ é™¤å­—å…¸ä¸­çš„é”®å€¼å¯¹</li></ol><p>pythonä¸­å‡½æ•°æ˜¯ä¸€ç­‰å…¬æ°‘ï¼š</p><ol><li>å°†å‡½æ•°èµ‹å€¼ç»™å˜é‡</li><li>å‡½æ•°å¯ä»¥ä½œä¸ºå‚æ•°</li><li>å‡½æ•°ä½œä¸ºå¦ä¸€ä¸ªå‡½æ•°çš„è¿”å›å€¼</li><li>åµŒå¥—å‡½æ•°</li></ol><p>åœ¨ Python ä¸­ï¼Œé«˜é˜¶å‡½æ•°ï¼ˆHigher-order functionsï¼‰æ˜¯æŒ‡èƒ½å¤Ÿæ¥å—å‡½æ•°ä½œä¸ºå‚æ•°ï¼Œæˆ–è€…è¿”å›ä¸€ä¸ªå‡½æ•°çš„å‡½æ•°ã€‚é«˜é˜¶å‡½æ•°æ˜¯å‡½æ•°å¼ç¼–ç¨‹çš„é‡è¦æ¦‚å¿µï¼Œå®ƒå¯ä»¥è®©ä»£ç æ›´åŠ ç®€æ´ã€çµæ´»å’Œå¯å¤ç”¨ã€‚ ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„é«˜é˜¶å‡½æ•°çš„ç¤ºä¾‹ï¼š</p><ul><li>map</li><li>filter</li><li>sorted</li><li>lambdaå‡½æ•°ï¼šlambda å‡½æ•°é€šå¸¸åªé€‚ç”¨äºç®€å•çš„ã€å•è¡Œçš„å‡½æ•°é€»è¾‘ã€‚å¦‚æœä½ éœ€è¦ç¼–å†™å¤æ‚çš„å‡½æ•°é€»è¾‘ï¼Œè¿˜æ˜¯å»ºè®®ä½¿ç”¨å¸¸è§„çš„å‡½æ•°å®šä¹‰æ–¹å¼ã€‚</li></ul><p>ç”¨æˆ·å¯ä»¥é€šè¿‡è‡ªå®šä¹‰ç±»æ¥åˆ›å»ºå¯è°ƒç”¨å¯¹è±¡ã€‚ä¸ºäº†ä½¿ä¸€ä¸ªç±»çš„å®ä¾‹å¯ä»¥åƒå‡½æ•°ä¸€æ ·è¢«è°ƒç”¨ï¼Œéœ€è¦åœ¨ç±»ä¸­å®šä¹‰ <code>__call__</code>() æ–¹æ³•</p><p><strong>æ€»ç»“pyä¸­æ˜Ÿå·çš„ç”¨æ³•</strong></p><p>åœ¨ Python ä¸­ï¼Œæœ‰ä¸€äº›æµè¡Œçš„åŒ…å’Œåº“æ”¯æŒå‡½æ•°å¼ç¼–ç¨‹èŒƒå¼ã€‚ä»¥ä¸‹æ˜¯å…¶ä¸­ä¸€äº›å¸¸ç”¨çš„åŒ…ï¼š</p><ol><li><p>functoolsï¼š<code>functools</code> æ˜¯ Python å†…ç½®çš„ä¸€ä¸ªæ¨¡å—ï¼Œæä¾›äº†ä¸€äº›å‡½æ•°å¼ç¼–ç¨‹çš„å·¥å…·å‡½æ•°ã€‚å®ƒåŒ…å«äº†ä¸€äº›ç”¨äºå‡½æ•°æ“ä½œçš„é«˜é˜¶å‡½æ•°ï¼Œå¦‚ <code>map()</code>ã€<code>filter()</code>ã€<code>reduce()</code>ï¼Œä»¥åŠä¸€äº›ç”¨äºå‡½æ•°ç»„åˆå’Œå‡½æ•°è£…é¥°å™¨çš„å·¥å…·å‡½æ•°ã€‚</p></li><li><p>itertoolsï¼š<code>itertools</code> ä¹Ÿæ˜¯ Python å†…ç½®çš„ä¸€ä¸ªæ¨¡å—ï¼Œæä¾›äº†ä¸€äº›ç”¨äºè¿­ä»£å’Œç»„åˆçš„å·¥å…·å‡½æ•°ã€‚å®ƒåŒ…å«äº†ä¸€äº›å¸¸è§çš„å‡½æ•°å¼ç¼–ç¨‹æ¨¡å¼ï¼Œå¦‚ç”Ÿæˆæ— é™è¿­ä»£å™¨ã€ç»„åˆè¿­ä»£å™¨ã€è¿‡æ»¤è¿­ä»£å™¨ç­‰ã€‚</p></li><li><p>operatorï¼š<code>operator</code> æ˜¯ Python å†…ç½®çš„ä¸€ä¸ªæ¨¡å—ï¼Œæä¾›äº†ä¸€äº›å¸¸è§çš„è¿ç®—ç¬¦çš„å‡½æ•°å½¢å¼ã€‚å®ƒæä¾›äº†ä¸€ç§å‡½æ•°å¼çš„æ–¹å¼æ¥æ‰§è¡Œå¸¸è§çš„ç®—æœ¯ã€æ¯”è¾ƒå’Œé€»è¾‘è¿ç®—ã€‚</p></li><li><p>toolzï¼š<code>toolz</code> æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„å‡½æ•°å¼ç¼–ç¨‹å·¥å…·åŒ…ï¼Œæä¾›äº†ä¸€äº›é«˜é˜¶å‡½æ•°å’Œå·¥å…·ï¼Œç”¨äºå¤„ç†é›†åˆã€è¿­ä»£å’Œå‡½æ•°ç»„åˆã€‚å®ƒæä¾›äº†ä¸€äº›å‡½æ•°å¼ç¼–ç¨‹çš„å¸¸è§æ¨¡å¼ï¼Œå¦‚ <code>curry()</code>ã€<code>compose()</code>ã€<code>pipe()</code> ç­‰ã€‚</p></li><li><p>fnï¼š<code>fn</code> æ˜¯ä¸€ä¸ªä¸“æ³¨äºå‡½æ•°å¼ç¼–ç¨‹çš„åº“ï¼Œæä¾›äº†ä¸€äº›å‡½æ•°å¼ç¼–ç¨‹çš„å·¥å…·å‡½æ•°å’Œæ•°æ®ç±»å‹ã€‚å®ƒæ”¯æŒå‡½æ•°ç»„åˆã€æŸ¯é‡ŒåŒ–ã€æƒ°æ€§æ±‚å€¼ç­‰å‡½æ•°å¼ç¼–ç¨‹çš„ç‰¹æ€§ã€‚</p></li></ol><p>è¿™äº›åŒ…å’Œåº“æä¾›äº†ä¸°å¯Œçš„å·¥å…·å’Œå‡½æ•°ï¼Œå¸®åŠ©å¼€å‘è€…æ›´æ–¹ä¾¿åœ°åº”ç”¨å‡½æ•°å¼ç¼–ç¨‹çš„æ€æƒ³å’Œæ¨¡å¼ã€‚æ— è®ºæ˜¯åœ¨å‡½æ•°ç»„åˆã€è¿­ä»£æ“ä½œã€æƒ°æ€§æ±‚å€¼è¿˜æ˜¯å…¶ä»–å‡½æ•°å¼ç¼–ç¨‹çš„åœºæ™¯ä¸­ï¼Œå®ƒä»¬éƒ½èƒ½æä¾›å¾ˆå¤šä¾¿åˆ©ã€‚</p><p>åœ¨ Python ä¸­ï¼Œç±»å‹æ³¨è§£æ˜¯ä¸€ç§å¯é€‰çš„è¯­æ³•ï¼Œç”¨äºæä¾›å˜é‡ã€å‡½æ•°å‚æ•°ã€å‡½æ•°è¿”å›å€¼ç­‰çš„ç±»å‹ä¿¡æ¯ã€‚ç±»å‹æ³¨è§£å¯ä»¥å¸®åŠ©å¼€å‘è€…å’Œå·¥å…·åœ¨é™æ€ç±»å‹æ£€æŸ¥æ—¶å‘ç°æ½œåœ¨çš„ç±»å‹é”™è¯¯ï¼Œæé«˜ä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚</p><p>ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸ç”¨çš„ç±»å‹æ³¨è§£ï¼Œå¯ä»¥åœ¨ Python çš„æ³¨è§£ä¸­ä½¿ç”¨ï¼š</p><ol><li><p>åŸºæœ¬ç±»å‹ï¼šintã€floatã€boolã€str ç­‰åŸºæœ¬æ•°æ®ç±»å‹ã€‚</p></li><li><p>å®¹å™¨ç±»å‹ï¼šlistã€tupleã€dictã€set ç­‰å®¹å™¨ç±»å‹ã€‚å¯ä»¥ä½¿ç”¨æ–¹æ‹¬å· <code>[]</code> è¡¨ç¤ºåˆ—è¡¨ï¼Œåœ†æ‹¬å· <code>()</code> è¡¨ç¤ºå…ƒç»„ï¼Œå¤§æ‹¬å· <code>&#123;&#125;</code> è¡¨ç¤ºå­—å…¸å’Œé›†åˆã€‚</p></li><li><p>è‡ªå®šä¹‰ç±»å‹ï¼šè‡ªå®šä¹‰çš„ç±»ã€æšä¸¾ç±»ã€å‘½åå…ƒç»„ç­‰ã€‚</p></li><li><p>Union ç±»å‹ï¼šä½¿ç”¨ <code>Union</code> æˆ– <code>|</code> ç¬¦å·è¡¨ç¤ºå¤šä¸ªç±»å‹ä¸­çš„ä¸€ä¸ªï¼Œè¡¨ç¤ºä¸€ä¸ªå˜é‡å¯ä»¥æ˜¯å¤šç§ç±»å‹ä¹‹ä¸€ã€‚</p></li><li><p>Optional ç±»å‹ï¼šä½¿ç”¨ <code>Optional</code> è¡¨ç¤ºä¸€ä¸ªå˜é‡å¯ä»¥æ˜¯æŒ‡å®šç±»å‹æˆ–è€… <code>None</code>ã€‚</p></li><li><p>Callable ç±»å‹ï¼šä½¿ç”¨ <code>Callable</code> è¡¨ç¤ºä¸€ä¸ªå˜é‡æ˜¯å¯è°ƒç”¨å¯¹è±¡ï¼Œå¦‚å‡½æ•°ã€æ–¹æ³•ç­‰ã€‚</p></li><li><p>ç±»å‹å˜é‡ï¼šä½¿ç”¨ <code>TypeVar</code> è¡¨ç¤ºä¸€ä¸ªç±»å‹å˜é‡ï¼Œç”¨äºæ³›å‹ç¼–ç¨‹æˆ–è¡¨ç¤ºå¤æ‚ç±»å‹ã€‚</p></li><li><p>Any ç±»å‹ï¼šä½¿ç”¨ <code>Any</code> è¡¨ç¤ºä»»æ„ç±»å‹ï¼Œç›¸å½“äºå–æ¶ˆäº†ç±»å‹æ£€æŸ¥ã€‚</p></li></ol><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç±»å‹æ³¨è§£åœ¨ Python ä¸­æ˜¯å¯é€‰çš„ï¼Œä¸ä¼šå½±å“ä»£ç çš„è¿è¡Œã€‚å®ƒä»¬åªæ˜¯æä¾›äº†ä¸€ç§ç»™å¼€å‘è€…å’Œå·¥å…·æ›´å¤šç±»å‹ä¿¡æ¯çš„æ–¹å¼ï¼Œä»¥æé«˜ä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚Python è§£é‡Šå™¨åœ¨è¿è¡Œæ—¶ä¸ä¼šå¯¹ç±»å‹æ³¨è§£è¿›è¡ŒéªŒè¯ï¼Œç±»å‹æ£€æŸ¥éœ€è¦é€šè¿‡é™æ€ç±»å‹æ£€æŸ¥å·¥å…·ï¼ˆå¦‚ <code>mypy</code>ï¼‰è¿›è¡Œã€‚</p><p><strong>è£…é¥°å™¨å’Œé—­åŒ…æ€»ç»“å’Œä½¿ç”¨è£…é¥°å™¨æ”¹è¿›ç­–ç•¥æ¨¡å¼</strong></p><p>å®ä¾‹æ–¹æ³•ã€é™æ€æ–¹æ³•ã€ç±»æ–¹æ³•æ¯”è¾ƒ</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span>:</span><br><span class="line">    cls_var = <span class="string">&#x27;cls_var&#x27;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, ins_var</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        self.ins_var = ins_var</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">cls_method</span>(<span class="params">cls</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;This is a cls method&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(cls.cls_var)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">ins_method</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;This is a ins method&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(self.ins_var)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">static_method</span>():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;This is a static method&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(MyClass.cls_var)</span><br><span class="line"></span><br><span class="line">MyClass.static_method()</span><br></pre></td></tr></table></figure><p>åœ¨Pythonä¸­ï¼Œæœ‰ä¸¤ç§æ–¹å¼å¯ä»¥é™åˆ¶å¯¹ç±»å±æ€§çš„è®¿é—®ï¼šç§æœ‰å±æ€§å’Œå—ä¿æŠ¤çš„å±æ€§ã€‚ </p><ol><li>ç§æœ‰å±æ€§ï¼š ç§æœ‰å±æ€§æ˜¯ä»¥åŒä¸‹åˆ’çº¿ __ å¼€å¤´çš„å±æ€§ï¼Œå®ƒä»¬åªèƒ½åœ¨ç±»çš„å†…éƒ¨è®¿é—®ï¼Œæ— æ³•ä»å¤–éƒ¨ç›´æ¥è®¿é—®ã€‚ç§æœ‰å±æ€§çš„ç›®çš„æ˜¯é˜²æ­¢æ„å¤–çš„ä¿®æ”¹æˆ–è®¿é—®ï¼Œä»¥ä¿æŠ¤ç±»çš„å†…éƒ¨å®ç°ç»†èŠ‚ã€‚</li></ol><p>å°½ç®¡æ— æ³•ç›´æ¥è®¿é—®ç§æœ‰å±æ€§å’Œæ–¹æ³•ï¼Œä½†å¯ä»¥é€šè¿‡ä½¿ç”¨ <code>å®ä¾‹å˜é‡._ç±»å__å±æ€§å</code>çš„æ–¹å¼æ¥é—´æ¥è®¿é—®ç§æœ‰å±æ€§å’Œæ–¹æ³•ã€‚</p><p>è¯·æ³¨æ„ï¼Œè¿™ç§æ–¹å¼åªæ˜¯ä¸€ä¸ªçº¦å®šï¼Œä¸æ˜¯çœŸæ­£çš„è®¿é—®æ§åˆ¶æœºåˆ¶ã€‚åœ¨Pythonä¸­ï¼Œæ²¡æœ‰çœŸæ­£çš„ç§æœ‰æ€§ï¼Œå®ƒåªæ˜¯ä¸€ç§çº¦å®šï¼Œç”¨äºæŒ‡ç¤ºè¿™äº›å±æ€§å’Œæ–¹æ³•åº”è¯¥è¢«è§†ä¸ºç§æœ‰çš„ã€‚ </p><ol><li>å—ä¿æŠ¤çš„å±æ€§ï¼š å—ä¿æŠ¤çš„å±æ€§æ˜¯ä»¥å•ä¸‹åˆ’çº¿ _ å¼€å¤´çš„å±æ€§ï¼Œå®ƒä»¬å»ºè®®åœ¨ç±»çš„å¤–éƒ¨ä¸ç›´æ¥è®¿é—®ï¼Œä½†å¯ä»¥ä»å­ç±»ä¸­è®¿é—®ã€‚å—ä¿æŠ¤çš„å±æ€§æ˜¯ä¸€ç§æ›´å®½æ¾çš„è®¿é—®é™åˆ¶ï¼Œç”¨äºæŒ‡ç¤ºè¿™äº›å±æ€§åº”è¯¥è¢«è§†ä¸ºå—ä¿æŠ¤çš„ã€‚</li></ol><p><code>__slots__</code> æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ç±»å±æ€§ï¼Œç”¨äºé™åˆ¶ç±»çš„å®ä¾‹å¯ä»¥æ‹¥æœ‰çš„å±æ€§ã€‚ é€šè¿‡ä½¿ç”¨ <code>__slots__</code>ï¼Œä½ å¯ä»¥å‘Šè¯‰Pythonä»…ä¸ºç±»çš„å®ä¾‹åˆ†é…æŒ‡å®šçš„å±æ€§ï¼Œä»è€ŒèŠ‚çœäº†å†…å­˜ç©ºé—´ã€‚å½“ä½ çŸ¥é“ç±»çš„å®ä¾‹åªéœ€è¦å›ºå®šçš„ä¸€ç»„å±æ€§æ—¶ï¼Œä½¿ç”¨ <code>__slots__</code> å¯ä»¥æé«˜æ€§èƒ½ã€‚ ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œæ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨ <code>__slots__</code></p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span>:</span><br><span class="line">    __slots__ = (<span class="string">&quot;attribute1&quot;</span>, <span class="string">&quot;attribute2&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, value1, value2</span>):</span><br><span class="line">        self.attribute1 = value1</span><br><span class="line">        self.attribute2 = value2</span><br><span class="line"></span><br><span class="line">obj = MyClass(<span class="string">&quot;Value 1&quot;</span>, <span class="string">&quot;Value 2&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(obj.attribute1)</span><br><span class="line"><span class="built_in">print</span>(obj.attribute2)</span><br><span class="line"></span><br><span class="line">obj.attribute3 = <span class="string">&quot;Value 3&quot;</span>  <span class="comment"># æ— æ³•ä¸ºå±æ€§3åˆ†é…å†…å­˜ï¼Œä¼šå¼•å‘ AttributeError</span></span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªåä¸º MyClass çš„ç±»ï¼Œå¹¶ä½¿ç”¨ <code>__slots__</code> å±æ€§æŒ‡å®šäº†ç±»çš„å®ä¾‹åªèƒ½æ‹¥æœ‰ attribute1 å’Œ attribute2 è¿™ä¸¤ä¸ªå±æ€§ã€‚ åœ¨ç±»çš„ <code>__init__</code>æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬ä¸ºè¿™ä¸¤ä¸ªå±æ€§èµ‹äºˆäº†åˆå§‹å€¼ã€‚ åˆ›å»º MyClass çš„å®ä¾‹ obj åï¼Œæˆ‘ä»¬å¯ä»¥è®¿é—®è¿™ä¸¤ä¸ªå±æ€§çš„å€¼ã€‚ ç„¶è€Œï¼Œå½“æˆ‘ä»¬å°è¯•ä¸º obj çš„ attribute3 å±æ€§èµ‹å€¼æ—¶ï¼Œä¼šå¼•å‘ AttributeError å¼‚å¸¸ã€‚è¿™æ˜¯å› ä¸º <code>__slots__</code> å±æ€§é™åˆ¶äº†å®ä¾‹åªèƒ½æ‹¥æœ‰ attribute1 å’Œ attribute2 è¿™ä¸¤ä¸ªå±æ€§ï¼Œæ— æ³•ä¸ºå…¶ä»–å±æ€§åˆ†é…å†…å­˜ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>__slots__</code> æ˜¯ä¸€ä¸ªç±»å±æ€§ï¼Œè€Œä¸æ˜¯å®ä¾‹å±æ€§ã€‚å®ƒä»…å¯¹ç±»çš„å®ä¾‹èµ·ä½œç”¨ï¼Œä¸å¯¹ç±»æœ¬èº«èµ·ä½œç”¨ã€‚ ä½¿ç”¨ <code>__slots__</code> å¯ä»¥æœ‰æ•ˆåœ°å‡å°‘å®ä¾‹æ‰€å ç”¨çš„å†…å­˜ç©ºé—´ï¼Œä½†éœ€è¦æ³¨æ„é€‰æ‹©é€‚å½“çš„å±æ€§åˆ—è¡¨ï¼Œç¡®ä¿ä¸ä¼šé™åˆ¶è¿‡å¤šæˆ–è¿‡å°‘çš„å±æ€§ã€‚</p><p>åŠ¨æ€å­˜å–å±æ€§</p><ol><li>ç‚¹å·èµ‹å€¼</li><li>getattr()ã€ setattr()</li><li>ä½¿ç”¨å­—å…¸ï¼š <code>obj.__dict__[&#39;name&#39;] = &#39;John&#39;</code></li></ol><p>zipå‡½æ•° æ‹‰é“¾</p><p>é¸­å­ç±»å‹æ˜¯ä¸€ç§åŠ¨æ€ç±»å‹ç³»ç»Ÿçš„æ¦‚å¿µï¼Œå®ƒå¼ºè°ƒåœ¨ç¼–ç¨‹ä¸­å…³æ³¨å¯¹è±¡çš„è¡Œä¸ºè€Œä¸æ˜¯å…·ä½“çš„ç±»å‹ã€‚æ ¹æ®é¸­å­ç±»å‹çš„åŸåˆ™ï¼Œåªè¦ä¸€ä¸ªå¯¹è±¡å…·æœ‰ç‰¹å®šçš„æ–¹æ³•æˆ–å±æ€§ï¼Œé‚£ä¹ˆå®ƒå°±å¯ä»¥è¢«è§†ä¸ºå…·æœ‰ç›¸åŒçš„è¡Œä¸ºï¼Œè€Œä¸éœ€è¦æ˜¾å¼åœ°æŒ‡å®šç›¸åŒçš„ç±»å‹ã€‚ åœ¨Pythonä¸­ï¼Œé¸­å­ç±»å‹ç¼–ç¨‹å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å®ç°ï¼š 1. ä¸ä¾èµ–å…·ä½“çš„ç±»å‹ï¼šç¼–å†™ä»£ç æ—¶ï¼Œä¸éœ€è¦å…³æ³¨å¯¹è±¡çš„å…·ä½“ç±»å‹ï¼Œè€Œæ˜¯å…³æ³¨å¯¹è±¡æ˜¯å¦å…·æœ‰æ‰€éœ€çš„æ–¹æ³•æˆ–å±æ€§ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªå¯¹è±¡å…·æœ‰read()å’Œwrite()æ–¹æ³•ï¼Œé‚£ä¹ˆå®ƒå¯ä»¥è¢«å½“ä½œæ–‡ä»¶å¯¹è±¡æ¥ä½¿ç”¨ï¼Œè€Œä¸éœ€è¦æ˜¯fileç±»å‹çš„å®ä¾‹ã€‚ 2. ä½¿ç”¨try-exceptè¯­å¥ï¼šåœ¨ä½¿ç”¨æŸä¸ªæ–¹æ³•æˆ–å±æ€§ä¹‹å‰ï¼Œå¯ä»¥ä½¿ç”¨try-exceptè¯­å¥æ¥æ•è·å¯èƒ½çš„å¼‚å¸¸ã€‚å¦‚æœå¯¹è±¡å…·æœ‰æ‰€éœ€çš„æ–¹æ³•æˆ–å±æ€§ï¼Œé‚£ä¹ˆä»£ç å°†æ­£å¸¸æ‰§è¡Œï¼›å¦‚æœå¯¹è±¡æ²¡æœ‰æ‰€éœ€çš„æ–¹æ³•æˆ–å±æ€§ï¼Œé‚£ä¹ˆä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå¯ä»¥åœ¨exceptå—ä¸­å¤„ç†è¯¥å¼‚å¸¸ã€‚ ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œæ¼”ç¤ºäº†é¸­å­ç±»å‹ç¼–ç¨‹çš„æ¦‚å¿µ</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">process_data</span>(<span class="params">obj</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        obj.read()</span><br><span class="line">        obj.process()</span><br><span class="line">        obj.write()</span><br><span class="line">    <span class="keyword">except</span> AttributeError:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;å¯¹è±¡ä¸å…·æœ‰æ‰€éœ€çš„æ–¹æ³•æˆ–å±æ€§&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FileObject</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">read</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;è¯»å–æ–‡ä»¶&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;å¤„ç†æ•°æ®&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">write</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;å†™å…¥æ–‡ä»¶&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DatabaseObject</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">read</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;è¯»å–æ•°æ®åº“&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;å¤„ç†æ•°æ®&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">write</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;å†™å…¥æ•°æ®åº“&quot;</span>)</span><br><span class="line"></span><br><span class="line">file_obj = FileObject()</span><br><span class="line">database_obj = DatabaseObject()</span><br><span class="line"></span><br><span class="line">process_data(file_obj)  <span class="comment"># è¾“å‡º: è¯»å–æ–‡ä»¶ã€å¤„ç†æ•°æ®ã€å†™å…¥æ–‡ä»¶</span></span><br><span class="line">process_data(database_obj)  <span class="comment"># è¾“å‡º: è¯»å–æ•°æ®åº“ã€å¤„ç†æ•°æ®ã€å†™å…¥æ•°æ®åº“</span></span><br><span class="line">process_data(<span class="string">&quot;Hello&quot;</span>)  <span class="comment"># è¾“å‡º: å¯¹è±¡ä¸å…·æœ‰æ‰€éœ€çš„æ–¹æ³•æˆ–å±æ€§</span></span><br></pre></td></tr></table></figure><p>åœ¨Pythonä¸­ï¼Œå¯ä»¥é€šè¿‡å­ç±»åŒ–å†…ç½®ç±»å‹æ¥åˆ›å»ºè‡ªå®šä¹‰çš„æ•°æ®ç±»å‹ã€‚å†…ç½®ç±»å‹ï¼Œå¦‚listã€dictã€strç­‰ï¼Œå¯ä»¥ä½œä¸ºåŸºç±»æ¥å®šä¹‰å­ç±»ï¼Œä»è€Œæ‰©å±•æˆ–å®šåˆ¶å…¶è¡Œä¸ºã€‚ ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œæ¼”ç¤ºäº†å¦‚ä½•å­ç±»åŒ–å†…ç½®ç±»å‹listï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyList</span>(<span class="title class_ inherited__">list</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, *args</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__(*args)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">append</span>(<span class="params">self, item</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Appending item:&quot;</span>, item)</span><br><span class="line">        <span class="built_in">super</span>().append(item)</span><br><span class="line"></span><br><span class="line">my_list = MyList([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])</span><br><span class="line"><span class="built_in">print</span>(my_list)  <span class="comment"># è¾“å‡º: [1, 2, 3]</span></span><br><span class="line"></span><br><span class="line">my_list.append(<span class="number">4</span>)  <span class="comment"># è¾“å‡º: Appending item: 4</span></span><br><span class="line"><span class="built_in">print</span>(my_list)  <span class="comment"># è¾“å‡º: [1, 2, 3, 4]</span></span><br></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå­ç±»åŒ–å†…ç½®ç±»å‹æœ‰ä¸€äº›é™åˆ¶å’Œæ³¨æ„äº‹é¡¹ã€‚ä¾‹å¦‚ï¼ŒæŸäº›å†…ç½®ç±»å‹çš„è¡Œä¸ºå¯èƒ½æ˜¯é€šè¿‡Cè¯­è¨€å®ç°çš„ï¼Œå› æ­¤æ— æ³•ç›´æ¥è¦†ç›–ã€‚æ­¤å¤–ï¼Œä¸€äº›å†…ç½®ç±»å‹å…·æœ‰ç‰¹æ®Šçš„æ–¹æ³•å’Œè¡Œä¸ºï¼Œéœ€è¦è¿›è¡Œç‰¹æ®Šå¤„ç†ã€‚</p><p>å¤šé‡ç»§æ‰¿ã€æ··å…¥ç±»ï¼šç•¥ã€‚</p><p>åœ¨Pythonä¸­ï¼ŒTypedDictæ˜¯ä¸€ç§ç”¨äºå®šä¹‰å…·æœ‰ç‰¹å®šé”®å’Œå€¼ç±»å‹çš„å­—å…¸çš„ç±»å‹æç¤ºå·¥å…·ã€‚å®ƒæ˜¯Python 3.8ç‰ˆæœ¬ä¸­å¼•å…¥çš„ï¼Œå¹¶ä¸”éœ€è¦ä½¿ç”¨typingæ¨¡å—è¿›è¡Œå¯¼å…¥ã€‚ TypedDictå…è®¸æˆ‘ä»¬ä¸ºå­—å…¸çš„é”®å’Œå€¼æŒ‡å®šç±»å‹æ³¨è§£ï¼Œä»¥æä¾›æ›´ä¸¥æ ¼çš„ç±»å‹æ£€æŸ¥å’Œç±»å‹æç¤ºã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> TypedDict</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>(<span class="title class_ inherited__">TypedDict</span>):</span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    age: <span class="built_in">int</span></span><br><span class="line"></span><br><span class="line">person: Person = &#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;John&quot;</span>,</span><br><span class="line">    <span class="string">&quot;age&quot;</span>: <span class="number">30</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªåä¸ºPersonçš„TypedDictï¼Œå®ƒå…·æœ‰ä¸¤ä¸ªé”®ï¼šnameå’Œageã€‚æˆ‘ä»¬åœ¨é”®åé¢ä½¿ç”¨å†’å·ï¼ˆ:ï¼‰æŒ‡å®šäº†é”®çš„ç±»å‹æ³¨è§£ï¼Œä»¥åŠå€¼çš„ç±»å‹æ³¨è§£ã€‚ ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨Personç±»å‹æ¥æ³¨è§£ä¸€ä¸ªå­—å…¸å˜é‡personï¼Œå¹¶ç¡®ä¿è¯¥å­—å…¸çš„é”®å’Œå€¼ç±»å‹ä¸Personç±»å‹å®šä¹‰åŒ¹é…ã€‚ TypedDictæä¾›äº†æ›´å¼ºçš„ç±»å‹çº¦æŸï¼Œå¯ä»¥åœ¨é™æ€ç±»å‹æ£€æŸ¥å·¥å…·ï¼ˆå¦‚mypyï¼‰æˆ–IDEä¸­æä¾›æ›´å‡†ç¡®çš„ç±»å‹æç¤ºã€‚å®ƒé€‚ç”¨äºéœ€è¦å¯¹å­—å…¸çš„ç»“æ„å’Œç±»å‹è¿›è¡Œä¸¥æ ¼æ§åˆ¶çš„æƒ…å†µã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒTypedDictåªåœ¨è¿è¡Œæ—¶å¯¹å­—å…¸è¿›è¡Œç±»å‹æ£€æŸ¥ï¼Œè€Œä¸æ˜¯åœ¨ç¼–è¯‘æ—¶ã€‚å› æ­¤ï¼Œå®ƒä¸èƒ½å®Œå…¨æ›¿ä»£ç¼–å†™å¥å£®çš„è¾“å…¥éªŒè¯å’Œæ•°æ®æ ¡éªŒä»£ç ã€‚</p><p>typing.castæ˜¯Pythonä¸­çš„ä¸€ä¸ªç±»å‹æç¤ºå·¥å…·å‡½æ•°ï¼Œå®ƒç”¨äºæ˜¾å¼åœ°æŒ‡å®šä¸€ä¸ªå¯¹è±¡çš„ç±»å‹ï¼Œå¹¶è¿”å›è¯¥å¯¹è±¡çš„ç±»å‹è½¬æ¢åçš„ç»“æœã€‚ castå‡½æ•°çš„ç­¾åå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">cast</span>(<span class="params"><span class="built_in">type</span>, value</span>) -&gt; <span class="built_in">type</span>:</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œtypeå‚æ•°æ˜¯ç›®æ ‡ç±»å‹ï¼Œvalueå‚æ•°æ˜¯è¦è¿›è¡Œç±»å‹è½¬æ¢çš„å¯¹è±¡ã€‚castå‡½æ•°ä¼šå°†valueå¯¹è±¡è½¬æ¢ä¸ºtypeç±»å‹ï¼Œå¹¶è¿”å›è½¬æ¢åçš„ç»“æœã€‚ ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> cast</span><br><span class="line"></span><br><span class="line">num_str = <span class="string">&quot;123&quot;</span></span><br><span class="line">num_int = cast(<span class="built_in">int</span>, num_str)</span><br><span class="line"><span class="built_in">print</span>(num_int)  <span class="comment"># è¾“å‡º: 123</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(num_int))  <span class="comment"># è¾“å‡º: &lt;class &#x27;int&#x27;&gt;</span></span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†å­—ç¬¦ä¸²num_stré€šè¿‡castå‡½æ•°è½¬æ¢ä¸ºæ•´æ•°ç±»å‹intã€‚å°½ç®¡num_strçš„ç±»å‹æ˜¯å­—ç¬¦ä¸²ï¼Œä½†æˆ‘ä»¬ä½¿ç”¨castå‡½æ•°æ˜¾å¼åœ°æŒ‡å®šäº†ç›®æ ‡ç±»å‹ä¸ºæ•´æ•°ï¼Œå¹¶å¾—åˆ°äº†è½¬æ¢åçš„ç»“æœã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œcastå‡½æ•°å¹¶ä¸ä¼šè¿›è¡Œå®é™…çš„ç±»å‹æ£€æŸ¥æˆ–ç±»å‹è½¬æ¢ã€‚å®ƒä»…ä»…æ˜¯ä¸€ä¸ªç±»å‹æç¤ºå·¥å…·ï¼Œç”¨äºå‘é™æ€ç±»å‹æ£€æŸ¥å™¨ï¼ˆå¦‚mypyï¼‰æä¾›é¢å¤–çš„ä¿¡æ¯ï¼Œä»¥ä¾¿è¿›è¡Œæ›´å‡†ç¡®çš„ç±»å‹æ¨æ–­å’Œç±»å‹æ£€æŸ¥ã€‚ åœ¨ä½¿ç”¨castå‡½æ•°æ—¶ï¼Œåº”è¯¥è°¨æ…ä½¿ç”¨ï¼Œå¹¶ç¡®ä¿å¯¹è±¡çš„å®é™…ç±»å‹ä¸æŒ‡å®šçš„ç›®æ ‡ç±»å‹æ˜¯å…¼å®¹çš„ï¼Œä»¥é¿å…è¿è¡Œæ—¶é”™è¯¯ã€‚</p><p>åœ¨Pythonä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ³›åŒ–ç±»ï¼ˆGeneric Classï¼‰æ¥å®ç°å…·æœ‰é€šç”¨æ€§çš„ç±»ï¼Œä»¥ä¾¿åœ¨ä¸åŒçš„ç±»å‹ä¸Šä½¿ç”¨ç›¸åŒçš„ä»£ç ã€‚æ³›åŒ–ç±»å¯ä»¥ä¸ç±»å‹å‚æ•°ä¸€èµ·ä½¿ç”¨ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨ç±»å®šä¹‰ä¸­ä½¿ç”¨è¿™äº›å‚æ•°æ¥è¡¨ç¤ºä¸ç¡®å®šçš„ç±»å‹ã€‚ ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•ä½¿ç”¨æ³›åŒ–ç±»æ¥å®ç°ä¸€ä¸ªé€šç”¨çš„å †æ ˆç±»ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> TypeVar, <span class="type">Generic</span></span><br><span class="line"></span><br><span class="line">T = TypeVar(<span class="string">&#x27;T&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Stack</span>(<span class="type">Generic</span>[T]):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.items = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">push</span>(<span class="params">self, item: T</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        self.items.append(item)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">pop</span>(<span class="params">self</span>) -&gt; T:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.is_empty():</span><br><span class="line">            <span class="keyword">return</span> self.items.pop()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> IndexError(<span class="string">&quot;Stack is empty&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_empty</span>(<span class="params">self</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(self.items) == <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">size</span>(<span class="params">self</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(self.items)</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨typingæ¨¡å—ä¸­çš„TypeVaræ¥å®šä¹‰ä¸€ä¸ªç±»å‹å˜é‡Tã€‚ç„¶åï¼Œåœ¨ç±»å®šä¹‰ä¸­ä½¿ç”¨Generic[T]æ¥è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªæ³›åŒ–ç±»ï¼Œå¹¶ä¸”Tæ˜¯ä¸€ä¸ªç±»å‹å‚æ•°ã€‚ åœ¨ç±»çš„æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç±»å‹å‚æ•°Tæ¥è¡¨ç¤ºä¸ç¡®å®šçš„ç±»å‹ã€‚ä¾‹å¦‚ï¼Œåœ¨pushæ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬æ¥å—ä¸€ä¸ªç±»å‹ä¸ºTçš„å‚æ•°ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°å †æ ˆä¸­ã€‚åœ¨popæ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ç±»å‹å‚æ•°Tæ¥æŒ‡å®šè¿”å›å€¼çš„ç±»å‹ã€‚ ä½¿ç”¨æ³›åŒ–ç±»æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å®ä¾‹åŒ–ç±»æ—¶æŒ‡å®šå…·ä½“çš„ç±»å‹ï¼Œæˆ–è€…è®©ç±»å‹æ¨æ–­æœºåˆ¶è‡ªåŠ¨æ¨æ–­ç±»å‹ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›ç¤ºä¾‹ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">stack = Stack[<span class="built_in">int</span>]()  <span class="comment"># å®ä¾‹åŒ–ä¸€ä¸ªæ•´æ•°ç±»å‹çš„å †æ ˆ</span></span><br><span class="line">stack.push(<span class="number">1</span>)</span><br><span class="line">stack.push(<span class="number">2</span>)</span><br><span class="line">stack.push(<span class="number">3</span>)</span><br><span class="line"><span class="built_in">print</span>(stack.pop())  <span class="comment"># è¾“å‡º: 3</span></span><br><span class="line"><span class="built_in">print</span>(stack.size())  <span class="comment"># è¾“å‡º: 2</span></span><br><span class="line"></span><br><span class="line">stack2 = Stack[<span class="built_in">str</span>]()  <span class="comment"># å®ä¾‹åŒ–ä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹çš„å †æ ˆ</span></span><br><span class="line">stack2.push(<span class="string">&quot;Hello&quot;</span>)</span><br><span class="line">stack2.push(<span class="string">&quot;World&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(stack2.pop())  <span class="comment"># è¾“å‡º: &quot;World&quot;</span></span><br><span class="line"><span class="built_in">print</span>(stack2.size())  <span class="comment"># è¾“å‡º: 1</span></span><br></pre></td></tr></table></figure><p>é€šè¿‡ä½¿ç”¨æ³›åŒ–ç±»ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸åŒçš„ç±»å‹ä¸Šä½¿ç”¨ç›¸åŒçš„ä»£ç é€»è¾‘ï¼Œä»è€Œå®ç°æ›´é€šç”¨ã€å¯é‡ç”¨çš„ç±»ã€‚</p><p>åœ¨Pythonä¸­ï¼Œè¿ç®—ç¬¦é‡è½½ï¼ˆOperator Overloadingï¼‰æ˜¯æŒ‡é€šè¿‡ç‰¹æ®Šçš„æ–¹æ³•ï¼ˆä¹Ÿç§°ä¸ºé­”æœ¯æ–¹æ³•æˆ–åŒä¸‹åˆ’çº¿æ–¹æ³•ï¼‰æ¥å®šä¹‰è‡ªå®šä¹‰ç±»å‹çš„è¡Œä¸ºï¼Œä½¿å…¶æ”¯æŒæ ‡å‡†çš„è¿ç®—ç¬¦æ“ä½œã€‚ ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸ç”¨çš„è¿ç®—ç¬¦é‡è½½æ–¹æ³•åŠå…¶å¯¹åº”çš„è¿ç®—ç¬¦ï¼š</p><p><code>__add__</code>(self, other): è¿ç®—ç¬¦ + çš„é‡è½½æ–¹æ³•ï¼Œç”¨äºå®ç°ä¸¤ä¸ªå¯¹è±¡ç›¸åŠ çš„æ“ä½œã€‚</p><p><code>__sub__</code>(self, other): è¿ç®—ç¬¦ - çš„é‡è½½æ–¹æ³•ï¼Œç”¨äºå®ç°ä¸¤ä¸ªå¯¹è±¡ç›¸å‡çš„æ“ä½œã€‚</p><p><code>__mul__</code>(self, other): è¿ç®—ç¬¦ * çš„é‡è½½æ–¹æ³•ï¼Œç”¨äºå®ç°ä¸¤ä¸ªå¯¹è±¡ç›¸ä¹˜çš„æ“ä½œã€‚</p><p><code>__div__</code>(self, other): è¿ç®—ç¬¦ / çš„é‡è½½æ–¹æ³•ï¼Œç”¨äºå®ç°ä¸¤ä¸ªå¯¹è±¡ç›¸é™¤çš„æ“ä½œã€‚</p><p><code>__eq__</code>(self, other): è¿ç®—ç¬¦ == çš„é‡è½½æ–¹æ³•ï¼Œç”¨äºå®ç°ä¸¤ä¸ªå¯¹è±¡ç›¸ç­‰æ¯”è¾ƒçš„æ“ä½œã€‚</p><p><code>__lt__</code>(self, other): è¿ç®—ç¬¦ &lt; çš„é‡è½½æ–¹æ³•ï¼Œç”¨äºå®ç°ä¸¤ä¸ªå¯¹è±¡å°äºæ¯”è¾ƒçš„æ“ä½œã€‚</p><p><code>__gt__</code>(self, other): è¿ç®—ç¬¦ &gt; çš„é‡è½½æ–¹æ³•ï¼Œç”¨äºå®ç°ä¸¤ä¸ªå¯¹è±¡å¤§äºæ¯”è¾ƒçš„æ“ä½œã€‚ ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•åœ¨è‡ªå®šä¹‰ç±»ä¸­é‡è½½è¿ç®—ç¬¦ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Point</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, x, y</span>):</span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__add__</span>(<span class="params">self, other</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(other, Point):</span><br><span class="line">            <span class="keyword">return</span> Point(self.x + other.x, self.y + other.y)</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(other, <span class="built_in">int</span>) <span class="keyword">or</span> <span class="built_in">isinstance</span>(other, <span class="built_in">float</span>):</span><br><span class="line">            <span class="keyword">return</span> Point(self.x + other, self.y + other)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">&quot;Unsupported operand type for +&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__eq__</span>(<span class="params">self, other</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(other, Point):</span><br><span class="line">            <span class="keyword">return</span> self.x == other.x <span class="keyword">and</span> self.y == other.y</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;(<span class="subst">&#123;self.x&#125;</span>, <span class="subst">&#123;self.y&#125;</span>)&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨è¿ç®—ç¬¦é‡è½½</span></span><br><span class="line">p1 = Point(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">p2 = Point(<span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line">p3 = p1 + p2</span><br><span class="line"><span class="built_in">print</span>(p3)  <span class="comment"># è¾“å‡º: (4, 6)</span></span><br><span class="line"></span><br><span class="line">p4 = p1 + <span class="number">5</span></span><br><span class="line"><span class="built_in">print</span>(p4)  <span class="comment"># è¾“å‡º: (6, 7)</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(p1 == p2)  <span class="comment"># è¾“å‡º: False</span></span><br><span class="line"><span class="built_in">print</span>(p1 == Point(<span class="number">1</span>, <span class="number">2</span>))  <span class="comment"># è¾“å‡º: True</span></span><br></pre></td></tr></table></figure><p>åœ¨Pythonä¸­ï¼Œiter()æ˜¯ä¸€ä¸ªå†…ç½®å‡½æ•°ï¼Œç”¨äºè¿”å›ä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡çš„è¿­ä»£å™¨ã€‚ å¯è¿­ä»£å¯¹è±¡æ˜¯æŒ‡å®ç°äº†<code>__iter__</code>()æ–¹æ³•æˆ–<code>__getitem__</code>()æ–¹æ³•çš„å¯¹è±¡ã€‚è¿­ä»£å™¨æ˜¯ä¸€ä¸ªå®ç°äº†<code>__iter__</code>()æ–¹æ³•å’Œ<code>__next__</code>()æ–¹æ³•çš„å¯¹è±¡ã€‚iter()å‡½æ•°æ¥å—ä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œå¹¶è¿”å›è¯¥å¯è¿­ä»£å¯¹è±¡çš„è¿­ä»£å™¨ã€‚ ä»¥ä¸‹æ˜¯iter()å‡½æ•°çš„è¯­æ³•ï¼š</p><p>å¯è¿­ä»£å¯¹è±¡ï¼ˆIterableï¼‰å’Œè¿­ä»£å™¨ï¼ˆIteratorï¼‰æ˜¯Pythonä¸­ç”¨äºè¿­ä»£æ“ä½œçš„ä¸¤ä¸ªé‡è¦æ¦‚å¿µï¼Œå®ƒä»¬ä¹‹é—´æœ‰ä¸€äº›åŒºåˆ«ï¼š </p><ol><li><p>å¯è¿­ä»£å¯¹è±¡ï¼ˆIterableï¼‰ï¼š   </p><ul><li>å¯è¿­ä»£å¯¹è±¡æ˜¯æŒ‡å®ç°äº†<strong>iter</strong>()æ–¹æ³•æˆ–<strong>getitem</strong>()æ–¹æ³•çš„å¯¹è±¡ã€‚</li><li>å¯è¿­ä»£å¯¹è±¡å¯ä»¥ä½¿ç”¨forå¾ªç¯è¿›è¡Œè¿­ä»£ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å†…ç½®å‡½æ•°iter()å°†å…¶è½¬æ¢ä¸ºè¿­ä»£å™¨ã€‚   - å¯è¿­ä»£å¯¹è±¡æ¯æ¬¡è¿­ä»£éƒ½ä¼šè¿”å›ä¸€ä¸ªæ–°çš„è¿­ä»£å™¨ã€‚ </li></ul></li><li><p>è¿­ä»£å™¨ï¼ˆIteratorï¼‰ï¼š   </p><ul><li>è¿­ä»£å™¨æ˜¯æŒ‡å®ç°äº†<strong>iter</strong>()æ–¹æ³•å’Œ<strong>next</strong>()æ–¹æ³•çš„å¯¹è±¡ã€‚   </li><li>è¿­ä»£å™¨ç”¨äºä»å¯è¿­ä»£å¯¹è±¡ä¸­é€ä¸ªè·å–å…ƒç´ ï¼Œæ¯æ¬¡è°ƒç”¨<strong>next</strong>()æ–¹æ³•è¿”å›è¿­ä»£å¯¹è±¡ä¸­çš„ä¸‹ä¸€ä¸ªå…ƒç´ ã€‚   </li><li>è¿­ä»£å™¨å…·æœ‰å†…éƒ¨çŠ¶æ€ï¼Œå¯ä»¥è®°ä½å½“å‰è¿­ä»£çš„ä½ç½®ã€‚   </li><li>å½“è¿­ä»£å™¨ä¸­æ²¡æœ‰æ›´å¤šçš„å…ƒç´ å¯ä¾›è·å–æ—¶ï¼Œè°ƒç”¨<strong>next</strong>()æ–¹æ³•ä¼šå¼•å‘StopIterationå¼‚å¸¸ã€‚<br>ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œå±•ç¤ºå¯è¿­ä»£å¯¹è±¡å’Œè¿­ä»£å™¨çš„åŒºåˆ«ï¼š</li></ul></li></ol><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SentenceIterator</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, words</span>):</span><br><span class="line">        self.words = words</span><br><span class="line">        self.index = <span class="number">0</span></span><br><span class="line">        </span><br><span class="line">    <span class="comment"># æœ‰äº†è¿™ä¸ªå‡½æ•°æ‰æ˜¯è¿­ä»£å™¨</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__next__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            word =  self.words[self.index]</span><br><span class="line">        <span class="keyword">except</span> IndexError:</span><br><span class="line">            <span class="keyword">raise</span> StopIteration()</span><br><span class="line">        self.index += <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> word</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Sentence</span>:</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;å®ç°ä¸€ä¸ªç±»ï¼Œä¼ å…¥ä¸€ä¸ªå¥å­ï¼Œåœ¨ä½¿ç”¨forè¿­ä»£çš„æ—¶å€™ï¼Œæ¯æ¬¡è¿”å›è¿™ä¸ªå¥å­çš„å•è¯ï¼ˆç©ºæ ¼åˆ’åˆ†ï¼‰&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, val:<span class="built_in">str</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        self.words = val.split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__iter__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;æ¯æ¬¡è¿­ä»£éƒ½è¿”å›æ–°çš„è¿”å›è¿­ä»£å™¨ï¼Œæœ‰äº†è¿™ä¸ªæ–¹æ³•æ‰æ˜¯å¯è¿­ä»£å¯¹è±¡&#x27;&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> SentenceIterator(self.words)</span><br><span class="line">    </span><br><span class="line">sentence = Sentence(<span class="string">&quot;I&#x27;m a Person.&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> word <span class="keyword">in</span> sentence:</span><br><span class="line">    <span class="built_in">print</span>(word)</span><br></pre></td></tr></table></figure><p>ç”Ÿæˆå™¨ï¼ˆGeneratorï¼‰æ˜¯ä¸€ç§ç‰¹æ®Šçš„è¿­ä»£å™¨ï¼Œå®ƒå¯ä»¥ä½¿ç”¨å‡½æ•°å’Œyieldè¯­å¥æ¥å®šä¹‰ã€‚ç”Ÿæˆå™¨å‡½æ•°å¯ä»¥é€ä¸ªäº§ç”Ÿå…ƒç´ ï¼Œè€Œä¸éœ€è¦ä¸€æ¬¡æ€§ç”Ÿæˆæ‰€æœ‰å…ƒç´ ã€‚ </p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">countdown</span>(<span class="params">n</span>):</span><br><span class="line">    <span class="keyword">while</span> n &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">yield</span> n</span><br><span class="line">        n -= <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºç”Ÿæˆå™¨å¯¹è±¡</span></span><br><span class="line">generator = countdown(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ç”Ÿæˆå™¨é€ä¸ªè·å–å…ƒç´ </span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">next</span>(generator))  <span class="comment"># è¾“å‡º: 5</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">next</span>(generator))  <span class="comment"># è¾“å‡º: 4</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">next</span>(generator))  <span class="comment"># è¾“å‡º: 3</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">next</span>(generator))  <span class="comment"># è¾“å‡º: 2</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">next</span>(generator))  <span class="comment"># è¾“å‡º: 1</span></span><br><span class="line"><span class="comment"># print(next(generator))  # å¼•å‘ StopIteration å¼‚å¸¸</span></span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªç”Ÿæˆå™¨å‡½æ•°countdown()ï¼Œå®ƒä½¿ç”¨whileå¾ªç¯å’Œyieldè¯­å¥é€ä¸ªäº§ç”Ÿå…ƒç´ ã€‚æˆ‘ä»¬é€šè¿‡è°ƒç”¨ç”Ÿæˆå™¨å‡½æ•°æ¥åˆ›å»ºä¸€ä¸ªç”Ÿæˆå™¨å¯¹è±¡generatorã€‚ ç„¶åï¼Œæˆ‘ä»¬ä½¿ç”¨next()å‡½æ•°é€ä¸ªè·å–ç”Ÿæˆå™¨ä¸­çš„å…ƒç´ ã€‚æ¯æ¬¡è°ƒç”¨next()å‡½æ•°æ—¶ï¼Œç”Ÿæˆå™¨å‡½æ•°ä¼šä»ä¸Šæ¬¡æš‚åœçš„ä½ç½®ç»§ç»­æ‰§è¡Œï¼Œç›´åˆ°é‡åˆ°ä¸‹ä¸€ä¸ªyieldè¯­å¥ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“ç”Ÿæˆå™¨ä¸­æ²¡æœ‰æ›´å¤šçš„å…ƒç´ å¯ä¾›è·å–æ—¶ï¼Œå†æ¬¡è°ƒç”¨next()å‡½æ•°ä¼šå¼•å‘StopIterationå¼‚å¸¸ã€‚ ç”Ÿæˆå™¨çš„ä¸€ä¸ªé‡è¦ç‰¹ç‚¹æ˜¯å®ƒä»¬åœ¨è¿­ä»£è¿‡ç¨‹ä¸­ä¿æŒçŠ¶æ€ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§ç”Ÿæˆæ‰€æœ‰å…ƒç´ ã€‚è¿™ä½¿å¾—ç”Ÿæˆå™¨éå¸¸é€‚åˆå¤„ç†å¤§é‡æ•°æ®æˆ–æ— é™åºåˆ—ï¼Œå› ä¸ºå®ƒä»¬åªåœ¨éœ€è¦æ—¶äº§ç”Ÿå…ƒç´ ï¼Œä»è€ŒèŠ‚çœäº†å†…å­˜å’Œè®¡ç®—èµ„æºã€‚ é™¤äº†ä½¿ç”¨ç”Ÿæˆå™¨å‡½æ•°åˆ›å»ºç”Ÿæˆå™¨ä¹‹å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ç”Ÿæˆå™¨è¡¨è¾¾å¼æ¥åˆ›å»ºç”Ÿæˆå™¨ã€‚ç”Ÿæˆå™¨è¡¨è¾¾å¼ä¸åˆ—è¡¨æ¨å¯¼å¼ç±»ä¼¼ï¼Œä½†ä½¿ç”¨åœ†æ‹¬å·è€Œä¸æ˜¯æ–¹æ‹¬å·ã€‚ ä»¥ä¸‹æ˜¯ä½¿ç”¨ç”Ÿæˆå™¨è¡¨è¾¾å¼åˆ›å»ºç”Ÿæˆå™¨çš„ç¤ºä¾‹ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">numbers = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ç”Ÿæˆå™¨è¡¨è¾¾å¼åˆ›å»ºç”Ÿæˆå™¨å¯¹è±¡</span></span><br><span class="line">generator = (num <span class="keyword">for</span> num <span class="keyword">in</span> numbers <span class="keyword">if</span> num % <span class="number">2</span> == <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ç”Ÿæˆå™¨é€ä¸ªè·å–å…ƒç´ </span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">next</span>(generator))  <span class="comment"># è¾“å‡º: 2</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">next</span>(generator))  <span class="comment"># è¾“å‡º: 4</span></span><br><span class="line"><span class="comment"># print(next(generator))  # å¼•å‘ StopIteration å¼‚å¸¸</span></span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ç”Ÿæˆå™¨è¡¨è¾¾å¼(num for num in numbers if num % 2 == 0)åˆ›å»ºäº†ä¸€ä¸ªç”Ÿæˆå™¨å¯¹è±¡generatorã€‚è¯¥ç”Ÿæˆå™¨å¯¹è±¡ä¼šé€ä¸ªäº§ç”Ÿåˆ—è¡¨numbersä¸­æ»¡è¶³æ¡ä»¶çš„å¶æ•°ã€‚</p><p>åœ¨Pythonä¸­ï¼Œä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼ˆContext Managerï¼‰æ˜¯ä¸€ç§ç”¨äºç®¡ç†èµ„æºçš„å¯¹è±¡ï¼Œå®ƒå®šä¹‰äº†åœ¨è¿›å…¥å’Œé€€å‡ºç‰¹å®šä»£ç å—æ—¶è¦æ‰§è¡Œçš„æ“ä½œã€‚ä¸Šä¸‹æ–‡ç®¡ç†å™¨é€šå¸¸ç”¨äºç¡®ä¿èµ„æºçš„æ­£ç¡®åˆ†é…å’Œé‡Šæ”¾ï¼Œä¾‹å¦‚æ‰“å¼€å’Œå…³é—­æ–‡ä»¶ã€è·å–å’Œé‡Šæ”¾é”ç­‰ã€‚ ä¸Šä¸‹æ–‡ç®¡ç†å™¨å¯ä»¥ä½¿ç”¨ä¸¤ç§æ–¹å¼æ¥å®ç°ï¼šé€šè¿‡ç±»å®ç°å’Œé€šè¿‡è£…é¥°å™¨å®ç°ã€‚ 1. ç±»å®ç°ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼š   - é€šè¿‡å®šä¹‰ä¸€ä¸ªç±»ï¼Œå¹¶åœ¨ç±»ä¸­å®ç°<code>__enter__</code>()å’Œ<code>__exit__</code>()æ–¹æ³•æ¥åˆ›å»ºä¸Šä¸‹æ–‡ç®¡ç†å™¨ã€‚   - <code>__enter__</code>()æ–¹æ³•åœ¨è¿›å…¥ä»£ç å—å‰æ‰§è¡Œï¼Œé€šå¸¸ç”¨äºè·å–èµ„æºæˆ–æ‰§è¡Œå¿…è¦çš„å‡†å¤‡å·¥ä½œï¼Œå¹¶å°†èµ„æºè¿”å›ç»™è°ƒç”¨è€…ã€‚   - <code>__exit__</code>()æ–¹æ³•åœ¨é€€å‡ºä»£ç å—æ—¶æ‰§è¡Œï¼Œé€šå¸¸ç”¨äºé‡Šæ”¾èµ„æºæˆ–æ‰§è¡Œæ¸…ç†æ“ä½œã€‚   - å¦‚æœåœ¨ä»£ç å—ä¸­å‘ç”Ÿå¼‚å¸¸ï¼Œå¼‚å¸¸ä¼šè¢«ä¼ é€’ç»™<code>__exit__</code>()æ–¹æ³•å¤„ç†ï¼Œå¯ä»¥åœ¨<code>__exit__</code>()æ–¹æ³•ä¸­è¿›è¡Œå¼‚å¸¸å¤„ç†å’Œæ—¥å¿—è®°å½•ç­‰æ“ä½œã€‚ ä»¥ä¸‹æ˜¯ä¸€ä¸ªä½¿ç”¨ç±»å®ç°ä¸Šä¸‹æ–‡ç®¡ç†å™¨çš„ç¤ºä¾‹ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ¨¡æ‹Ÿ Python çš„æ‰“å¼€æ–‡ä»¶ã€å…³é—­æ–‡ä»¶æ“ä½œ</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Filemanager</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, mode</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;calling __init__ method&#x27;</span>)</span><br><span class="line">        self.name = name</span><br><span class="line">        self.mode = mode</span><br><span class="line">        self.file = <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__enter__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;caling __enter__ method&#x27;</span>)</span><br><span class="line">        self.file = <span class="built_in">open</span>(self.name, self.mode)</span><br><span class="line">        <span class="keyword">return</span> self.file</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__exit__</span>(<span class="params">self, exc_type, exc_val, exc_tb</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;caling __exit__ method&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> self.file:</span><br><span class="line">            self.file.close</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Filemanagerä¸ºä¸Šä¸‹æ–‡ç®¡ç†å™¨</span></span><br><span class="line"><span class="comment"># with Filemanager(&#x27;test.txt&#x27;, &#x27;w&#x27;) as f æ˜¯ä¸Šä¸‹æ–‡è¡¨è¾¾å¼ï¼Œfä¸ºèµ„æºå¯¹è±¡ </span></span><br><span class="line"><span class="keyword">with</span> Filemanager(<span class="string">&#x27;test.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;ready to write to file&#x27;</span>)</span><br><span class="line">    f.write(<span class="string">&#x27;Hello World&#x27;</span>)</span><br></pre></td></tr></table></figure><p>exitæ–¹æ³•ä¸­çš„å‚æ•°exc_typeã€exc_valã€exc_tbåˆ†åˆ«è¡¨ç¤ºexception typeã€exception valueã€tracebackã€‚</p><p>è£…é¥°å™¨å®ç°ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼š</p><ul><li>é€šè¿‡ä½¿ç”¨@contextlib.contextmanagerè£…é¥°å™¨å’Œç”Ÿæˆå™¨å‡½æ•°æ¥åˆ›å»ºä¸Šä¸‹æ–‡ç®¡ç†å™¨ã€‚   </li><li>åœ¨ç”Ÿæˆå™¨å‡½æ•°å†…éƒ¨ï¼Œä½¿ç”¨yieldè¯­å¥å°†æ§åˆ¶æƒæš‚æ—¶äº¤ç»™è°ƒç”¨è€…ï¼Œå¹¶åœ¨yieldè¯­å¥å‰åæ‰§è¡Œè¿›å…¥å’Œé€€å‡ºä»£ç å—çš„æ“ä½œã€‚   </li><li>è°ƒç”¨è€…å¯ä»¥ä½¿ç”¨withè¯­å¥æ¥ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼Œè€Œä¸éœ€è¦æ‰‹åŠ¨è°ƒç”¨<strong>enter</strong>()å’Œ<strong>exit</strong>()æ–¹æ³•ã€‚ ä»¥ä¸‹æ˜¯ä¸€ä¸ªä½¿ç”¨è£…é¥°å™¨å®ç°ä¸Šä¸‹æ–‡ç®¡ç†å™¨çš„ç¤ºä¾‹ï¼š</li></ul><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> contextlib <span class="keyword">import</span> contextmanager</span><br><span class="line"></span><br><span class="line"><span class="meta">@contextmanager</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">file_manager</span>(<span class="params">name, mode</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        f = <span class="built_in">open</span>(name, mode)</span><br><span class="line">        <span class="keyword">yield</span> f</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        f.close()</span><br><span class="line">        </span><br><span class="line"><span class="keyword">with</span> file_manager(<span class="string">&#x27;test.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(<span class="string">&#x27;hello world&#x27;</span>)</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨@contextmanagerè£…é¥°å™¨å°†ç”Ÿæˆå™¨å‡½æ•°my<em>context<em>manager()è½¬æ¢ä¸ºä¸Šä¸‹æ–‡ç®¡ç†å™¨ã€‚åœ¨ç”Ÿæˆå™¨å‡½æ•°å†…éƒ¨ï¼Œæˆ‘ä»¬ä½¿ç”¨yieldè¯­å¥å°†æ§åˆ¶æƒäº¤ç»™è°ƒç”¨è€…ï¼Œå¹¶åœ¨yieldè¯­å¥å‰åæ‰§è¡Œè¿›å…¥å’Œé€€å‡ºä»£ç å—çš„æ“ä½œã€‚ ç„¶åï¼Œæˆ‘ä»¬ä½¿ç”¨withè¯­å¥æ¥ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨ã€‚åœ¨withä»£ç å—ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œéœ€è¦çš„æ“ä½œï¼Œè€Œä¸éœ€è¦æ‰‹åŠ¨è°ƒç”¨<strong>enter</strong>()å’Œ__exit</em></em>()æ–¹æ³•ã€‚å¦‚æœåœ¨ä»£ç å—ä¸­å‘ç”Ÿå¼‚å¸¸ï¼Œå¼‚å¸¸ä¼šè¢«ä¼ é€’ç»™ç”Ÿæˆå™¨å‡½æ•°ä¸­çš„exceptå—å¤„ç†ã€‚ ä¸Šä¸‹æ–‡ç®¡ç†å™¨æ˜¯ä¸€ç§éå¸¸æœ‰ç”¨çš„ç¼–ç¨‹æ¨¡å¼ï¼Œå®ƒå¯ä»¥ç¡®ä¿èµ„æºçš„æ­£ç¡®åˆ†é…å’Œé‡Šæ”¾ï¼Œæé«˜ä»£ç çš„å¯è¯»æ€§å’Œå¥å£®æ€§ã€‚</p><p>GILï¼ˆGlobal Interpreter Lockï¼‰æ˜¯Pythonè§£é‡Šå™¨ä¸­çš„ä¸€ä¸ªæœºåˆ¶ï¼Œå®ƒæ˜¯ä¸ºäº†ä¿è¯è§£é‡Šå™¨åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„å®‰å…¨æ€§è€Œå¼•å…¥çš„ã€‚GILçš„å­˜åœ¨å¯¼è‡´äº†Pythonè§£é‡Šå™¨åœ¨åŒä¸€æ—¶é—´åªèƒ½æ‰§è¡Œä¸€ä¸ªçº¿ç¨‹çš„å­—èŠ‚ç ï¼Œä»è€Œé™åˆ¶äº†å¤šçº¿ç¨‹å¹¶è¡Œæ‰§è¡Œçš„èƒ½åŠ›ã€‚</p><p>GILçš„ä½œç”¨æ˜¯åœ¨è§£é‡Šå™¨çº§åˆ«ä¸Šä¿æŠ¤Pythonå¯¹è±¡å…å—å¹¶å‘è®¿é—®çš„å½±å“ã€‚ç”±äºPythonçš„å†…å­˜ç®¡ç†ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼ŒGILå¯ä»¥ç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿæ“ä½œPythonå¯¹è±¡ï¼Œä»è€Œé¿å…äº†å¤šçº¿ç¨‹è®¿é—®åŒä¸€å¯¹è±¡æ—¶å¯èƒ½å¼•å‘çš„ç«æ€æ¡ä»¶å’Œæ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€‚</p><p>ç”±äºGILçš„å­˜åœ¨ï¼ŒPythonçš„å¤šçº¿ç¨‹å¹¶ä¸èƒ½çœŸæ­£å‘æŒ¥å¤šæ ¸å¤„ç†å™¨çš„å¹¶è¡Œè®¡ç®—èƒ½åŠ›ã€‚åœ¨CPUå¯†é›†å‹ä»»åŠ¡ä¸­ï¼Œå¤šçº¿ç¨‹çš„æ€§èƒ½å¯èƒ½æ¯”å•çº¿ç¨‹è¿˜è¦å·®ã€‚ç„¶è€Œï¼Œåœ¨I/Oå¯†é›†å‹ä»»åŠ¡ä¸­ï¼Œå¤šçº¿ç¨‹ä»ç„¶å¯ä»¥æä¾›ä¸€å®šçš„æ€§èƒ½ä¼˜åŠ¿ï¼Œå› ä¸ºçº¿ç¨‹å¯ä»¥åœ¨ç­‰å¾…I/Oæ“ä½œå®Œæˆæ—¶é‡Šæ”¾GILï¼Œå…è®¸å…¶ä»–çº¿ç¨‹æ‰§è¡Œã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒGILåªå­˜åœ¨äºCPythonè§£é‡Šå™¨ä¸­ï¼Œå®ƒæ˜¯Pythonçš„å‚è€ƒå®ç°ã€‚å…¶ä»–ä¸€äº›Pythonè§£é‡Šå™¨ï¼Œå¦‚Jythonå’ŒIronPythonï¼Œæ²¡æœ‰GILï¼Œå¯ä»¥å®ç°çœŸæ­£çš„å¹¶è¡Œæ‰§è¡Œã€‚</p><p>ä¸ºäº†å……åˆ†åˆ©ç”¨å¤šæ ¸å¤„ç†å™¨çš„å¹¶è¡Œè®¡ç®—èƒ½åŠ›ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨å¤šè¿›ç¨‹ã€å¼‚æ­¥ç¼–ç¨‹æˆ–ä½¿ç”¨å…¶ä»–è¯­è¨€ç¼–å†™CPUå¯†é›†å‹ä»»åŠ¡çš„æ¨¡å—ã€‚</p><p>ä¸‹é¢æ˜¯å‡ ä¸ªä½¿ç”¨Pythonå®ç°å¹¶å‘çš„ç¤ºä¾‹ï¼š 1. å¤šçº¿ç¨‹å¹¶å‘ä¸‹è½½æ–‡ä»¶ï¼š   ä½¿ç”¨threadingæ¨¡å—åˆ›å»ºå¤šä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹è´Ÿè´£ä¸‹è½½ä¸€ä¸ªæ–‡ä»¶ã€‚  </p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download_file</span>(<span class="params">url, filename</span>):</span><br><span class="line">    response = requests.get(url)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">        file.write(response.content)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–‡ä»¶ä¸‹è½½é“¾æ¥åˆ—è¡¨</span></span><br><span class="line">urls = [</span><br><span class="line">    <span class="string">&#x27;http://example.com/file1.txt&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;http://example.com/file2.txt&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;http://example.com/file3.txt&#x27;</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºå¤šä¸ªçº¿ç¨‹è¿›è¡Œæ–‡ä»¶ä¸‹è½½</span></span><br><span class="line">threads = []</span><br><span class="line"><span class="keyword">for</span> url <span class="keyword">in</span> urls:</span><br><span class="line">    filename = url.split(<span class="string">&#x27;/&#x27;</span>)[-<span class="number">1</span>]</span><br><span class="line">    thread = threading.Thread(target=download_file, args=(url, filename))</span><br><span class="line">    thread.start()</span><br><span class="line">    threads.append(thread)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç­‰å¾…æ‰€æœ‰çº¿ç¨‹æ‰§è¡Œå®Œæ¯•</span></span><br><span class="line"><span class="keyword">for</span> thread <span class="keyword">in</span> threads:</span><br><span class="line">    thread.join()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¤šè¿›ç¨‹å¹¶å‘å¤„ç†ä»»åŠ¡ï¼šä½¿ç”¨multiprocessingæ¨¡å—åˆ›å»ºå¤šä¸ªè¿›ç¨‹ï¼Œæ¯ä¸ªè¿›ç¨‹è´Ÿè´£å¤„ç†ä¸€ä¸ªä»»åŠ¡ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_task</span>(<span class="params">task</span>):</span><br><span class="line">    <span class="comment"># å¤„ç†ä»»åŠ¡</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Processing task: <span class="subst">&#123;task&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»»åŠ¡åˆ—è¡¨</span></span><br><span class="line">tasks = [<span class="string">&#x27;task1&#x27;</span>, <span class="string">&#x27;task2&#x27;</span>, <span class="string">&#x27;task3&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºå¤šä¸ªè¿›ç¨‹å¤„ç†ä»»åŠ¡</span></span><br><span class="line">processes = []</span><br><span class="line"><span class="keyword">for</span> task <span class="keyword">in</span> tasks:</span><br><span class="line">    process = multiprocessing.Process(target=process_task, args=(task,))</span><br><span class="line">    process.start()</span><br><span class="line">    processes.append(process)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç­‰å¾…æ‰€æœ‰è¿›ç¨‹æ‰§è¡Œå®Œæ¯•</span></span><br><span class="line"><span class="keyword">for</span> process <span class="keyword">in</span> processes:</span><br><span class="line">    process.join()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¼‚æ­¥å¹¶å‘æ‰§è¡Œç½‘ç»œè¯·æ±‚ï¼š ä½¿ç”¨asyncioæ¨¡å—å’Œaiohttpåº“è¿›è¡Œå¼‚æ­¥ç¼–ç¨‹ï¼Œå®ç°å¹¶å‘æ‰§è¡Œå¤šä¸ªç½‘ç»œè¯·æ±‚ã€‚     </p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">fetch</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> session:</span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> session.get(url) <span class="keyword">as</span> response:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> response.text()</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç½‘ç»œè¯·æ±‚é“¾æ¥åˆ—è¡¨</span></span><br><span class="line">urls = [</span><br><span class="line">    <span class="string">&#x27;http://example.com/page1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;http://example.com/page2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;http://example.com/page3&#x27;</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    tasks = [fetch(url) <span class="keyword">for</span> url <span class="keyword">in</span> urls]</span><br><span class="line">    results = <span class="keyword">await</span> asyncio.gather(*tasks)</span><br><span class="line">    <span class="keyword">for</span> result <span class="keyword">in</span> results:</span><br><span class="line">        <span class="built_in">print</span>(result)</span><br><span class="line"></span><br><span class="line">asyncio.run(main())</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>åœ¨Pythonä¸­ï¼Œå¯ä»¥ä½¿ç”¨multiprocessing.Poolç±»æ¥è‡ªå»ºè¿›ç¨‹æ± ï¼Œä»¥å®ç°å¹¶å‘æ‰§è¡Œå¤šä¸ªä»»åŠ¡çš„ç›®çš„ã€‚è¿›ç¨‹æ± å¯ä»¥æé«˜ä»»åŠ¡çš„æ‰§è¡Œæ•ˆç‡ï¼Œå‡å°‘åˆ›å»ºå’Œé”€æ¯è¿›ç¨‹çš„å¼€é”€ã€‚ ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨multiprocessing.Poolè‡ªå»ºè¿›ç¨‹æ± çš„ç¤ºä¾‹ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_task</span>(<span class="params">task</span>):</span><br><span class="line">    <span class="comment"># å¤„ç†ä»»åŠ¡</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Processing task: <span class="subst">&#123;task&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºè¿›ç¨‹æ± ï¼ŒæŒ‡å®šè¿›ç¨‹æ•°é‡</span></span><br><span class="line">pool = multiprocessing.Pool(processes=<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»»åŠ¡åˆ—è¡¨</span></span><br><span class="line">tasks = [<span class="string">&#x27;task1&#x27;</span>, <span class="string">&#x27;task2&#x27;</span>, <span class="string">&#x27;task3&#x27;</span>, <span class="string">&#x27;task4&#x27;</span>, <span class="string">&#x27;task5&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨è¿›ç¨‹æ± æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">pool.<span class="built_in">map</span>(process_task, tasks)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…³é—­è¿›ç¨‹æ± ï¼Œé˜»æ­¢æ–°çš„ä»»åŠ¡æäº¤</span></span><br><span class="line">pool.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç­‰å¾…æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæ¯•</span></span><br><span class="line">pool.join()</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ªè¿›ç¨‹æ± å¯¹è±¡poolï¼Œé€šè¿‡æŒ‡å®šprocesseså‚æ•°æ¥è®¾ç½®è¿›ç¨‹çš„æ•°é‡ã€‚ç„¶åï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªä»»åŠ¡å¤„ç†å‡½æ•°process_taskï¼Œè¯¥å‡½æ•°ç”¨äºå¤„ç†æ¯ä¸ªä»»åŠ¡ã€‚ æ¥ç€ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªä»»åŠ¡åˆ—è¡¨tasksï¼Œå…¶ä¸­åŒ…å«äº†éœ€è¦å¤„ç†çš„å¤šä¸ªä»»åŠ¡ã€‚ä½¿ç”¨pool.map()æ–¹æ³•ï¼Œæˆ‘ä»¬å°†ä»»åŠ¡åˆ—è¡¨å’Œä»»åŠ¡å¤„ç†å‡½æ•°ä½œä¸ºå‚æ•°ä¼ é€’ç»™è¿›ç¨‹æ± ï¼Œè¿›ç¨‹æ± ä¼šè‡ªåŠ¨å°†ä»»åŠ¡åˆ†é…ç»™ç©ºé—²çš„è¿›ç¨‹è¿›è¡Œå¤„ç†ã€‚ æœ€åï¼Œæˆ‘ä»¬å…³é—­è¿›ç¨‹æ± å¹¶è°ƒç”¨pool.join()æ–¹æ³•ï¼Œä»¥ç­‰å¾…æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿›ç¨‹æ± åœ¨æ‰§è¡Œä»»åŠ¡æ—¶ä¼šè‡ªåŠ¨ç®¡ç†è¿›ç¨‹çš„åˆ›å»ºå’Œé”€æ¯ï¼Œå› æ­¤ä¸éœ€è¦æ‰‹åŠ¨åˆ›å»ºå’Œé”€æ¯è¿›ç¨‹ã€‚è¿›ç¨‹æ± å†…éƒ¨ä¼šç»´æŠ¤ä¸€ä¸ªè¿›ç¨‹é˜Ÿåˆ—ï¼Œæ ¹æ®ä»»åŠ¡çš„æ•°é‡å’Œè¿›ç¨‹æ± çš„å¤§å°æ¥åŠ¨æ€åˆ†é…ä»»åŠ¡ç»™è¿›ç¨‹</p><p>concurrent.futuresæ˜¯Pythonæ ‡å‡†åº“ä¸­çš„ä¸€ä¸ªæ¨¡å—ï¼Œæä¾›äº†é«˜çº§çš„å¹¶å‘ç¼–ç¨‹æ¥å£ï¼Œç”¨äºç®¡ç†å¹¶å‘ä»»åŠ¡çš„æ‰§è¡Œå’Œç»“æœçš„è·å–ã€‚å®ƒå»ºç«‹åœ¨threadingå’Œmultiprocessingæ¨¡å—ä¹‹ä¸Šï¼Œæä¾›äº†çº¿ç¨‹æ± å’Œè¿›ç¨‹æ± çš„å®ç°ã€‚ concurrent.futuresæ¨¡å—ä¸»è¦åŒ…å«ä»¥ä¸‹ä¸¤ä¸ªç±»ï¼š 1. ThreadPoolExecutorï¼šçº¿ç¨‹æ± æ‰§è¡Œå™¨ï¼Œç”¨äºç®¡ç†çº¿ç¨‹æ± å¹¶å‘æ‰§è¡Œä»»åŠ¡ã€‚ 2. ProcessPoolExecutorï¼šè¿›ç¨‹æ± æ‰§è¡Œå™¨ï¼Œç”¨äºç®¡ç†è¿›ç¨‹æ± å¹¶å‘æ‰§è¡Œä»»åŠ¡ã€‚ è¿™ä¸¤ä¸ªæ‰§è¡Œå™¨ç±»éƒ½å®ç°äº†Executoræ¥å£ï¼Œæä¾›äº†ä¸€ç³»åˆ—æ–¹æ³•æ¥æäº¤ä»»åŠ¡ã€è·å–ç»“æœã€å…³é—­æ‰§è¡Œå™¨ç­‰ã€‚ ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨concurrent.futuresæ¨¡å—çš„ç¤ºä¾‹ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor, as_completed</span><br><span class="line"><span class="keyword">from</span> concurrent <span class="keyword">import</span> futures </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_task</span>(<span class="params">task</span>):</span><br><span class="line">    <span class="comment"># å¤„ç†ä»»åŠ¡</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Processing task: <span class="subst">&#123;task&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;Result: <span class="subst">&#123;task&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºçº¿ç¨‹æ± æ‰§è¡Œå™¨ï¼ŒæŒ‡å®šçº¿ç¨‹æ•°é‡</span></span><br><span class="line"><span class="keyword">with</span> ThreadPoolExecutor(max_workers=<span class="number">4</span>) <span class="keyword">as</span> executor:</span><br><span class="line">    <span class="comment"># ä»»åŠ¡åˆ—è¡¨</span></span><br><span class="line">    tasks = [<span class="string">&#x27;task1&#x27;</span>, <span class="string">&#x27;task2&#x27;</span>, <span class="string">&#x27;task3&#x27;</span>, <span class="string">&#x27;task4&#x27;</span>, <span class="string">&#x27;task5&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æäº¤ä»»åŠ¡åˆ°çº¿ç¨‹æ± </span></span><br><span class="line">    futures = [executor.submit(process_task, task) <span class="keyword">for</span> task <span class="keyword">in</span> tasks]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è·å–ä»»åŠ¡ç»“æœ</span></span><br><span class="line">    <span class="keyword">for</span> future <span class="keyword">in</span> as_completed(futures):</span><br><span class="line">        result = future.result()</span><br><span class="line">        <span class="built_in">print</span>(result)</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨ThreadPoolExecutoræ¥å¹¶å‘ä¸‹è½½æ–‡ä»¶çš„ç¤ºä¾‹ä»£ç ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> concurrent.futures</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download_file</span>(<span class="params">url</span>):</span><br><span class="line">    response = requests.get(url)</span><br><span class="line">    filename = url.split(<span class="string">&#x27;/&#x27;</span>)[-<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">        file.write(response.content)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Downloaded file: <span class="subst">&#123;filename&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–‡ä»¶ä¸‹è½½é“¾æ¥åˆ—è¡¨</span></span><br><span class="line">urls = [</span><br><span class="line">    <span class="string">&#x27;http://example.com/file1.txt&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;http://example.com/file2.txt&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;http://example.com/file3.txt&#x27;</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºçº¿ç¨‹æ± æ‰§è¡Œå™¨ï¼ŒæŒ‡å®šçº¿ç¨‹æ•°é‡</span></span><br><span class="line"><span class="keyword">with</span> concurrent.futures.ThreadPoolExecutor() <span class="keyword">as</span> executor:</span><br><span class="line">    <span class="comment"># æäº¤ä¸‹è½½ä»»åŠ¡åˆ°çº¿ç¨‹æ± </span></span><br><span class="line">    futures = [executor.submit(download_file, url) <span class="keyword">for</span> url <span class="keyword">in</span> urls]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è·å–ä»»åŠ¡ç»“æœ</span></span><br><span class="line">    <span class="keyword">for</span> future <span class="keyword">in</span> concurrent.futures.as_completed(futures):</span><br><span class="line">        result = future.result()</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆå®šä¹‰äº†ä¸€ä¸ªdownload_fileå‡½æ•°ï¼Œç”¨äºä¸‹è½½æŒ‡å®šURLçš„æ–‡ä»¶ã€‚è¯¥å‡½æ•°ä½¿ç”¨requestsåº“å‘é€HTTPè¯·æ±‚å¹¶å°†å“åº”å†…å®¹å†™å…¥æœ¬åœ°æ–‡ä»¶ã€‚ ç„¶åï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæ–‡ä»¶ä¸‹è½½é“¾æ¥åˆ—è¡¨urlsï¼Œå…¶ä¸­åŒ…å«äº†éœ€è¦ä¸‹è½½çš„æ–‡ä»¶çš„URLã€‚ æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹æ± æ‰§è¡Œå™¨executorï¼Œå¹¶ä½¿ç”¨executor.submit()æ–¹æ³•å°†ä¸‹è½½ä»»åŠ¡æäº¤ç»™çº¿ç¨‹æ± æ‰§è¡Œå™¨ã€‚submit()æ–¹æ³•è¿”å›ä¸€ä¸ªFutureå¯¹è±¡ï¼Œè¡¨ç¤ºä»»åŠ¡çš„æ‰§è¡Œç»“æœã€‚ æœ€åï¼Œæˆ‘ä»¬ä½¿ç”¨concurrent.futures.as_completed()å‡½æ•°æ¥è¿­ä»£Futureå¯¹è±¡ï¼Œè·å–ä¸‹è½½ä»»åŠ¡çš„ç»“æœã€‚as_completed()å‡½æ•°ä¼šè¿”å›ä¸€ä¸ªè¿­ä»£å™¨ï¼ŒæŒ‰ç…§ä»»åŠ¡çš„å®Œæˆé¡ºåºè¿”å›Futureå¯¹è±¡ã€‚æˆ‘ä»¬é€šè¿‡è°ƒç”¨future.result()æ–¹æ³•è·å–æ¯ä¸ªä»»åŠ¡çš„ç»“æœã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ä½¿ç”¨ThreadPoolExecutoræ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†withè¯­å¥æ¥è‡ªåŠ¨ç®¡ç†æ‰§è¡Œå™¨çš„åˆ›å»ºå’Œå…³é—­ã€‚åœ¨withä»£ç å—ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æäº¤ä»»åŠ¡ã€è·å–ç»“æœç­‰æ“ä½œã€‚æ‰§è¡Œå™¨ä¼šåœ¨ä»£ç å—ç»“æŸæ—¶è‡ªåŠ¨å…³é—­ï¼Œé‡Šæ”¾èµ„æºã€‚</p><p>Python asyncioï¼ˆå¼‚æ­¥I/Oï¼‰æ˜¯ä¸€ç§åŸºäºäº‹ä»¶å¾ªç¯çš„å¼‚æ­¥ç¼–ç¨‹åº“ï¼Œç”¨äºç¼–å†™é«˜æ•ˆçš„å¹¶å‘ä»£ç ã€‚å®ƒæä¾›äº†ä¸€ç§åç¨‹ï¼ˆcoroutineï¼‰çš„æ–¹å¼ï¼Œä½¿å¾—ç¼–å†™å¼‚æ­¥ä»£ç æ›´åŠ ç®€æ´å’Œå¯è¯»ã€‚ ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•ä½¿ç”¨asyncioæ¥æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">hello</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Hello&quot;</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;World&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">await</span> asyncio.gather(</span><br><span class="line">        hello(),</span><br><span class="line">        hello(),</span><br><span class="line">        hello()</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªhelloåç¨‹å‡½æ•°ï¼Œå…¶ä¸­åŒ…å«äº†ä¸€ä¸ªå¼‚æ­¥çš„æ‰“å°ä»»åŠ¡å’Œä¸€ä¸ªå¼‚æ­¥çš„ç­‰å¾…ä»»åŠ¡ã€‚é€šè¿‡ä½¿ç”¨awaitå…³é”®å­—ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨åç¨‹ä¸­ç­‰å¾…å…¶ä»–åç¨‹çš„å®Œæˆã€‚ ç„¶åï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªmainåç¨‹å‡½æ•°ï¼Œå®ƒä½¿ç”¨asyncio.gatherå‡½æ•°æ¥å¹¶å‘æ‰§è¡Œå¤šä¸ªåç¨‹ä»»åŠ¡ã€‚ æœ€åï¼Œæˆ‘ä»¬ä½¿ç”¨asyncio.runå‡½æ•°æ¥è¿è¡Œmainåç¨‹å‡½æ•°ï¼Œä»è€Œå¯åŠ¨æ•´ä¸ªå¼‚æ­¥ç¨‹åºã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œasyncioåœ¨Python 3.7åŠä»¥ä¸Šç‰ˆæœ¬ä¸­æ˜¯ä¸€ä¸ªå†…ç½®çš„æ ‡å‡†åº“ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚åœ¨æ—§ç‰ˆæœ¬çš„Pythonä¸­ï¼Œä½ å¯èƒ½éœ€è¦é€šè¿‡pipæ¥å®‰è£…asyncioåº“ã€‚</p><p>21.2.å¯å¼‚æ­¥è°ƒç”¨å¯¹è±¡<br>åœ¨Pythonä¸­ï¼Œå¯ä»¥ä½¿ç”¨asyncio.ensure_futureæˆ–asyncio.create_taskæ¥å°†å¯è°ƒç”¨å¯¹è±¡è½¬æ¢ä¸ºå¯å¼‚æ­¥è°ƒç”¨çš„å¯¹è±¡ã€‚è¿™æ ·å¯ä»¥åœ¨å¼‚æ­¥ç¨‹åºä¸­å¹¶å‘åœ°æ‰§è¡Œå¤šä¸ªå¯è°ƒç”¨å¯¹è±¡ã€‚ ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ä»£ç ï¼Œå±•ç¤ºå¦‚ä½•ä½¿ç”¨asyncio.ensure_futureæ¥å¼‚æ­¥è°ƒç”¨å¯è°ƒç”¨å¯¹è±¡ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">hello</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Hello&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">world</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;World&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    task1 = asyncio.ensure_future(hello())</span><br><span class="line">    task2 = asyncio.ensure_future(world())</span><br><span class="line">    <span class="keyword">await</span> asyncio.gather(task1, task2)</span><br><span class="line"></span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸¤ä¸ªå¼‚æ­¥å‡½æ•°helloå’Œworldï¼Œå®ƒä»¬åˆ†åˆ«æ‰“å°â€Helloâ€å’Œâ€Worldâ€ã€‚ ç„¶åï¼Œåœ¨mainå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨asyncio.ensure_futureå°†è¿™ä¸¤ä¸ªå¼‚æ­¥å‡½æ•°è½¬æ¢ä¸ºå¯å¼‚æ­¥è°ƒç”¨çš„å¯¹è±¡task1å’Œtask2ã€‚ æœ€åï¼Œæˆ‘ä»¬ä½¿ç”¨asyncio.gatheræ¥å¹¶å‘åœ°æ‰§è¡Œè¿™ä¸¤ä¸ªä»»åŠ¡ã€‚ å¦å¤–ï¼Œä»Python 3.7å¼€å§‹ï¼Œå¯ä»¥ä½¿ç”¨asyncio.create_taskæ¥å®ç°ç›¸åŒçš„æ•ˆæœï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">hello</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Hello&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">world</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;World&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    task1 = asyncio.create_task(hello())</span><br><span class="line">    task2 = asyncio.create_task(world())</span><br><span class="line">    <span class="keyword">await</span> asyncio.gather(task1, task2)</span><br><span class="line"></span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure><p>è¿™ä¸¤ç§æ–¹æ³•éƒ½å¯ä»¥å°†å¯è°ƒç”¨å¯¹è±¡è½¬æ¢ä¸ºå¯å¼‚æ­¥è°ƒç”¨çš„å¯¹è±¡ï¼Œä»¥ä¾¿åœ¨å¼‚æ­¥ç¨‹åºä¸­å¹¶å‘åœ°æ‰§è¡Œå¤šä¸ªä»»åŠ¡ã€‚</p><p>åœ¨Pythonä¸­ï¼Œä»Python 3.7å¼€å§‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨asyncioåº“æ¥åˆ›å»ºå¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨ã€‚å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨æ˜¯ä¸€ç§ç‰¹æ®Šçš„å¯¹è±¡ï¼Œå®ƒå¯ä»¥åœ¨å¼‚æ­¥ä»£ç ä¸­ä½¿ç”¨async withè¯­æ³•æ¥ç®¡ç†èµ„æºçš„è·å–å’Œé‡Šæ”¾ã€‚ ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ä»£ç ï¼Œå±•ç¤ºå¦‚ä½•åˆ›å»ºå’Œä½¿ç”¨å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AsyncContextManager</span>:</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">__aenter__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Entering async context&quot;</span>)</span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Resource&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">__aexit__</span>(<span class="params">self, exc_type, exc_val, exc_tb</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Exiting async context&quot;</span>)</span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> AsyncContextManager() <span class="keyword">as</span> resource:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Using resource: <span class="subst">&#123;resource&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªAsyncContextManagerç±»ï¼Œå®ƒå®ç°äº†<strong>aenter</strong>å’Œ<strong>aexit</strong>æ–¹æ³•ã€‚è¿™ä¸¤ä¸ªæ–¹æ³•åˆ†åˆ«åœ¨è¿›å…¥å’Œé€€å‡ºå¼‚æ­¥ä¸Šä¸‹æ–‡æ—¶è¢«è°ƒç”¨ã€‚ åœ¨<strong>aenter</strong>æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œä¸€äº›å¼‚æ­¥æ“ä½œæ¥è·å–èµ„æºã€‚åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨await asyncio.sleep(1)æ¨¡æ‹Ÿè·å–èµ„æºçš„è€—æ—¶æ“ä½œï¼Œå¹¶è¿”å›ä¸€ä¸ªè¡¨ç¤ºèµ„æºçš„å­—ç¬¦ä¸²ã€‚ åœ¨<strong>aexit</strong>æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œä¸€äº›å¼‚æ­¥æ“ä½œæ¥é‡Šæ”¾èµ„æºã€‚åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åŒæ ·ä½¿ç”¨await asyncio.sleep(1)æ¨¡æ‹Ÿé‡Šæ”¾èµ„æºçš„è€—æ—¶æ“ä½œã€‚ ç„¶åï¼Œåœ¨mainåç¨‹å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨async withè¯­æ³•æ¥ä½¿ç”¨å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨ã€‚åœ¨è¿›å…¥ä¸Šä¸‹æ–‡æ—¶ï¼Œä¼šè°ƒç”¨<strong>aenter</strong>æ–¹æ³•ï¼Œè·å–èµ„æºå¹¶å°†å…¶èµ‹å€¼ç»™resourceå˜é‡ã€‚ç„¶åï¼Œåœ¨é€€å‡ºä¸Šä¸‹æ–‡æ—¶ï¼Œä¼šè°ƒç”¨<strong>aexit</strong>æ–¹æ³•ï¼Œé‡Šæ”¾èµ„æºã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªç¤ºä¾‹ä½¿ç”¨asyncio.runæ¥è¿è¡Œmainåç¨‹å‡½æ•°ï¼Œä»è€Œå¯åŠ¨æ•´ä¸ªå¼‚æ­¥ç¨‹åºã€‚</p><p>åœ¨Pythonä¸­ï¼Œä»Python 3.6å¼€å§‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<strong>async for</strong>è¯­æ³•æ¥è¿›è¡Œå¼‚æ­¥è¿­ä»£ï¼Œä»¥åŠä½¿ç”¨å¼‚æ­¥å¯è¿­ä»£å¯¹è±¡æ¥æ”¯æŒå¼‚æ­¥è¿­ä»£æ“ä½œã€‚ å¼‚æ­¥è¿­ä»£æ˜¯æŒ‡åœ¨è¿­ä»£è¿‡ç¨‹ä¸­å¯ä»¥æš‚åœå’Œæ¢å¤æ‰§è¡Œï¼Œä»¥ä¾¿åœ¨ç­‰å¾…å¼‚æ­¥æ“ä½œå®Œæˆæ—¶ä¸é˜»å¡äº‹ä»¶å¾ªç¯ã€‚ ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ä»£ç ï¼Œå±•ç¤ºå¦‚ä½•è¿›è¡Œå¼‚æ­¥è¿­ä»£å’Œä½¿ç”¨å¼‚æ­¥å¯è¿­ä»£å¯¹è±¡ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AsyncIterable</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, data</span>):</span><br><span class="line">        self.data = data</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__aiter__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">__anext__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.data:</span><br><span class="line">            <span class="keyword">raise</span> StopAsyncIteration</span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(<span class="number">1</span>)  <span class="comment"># æ¨¡æ‹Ÿå¼‚æ­¥æ“ä½œ</span></span><br><span class="line">        item = self.data.pop(<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> item</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">for</span> item <span class="keyword">in</span> AsyncIterable([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]):</span><br><span class="line">        <span class="built_in">print</span>(item)</span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªAsyncIterableç±»ï¼Œå®ƒå®ç°äº†<strong>aiter</strong>å’Œ<strong>anext</strong>æ–¹æ³•ã€‚<strong>aiter</strong>æ–¹æ³•è¿”å›ä¸€ä¸ªå¼‚æ­¥è¿­ä»£å™¨å¯¹è±¡ï¼Œè€Œ<strong>anext</strong>æ–¹æ³•å®šä¹‰äº†å¼‚æ­¥è¿­ä»£çš„è¡Œä¸ºã€‚ åœ¨<strong>anext</strong>æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨await asyncio.sleep(1)æ¨¡æ‹Ÿå¼‚æ­¥æ“ä½œçš„ç­‰å¾…æ—¶é—´ã€‚ç„¶åï¼Œæˆ‘ä»¬ä»æ•°æ®åˆ—è¡¨ä¸­å–å‡ºä¸€ä¸ªå…ƒç´ å¹¶è¿”å›ã€‚ ç„¶åï¼Œåœ¨mainåç¨‹å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨async forè¯­æ³•æ¥è¿›è¡Œå¼‚æ­¥è¿­ä»£ã€‚åœ¨æ¯æ¬¡è¿­ä»£æ—¶ï¼Œä¼šè°ƒç”¨<strong>anext</strong>æ–¹æ³•æ¥è·å–ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œå¹¶åœ¨ç­‰å¾…å¼‚æ­¥æ“ä½œå®Œæˆæ—¶æš‚åœæ‰§è¡Œã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªç¤ºä¾‹ä½¿ç”¨asyncio.runæ¥è¿è¡Œmainåç¨‹å‡½æ•°ï¼Œä»è€Œå¯åŠ¨æ•´ä¸ªå¼‚æ­¥ç¨‹åºã€‚</p><p>å¼‚æ­¥å¯¹è±¡çš„ç±»å‹æç¤º<br>åœ¨Pythonä¸­ï¼Œå¯ä»¥ä½¿ç”¨ç±»å‹æç¤ºæ¥æŒ‡å®šå¼‚æ­¥å¯¹è±¡çš„ç±»å‹ã€‚ä»Python 3.5å¼€å§‹ï¼Œå¼•å…¥äº†typingæ¨¡å—ï¼Œå…¶ä¸­åŒ…å«äº†ä¸€äº›ç”¨äºå¼‚æ­¥ç¼–ç¨‹çš„ç±»å‹æç¤ºå·¥å…·ã€‚ ä¸‹é¢æ˜¯ä¸€äº›å¸¸ç”¨çš„ç”¨äºå¼‚æ­¥å¯¹è±¡ç±»å‹æç¤ºçš„å·¥å…·ï¼š 1. typing.Coroutine: ç”¨äºæŒ‡å®šåç¨‹å‡½æ•°çš„è¿”å›ç±»å‹ã€‚ 2. typing.Awaitable: ç”¨äºæŒ‡å®šä¸€ä¸ªå¯¹è±¡æ˜¯å¯ç­‰å¾…çš„ï¼Œå¯ä»¥ä½¿ç”¨awaitå…³é”®å­—æ¥ç­‰å¾…å…¶å®Œæˆã€‚ 3. typing.AsyncIterable: ç”¨äºæŒ‡å®šå¼‚æ­¥å¯è¿­ä»£å¯¹è±¡çš„ç±»å‹ã€‚ 4. typing.AsyncIterator: ç”¨äºæŒ‡å®šå¼‚æ­¥è¿­ä»£å™¨çš„ç±»å‹ã€‚ 5. typing.AsyncContextManager: ç”¨äºæŒ‡å®šå¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨çš„ç±»å‹ã€‚ ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ä»£ç ï¼Œå±•ç¤ºå¦‚ä½•ä½¿ç”¨è¿™äº›ç±»å‹æç¤ºå·¥å…·ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Coroutine</span>, Awaitable, AsyncIterable, AsyncIterator, AsyncContextManager</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">foo</span>() -&gt; <span class="type">Coroutine</span>:</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">42</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">bar</span>() -&gt; Awaitable[<span class="built_in">int</span>]:</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">42</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">baz</span>() -&gt; AsyncIterable[<span class="built_in">int</span>]:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">        <span class="keyword">yield</span> i</span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">qux</span>() -&gt; AsyncIterator[<span class="built_in">int</span>]:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">        <span class="keyword">yield</span> i</span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">spam</span>() -&gt; AsyncContextManager[<span class="built_in">str</span>]:</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;file.txt&quot;</span>) <span class="keyword">as</span> file:</span><br><span class="line">        content = <span class="keyword">await</span> file.read()</span><br><span class="line">        <span class="keyword">return</span> content</span><br><span class="line"></span><br><span class="line">asyncio.run(foo())</span><br><span class="line">asyncio.run(bar())</span><br><span class="line">asyncio.run(baz())</span><br><span class="line">asyncio.run(qux())</span><br><span class="line">asyncio.run(spam())</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†å‡ ä¸ªå¼‚æ­¥å‡½æ•°ï¼Œæ¯ä¸ªå‡½æ•°ä½¿ç”¨ä¸åŒçš„ç±»å‹æç¤ºæ¥æŒ‡å®šè¿”å›ç±»å‹ã€‚ åœ¨fooå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨Coroutineç±»å‹æç¤ºæ¥æŒ‡å®šè¿”å›çš„åç¨‹å¯¹è±¡çš„ç±»å‹ã€‚ åœ¨barå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨Awaitableç±»å‹æç¤ºæ¥æŒ‡å®šè¿”å›çš„å¯¹è±¡æ˜¯å¯ç­‰å¾…çš„ã€‚ åœ¨bazå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨AsyncIterableç±»å‹æç¤ºæ¥æŒ‡å®šè¿”å›çš„å¯¹è±¡æ˜¯å¼‚æ­¥å¯è¿­ä»£çš„ã€‚ åœ¨quxå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨AsyncIteratorç±»å‹æç¤ºæ¥æŒ‡å®šè¿”å›çš„å¯¹è±¡æ˜¯å¼‚æ­¥è¿­ä»£å™¨ã€‚ åœ¨spamå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨AsyncContextManagerç±»å‹æç¤ºæ¥æŒ‡å®šè¿”å›çš„å¯¹è±¡æ˜¯å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªç¤ºä¾‹ä½¿ç”¨asyncio.runæ¥è¿è¡Œæ¯ä¸ªå¼‚æ­¥å‡½æ•°ï¼Œä»è€Œå¯åŠ¨ç›¸åº”çš„å¼‚æ­¥ç¨‹åºã€‚</p><p>ä½¿ç”¨åŠ¨æ€å±æ€§è®¿é—®jsonæ•°æ®</p><p>åœ¨Pythonä¸­ï¼Œå¯ä»¥ä½¿ç”¨åŠ¨æ€å±æ€§æ¥è®¿é—®JSONæ•°æ®ã€‚åŠ¨æ€å±æ€§å…è®¸æˆ‘ä»¬åœ¨å¯¹è±¡ä¸Šåˆ›å»ºæˆ–ä¿®æ”¹å±æ€§ï¼Œä»è€Œå®ç°å¯¹JSONæ•°æ®çš„çµæ´»è®¿é—®ã€‚ ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ä»£ç ï¼Œå±•ç¤ºå¦‚ä½•ä½¿ç”¨åŠ¨æ€å±æ€§è®¿é—®JSONæ•°æ®ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">JSONData</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, json_str</span>):</span><br><span class="line">        self.data = json.loads(json_str)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getattr__</span>(<span class="params">self, name</span>):</span><br><span class="line">        <span class="keyword">if</span> name <span class="keyword">in</span> self.data:</span><br><span class="line">            value = self.data[name]</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(value, <span class="built_in">dict</span>):</span><br><span class="line">                <span class="keyword">return</span> JSONData(json.dumps(value))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> value</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> AttributeError(<span class="string">f&quot;&#x27;JSONData&#x27; object has no attribute &#x27;<span class="subst">&#123;name&#125;</span>&#x27;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨åŠ¨æ€å±æ€§è®¿é—®JSONæ•°æ®</span></span><br><span class="line">json_str = <span class="string">&#x27;&#123;&quot;name&quot;: &quot;John&quot;, &quot;age&quot;: 30, &quot;address&quot;: &#123;&quot;city&quot;: &quot;New York&quot;, &quot;country&quot;: &quot;USA&quot;&#125;&#125;&#x27;</span></span><br><span class="line">data = JSONData(json_str)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(data.name)                <span class="comment"># è¾“å‡º: John</span></span><br><span class="line"><span class="built_in">print</span>(data.age)                 <span class="comment"># è¾“å‡º: 30</span></span><br><span class="line"><span class="built_in">print</span>(data.address)             <span class="comment"># è¾“å‡º: &lt;__main__.JSONData object at 0x...&gt;</span></span><br><span class="line"><span class="built_in">print</span>(data.address.city)        <span class="comment"># è¾“å‡º: New York</span></span><br><span class="line"><span class="built_in">print</span>(data.address.country)     <span class="comment"># è¾“å‡º: USA</span></span><br></pre></td></tr></table></figure><p>åé¢çš„ç•¥</p>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;åé¢å‡ èŠ‚æ²¡æ•´ç†ï¼›æ²¡æœ‰ç›®å½•ï¼›ä¸€äº›é‡è¦ç« èŠ‚ä¸æ˜¯å¾ˆå…¨ï¼Œä»…ä»…æ˜¯ä»‹ç»ã€‚&lt;br&gt;å¾…æ‹†åˆ†&lt;br&gt;Refï¼š&lt;a href=&quot;https://www.52pojie.cn/thread-1816710-1-1.html&quot;&gt;https://www.52pojie.cn</summary>
      
    
    
    
    <category term="Python" scheme="https://guoyujian.github.io/categories/Python/"/>
    
    <category term="åŸºç¡€" scheme="https://guoyujian.github.io/categories/Python/%E5%9F%BA%E7%A1%80/"/>
    
    
    <category term="Python" scheme="https://guoyujian.github.io/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>Pythonæ˜Ÿå·ç”¨æ³•å°ç»“</title>
    <link href="https://guoyujian.github.io/2024/03/06/Python%E6%98%9F%E5%8F%B7%E7%94%A8%E6%B3%95%E5%B0%8F%E7%BB%93/"/>
    <id>https://guoyujian.github.io/2024/03/06/Python%E6%98%9F%E5%8F%B7%E7%94%A8%E6%B3%95%E5%B0%8F%E7%BB%93/</id>
    <published>2024-03-06T09:48:33.000Z</published>
    <updated>2024-03-06T10:20:37.161Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1"><a href="#1" class="headerlink" title="1"></a>1</h2><p>ä¹˜æ³•å’Œä¹˜æ–¹</p><h2 id="2"><a href="#2" class="headerlink" title="2"></a>2</h2><p>ç”¨åœ¨å‡½æ•°å®šä¹‰çš„å‚æ•°æ—¶ï¼Œ</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">func</span>(<span class="params">a, *b, **c</span>):</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure><p>åœ¨å‡½æ•°çš„å‚æ•°ä¸­ï¼Œå½“ä»¥æ ‡è®°ä¸€ä¸ªå‚æ•°æ—¶ï¼Œè¡¨æ˜è¿™ä¸ªå‚æ•°æ˜¯å¯å˜å‚æ•°ï¼Œå…·ä½“æ¥è®²ï¼Œç”¨å•æ˜Ÿå·<code>*</code>æ ‡è®°å‚æ•°ï¼Œè¡¨ç¤ºå…¶æ˜¯å¯å˜çš„ä½ç½®å‚æ•°ï¼Œå¹¶ä¸”ä»¥å…ƒç»„çš„å½¢å¼å°†å¤–éƒ¨çš„å¤šä¸ªä½ç½®å‚æ•°è¿”å›ç»™è¯¥å‚æ•°å˜é‡ï¼Œå¦‚æœç”¨åŒæ˜Ÿå·<code>**</code>æ ‡è®°ï¼Œè¡¨ç¤ºå…¶çœ‹æ˜¯å¯å˜çš„å…³é”®è¯å‚æ•°ï¼Œå¹¶ä¸”ä¼šä»¥å­—å…¸çš„å½¢å¼å°†å¤–éƒ¨çš„å¤šç»„å…³é”®è¯å‚æ•°å’Œå€¼è¿”å›ç»™è¯¥å‚æ•°å˜é‡ã€‚</p><h2 id="3"><a href="#3" class="headerlink" title="3"></a>3</h2><p>å¯ä»¥ç”¨ <code>*</code>è¿ç®—ç¬¦æŠŠä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡æ‹†å¼€ä½œä¸ºå‡½æ•°çš„å‚æ•°ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">divmod</span>(<span class="number">20</span>, <span class="number">8</span>)</span><br><span class="line">(<span class="number">2</span>, <span class="number">4</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>t = (<span class="number">20</span>, <span class="number">8</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">divmod</span>(*t)</span><br><span class="line">(<span class="number">2</span>, <span class="number">4</span>)</span><br></pre></td></tr></table></figure><h2 id="4"><a href="#4" class="headerlink" title="4"></a>4</h2><p>ç”¨æ˜Ÿå·å¤„ç†æ‹†åŒ…æ—¶çš„éƒ¨åˆ†å…ƒç´ ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = (<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b,c,*d=a</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d</span><br><span class="line">(<span class="number">3</span>,<span class="number">4</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="5"><a href="#5" class="headerlink" title="5"></a>5</h2><p>é™åˆ¶å…³é”®è¯å‚æ•°</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">func</span>(<span class="params">a, *, b</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line">func(<span class="number">1</span>, b = <span class="number">2</span>)</span><br></pre></td></tr></table></figure><h2 id="6"><a href="#6" class="headerlink" title="6"></a>6</h2><p>æ‹†åŒ…åˆ—è¡¨æˆ–è€…å­—å…¸ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line">b = [<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>]</span><br><span class="line">c = [*a, <span class="number">10</span>, * b]  <span class="comment"># [1, 2, 3, 10, 4, 5, 6]</span></span><br><span class="line"></span><br><span class="line">d = &#123;<span class="string">&#x27;k1&#x27;</span>: <span class="number">1</span>&#125;</span><br><span class="line">e = &#123;<span class="string">&#x27;k2&#x27;</span>: <span class="number">2</span>&#125;</span><br><span class="line">f = &#123;**d, **e, <span class="string">&#x27;k3&#x27;</span>: <span class="number">3</span>&#125; <span class="comment"># &#123;&#x27;k1&#x27;: 1, &#x27;k2&#x27;: 2, &#x27;k3&#x27;: 3&#125;</span></span><br></pre></td></tr></table></figure><h2 id="More"><a href="#More" class="headerlink" title="More"></a>More</h2><p>â€¦</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;1&quot;&gt;&lt;a href=&quot;#1&quot; class=&quot;headerlink&quot; title=&quot;1&quot;&gt;&lt;/a&gt;1&lt;/h2&gt;&lt;p&gt;ä¹˜æ³•å’Œä¹˜æ–¹&lt;/p&gt;
&lt;h2 id=&quot;2&quot;&gt;&lt;a href=&quot;#2&quot; class=&quot;headerlink&quot; title=&quot;2&quot;&gt;&lt;/a&gt;2&lt;/h2&gt;&lt;</summary>
      
    
    
    
    <category term="Python" scheme="https://guoyujian.github.io/categories/Python/"/>
    
    <category term="åŸºç¡€" scheme="https://guoyujian.github.io/categories/Python/%E5%9F%BA%E7%A1%80/"/>
    
    
    <category term="Python" scheme="https://guoyujian.github.io/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>Pythoné—­åŒ…ä¸è£…é¥°å™¨æ€»ç»“1</title>
    <link href="https://guoyujian.github.io/2024/03/06/Python%E9%97%AD%E5%8C%85%E4%B8%8E%E8%A3%85%E9%A5%B0%E5%99%A8%E6%80%BB%E7%BB%931/"/>
    <id>https://guoyujian.github.io/2024/03/06/Python%E9%97%AD%E5%8C%85%E4%B8%8E%E8%A3%85%E9%A5%B0%E5%99%A8%E6%80%BB%E7%BB%931/</id>
    <published>2024-03-06T06:49:48.000Z</published>
    <updated>2024-03-06T06:52:58.409Z</updated>
    
    <content type="html"><![CDATA[<h1 id="è£…é¥°å™¨åŸºç¡€"><a href="#è£…é¥°å™¨åŸºç¡€" class="headerlink" title="è£…é¥°å™¨åŸºç¡€"></a>è£…é¥°å™¨åŸºç¡€</h1><p>è£…é¥°å™¨æ˜¯å¯è°ƒç”¨çš„å¯¹è±¡ï¼Œå…¶å‚æ•°æ˜¯å¦ä¸€ä¸ªå‡½æ•°ï¼ˆè¢«è£…é¥°çš„å‡½æ•°ï¼‰ã€‚</p><p>è£…é¥°å™¨çš„ä¸€ä¸ªå…³é”®ç‰¹æ€§æ˜¯ï¼Œå®ƒä»¬åœ¨è¢«è£…é¥°çš„å‡½æ•°å®šä¹‰ä¹‹åç«‹å³è¿è¡Œã€‚è¿™é€šå¸¸æ˜¯åœ¨å¯¼å…¥æ—¶ ï¼ˆå³ Python åŠ è½½æ¨¡å—æ—¶ï¼‰</p><p>â€</p><h1 id="å˜é‡ä½œç”¨åŸŸè§„åˆ™"><a href="#å˜é‡ä½œç”¨åŸŸè§„åˆ™" class="headerlink" title="å˜é‡ä½œç”¨åŸŸè§„åˆ™"></a>å˜é‡ä½œç”¨åŸŸè§„åˆ™</h1><p>å¯¹æ¯”ä»£ç </p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">b = <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func</span>(<span class="params">a</span>):</span><br><span class="line">    <span class="built_in">print</span>(a)</span><br><span class="line">    <span class="built_in">print</span>(b)</span><br><span class="line"></span><br><span class="line">func(<span class="number">3</span>) <span class="comment"># 3 3</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">b = <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func</span>(<span class="params">a</span>):</span><br><span class="line">    <span class="built_in">print</span>(a)</span><br><span class="line">    <span class="built_in">print</span>(b)</span><br><span class="line">b = <span class="number">9</span></span><br><span class="line"></span><br><span class="line">func(<span class="number">3</span>) <span class="comment"># 3 UnboundLocalError</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸æ˜¯ç¼ºé™·ï¼Œè€Œæ˜¯è®¾è®¡é€‰æ‹©ï¼šPython ä¸è¦æ±‚å£°æ˜å˜é‡ï¼Œä½†æ˜¯å‡å®šåœ¨å‡½æ•°å®šä¹‰ä½“ä¸­èµ‹å€¼çš„å˜é‡æ˜¯å±€éƒ¨å˜é‡ã€‚</p><p>å¦‚æœåœ¨å‡½æ•°ä¸­èµ‹å€¼æ—¶æƒ³è®©è§£é‡Šå™¨æŠŠ b å½“æˆå…¨å±€å˜é‡ï¼Œè¦ä½¿ç”¨ global å£°æ˜:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">b = <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func</span>(<span class="params">a</span>):</span><br><span class="line"><span class="keyword">global</span> b</span><br><span class="line">    <span class="built_in">print</span>(a)</span><br><span class="line">    <span class="built_in">print</span>(b)</span><br><span class="line">b = <span class="number">9</span></span><br><span class="line"></span><br><span class="line">func(<span class="number">3</span>) <span class="comment"># 3 3</span></span><br></pre></td></tr></table></figure><h1 id="é—­åŒ…"><a href="#é—­åŒ…" class="headerlink" title="é—­åŒ…"></a>é—­åŒ…</h1><p><strong>é—­åŒ…æŒ‡å»¶ä¼¸äº†ä½œç”¨åŸŸçš„å‡½æ•°ï¼Œå…¶ä¸­åŒ…å«å‡½æ•°å®šä¹‰ä½“ä¸­å¼•ç”¨ã€ä½†æ˜¯ä¸åœ¨å®šä¹‰ä½“ä¸­å®šä¹‰çš„éå…¨å±€å˜é‡ã€‚</strong></p><p>å‡å¦‚æœ‰ä¸ªåä¸º avg çš„å‡½æ•°ï¼Œå®ƒçš„ä½œç”¨æ˜¯è®¡ç®—ä¸æ–­å¢åŠ çš„ç³»åˆ—å€¼çš„å‡å€¼ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>avg(<span class="number">10</span>)</span><br><span class="line"><span class="number">10.0</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>avg(<span class="number">11</span>)</span><br><span class="line"><span class="number">10.5</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>avg(<span class="number">12</span>)</span><br><span class="line"><span class="number">11.0</span></span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆå®ƒçš„å®ç°ï¼Œå¯ä»¥æ˜¯ç±»çš„å½¢å¼ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Average</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        self.<span class="built_in">sum</span> = <span class="number">0</span></span><br><span class="line">        self.count = <span class="number">0</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">self, num:<span class="built_in">int</span></span>) -&gt; <span class="type">Any</span>:</span><br><span class="line">        self.<span class="built_in">sum</span> += num</span><br><span class="line">        self.count += <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> self.<span class="built_in">sum</span> / self.count</span><br><span class="line">  </span><br><span class="line">avg = Average()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(avg(<span class="number">10</span>))</span><br><span class="line"><span class="built_in">print</span>(avg(<span class="number">11</span>))</span><br><span class="line"><span class="built_in">print</span>(avg(<span class="number">12</span>))</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥æ˜¯é«˜é˜¶å‡½æ•°</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">make_averager</span>():</span><br><span class="line">    total = <span class="number">0</span></span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">averager</span>(<span class="params">num: <span class="built_in">int</span></span>):</span><br><span class="line">        <span class="keyword">nonlocal</span> total, count</span><br><span class="line">        total += num</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> total / count</span><br><span class="line">    <span class="keyword">return</span> averager</span><br><span class="line"></span><br><span class="line">avg = make_averager()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(avg(<span class="number">10</span>))</span><br><span class="line"><span class="built_in">print</span>(avg(<span class="number">11</span>))</span><br><span class="line"><span class="built_in">print</span>(avg(<span class="number">12</span>))<span class="keyword">def</span> <span class="title function_">make_averager</span>():</span><br><span class="line">    total = <span class="number">0</span></span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">averager</span>(<span class="params">num: <span class="built_in">int</span></span>):</span><br><span class="line">        <span class="keyword">nonlocal</span> total, count</span><br><span class="line">        total += num</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> total / count</span><br><span class="line">    <span class="keyword">return</span> averager</span><br><span class="line"></span><br><span class="line">avg = make_averager()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(avg(<span class="number">10</span>))</span><br><span class="line"><span class="built_in">print</span>(avg(<span class="number">11</span>))</span><br><span class="line"><span class="built_in">print</span>(avg(<span class="number">12</span>))</span><br></pre></td></tr></table></figure><p>æ³¨æ„<code>nonlocal total, count</code>â€‹ï¼š</p><p>å› ä¸ºåœ¨Pythonä¸­å¹¶æ²¡æœ‰è¦æ±‚å…ˆå£°æ˜ä¸€ä¸ªå˜é‡ï¼Œæ‰€ä»¥Pythonè§£é‡Šå™¨ä»»åŠ¡åœ¨å‡½æ•°ä½“å†…ï¼Œåªè¦å¯¹ä¸€ä¸ªå˜é‡è¿›è¡Œèµ‹å€¼æ“ä½œï¼Œé‚£ä¹ˆè¿™ä¸ªå˜é‡å°±æ˜¯å±€éƒ¨å˜é‡ã€‚è€Œ count+=1ç›¸å½“äº count=count+1ï¼Œå¯¹ count è¿›è¡Œäº†èµ‹å€¼æ“ä½œï¼Œæ‰€ä»¥Pythonè§£é‡Šå™¨è®¤ä¸º count æ˜¯å‡½æ•°å†…çš„å±€éƒ¨å˜é‡ã€‚æˆ‘ä»¬è¿™é‡Œéœ€è¦ç”¨nonlocalå…³é”®å­—å°†å±€éƒ¨å˜é‡ä¿®æ­£ä¸ºè‡ªç”±å˜é‡ã€‚</p><p>æ‰€è°“è‡ªç”±å˜é‡å°±æ˜¯æ²¡æœ‰è¢«ç»‘å®šåœ¨å±€éƒ¨ä½œç”¨åŸŸçš„å˜é‡ã€‚</p><p>â€</p><h1 id="è£…é¥°å™¨"><a href="#è£…é¥°å™¨" class="headerlink" title="è£…é¥°å™¨"></a>è£…é¥°å™¨</h1><p>åˆ©ç”¨é—­åŒ…å®ç°æ—¥å¿—è£…é¥°å™¨ï¼šå¯¹äºè¢«è£…é¥°å‡½æ•°ï¼Œæ¯æ¬¡è°ƒç”¨æ‰“å°è°ƒåº¦log</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">logit</span>(<span class="params">func</span>):</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">with_logging</span>(<span class="params">*args, **kwargs</span>):</span><br><span class="line">        <span class="built_in">print</span>(func.__name__, <span class="string">&quot;was called&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> func(*args, **kwargs)</span><br><span class="line">    <span class="keyword">return</span> with_logging</span><br><span class="line"></span><br><span class="line"><span class="meta">@logit</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">some_func</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;do something&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> x + x</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(some_func(<span class="number">5</span>))</span><br></pre></td></tr></table></figure><p>@ç¬¦å·æ˜¯ä¸€ä¸ªè¯­æ³•ç³–ï¼Œå®é™…çš„æ‰§è¡Œæ˜¯ï¼šlogit(some_func(x))</p><p>å¦‚æœè£…é¥°å™¨éœ€è¦å¸¦å‚æ•°ï¼Œï¼ˆä¾‹å¦‚ä¸‹é¢çš„ä»£ç å®ç°äº†å°†æ—¥å¿—ä¿å­˜åˆ°æŒ‡å®šæ–‡ä»¶ï¼‰ï¼Œåˆ™éœ€è¦å†åŠ ä¸€å±‚ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">logit</span>(<span class="params">log_file = <span class="string">&#x27;out.log&#x27;</span></span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_logit</span>(<span class="params">func</span>):</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">with_logging</span>(<span class="params">*args, **kwargs</span>):</span><br><span class="line">            <span class="built_in">print</span>(func.__name__, <span class="string">&quot;was called&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;save log to <span class="subst">&#123;log_file&#125;</span>&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> func(*args, **kwargs)</span><br><span class="line">        <span class="keyword">return</span> with_logging</span><br><span class="line">    <span class="keyword">return</span> _logit</span><br><span class="line"></span><br><span class="line"><span class="meta">@logit(<span class="params">log_file=<span class="string">&#x27;a.log&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">some_func</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;do something&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> x + x</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(some_func(<span class="number">5</span>))</span><br></pre></td></tr></table></figure><h1 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h1><p>ã€Šæµç•…çš„Pythonã€‹</p><p>â€</p><h1 id="More"><a href="#More" class="headerlink" title="More"></a>More</h1><p>å…³äºè£…é¥°å™¨æ›´å¤šå†…å®¹è¿˜åŒ…æ‹¬ï¼š</p><ul><li>[ ] @functools.wraps</li><li>[ ] @lru_cache()å’Œ@singledispatch</li><li>[ ] ç±»è£…é¥°å™¨</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;è£…é¥°å™¨åŸºç¡€&quot;&gt;&lt;a href=&quot;#è£…é¥°å™¨åŸºç¡€&quot; class=&quot;headerlink&quot; title=&quot;è£…é¥°å™¨åŸºç¡€&quot;&gt;&lt;/a&gt;è£…é¥°å™¨åŸºç¡€&lt;/h1&gt;&lt;p&gt;è£…é¥°å™¨æ˜¯å¯è°ƒç”¨çš„å¯¹è±¡ï¼Œå…¶å‚æ•°æ˜¯å¦ä¸€ä¸ªå‡½æ•°ï¼ˆè¢«è£…é¥°çš„å‡½æ•°ï¼‰ã€‚&lt;/p&gt;
&lt;p&gt;è£…é¥°å™¨çš„ä¸€ä¸ªå…³é”®ç‰¹æ€§æ˜¯ï¼Œå®ƒä»¬åœ¨è¢«è£…é¥°çš„å‡½æ•°</summary>
      
    
    
    
    <category term="Python" scheme="https://guoyujian.github.io/categories/Python/"/>
    
    <category term="åŸºç¡€" scheme="https://guoyujian.github.io/categories/Python/%E5%9F%BA%E7%A1%80/"/>
    
    
    <category term="Python" scheme="https://guoyujian.github.io/tags/Python/"/>
    
    <category term="é—­åŒ…" scheme="https://guoyujian.github.io/tags/%E9%97%AD%E5%8C%85/"/>
    
  </entry>
  
  <entry>
    <title>Kruskalç®—æ³•ä¸åŠ›æ‰£1135</title>
    <link href="https://guoyujian.github.io/2024/01/20/Kruskal%E7%AE%97%E6%B3%95%E4%B8%8E%E5%8A%9B%E6%89%A31135/"/>
    <id>https://guoyujian.github.io/2024/01/20/Kruskal%E7%AE%97%E6%B3%95%E4%B8%8E%E5%8A%9B%E6%89%A31135/</id>
    <published>2024-01-20T07:01:01.000Z</published>
    <updated>2024-01-20T07:14:38.602Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬æ–‡ä»‹ç»å›¾çš„æœ€å°ç”Ÿæˆæ ‘ç®—æ³•Kruskal ç®—æ³•ã€‚</p><p>é˜…è¯»ä¹‹å‰éœ€è¦å…ˆäº†è§£</p><ul><li>å›¾å’Œæ ‘æ•°æ®ç»“æ„</li><li>åŠ æƒå›¾ã€ç”Ÿæˆæ ‘ã€æœ€å°ç”Ÿæˆæ ‘</li><li>Kruskal ç®—æ³•åŸºæœ¬æ€æƒ³</li></ul><p>åœ¨Kruskal ç®—æ³•ä¸­ï¼Œéœ€è¦ä¿è¯æ¯æ¬¡æ–°åŠ å…¥çš„è¾¹ä¸ä¼šè®©æ ‘å˜æˆå›¾ï¼Œå³ä¸èƒ½è®©æ ‘åŒ…å«ç¯ã€‚é‚£ä¹ˆ Union-Find ç®—æ³•å°±æ˜¯å¸®ä½ å¹²è¿™ä¸ªäº‹å„¿çš„ã€‚</p><p>åƒä¸‹é¢è¿™æ ·æ·»åŠ è¾¹ä¼šå‡ºç°ç¯ï¼š</p><p><img src="1.png" alt="å›¾ç‰‡"></p><p>è€Œè¿™æ ·æ·»åŠ è¾¹åˆ™ä¸ä¼šå‡ºç°ç¯ï¼š</p><p><img src="2.png" alt="å›¾ç‰‡"></p><p>æ€»ç»“ä¸€ä¸‹è§„å¾‹å°±æ˜¯ï¼š</p><p><strong>å¯¹äºæ·»åŠ çš„è¿™æ¡è¾¹ï¼Œå¦‚æœè¯¥è¾¹çš„ä¸¤ä¸ªèŠ‚ç‚¹æœ¬æ¥å°±åœ¨åŒä¸€è¿é€šåˆ†é‡é‡Œï¼Œé‚£ä¹ˆæ·»åŠ è¿™æ¡è¾¹ä¼šäº§ç”Ÿç¯ï¼›åä¹‹ï¼Œå¦‚æœè¯¥è¾¹çš„ä¸¤ä¸ªèŠ‚ç‚¹ä¸åœ¨åŒä¸€è¿é€šåˆ†é‡é‡Œï¼Œåˆ™æ·»åŠ è¿™æ¡è¾¹ä¸ä¼šäº§ç”Ÿç¯</strong>ã€‚</p><p>è€Œåˆ¤æ–­ä¸¤ä¸ªèŠ‚ç‚¹æ˜¯å¦è¿é€šï¼ˆæ˜¯å¦åœ¨åŒä¸€ä¸ªè¿é€šåˆ†é‡ä¸­ï¼‰å°±æ˜¯ Union-Find ç®—æ³•çš„æ‹¿æ‰‹ç»æ´»ã€‚</p><p>åŠ›æ‰£ç¬¬ 1135 é¢˜ã€Œæœ€ä½æˆæœ¬è”é€šæ‰€æœ‰åŸå¸‚ã€ï¼Œè¿™æ˜¯ä¸€é“æ ‡å‡†çš„æœ€å°ç”Ÿæˆæ ‘é—®é¢˜ï¼š</p><p><img src="640.png" alt="å›¾ç‰‡"></p><p>æ¯åº§åŸå¸‚ç›¸å½“äºå›¾ä¸­çš„èŠ‚ç‚¹ï¼Œè¿é€šåŸå¸‚çš„æˆæœ¬ç›¸å½“äºè¾¹çš„æƒé‡ï¼Œè¿é€šæ‰€æœ‰åŸå¸‚çš„æœ€å°æˆæœ¬å³æ˜¯æœ€å°ç”Ÿæˆæ ‘çš„æƒé‡ä¹‹å’Œã€‚</p><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span></span><br><span class="line"><span class="keyword">from</span> union_find <span class="keyword">import</span> UF  <span class="comment"># è‡ªå®ç°çš„union-findç®—æ³•ï¼Œè¯¦ç•¥</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">minimumCost</span>(<span class="params">self, n: <span class="built_in">int</span>, connections:<span class="type">List</span>[<span class="type">List</span>[<span class="built_in">int</span>]]</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        <span class="comment"># åŸå¸‚ç¼–å·ä»1å¼€å§‹ï¼Œæ‰€ä»¥åˆå§‹åŒ–å¤§å°ä¸º1+n</span></span><br><span class="line">        uf = UF(n+<span class="number">1</span>)</span><br><span class="line">        <span class="comment"># æŒ‰æƒé‡æ’åº</span></span><br><span class="line">        connections.sort(<span class="keyword">lambda</span> x : x[<span class="number">2</span>])</span><br><span class="line">        mst = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> u, v, weight <span class="keyword">in</span> connections:</span><br><span class="line">            <span class="comment">#å¦‚æœäº§ç”Ÿç¯ï¼Œåˆ™ä¸èƒ½åŠ å…¥mst</span></span><br><span class="line">            <span class="keyword">if</span> uf.connected(u, v):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="comment"># å¦‚æœæ²¡æœ‰äº§ç”Ÿç¯ï¼Œåˆ™å±äºæœ€å°ç”Ÿæˆæ ‘</span></span><br><span class="line">            mst += weight</span><br><span class="line">            uf.union(u, v)</span><br><span class="line">        <span class="comment"># ä¿è¯æ‰€æœ‰èŠ‚ç‚¹éƒ½è¢«è¿é€š</span></span><br><span class="line">        <span class="comment"># æŒ‰ç†uf.count() == 1è¯´æ˜æ‰€æœ‰èŠ‚ç‚¹è¢«è¿é€š</span></span><br><span class="line">        <span class="comment"># ä½†å› ä¸ºèŠ‚ç‚¹0æ²¡æœ‰è¢«ä½¿ç”¨ï¼Œæ‰€ä»¥0ä¼šé¢å¤–å ç”¨ä¸€ä¸ªè¿é€šåˆ†é‡</span></span><br><span class="line">        <span class="keyword">return</span> mst <span class="keyword">if</span> uf.count() == <span class="number">2</span> <span class="keyword">else</span> -<span class="number">1</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="Refs"><a href="#Refs" class="headerlink" title="Refs"></a>Refs</h1><ol><li><a href="https://mp.weixin.qq.com/s/dJ9gqR3RVoeGnATlpMG39w">ä¸œå“¥å¸¦ä½ åˆ·å›¾è®ºç¬¬äº”æœŸï¼šKruskal æœ€å°ç”Ÿæˆæ ‘ç®—æ³•</a></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;æœ¬æ–‡ä»‹ç»å›¾çš„æœ€å°ç”Ÿæˆæ ‘ç®—æ³•Kruskal ç®—æ³•ã€‚&lt;/p&gt;
&lt;p&gt;é˜…è¯»ä¹‹å‰éœ€è¦å…ˆäº†è§£&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å›¾å’Œæ ‘æ•°æ®ç»“æ„&lt;/li&gt;
&lt;li&gt;åŠ æƒå›¾ã€ç”Ÿæˆæ ‘ã€æœ€å°ç”Ÿæˆæ ‘&lt;/li&gt;
&lt;li&gt;Kruskal ç®—æ³•åŸºæœ¬æ€æƒ³&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;åœ¨Kruskal ç®—æ³•ä¸­ï¼Œ</summary>
      
    
    
    
    <category term="æ•°æ®ç»“æ„ä¸ç®—æ³•" scheme="https://guoyujian.github.io/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/"/>
    
    <category term="å›¾" scheme="https://guoyujian.github.io/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E5%9B%BE/"/>
    
    
    <category term="Kruskal ç®—æ³•" scheme="https://guoyujian.github.io/tags/Kruskal-%E7%AE%97%E6%B3%95/"/>
    
    <category term="åŠ›æ‰£1135" scheme="https://guoyujian.github.io/tags/%E5%8A%9B%E6%89%A31135/"/>
    
    <category term="å›¾" scheme="https://guoyujian.github.io/tags/%E5%9B%BE/"/>
    
  </entry>
  
  <entry>
    <title>Union-Findå¹¶æŸ¥é›†ç®—æ³•ï¼ˆPythonå®ç°ï¼‰</title>
    <link href="https://guoyujian.github.io/2023/12/24/Union-Find%E5%B9%B6%E6%9F%A5%E9%9B%86%E7%AE%97%E6%B3%95%EF%BC%88Python%E5%AE%9E%E7%8E%B0%EF%BC%89/"/>
    <id>https://guoyujian.github.io/2023/12/24/Union-Find%E5%B9%B6%E6%9F%A5%E9%9B%86%E7%AE%97%E6%B3%95%EF%BC%88Python%E5%AE%9E%E7%8E%B0%EF%BC%89/</id>
    <published>2023-12-24T01:37:00.000Z</published>
    <updated>2023-12-24T01:39:52.705Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™æ˜¯å¹¶æŸ¥é›†ç®—æ³•çš„Pythonå®ç°ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UF</span>:</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    å¹¶æŸ¥é›†ç®—æ³•</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, n</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        åˆå§‹åŒ–æ•°æ®ç»“æ„</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        <span class="comment"># åˆå§‹åŒ–è¿é€šåˆ†é‡æ•°é‡</span></span><br><span class="line">        self._count = n</span><br><span class="line">        <span class="comment"># åˆå§‹åŒ–åŒäº²èŠ‚ç‚¹</span></span><br><span class="line">        self._parent = [i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n)]</span><br><span class="line">        <span class="comment"># self.size[x]è¡¨ç¤ºä»¥xä¸ºæ ¹èŠ‚ç‚¹çš„èŠ‚ç‚¹æ•°é‡</span></span><br><span class="line">        self._size = [<span class="number">1</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n)]</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find</span>(<span class="params">self, x : <span class="built_in">int</span></span>):</span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        find root of x</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">while</span> self._parent[x] != x:</span><br><span class="line">            <span class="comment"># è·¯ç»å‹ç¼©ï¼Œå°†å½“å‰èŠ‚ç‚¹çš„åŒäº²èŠ‚ç‚¹è®¾ä¸ºå…¶åŒäº²èŠ‚ç‚¹çš„åŒäº²èŠ‚ç‚¹</span></span><br><span class="line">            self._parent[x] = self._parent[self._parent[x]]</span><br><span class="line">            x = self._parent[x]</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">union</span>(<span class="params">self, p: <span class="built_in">int</span>, q: <span class="built_in">int</span></span>):</span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        union p and q</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        <span class="comment"># æ‰¾åˆ°på’Œqçš„æ ¹èŠ‚ç‚¹</span></span><br><span class="line">        rootP = self.find(p)</span><br><span class="line">        rootQ = self.find(q)</span><br><span class="line">        <span class="keyword">if</span> rootP == rootQ:</span><br><span class="line">            <span class="comment"># å¦‚æœæ ¹èŠ‚ç‚¹ç›¸ç­‰ï¼Œåˆ™pqæœ¬å°±è”é€š</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="comment"># å°†å°é›†åˆåˆå¹¶åˆ°å¤§é›†åˆä¸­ï¼Œå¹³è¡¡æ€§ä¼˜åŒ–</span></span><br><span class="line">        <span class="keyword">if</span> self._size[rootP] &gt; self._size[rootQ]:</span><br><span class="line"></span><br><span class="line">            self._parent[rootQ] = rootP</span><br><span class="line">            self._size[rootP] += self._size[rootQ]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self._parent[rootP] = rootQ</span><br><span class="line">            self._size[rootQ] += self._size[rootP]</span><br><span class="line">        self._count -= <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">count</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        è¿”å›è”é€šæ•°</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> self._count</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">connected</span>(<span class="params">self, p, q</span>):</span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        åˆ¤æ–­pqæ˜¯å¦è”é€š</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> self.find(q) == self.find(p)</span><br><span class="line">    </span><br></pre></td></tr></table></figure><p>å‚è€ƒï¼š<a href="https://zhuanlan.zhihu.com/p/98406740">https://zhuanlan.zhihu.com/p/98406740</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;è¿™æ˜¯å¹¶æŸ¥é›†ç®—æ³•çš„Pythonå®ç°ï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;</summary>
      
    
    
    
    <category term="æ•°æ®ç»“æ„ä¸ç®—æ³•" scheme="https://guoyujian.github.io/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/"/>
    
    <category term="å¹¶æŸ¥é›†ç®—æ³•" scheme="https://guoyujian.github.io/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E5%B9%B6%E6%9F%A5%E9%9B%86%E7%AE%97%E6%B3%95/"/>
    
    
    <category term="Python" scheme="https://guoyujian.github.io/tags/Python/"/>
    
    <category term="ç®—æ³•" scheme="https://guoyujian.github.io/tags/%E7%AE%97%E6%B3%95/"/>
    
    <category term="å¹¶æŸ¥é›†" scheme="https://guoyujian.github.io/tags/%E5%B9%B6%E6%9F%A5%E9%9B%86/"/>
    
    <category term="UnionFind" scheme="https://guoyujian.github.io/tags/UnionFind/"/>
    
  </entry>
  
  <entry>
    <title>subprocessæ‰§è¡Œjavaå‘½ä»¤æ®‹ç•™è¿›ç¨‹è§£å†³</title>
    <link href="https://guoyujian.github.io/2023/12/07/subprocess%E6%89%A7%E8%A1%8Cjava%E5%91%BD%E4%BB%A4%E6%AE%8B%E7%95%99%E8%BF%9B%E7%A8%8B%E8%A7%A3%E5%86%B3/"/>
    <id>https://guoyujian.github.io/2023/12/07/subprocess%E6%89%A7%E8%A1%8Cjava%E5%91%BD%E4%BB%A4%E6%AE%8B%E7%95%99%E8%BF%9B%E7%A8%8B%E8%A7%A3%E5%86%B3/</id>
    <published>2023-12-07T08:42:12.000Z</published>
    <updated>2023-12-07T08:51:07.103Z</updated>
    
    <content type="html"><![CDATA[<h1 id="é—®é¢˜ç®€è¿°"><a href="#é—®é¢˜ç®€è¿°" class="headerlink" title="é—®é¢˜ç®€è¿°"></a>é—®é¢˜ç®€è¿°</h1><blockquote><p>éœ€æ±‚æ˜¯é€šè¿‡Pythonæ‰§è¡Œå‘½ä»¤java -java springboot-demo.jar</p><p>äºæ˜¯ï¼Œæˆ‘ä½¿ç”¨subprocess.Popen()æ¥å¯åœã€‚ä½†æ˜¯æˆ‘å‘ç°åœ¨å…³é—­å­è¿›ç¨‹åï¼Œjavaè¿›ç¨‹å¹¶æ²¡æœ‰æ­£ç¡®å…³é—­ã€‚</p><p>è¿™æ˜¯ç”±äºä¸Šé¢çš„æ–¹æ³•å®é™…åŸç†æ˜¯å¦å¤–å¼€å¯ä¸€ä¸ªcmdå‘½ä»¤æ¥è¿è¡Œjava -jarå‘½ä»¤ï¼Œåé¢ç”¨popen.terminate()ä¹Ÿåªèƒ½å…³é—­cmdçš„å‘½ä»¤ï¼Œcmdå‘½ä»¤è¢«killæ‰åï¼Œjavaè¿›ç¨‹ç”±ç³»ç»Ÿæ¥æ‰˜ç®¡ï¼Œä»è€Œå¯¼è‡´javaè¿›ç¨‹å¹¶æ²¡æœ‰æ­£ç¡®å…³é—­ã€‚</p></blockquote><h1 id="Bugå¤ç°"><a href="#Bugå¤ç°" class="headerlink" title="Bugå¤ç°"></a>Bugå¤ç°</h1><p>æ‰§è¡Œä»£ç ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line"><span class="comment"># æ‰§è¡Œjava -jar</span></span><br><span class="line">t = subprocess.Popen([<span class="string">&quot;java&quot;</span>, <span class="string">&quot;-jar&quot;</span>, <span class="string">&quot;springboot-demo.jar&quot;</span>])</span><br><span class="line"><span class="comment"># Popenæ˜¯å¼‚æ­¥çš„ï¼Œæ‰€ä»¥éœ€è¦ç­‰å¾…å‡ ç§’ï¼Œå†å…³é—­</span></span><br><span class="line">time.sleep(<span class="number">10</span>)</span><br><span class="line"><span class="comment"># å…³é—­å­è¿›ç¨‹</span></span><br><span class="line">t.terminate()</span><br><span class="line"><span class="comment"># ç­‰å¾…å…³é—­ç»“æŸ</span></span><br><span class="line">t.wait()</span><br></pre></td></tr></table></figure><p>å‘ç°æ®‹ç•™çš„javaè¿›ç¨‹</p><p><img src="image.png" alt="image"></p><h1 id="è§£å†³"><a href="#è§£å†³" class="headerlink" title="è§£å†³"></a>è§£å†³</h1><h2 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>æˆ‘çš„è§£å†³æ€è·¯æ˜¯ï¼Œç¨å¾®ä¿®æ”¹javaä»£ç ï¼Œåœ¨æ‰§è¡Œjava -jarå‘½ä»¤åï¼Œå°†javaè¿›ç¨‹idï¼ˆpidï¼‰æš´éœ²å‡ºæ¥ã€‚</p><p>å½“éœ€è¦å…³é—­ç¨‹åºæ—¶ï¼Œè¯»å–æš´éœ²å‡ºæ¥çš„javaè¿›ç¨‹idï¼Œä½¿ç”¨killå‘½ä»¤ï¼Œå°†è¿›ç¨‹æ€æ­»ã€‚</p><h2 id="è¯¦è¿°"><a href="#è¯¦è¿°" class="headerlink" title="è¯¦è¿°"></a>è¯¦è¿°</h2><p>é¦–å…ˆä¿®æ”¹javaä»£ç ï¼Œæˆ‘ä½¿ç”¨çš„ä»£ç æ¡†æ¶æ˜¯springbootï¼Œæ‰€ä»¥åœ¨springbootçš„å¯åŠ¨ç±»ä¸Šä¿®æ”¹å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringbootDemoApplication</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"><span class="type">SpringApplication</span> <span class="variable">application</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpringApplication</span>(SpringbootDemoApplication.class);</span><br><span class="line"><span class="comment">// è·å–jaråŒ…æ‰§è¡Œçš„è·¯å¾„</span></span><br><span class="line"><span class="type">ApplicationHome</span> <span class="variable">h</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ApplicationHome</span>(SpringbootDemoApplication.class);</span><br><span class="line"><span class="type">File</span> <span class="variable">source</span> <span class="operator">=</span> h.getSource();</span><br><span class="line">System.out.println(<span class="string">&quot;&lt;&lt;&lt;&lt;&lt;&lt; jar æ‰§è¡Œç›®å½•ï¼š&quot;</span> + source.getParentFile().toString() + <span class="string">&quot; &gt;&gt;&gt;&gt;&gt;&gt;&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">app_pid_file</span> <span class="operator">=</span> source.getParentFile().toString() + <span class="string">&quot;\\app.pid&quot;</span>;</span><br><span class="line">application.addListeners(<span class="keyword">new</span> <span class="title class_">ApplicationPidFileWriter</span>(app_pid_file)); <span class="comment">// æŠŠè¿›ç¨‹å·æ”¾åˆ°è¿™ä¸ªæ–‡ä»¶ä¸­</span></span><br><span class="line">application.run();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œ</p><ul><li>source.getParentFile().toString()å¯ä»¥è·å¾—jaråŒ…æ‰€åœ¨çš„ç›®å½•ã€‚</li><li>application.addListeners(new ApplicationPidFileWriter(app_pid_file));å°†åœ¨jaråŒ…åŒçº§ç›®å½•ä¸‹ç”Ÿæˆapp.pidçš„æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶ä¸­å†™å…¥äº†springbootè¿è¡Œçš„è¿›ç¨‹å·</li></ul><p>ç„¶åä¿®æ”¹Pythonä»£ç </p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">JAR_DIR = <span class="string">&#x27;XXX&#x27;</span> <span class="comment"># jaråŒ…æ‰€åœ¨ç›®å½•</span></span><br><span class="line"><span class="comment"># æ‰§è¡Œjava -jar</span></span><br><span class="line">t = subprocess.Popen([<span class="string">&quot;java&quot;</span>, <span class="string">&quot;-jar&quot;</span>, os.path.join(<span class="string">f&quot;<span class="subst">&#123;JAR_DIR&#125;</span>&quot;</span>, <span class="string">&quot;springboot-demo.jar&quot;</span>])</span><br><span class="line"><span class="comment"># Popenæ˜¯å¼‚æ­¥çš„ï¼Œæ‰€ä»¥éœ€è¦ç­‰å¾…å‡ ç§’ï¼Œå†å…³é—­</span></span><br><span class="line">time.sleep(<span class="number">10</span>)</span><br><span class="line"><span class="comment"># å…³é—­å­è¿›ç¨‹</span></span><br><span class="line">t.terminate()</span><br><span class="line"><span class="comment"># ç­‰å¾…å…³é—­ç»“æŸ</span></span><br><span class="line">t.wait()</span><br><span class="line"><span class="comment"># å…³é—­javaè¿›ç¨‹</span></span><br><span class="line">app_pid_file_path = os.path.join(JAR_DIR, <span class="string">&quot;app.pid&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> os.path.exists(app_pid_file_path):</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(app_pid_file_path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">pid = f.read()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;æ­£åœ¨å…³é—­java è¿›ç¨‹, pidï¼š <span class="subst">&#123;<span class="built_in">int</span>(pid)&#125;</span>&quot;</span>)</span><br><span class="line"><span class="comment"># åœ¨windowsç³»ç»Ÿä¸‹æ‰§è¡Œæ€æ­»è¿›ç¨‹çš„å‘½ä»¤ï¼Œå…¶ä»–ç³»ç»Ÿå¯èƒ½å‘½ä»¤ä¸åŒ</span></span><br><span class="line">subprocess.run([<span class="string">&quot;cmd&quot;</span>, <span class="string">&quot;/c&quot;</span>, <span class="string">&quot;taskkill&quot;</span>, <span class="string">&quot;/pid&quot;</span>, <span class="string">f&#x27;<span class="subst">&#123;<span class="built_in">int</span>(pid)&#125;</span>&#x27;</span>, <span class="string">&quot;-f&quot;</span>])</span><br><span class="line">os.remove(app_pid_file_path) <span class="comment"># åˆ é™¤app.pidæ–‡ä»¶</span></span><br></pre></td></tr></table></figure><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æ— </p><h1 id="Refs"><a href="#Refs" class="headerlink" title="Refs"></a>Refs</h1><ol><li><a href="https://blog.csdn.net/skyli114/article/details/127324383">subprocess.Popenæ‰§è¡Œç¨‹åºä»¥åŠå…³é—­è¿›ç¨‹</a></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;é—®é¢˜ç®€è¿°&quot;&gt;&lt;a href=&quot;#é—®é¢˜ç®€è¿°&quot; class=&quot;headerlink&quot; title=&quot;é—®é¢˜ç®€è¿°&quot;&gt;&lt;/a&gt;é—®é¢˜ç®€è¿°&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;éœ€æ±‚æ˜¯é€šè¿‡Pythonæ‰§è¡Œå‘½ä»¤java -java springboot-demo.jar&lt;/p&gt;</summary>
      
    
    
    
    <category term="Python" scheme="https://guoyujian.github.io/categories/Python/"/>
    
    
    <category term="Python" scheme="https://guoyujian.github.io/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>CC+Open3dè§£å†³å¤§å‹ç‚¹äº‘æ•°æ®åŠ è½½å’Œè®¡ç®—é—®é¢˜</title>
    <link href="https://guoyujian.github.io/2023/11/29/CC-Open3d%E8%A7%A3%E5%86%B3%E5%A4%A7%E5%9E%8B%E7%82%B9%E4%BA%91%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD%E5%92%8C%E8%AE%A1%E7%AE%97%E9%97%AE%E9%A2%98/"/>
    <id>https://guoyujian.github.io/2023/11/29/CC-Open3d%E8%A7%A3%E5%86%B3%E5%A4%A7%E5%9E%8B%E7%82%B9%E4%BA%91%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD%E5%92%8C%E8%AE%A1%E7%AE%97%E9%97%AE%E9%A2%98/</id>
    <published>2023-11-29T10:28:41.000Z</published>
    <updated>2023-11-29T10:32:24.268Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>é›·è¾¾æ‰«æçš„ç‚¹äº‘æ•°æ®é‡å¾€å¾€å¾ˆå¤§ï¼Œè€Œå…¶ä¸­å­˜åœ¨å¤§é‡ä¸éœ€è¦çš„ç‚¹ã€‚</p><p>ä¾‹å¦‚æˆ‘åªéœ€è¦æŸä¸ªå°æ¨¡å‹çš„ç‚¹äº‘ï¼Œä½†é›·è¾¾å°†å‘¨å›´çš„ç¯å¢ƒä¹Ÿä¸€å¹¶æ‰«æè¿›æ¥äº†ï¼Œè¿™äº›ç¯å¢ƒç‚¹äº‘æˆ‘å¹¶ä¸éœ€è¦ã€‚</p><p>ç°åœ¨æˆ‘éœ€è¦æµ‹é‡è¿™ä¸ªå°æ¨¡å‹çš„æŸäº›å±æ€§ã€‚ï¼ˆæ¯”å¦‚é•¿å®½ï¼‰</p><p>æ­¤æ—¶å¦‚æœç›´æ¥åœ¨å…¨éƒ¨ç‚¹äº‘æ•°æ®ä¸‹è¿›è¡Œæµ‹é‡ï¼Œå°†è¿™äº›ç‚¹äº‘åŠ è½½å‡ºæ¥éƒ½æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„é—®é¢˜ã€‚åœ¨æˆ‘çš„æœºå™¨ä¸Šï¼Œä½¿ç”¨Cloud Compareè½½å…¥1.3äº¿æ•°é‡çº§çš„ç‚¹äº‘æ•°æ®ç›´æ¥å¡æ­»ã€‚</p><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œå¯ä»¥é€šè¿‡ä½“ç´ é™é‡‡æ ·çš„æ–¹å¼ï¼ˆä¾‹å¦‚ä½“ç´ å€¼ä¸º2dmï¼‰æå¤§ç¼©å°ç‚¹äº‘çš„æ•°é‡ï¼Œä½†æˆ‘çš„éœ€æ±‚æ˜¯å¸Œæœ›è®¡ç®—å°æ¨¡å‹çš„é•¿å®½ï¼Œå…¶è¯¯å·®ä¸è¶…è¿‡5cmã€‚</p><h1 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h1><p>å› æ­¤æˆ‘çš„åšæ³•å¦‚å›¾æ‰€ç¤ºï¼š</p><p><img src="æœªå‘½åç»˜å›¾.drawio-20231129175149-u5ss8y9.png" alt="æœªå‘½åç»˜å›¾.drawio">â€‹â€‹</p><ol><li>é¦–å…ˆä¸ºäº†èƒ½å¤Ÿå°†ç‚¹äº‘å±•ç¤ºå‡ºæ¥ï¼Œæˆ‘è¦æå¤§çš„ä¸‹é‡‡æ ·ç‚¹äº‘ï¼Œè¿™é‡Œæˆ‘å–å‚æ•°ä¸º0.2ï¼ˆ2dmï¼‰ï¼Œå¾—åˆ°ä¸‹é‡‡æ ·åçš„ç‚¹äº‘1</li><li>ä½¿ç”¨CCåŠ è½½ç‚¹äº‘1ï¼Œå¹¶å¯è§†åŒ–è£å‰ªç‚¹äº‘ï¼Œå¾—åˆ°è£å‰ªç«‹æ–¹ä½“çš„å‚æ•°ï¼ŒåŒ…æ‹¬ç«‹æ–¹ä½“çš„ä¸­å¿ƒï¼Œé•¿å®½é«˜ï¼Œæ—‹è½¬ç­‰</li><li>ä½¿ç”¨ä¸Šä¸€æ­¥çš„å¾—åˆ°çš„å‚æ•°å»è£å‰ªåŸå§‹ç‚¹äº‘ï¼Œæå¤§çš„å‡å°‘äº†ç‚¹äº‘æ•°é‡</li><li>å°†è£å‡åçš„ç‚¹äº‘ä¸‹é‡‡æ ·ï¼Œä¸ºäº†ä¿è¯ç²¾åº¦ï¼Œè¿™æ¬¡ä¸‹é‡‡æ ·ç‡ä¸º0.01ï¼ˆ1cmï¼‰ï¼Œå¾—åˆ°ç‚¹äº‘2</li><li>å¯è§†åŒ–ç‚¹äº‘2ï¼Œå¹¶è¿›è¡Œæµ‹é‡ï¼Œå¾—åˆ°ç»“æœã€‚</li></ol><h1 id="æ­¥éª¤"><a href="#æ­¥éª¤" class="headerlink" title="æ­¥éª¤"></a>æ­¥éª¤</h1><h2 id="1"><a href="#1" class="headerlink" title="1."></a>1.</h2><p>ç¼–å†™pythonè„šæœ¬å¹¶å¯¼å…¥åˆ°CCï¼Œæ‰§è¡Œè¯¥è„šæœ¬ï¼Œå°†ç‚¹äº‘1åŠ è½½åˆ°CCä¸­</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pycc</span><br><span class="line"><span class="keyword">import</span> cccorelib</span><br><span class="line"></span><br><span class="line">cc = pycc.GetInstance()</span><br><span class="line"><span class="keyword">import</span> open3d <span class="keyword">as</span> o3d</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="comment"># open PointCloud with 139032791 points.</span></span><br><span class="line">pcd: o3d.geometry.PointCloud = o3d.io.read_point_cloud(<span class="string">r&quot;origin.pcd&quot;</span>)</span><br><span class="line"><span class="comment"># è°ƒæ•´åˆé€‚çš„é™é‡‡æ ·ç‡</span></span><br><span class="line">pcd = pcd.voxel_down_sample(<span class="number">0.2</span>) <span class="comment">#</span></span><br><span class="line">points = np.asarray(pcd.points)</span><br><span class="line"></span><br><span class="line">xs = points[:, <span class="number">0</span>]</span><br><span class="line">ys = points[:, <span class="number">1</span>]</span><br><span class="line">zs = points[:, <span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">pc = pycc.ccPointCloud(xs, ys, zs)</span><br><span class="line"><span class="comment"># load</span></span><br><span class="line">cc.addToDB(pc)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="2"><a href="#2" class="headerlink" title="2."></a>2.</h2><p>åœ¨CCä¸­å¯¹ç‚¹äº‘è¿›è¡Œåˆ‡ç‰‡ï¼Œå¾—åˆ°æƒ³è¦çš„éƒ¨åˆ†ç‚¹äº‘çš„è£å‰ªç«‹æ–¹ä½“å‚æ•°ã€‚</p><p><img src="image-20231129175946-c305vb2.png" alt="è£å‰ªå‰"></p><p><img src="image-20231129180213-3vc0ov2.png" alt="è£å‰ªå">â€‹</p><p>å¦‚å›¾åˆ†åˆ«æ˜¯è£å‰ªå‰åçš„æ•ˆæœå›¾ï¼Œè£å‰ªåçš„çº¢æ¡†é‡Œæ˜¯è£å‰ªç«‹æ–¹ä½“çš„å‚æ•°ã€‚å¤åˆ¶ä¸‹æ¥åé¢è¦ç”¨åˆ°ã€‚</p><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">transformation matrix:</span><br><span class="line">0.987671196461 -0.156546846032 0.000000000000 3.480050563812</span><br><span class="line">0.156546846032 0.987671196461 0.000000000000 -3.573182106018</span><br><span class="line">0.000000000000 0.000000000000 1.000001311302 2.071678161621</span><br><span class="line">0.000000000000 0.000000000000 0.000000000000 1.000000000000</span><br><span class="line"></span><br><span class="line">é•¿å®½é«˜ï¼š</span><br><span class="line">X: 6.21198273</span><br><span class="line">Y: 13.27857590</span><br><span class="line">Z: 9.57320881</span><br></pre></td></tr></table></figure><h2 id="3"><a href="#3" class="headerlink" title="3."></a>3.</h2><p>ç”±ä¸Šè¿°çš„å‚æ•°å¯ä»¥çŸ¥é“è¯¥ç«‹æ–¹ä½“çš„ä¸­å¿ƒç‚¹æ˜¯<code>(3.480050563812, -3.573182106018, 2.071678161621)</code>â€‹ï¼Œæ—‹è½¬çŸ©é˜µä¸º</p><script type="math/tex; mode=display">\begin{bmatrix}0.987671196461&-0.156546846032&0.000000000000\\0.156546846032&0.987671196461&0.000000000000\\0.000000000000&0.000000000000&1.000001311302\\\end{bmatrix}</script><p>é•¿å®½é«˜ä¸º<code>(6.21198273, 13.27857590, 9.57320881)</code>â€‹</p><p>å› æ­¤å¯ä»¥å†™ä»£ç ä½¿ç”¨open3dæ¥è£å‰ªåŸå§‹ç‚¹äº‘ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">pcd: o3d.geometry.PointCloud = o3d.io.read_point_cloud(<span class="string">r&quot;origin.pcd&quot;</span>)</span><br><span class="line">   <span class="comment"># ç”»ä¸€ä¸ª&quot;ç›’å­&quot;ï¼Œå°†ç›’å­å¤–çš„ç‚¹äº‘å»æ‰ï¼Œ</span></span><br><span class="line">   obx = o3d.geometry.OrientedBoundingBox(</span><br><span class="line">       np.array([<span class="number">3.480050563812</span>, -<span class="number">3.573182106018</span>, <span class="number">2.071678161621</span>]), <span class="comment"># center</span></span><br><span class="line">       np.array([</span><br><span class="line">           [<span class="number">0.987671196461</span>, -<span class="number">0.156546846032</span>, <span class="number">0.000000000000</span>],</span><br><span class="line">           [<span class="number">0.156546846032</span>, <span class="number">0.987671196461</span>, <span class="number">0.000000000000</span>],</span><br><span class="line">           [<span class="number">0.000000000000</span>, <span class="number">0.000000000000</span>, <span class="number">1.000001311302</span>]</span><br><span class="line">       ]), <span class="comment"># rotation</span></span><br><span class="line">       np.array([<span class="number">6.21198273</span>, <span class="number">13.27857590</span>, <span class="number">9.57320881</span>]) <span class="comment"># width, depth, height</span></span><br><span class="line">   )</span><br><span class="line">   pcd_cropped = pcd.crop(obx) <span class="comment"># è£å‰ªåçš„ç‚¹äº‘</span></span><br><span class="line">pcd_cropped = pcd_cropped.voxel_down_sample(<span class="number">0.01</span>) <span class="comment"># ç¬¬äºŒæ¬¡é™é‡‡æ ·</span></span><br><span class="line">   o3d.io.write_point_cloud(<span class="string">&#x27;cropped.pcd&#x27;</span>, pcd_cropped) <span class="comment"># save </span></span><br></pre></td></tr></table></figure><h2 id="4"><a href="#4" class="headerlink" title="4."></a>4.</h2><p>ç»è¿‡è¿™äº›æ­¥éª¤åï¼Œç‚¹äº‘æ•°æ®é‡ä»1.3äº¿é™åˆ°äº†840ä¸‡ã€‚å°†è¿™ä¸ª<code>cropped.pcd</code>â€‹æ‹¿åˆ°CCä¸­æ‰“å¼€ï¼Œå¹¶æµ‹é‡ã€‚ï¼ˆå›¾ç•¥ï¼‰</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æœ¬æ–‡æ–¹æ³•æ—¢è§£å†³äº†å¤§è§„æ¨¡ç‚¹äº‘æ•°æ®åŠ è½½å¡æ­»ã€æ“ä½œå›°éš¾çš„é—®é¢˜ï¼Œåˆèƒ½ç²¾ç¡®å¾—åˆ°è®¡ç®—ç»“æœã€‚</p><p>ä¸è¿‡æµç¨‹å¯ä»¥å†ä¼˜åŒ–ï¼Œæ›´è‡ªåŠ¨åŒ–ä¸€äº›ã€‚</p><h1 id="Refs"><a href="#Refs" class="headerlink" title="Refs"></a>Refs</h1><p>æ— </p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;é›·è¾¾æ‰«æçš„ç‚¹äº‘æ•°æ®é‡å¾€å¾€å¾ˆå¤§ï¼Œè€Œå…¶ä¸­å­˜åœ¨å¤§é‡ä¸éœ€è¦çš„ç‚¹ã€‚&lt;/p&gt;
&lt;p&gt;ä¾‹å¦‚æˆ‘åªéœ€è¦æŸä¸ªå°æ¨¡å‹çš„ç‚¹äº‘ï¼Œä½†é›·è¾¾å°†å‘¨å›´çš„ç¯å¢ƒä¹Ÿä¸€å¹¶æ‰«æè¿›æ¥äº†ï¼Œè¿™</summary>
      
    
    
    
    <category term="ç‚¹äº‘æ•°æ®å¤„ç†" scheme="https://guoyujian.github.io/categories/%E7%82%B9%E4%BA%91%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86/"/>
    
    
    <category term="CloudCompare" scheme="https://guoyujian.github.io/tags/CloudCompare/"/>
    
    <category term="Point Cloud" scheme="https://guoyujian.github.io/tags/Point-Cloud/"/>
    
  </entry>
  
  <entry>
    <title>CloudCompareå¸¸ç”¨æ“ä½œåŠPythonæ’ä»¶</title>
    <link href="https://guoyujian.github.io/2023/11/28/CloudCompare%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C%E5%8F%8APython%E6%8F%92%E4%BB%B6/"/>
    <id>https://guoyujian.github.io/2023/11/28/CloudCompare%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C%E5%8F%8APython%E6%8F%92%E4%BB%B6/</id>
    <published>2023-11-28T06:14:52.000Z</published>
    <updated>2023-11-28T06:30:06.169Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><blockquote><p>æœ€è¿‘åœ¨åšç‚¹äº‘å¤„ç†ç›¸å…³çš„å·¥ä½œï¼Œè¿™é‡Œæ‰¾åˆ°äº†ä¸€ä¸ªéå¸¸å¥½ç”¨çš„å¼€æºè½¯ä»¶CloudCompareï¼ˆä¸‹ç§°CCï¼‰ã€‚è¿™é‡Œå¯¹æˆ‘çš„å¸¸ç”¨æ“ä½œè¿›è¡Œæ€»ç»“ï¼Œå¹¶ä»‹ç»CCçš„Pythonæ’ä»¶ï¼Œè¯¥æ’ä»¶å¯ä»¥å®ç°è‡ªå®šä¹‰çš„ç‚¹äº‘æ“ä½œå®ç°ï¼Œæå¤§åœ°æ‰©å±•äº†CCçš„åŠŸèƒ½ã€‚</p></blockquote><h1 id="å¸¸ç”¨æ“ä½œ"><a href="#å¸¸ç”¨æ“ä½œ" class="headerlink" title="å¸¸ç”¨æ“ä½œ"></a>å¸¸ç”¨æ“ä½œ</h1><h2 id="ç‚¹äº‘æŒ‰é«˜ç¨‹èµ‹è‰²"><a href="#ç‚¹äº‘æŒ‰é«˜ç¨‹èµ‹è‰²" class="headerlink" title="ç‚¹äº‘æŒ‰é«˜ç¨‹èµ‹è‰²"></a>ç‚¹äº‘æŒ‰é«˜ç¨‹èµ‹è‰²</h2><p>æ‰“å¼€çš„ç‚¹äº‘æ²¡æœ‰é¢œè‰²ï¼Œå¾ˆéš¾çœ‹ä¸”å¾ˆéš¾æ“ä½œï¼Œä¸ºäº†è®©ç‚¹äº‘æ›´æœ‰ç«‹ä½“æ„Ÿï¼Œå¯ä»¥æŒ‰é«˜ç¨‹å¯¹ç‚¹äº‘è¿›è¡Œèµ‹è‰²ã€‚</p><p><code>Edit -&gt; Colors -&gt; Height Ramp</code></p><p><img src="wps1-20231128113644-3f440qp.jpg" alt="img"></p><p>CCä¹Ÿå¯ä»¥æŒ‰ç…§å…¶ä»–è½´è¿›è¡Œèµ‹è‰²</p><p><code>Edit -&gt; Scalar fields -&gt; export coordinate to SF</code>ï¼Œ é€‰æ‹©x/y/zè½´</p><p><img src="wps2-20231128113644-ecarnyw.jpg" alt="img"></p><p><img src="wps3-20231128113644-ibdm0ik.jpg" alt="img"></p><h2 id="ä½¿ç”¨å¤šè¾¹å½¢å¯¹ç‚¹äº‘è£å‰ª"><a href="#ä½¿ç”¨å¤šè¾¹å½¢å¯¹ç‚¹äº‘è£å‰ª" class="headerlink" title="ä½¿ç”¨å¤šè¾¹å½¢å¯¹ç‚¹äº‘è£å‰ª"></a>ä½¿ç”¨å¤šè¾¹å½¢å¯¹ç‚¹äº‘è£å‰ª</h2><p><a href="https://blog.csdn.net/qq_32867925/article/details/124187166">https://blog.csdn.net/qq_32867925/article/details/124187166</a></p><h2 id="è®¡ç®—ç‚¹äº‘ä¸­ä¸¤ä¸ªç‚¹ä¹‹é—´çš„è·ç¦»"><a href="#è®¡ç®—ç‚¹äº‘ä¸­ä¸¤ä¸ªç‚¹ä¹‹é—´çš„è·ç¦»" class="headerlink" title="è®¡ç®—ç‚¹äº‘ä¸­ä¸¤ä¸ªç‚¹ä¹‹é—´çš„è·ç¦»"></a>è®¡ç®—ç‚¹äº‘ä¸­ä¸¤ä¸ªç‚¹ä¹‹é—´çš„è·ç¦»</h2><p><a href="https://blog.csdn.net/qq_36686437/article/details/122224036">https://blog.csdn.net/qq_36686437/article/details/122224036</a></p><h2 id="ä¸‹é‡‡æ ·"><a href="#ä¸‹é‡‡æ ·" class="headerlink" title="ä¸‹é‡‡æ ·"></a>ä¸‹é‡‡æ ·</h2><p><a href="https://blog.csdn.net/qq_27353621/article/details/124008810">https://blog.csdn.net/qq_27353621/article/details/124008810</a></p><h2 id="ç»Ÿè®¡æ»¤æ³¢"><a href="#ç»Ÿè®¡æ»¤æ³¢" class="headerlink" title="ç»Ÿè®¡æ»¤æ³¢"></a>ç»Ÿè®¡æ»¤æ³¢</h2><p><a href="https://blog.csdn.net/qq_36686437/article/details/120011047">https://blog.csdn.net/qq_36686437/article/details/120011047</a></p><p>CCå¥½åƒæ²¡æœ‰å®ç°åŠå¾„æ»¤æ³¢ï¼Œéœ€è¦è‡ªè¡Œå®ç°</p><h2 id="è®¡ç®—ä½“ç§¯"><a href="#è®¡ç®—ä½“ç§¯" class="headerlink" title="è®¡ç®—ä½“ç§¯"></a>è®¡ç®—ä½“ç§¯</h2><p><a href="https://www.cnblogs.com/codeAndlearn/p/12317673.html">https://www.cnblogs.com/codeAndlearn/p/12317673.html</a></p><p>CCè®¡ç®—çš„å¹¶éæ˜¯ç‚¹äº‘çš„å‡¸åŒ…ä½“ç§¯ï¼ŒCCå¥½åƒæ²¡æœ‰å®ç°å‡¸åŒ…ä½“ç§¯è®¡ç®—ï¼Œéœ€è¦è‡ªè¡Œå®ç°</p><h2 id="åˆ›å»ºçƒå¹¶ç§»åŠ¨ï¼Œè®¡ç®—çƒå’Œçƒä¹‹é—´çš„è·ç¦»"><a href="#åˆ›å»ºçƒå¹¶ç§»åŠ¨ï¼Œè®¡ç®—çƒå’Œçƒä¹‹é—´çš„è·ç¦»" class="headerlink" title="åˆ›å»ºçƒå¹¶ç§»åŠ¨ï¼Œè®¡ç®—çƒå’Œçƒä¹‹é—´çš„è·ç¦»"></a>åˆ›å»ºçƒå¹¶ç§»åŠ¨ï¼Œè®¡ç®—çƒå’Œçƒä¹‹é—´çš„è·ç¦»</h2><p>æœ‰æ—¶éœ€è¦è®¡ç®—ä¸¤ç‚¹ä¹‹é—´çš„è·ç¦»ï¼Œä½†æ˜¯è¿™ä¸¤ç‚¹è™½ç„¶ä»£è¡¨ç‚¹äº‘ä½†å¹¶ä¸åœ¨ç‚¹äº‘é›†åˆä¸­ï¼Œéœ€è¦è‡ªå®šä¹‰ä½ç½®ã€‚æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸¤ä¸ªçƒï¼Œç„¶åå°†å®ƒä»¬æ‹–åŠ¨åˆ°æŒ‡å®šä½ç½®ï¼Œç„¶åå†è®¡ç®—è·ç¦»ã€‚</p><p>é¦–å…ˆï¼Œåˆ›å»ºçƒ</p><p><code>File -&gt; Primitive Factory</code>ï¼Œé€‰æ‹©sphereï¼Œç¡®å®šä½ç½®å’ŒåŠå¾„</p><p><img src="wps4-20231128113644-n938rmx.jpg?lastModify=1701152207" alt="img"></p><p>ç„¶åæ‹–åŠ¨çƒï¼šé€‰ä¸­çƒï¼Œå¹¶ç‚¹é€‰ä¸‹å›¾å›¾æ ‡ã€‚é¼ æ ‡å³é”®æ‹–åŠ¨ã€‚</p><p><img src="wps5-20231128113644-mbw49ys.jpg" alt="img"></p><p>å°†ä¸¤ä¸ªçƒæ‹–åŠ¨åˆ°åˆé€‚çš„ä½ç½®ï¼Œè®¡ç®—è·ç¦»</p><p><img src="wps6-20231128113644-oc6tpfo.jpg?lastModify=1701152207" alt="img"></p><h2 id="æ›´å¤šæ“ä½œ"><a href="#æ›´å¤šæ“ä½œ" class="headerlink" title="æ›´å¤šæ“ä½œ"></a>æ›´å¤šæ“ä½œ</h2><p>è¿™é‡Œæœ‰äººæ€»ç»“äº†CCçš„æ“ä½œï¼Œéå¸¸å…¨é¢ã€‚</p><p><a href="https://blog.csdn.net/qq_36686437/article/details/120100839">https://blog.csdn.net/qq_36686437/article/details/120100839</a></p><h1 id="CC-Pythonæ’ä»¶"><a href="#CC-Pythonæ’ä»¶" class="headerlink" title="CC-Pythonæ’ä»¶"></a>CC-Pythonæ’ä»¶</h1><h2 id="å‰ç½®æ¡ä»¶-Win10"><a href="#å‰ç½®æ¡ä»¶-Win10" class="headerlink" title="å‰ç½®æ¡ä»¶(Win10)"></a>å‰ç½®æ¡ä»¶(Win10)</h2><p>ä½¿ç”¨è¯¥æ’ä»¶éœ€è¦å®‰è£…æœ€æ–°ç‰ˆçš„CCï¼Œæˆ‘å®‰è£…çš„ç‰ˆæœ¬æ˜¯2.13</p><p><img src="image-20231128114621-bo1kz5e.png" alt="image"></p><p>åœ¨å®‰è£…æ—¶ï¼Œè®°å¾—å‹¾é€‰</p><p><img src="image-20231128114706-bwwrkfk.png" alt="image"></p><blockquote><p>Windowsæ˜¯ç›´æ¥å¸¦æœ‰è¿™ä¸ªæ’ä»¶çš„ï¼Œè€ŒMacOSä¸‹å®‰è£…è¯¥æ’ä»¶éœ€è¦è‡ªå·±å»ç¼–è¯‘æ’ä»¶ä»£ç å¹¶å®‰è£…ã€‚</p><p>è¿™æ˜¯æ’ä»¶ä»£ç çš„æ–‡æ¡£ï¼š<a href="https://tmontaigu.github.io/CloudCompare-PythonPlugin/">https://tmontaigu.github.io/CloudCompare-PythonPlugin/</a></p><p>åŒ…æ‹¬å¦‚ä½•ç¼–è¯‘æºç &amp;Useage</p></blockquote><p>å®‰è£…å®Œæˆåï¼Œè®°å¾—æ›´æ–°ä¸€ä¸‹pipï¼š</p><p>è¿›å…¥å®‰è£…ç›®å½•ä¸‹<code>CloudCompare/plugins/Python</code>ï¼Œæ‰§è¡Œ<code>.\python.exe -m pip install --upgrade pip</code></p><h2 id="ä½¿ç”¨æ’ä»¶ç¤ºä¾‹"><a href="#ä½¿ç”¨æ’ä»¶ç¤ºä¾‹" class="headerlink" title="ä½¿ç”¨æ’ä»¶ç¤ºä¾‹"></a>ä½¿ç”¨æ’ä»¶ç¤ºä¾‹</h2><p>æœ‰äº›ç‚¹äº‘æ–‡ä»¶å·¨å¤§ï¼ŒåŠ è½½è¿›æ¥ä¼šå¾ˆæ…¢ï¼Œæˆ‘è¿™é‡Œå…ˆå°†ç‚¹äº‘é™é‡‡æ ·ä¹‹åæ‰æŠŠä»–åŠ è½½åˆ°CCä¸­ã€‚</p><p>ä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘éœ€è¦å®‰è£…open3d</p><p>æ‰“å¼€Python Managerï¼š <code>Plugins -&gt; Python Plugins -&gt; Package Manager</code></p><p><img src="image-20231128120020-x27frq0.png" alt="image">ç‚¹å‡»installï¼Œè¾“å…¥open3d è¿›è¡Œå®‰è£…ã€‚</p><p><img src="image-20231128120130-6obtvph.png" alt="image"></p><p>æ‰“å¼€Show REPLï¼š <code>Plugins -&gt; Python Plugins -&gt; Show REPL</code></p><p>çº¢æ¡†è¾“å…¥æŒ‡ä»¤</p><p><img src="image-20231128120448-c9cul9e.png" alt="image"></p><p>ä»¥ä¸‹æ˜¯æˆ‘è¾“å…¥çš„æŒ‡ä»¤</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> pycc</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> cccorelib</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cc = pycc.GetInstance()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> open3d <span class="keyword">as</span> o3d</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>pcd = o3d.io.read_point_cloud(<span class="string">&#x27;C:/Users/Administrator/Desktop/merged_room.pcd&#x27;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>pcd = pcd.voxel_down_sample(<span class="number">0.5</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>points = np.asarray(pcd.points)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>xs = points[:, <span class="number">0</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ys = points[:, <span class="number">1</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>zs = points[:, <span class="number">2</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>pc = pycc.ccPointCloud(xs, ys, zs)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cc.addToDB(pc)</span><br></pre></td></tr></table></figure><p>è‡³æ­¤å¯ä»¥çœ‹åˆ°CCåœºæ™¯ä¸­å·²ç»åŠ è½½äº†ç‚¹äº‘</p><p><img src="image-20231128120849-90hz4hw.png" alt="image"></p><p>æˆ‘ä»¬å¯ä»¥ç”¨æ’ä»¶å®ç°å‰é¢CCæœªå®ç°çš„è¯¸å¤šåŠŸèƒ½ã€‚æ›´å¤šç”¨æ³•å¯ä»¥å‚è€ƒå‰æ–‡æåˆ°çš„æ’ä»¶çš„å®˜æ–¹æ–‡æ¡£ã€‚</p><h1 id="Refs"><a href="#Refs" class="headerlink" title="Refs"></a>Refs</h1>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;æœ€è¿‘åœ¨åšç‚¹äº‘å¤„ç†ç›¸å…³çš„å·¥ä½œï¼Œè¿™é‡Œæ‰¾åˆ°äº†ä¸€ä¸ªéå¸¸å¥½ç”¨çš„å¼€æºè½¯ä»¶CloudCompareï¼ˆä¸‹ç§°CCï¼‰ã€‚è¿™é‡Œå¯¹æˆ‘çš„å¸¸ç”¨æ“</summary>
      
    
    
    
    <category term="ç‚¹äº‘æ•°æ®å¤„ç†" scheme="https://guoyujian.github.io/categories/%E7%82%B9%E4%BA%91%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86/"/>
    
    
    <category term="CloudCompare" scheme="https://guoyujian.github.io/tags/CloudCompare/"/>
    
    <category term="Point Cloud" scheme="https://guoyujian.github.io/tags/Point-Cloud/"/>
    
  </entry>
  
  <entry>
    <title>CPUå¯†é›†å‹ä»»åŠ¡çš„åç«¯å®ç°æ–¹æ³•æ¯”è¾ƒæ€»ç»“</title>
    <link href="https://guoyujian.github.io/2023/10/19/CPU%E5%AF%86%E9%9B%86%E5%9E%8B%E4%BB%BB%E5%8A%A1%E7%9A%84%E5%90%8E%E7%AB%AF%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%B3%95%E6%AF%94%E8%BE%83%E6%80%BB%E7%BB%93/"/>
    <id>https://guoyujian.github.io/2023/10/19/CPU%E5%AF%86%E9%9B%86%E5%9E%8B%E4%BB%BB%E5%8A%A1%E7%9A%84%E5%90%8E%E7%AB%AF%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%B3%95%E6%AF%94%E8%BE%83%E6%80%BB%E7%BB%93/</id>
    <published>2023-10-19T14:38:32.000Z</published>
    <updated>2023-10-19T14:49:56.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h1><p>å…ˆä»‹ç»ä¸‹æ•´ä½“ç³»ç»Ÿæ¡†æ¶ï¼Œç³»ç»Ÿåˆ†ä¸ºå‰ç«¯å’Œåç«¯ï¼ŒäºŒè€…é€šè¿‡websocketåè®®è¿›è¡Œé€šä¿¡ã€‚é€šè¿‡è¯·æ±‚æ•°æ®ä¸­çš„codeå­—æ®µæ¥å“åº”ä¸åŒçš„æ“ä½œã€‚</p><p><img src="å‰åç«¯é€šä¿¡.png" alt="å‰åç«¯é€šä¿¡"></p><p><img src="æ—¶åºå›¾.png" alt="æ—¶åºå›¾"></p><p><img src="åç«¯å¤„ç†ä¸€æ¬¡è¯·æ±‚çš„æµç¨‹å›¾.png" alt="åç«¯å¤„ç†ä¸€æ¬¡è¯·æ±‚çš„æµç¨‹å›¾"></p><p>ä»¥ä¸Šä»‹ç»æ•´ä½“çš„è½¯ä»¶é€»è¾‘ã€‚æ­¤å¤–ï¼Œåç«¯ä½¿ç”¨Pythonçš„asyncioæ¥å®ç°å¼‚æ­¥ç¼–ç¨‹ã€‚</p><p>ä¾‹å¦‚ï¼Œå®ç°å°†æ•°æ®æ’å…¥åˆ°æ•°æ®åº“å¹¶å°†æ•°æ®å‘é€åˆ°å‰ç«¯ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">insert_data2db(data)</span><br><span class="line">ws_send(websocket, data)</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ç¨‹åºæ˜¯é¡ºåºæ‰§è¡Œçš„ã€‚å¼‚æ­¥ç‰ˆæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">await</span> insert_data2db(data)</span><br><span class="line"><span class="keyword">await</span> ws_send(websocket, data)</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ï¼Œç¨‹åºä¸ä¼šç­‰å¾…insert_data2dbå®Œæˆï¼Œç›´æ¥ç»§ç»­æ‰§è¡Œws_sendæ–¹æ³•ã€‚ä¸¤è€…åŒºåˆ«å¦‚ä¸‹è‰å›¾ï¼š</p><p><img src="åŒæ­¥å¼‚æ­¥.png" alt="åŒæ­¥å¼‚æ­¥"></p><p>è¿™ç§å¼‚æ­¥çš„æ–¹å¼åœ¨IO-Bound Taskä¸­å¥½ç”¨ã€‚ä½†æ˜¯å¯¹äºCPU-Bound Taskä¼˜åŒ–æ•ˆæœä¸å¤§ï¼ˆç”šè‡³ä¼šæœ‰åæ•ˆæœï¼‰</p><p>æ­¤å¤–ï¼Œå¦‚æœåä¸€ä¸ªæ“ä½œéœ€è¦ç”¨åˆ°å‰ä¸€ä¸ªæ“ä½œçš„ç»“æœï¼Œè¿™ä¸ªä»£ç å®é™…æ˜¯é¡ºåºæ‰§è¡Œçš„ã€‚</p><h1 id="ä¸»è¦ä»£ç ç»“æ„ï¼ˆä¼ªï¼‰"><a href="#ä¸»è¦ä»£ç ç»“æ„ï¼ˆä¼ªï¼‰" class="headerlink" title="ä¸»è¦ä»£ç ç»“æ„ï¼ˆä¼ªï¼‰"></a>ä¸»è¦ä»£ç ç»“æ„ï¼ˆä¼ªï¼‰</h1><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">ws_send</span>(<span class="params">websocket, data</span>)</span><br><span class="line"><span class="keyword">await</span> websocket.send(data)</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæ˜¯é€šè¿‡websocketè¿æ¥å°†æ•°æ®å‘é€å›å‰ç«¯çš„é€šç”¨æ–¹æ³•</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">dealPointCloudData</span>(<span class="params">websocket, request_data</span>):</span><br><span class="line">code = request_data[<span class="string">&#x27;code&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> code == <span class="number">0</span>:</span><br><span class="line"><span class="comment"># å¿ƒè·³</span></span><br><span class="line"><span class="keyword">await</span> ws_send(websocket, response_heartbeat_data)</span><br><span class="line"><span class="keyword">elif</span> code == <span class="number">1</span>:</span><br><span class="line"><span class="keyword">await</span> func1()</span><br><span class="line"><span class="keyword">elif</span> code == <span class="number">2</span>:</span><br><span class="line"><span class="keyword">await</span> func2(websocket, request_data)</span><br><span class="line"><span class="comment"># ...</span></span><br></pre></td></tr></table></figure><p>å…¶æ¬¡ï¼Œæ˜¯åˆ†å‘è¯·æ±‚çš„æ–¹æ³•dealPointCloudDataï¼Œå®ƒæœ‰ä¸¤ä¸ªå‚æ•°ï¼Œwebsocketè¿æ¥å’Œrequest_dataå‰ç«¯å‘æ¥çš„æ•°æ®ã€‚</p><p>æœ€åï¼Œä¸»ç¨‹åºä¸­ä¼šèµ·ä¸€ä¸ªwebsocketæœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨ä¼šå°†è¿æ¥å‘é€åˆ°dispatchæ–¹æ³•ï¼Œdispatchæ–¹æ³•ä¼šè½®è¯¢æ¯ä¸€ä¸ªwebsocketè¿æ¥çš„æ¶ˆæ¯ï¼Œå¹¶äº¤ç»™dealPointCloudDataå¤„ç†ã€‚ä¼ªä»£ç å¦‚ä¸‹ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">server = websockets.serve(dispatch, ip, port)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">dispatch</span>(<span class="params">websocket_conn</span>):</span><br><span class="line"><span class="keyword">async</span> <span class="keyword">for</span> message <span class="keyword">in</span> websocket:  <span class="comment"># recv message from a websocket client.</span></span><br><span class="line">msg_dict = parse_json(message)</span><br><span class="line"><span class="keyword">await</span> dealPointCloudData(websocket, msg_dict)</span><br></pre></td></tr></table></figure><h1 id="ç°çŠ¶"><a href="#ç°çŠ¶" class="headerlink" title="ç°çŠ¶"></a>ç°çŠ¶</h1><p>ç›®å‰ï¼Œå½“code==2æ—¶ï¼Œéœ€è¦å¤„ç†ä¸€ä¸ªè®¡ç®—ä»»åŠ¡ã€‚request_dataå‚æ•°ä¸­æœ‰ä¸€ä¸ªæ–‡ä»¶å¤¹è·¯å¾„ï¼Œè¯¥è®¡ç®—ä»»åŠ¡æ˜¯è¯»å–æ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å†…å®¹ï¼Œå°†æ–‡ä»¶å†…å®¹è¿›è¡Œmergeï¼Œæœ€ç»ˆç”Ÿæˆä¸€ä¸ªå®Œæ•´çš„æ–‡ä»¶ã€‚æµç¨‹å¦‚ä¸‹ï¼š</p><p><img src="è®¡ç®—æµç¨‹.png" alt="è®¡ç®—æµç¨‹"></p><p>ä¼ªä»£ç ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">func2</span>(<span class="params">websocket, request_data</span>):</span><br><span class="line">total = init()</span><br><span class="line">file_list = get_file_list(request_data) <span class="comment"># ä»request_dataä¸­å–å‡ºæ–‡ä»¶å¤¹ï¼Œ</span></span><br><span class="line"><span class="keyword">for</span> i, file_path <span class="keyword">in</span> <span class="built_in">enumerate</span>(file_list):</span><br><span class="line">obj = read_file_as_obj(file_path)</span><br><span class="line">total = merge(total, obj)</span><br><span class="line"><span class="keyword">await</span> ws_send(websocket, <span class="string">&#x27;è¿›åº¦ï¼š...&#x27;</span>) <span class="comment"># æœ¬æ¬¡mergeç»“æŸåå‘å‰ç«¯å‘é€è¿›åº¦</span></span><br><span class="line">save2file(total)</span><br><span class="line"><span class="keyword">await</span> ws_send(websocket, finish_flag)</span><br></pre></td></tr></table></figure><p>ç”±äºfunc2ä¸»è¦æ—¶é—´èŠ±è´¹åœ¨ä¸€ä¸ªforå¾ªç¯ä¸­ï¼Œ æ¯æ¬¡forå¾ªç¯ä¸­éƒ½æœ‰ä¸€ä¸ªè€—æ—¶çš„è®¡ç®—ä»»åŠ¡mergeã€‚mergeæ˜¯ä¸€ä¸ªåŒæ­¥æ–¹æ³•</p><p>æ‰€ä»¥func2ä¸­è™½ç„¶ä½¿ç”¨äº†awaitå¼‚æ­¥ç¼–ç¨‹ï¼Œä½†æ•´ä½“æ¥çœ‹ï¼Œè¿˜æ˜¯ä¸ªåŒæ­¥å¤„ç†ç¨‹åºã€‚</p><p>è¿™å°±å¯¼è‡´ä¸€ä¸ªä¸¥é‡çš„é—®é¢˜ï¼Œå°±æ˜¯å½“å•çº¿ç¨‹æ‰§è¡Œfunc2è¿›è¡Œé•¿æ—¶é—´è®¡ç®—çš„æ—¶å€™ï¼Œæ–°çš„å¿ƒè·³åŒ…è¯·æ±‚-å“åº”ä¼šè¢«é˜»å¡æ‰ã€‚å¦‚å›¾</p><p><img src="å¿ƒè·³å“åº”é˜»å¡.png" alt="å¿ƒè·³å“åº”é˜»å¡"></p><p>å¦‚æœé˜»å¡çš„æ—¶é—´è¿‡é•¿ï¼Œå‰åç«¯å°±ä¼šå¤±å»æœ¬æ¬¡è¿æ¥ã€‚</p><p>é’ˆå¯¹è¯¥é—®é¢˜ï¼Œæˆ‘å°è¯•äº†å‡ ç§è§£å†³æ–¹æ³•ã€‚</p><h1 id="å°è¯•"><a href="#å°è¯•" class="headerlink" title="å°è¯•"></a>å°è¯•</h1><h2 id="1-å¼€å¯çº¿ç¨‹æ‰§è¡Œè®¡ç®—ï¼ˆmergeï¼‰"><a href="#1-å¼€å¯çº¿ç¨‹æ‰§è¡Œè®¡ç®—ï¼ˆmergeï¼‰" class="headerlink" title="1 å¼€å¯çº¿ç¨‹æ‰§è¡Œè®¡ç®—ï¼ˆmergeï¼‰"></a>1 å¼€å¯çº¿ç¨‹æ‰§è¡Œè®¡ç®—ï¼ˆmergeï¼‰</h2><p>func2å‡½æ•°ä¸­å¼€å¯ä¸€ä¸ªæ–°çš„çº¿ç¨‹æ‰§è¡Œè®¡ç®—ï¼Œå¹¶è¿”å›æ•°æ®ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">func2</span>(<span class="params">websocket, request_data</span>):</span><br><span class="line">    t = DealPcdsThread(websocket, other_params)</span><br><span class="line">    t.start()</span><br></pre></td></tr></table></figure><p>DealPcdsThreadçº¿ç¨‹ç±»çš„å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DealPcdsThread</span>(threading.Thread):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    å¤„ç†pcdæ–‡ä»¶å¤¹çš„çº¿ç¨‹</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, websocket, request_data</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        file_list = get_file_list(request_data)</span><br><span class="line">        self.websocket = websocket</span><br><span class="line">        self.file_list = file_list </span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        asyncio.run(self.merge()) <span class="comment"># åœ¨çº¿ç¨‹ä¸­å¼€å¯æ–°çš„äº‹ä»¶å¾ªç¯æ¥æ‰§è¡Œåç¨‹å‡½æ•°</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">self</span>):</span><br><span class="line">        total = init()</span><br><span class="line">file_list = get_file_list(request_data) <span class="comment"># ä»request_dataä¸­å–å‡ºæ–‡ä»¶å¤¹ï¼Œ</span></span><br><span class="line"><span class="keyword">for</span> i, file_path <span class="keyword">in</span> <span class="built_in">enumerate</span>(file_list):</span><br><span class="line">obj = read_file_as_obj(file_path)</span><br><span class="line">total = merge(total, obj)</span><br><span class="line">log.info(<span class="string">f&#x27;...&#x27;</span>)</span><br><span class="line"><span class="keyword">await</span> ws_send(websocket, <span class="string">&#x27;è¿›åº¦ï¼š...&#x27;</span>) <span class="comment"># æœ¬æ¬¡mergeç»“æŸåå‘å‰ç«¯å‘é€è¿›åº¦</span></span><br><span class="line">save2file(total)</span><br><span class="line"><span class="keyword">await</span> ws_send(websocket, finish_flag)</span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><p>æµè§ˆå™¨æ§åˆ¶å°æ—¥å¿—å¦‚å›¾ï¼š</p><p><img src="æ§åˆ¶å°æ—¥å¿—.png" alt="æ§åˆ¶å°æ—¥å¿—"></p><p>è¿™è¯´æ˜åœ¨å¤„ç†è®¡ç®—ä»»åŠ¡æ—¶ï¼Œä¸»çº¿ç¨‹æ²¡æœ‰é˜»å¡ï¼Œå¿ƒè·³åŒ…èƒ½å¤Ÿæ­£å¸¸è¿”å›ï¼Œå’Œé¢„æœŸä¸€è‡´ã€‚</p><p>æœ¬æ¥é—®é¢˜åˆ°è¿™é‡Œå°±è§£å†³äº†ï¼Œä½†æ˜¯åœ¨å®é™…æµ‹è¯•ä¸­åˆå‘ç°äº†å…¶ä»–é—®é¢˜ã€‚</p><h3 id="é—®é¢˜1-å‰ç«¯æ˜¾ç¤ºä¸æµç•…"><a href="#é—®é¢˜1-å‰ç«¯æ˜¾ç¤ºä¸æµç•…" class="headerlink" title="é—®é¢˜1: å‰ç«¯æ˜¾ç¤ºä¸æµç•…"></a>é—®é¢˜1: å‰ç«¯æ˜¾ç¤ºä¸æµç•…</h3><p><img src="åˆæˆè¿›åº¦æ¡.gif" alt="åˆæˆè¿›åº¦æ¡"></p><p>å¦‚å›¾å¯ä»¥çœ‹åˆ°è¿›åº¦æ¡å¡åœ¨2.21%åï¼Œè¿‡äº†å‡ ç§’éå¸¸è¿…é€Ÿçš„è¹¦åˆ°äº†40.79%ã€‚ä½†æ˜¯åå°çš„æ—¥å¿—æ‰“å°æ˜¯â€œæµç•…çš„â€ï¼Œå³æ²¡æœ‰ç±»ä¼¼çš„åœé¡¿ã€‚</p><p>çŒœæµ‹å¯èƒ½æ˜¯å’Œå¼‚æ­¥æœ‰å…³ï¼Œæ¯•ç«Ÿåœ¨<code>await ws_send()</code>â€‹åç›´æ¥è¿”å›äº†ï¼Œäº‹ä»¶å¾ªç¯é€‰æ‹©äº†æŸä¸ªæ—¶é—´ç‚¹ç»Ÿä¸€å‘é€è¿™äº›è¯·æ±‚ã€‚</p><p>ä¸€å¼€å§‹è¿˜ä»¥ä¸ºæ˜¯è®¡ç®—çº¿ç¨‹å¤±å»äº†CPUçš„æ§åˆ¶æƒå¯¼è‡´çš„ï¼Œåæ¥ä¸€æƒ³å¯èƒ½æ€§ä¸å¤§ï¼Œä¸€æ–¹é¢å ç”¨æ—¶é—´åº”è¯¥åœ¨å¾ˆçŸ­çš„æ—¶é—´ï¼Œæˆ‘åº”è¯¥æ„Ÿè§‰ä¸åˆ°ï¼Œå¦ä¸€æ–¹é¢ï¼Œåå°æ—¥å¿—æ‰“å°æµç•…ã€‚</p><h3 id="é—®é¢˜2-åå°æŠ¥é”™"><a href="#é—®é¢˜2-åå°æŠ¥é”™" class="headerlink" title="é—®é¢˜2: åå°æŠ¥é”™"></a>é—®é¢˜2: åå°æŠ¥é”™</h3><p>åœ¨æ‰§è¡Œè®¡ç®—çš„è¿‡ç¨‹ï¼Œå‡ºç°æŠ¥é”™å¦‚ä¸‹å›¾</p><p><img src="æŠ¥é”™.png" alt="æŠ¥é”™"></p><p>è¯¥æŠ¥é”™æˆ‘æœç´¢äº†å¾ˆä¹…ä¹Ÿæ²¡æœ‰æ‰¾åˆ°è§£å†³æ–¹æ¡ˆï¼Œåœ¨åŠ ä¸Šè¯¥æŠ¥é”™ä¸ä¼šå¯¼è‡´ä»»åŠ¡å¤±è´¥ï¼Œä¹Ÿä¸ä¼šæœ‰å…¶ä»–å½±å“ã€‚æ‰€ä»¥æç½®äº†ã€‚</p><p>è¯¥æ–¹æ¡ˆæ˜¯ç›®å‰æœ€å¥½çš„è§£å†³æ–¹æ¡ˆï¼Œæˆ‘ä¹Ÿå°è¯•äº†å¾ˆå¤šå…¶ä»–è§£å†³æ–¹æ¡ˆã€‚è¿™é‡Œä¹Ÿä¸€å¹¶åˆ—å‡ºã€‚</p><h2 id="2"><a href="#2" class="headerlink" title="2"></a>2</h2><p>æ–¹æ¡ˆ2ä¸æ–¹æ¡ˆ1ç›¸åŒï¼ŒåŒæ ·æ˜¯å¼€å¯æ–°çº¿ç¨‹æ‰§è¡Œåˆå¹¶ï¼Œåªæ˜¯æ–°çš„äº‹ä»¶å¾ªç¯æœ‰ä¸»çº¿ç¨‹åˆ›å»ºï¼Œè€Œéåœ¨æ–°çº¿ç¨‹ä¸­åˆ›å»ºã€‚æµ‹è¯•è¿™ä¸¤ç§æ–¹æ³•è¡¨ç°ä¸€è‡´ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">func2</span>(<span class="params">websocket, request_data</span>):</span><br><span class="line">new_loop: AbstractEventLoop = asyncio.new_event_loop()</span><br><span class="line">    <span class="comment"># å®šä¹‰</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">start_loop</span>(<span class="params">loop: AbstractEventLoop</span>):</span><br><span class="line">        asyncio.set_event_loop(loop)</span><br><span class="line">        loop.run_forever()</span><br><span class="line">    <span class="comment">#é€šè¿‡å½“å‰çº¿ç¨‹å¼€å¯æ–°çš„çº¿ç¨‹å¯åŠ¨äº‹ä»¶å¾ªç¯</span></span><br><span class="line">    t = threading.Thread(target=start_loop, args= (new_loop,))</span><br><span class="line">    t.start()</span><br><span class="line">    asyncio.run_coroutine_threadsafe(</span><br><span class="line">        DealPcdsThread(websocket, request_data).merge(),</span><br><span class="line">        new_loop</span><br><span class="line">    )</span><br></pre></td></tr></table></figure><h2 id="3"><a href="#3" class="headerlink" title="3"></a>3</h2><p>ä½¿ç”¨asyncio.run_in_executorå°†ä»»åŠ¡æ”¾åˆ°çº¿ç¨‹æ± ä¸­è¿è¡Œ</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">func2</span>(<span class="params">websocket, request_data</span>):</span><br><span class="line"><span class="comment"># 4.4 ä½¿ç”¨asyncio.run_in_executorå°†ä»»åŠ¡æ”¾åˆ°çº¿ç¨‹æ± ä¸­è¿è¡Œã€‚æ•ˆæœå’Œ4.2ä¸€æ ·</span></span><br><span class="line">loop: AbstractEventLoop = asyncio.get_event_loop()</span><br><span class="line"><span class="keyword">await</span> loop.run_in_executor(<span class="literal">None</span>, DealPcdsThread(websocket, request_data).run)</span><br><span class="line"><span class="comment"># await asyncio.to_thread(DealPcdsNoThread.run, loop) # new py3.9</span></span><br></pre></td></tr></table></figure><p>æµ‹è¯•è¯´æ˜ï¼Œè¿™ç§æ–¹æ³•ä¼šé˜»å¡ä¸»çº¿ç¨‹ï¼Œå¯¼è‡´å¿ƒè·³åŒ…æ— æ³•åŠæ—¶å“åº”ã€‚ã€‚</p><h2 id="4"><a href="#4" class="headerlink" title="4"></a>4</h2><p>ä¸ºäº†åŠ å¿«è®¡ç®—çš„é€Ÿåº¦ï¼Œæƒ³åˆ°å°è¯•å¼€å¯æ–°çš„è¿›ç¨‹æ‰§è¡Œè®¡ç®—ã€‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">Process(target=merge, args=(websocket, request_data)).start()</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯æ²¡æƒ³åˆ°ï¼Œè¿›ç¨‹ä¹‹é—´ä¼ é€’çš„Pythonå¯¹è±¡å¿…é¡»å¯ä»¥è¢«åºåˆ—åŒ–ï¼ˆpickleï¼‰æ‰å¯ä»¥ï¼Œè€Œwebsocketå¯¹è±¡ä¸èƒ½è¢«åºåˆ—åŒ–ï¼Œæ‰€ä»¥è¿™ç§æ–¹æ³•æ— æ•ˆã€‚</p><h2 id="5"><a href="#5" class="headerlink" title="5"></a>5</h2><p>æœ€åä¸€ç§ï¼ŒåŒæ ·ä¹Ÿæ˜¯å¼€å¯ä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼Œä¸è¿‡targetä¼ å…¥çš„æ˜¯å¼‚æ­¥è®¡ç®—æ–¹æ³•ï¼ˆè™½ç„¶æ˜¯å¼‚æ­¥çš„ï¼Œä½†æ˜¯å†…éƒ¨ç¡®æ˜¯åŒæ­¥çš„ã€‚ã€‚ã€‚ï¼‰</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">threading.Thread(target=<span class="keyword">await</span> DealPcdsThread(websocket, request_data).merge()).start()</span><br></pre></td></tr></table></figure><p>è¿™ç§æ–¹æ³•ä¹Ÿä¼šé˜»å¡ä¸»çº¿ç¨‹ã€‚</p><h1 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h1><p>åœ¨å®éªŒè¿‡ç¨‹ä¸­ï¼Œæˆ‘å‘ç°å‡¡æ˜¯å¼€å¯æ–°çº¿ç¨‹å¹¶ä¸”æ–°çº¿ç¨‹ä¸­ä½¿ç”¨æ–°çš„äº‹ä»¶å¾ªç¯æ¥å¤„ç†å‘é€è¯·æ±‚éƒ½å¯ä»¥è®©ä¸»çº¿ç¨‹ä¸é˜»å¡ã€‚ä¾‹å¦‚æ–¹æ¡ˆ1ã€2</p><p>ä½†æ˜¯å¦‚æœåªå¼€æ–°çº¿ç¨‹ï¼Œè€Œäº‹ä»¶å¾ªç¯ä¾ç„¶ä½¿ç”¨ä¸»çº¿ç¨‹loopçš„è¯ï¼Œä¸èƒ½è§£å†³ä¸»çº¿ç¨‹é˜»å¡çš„é—®é¢˜ã€‚ä¾‹å¦‚æ–¹æ¡ˆ3ã€5</p><h1 id="å±•æœ›"><a href="#å±•æœ›" class="headerlink" title="å±•æœ›"></a>å±•æœ›</h1><ol><li>ç”¨<code>concurrent.futures.ThreadPoolExecutor</code>â€‹æ›¿æ¢threadingã€‚<code>concurrent.futures.ThreadPoolExecutor</code>â€‹æä¾›äº†ä¸€ä¸ªé«˜å±‚çº§æ¥å£ç”¨æ¥å‘åå°çº¿ç¨‹æ¨é€ä»»åŠ¡è€Œä¸ä¼šé˜»å¡è°ƒç”¨æ–¹çº¿ç¨‹çš„æ‰§è¡Œï¼ŒåŒæ—¶ä»ç„¶èƒ½å¤Ÿåœ¨éœ€è¦æ—¶è·å–ä»»åŠ¡çš„ç»“æœã€‚</li><li>å…ˆè¯»å‡ºæ‰€æœ‰çš„æ–‡ä»¶åˆ°å†…å­˜ä¸­ï¼Œæ”¾åˆ°ä¸€ä¸ªæ•°ç»„é‡Œï¼Œå†å¼€å¯å¤šè¿›ç¨‹å¯¹è¿™ä¸ªæ•°ç»„çš„ç‚¹äº‘æ•°æ®è¿›è¡Œreduceã€‚åˆ©ç”¨å¤šæ ¸åŠ å¿«åˆå¹¶é€Ÿåº¦ï¼Ÿ</li><li>å…¶å®æˆ‘è§‰å¾—æœ€å¥½çš„æ–¹å¼æ˜¯ï¼Œå¼€å¯ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œè®¡ç®—ä»»åŠ¡ï¼Œçº¿ç¨‹ç±»ä¸­æœ‰ä¸€ä¸ªæŒ‡ç¤ºè¿›åº¦çš„å˜é‡ã€‚åœ¨ä¸»çº¿ç¨‹ä¸­ä½¿ç”¨ä¸€ä¸ªåç¨‹æ¯éš”Xç§’è·å–ä¸€æ¬¡è¿›åº¦å¹¶å°†å…¶å‘é€ç»™å‰ç«¯ã€‚ä½†æ˜¯è¿™ç§æ–¹å¼æ— æ³•åšåˆ°å®æ—¶ã€‚</li><li>ä»€ä¹ˆæ—¶å€™Pythonå¯ä»¥å»æ‰GILçš„é™åˆ¶ï¼Œè®©è¿™ç§è®¡ç®—å¯†é›†å‹ä»»åŠ¡èƒ½å¤Ÿå……åˆ†åˆ©ç”¨å¤šæ ¸CPUã€‚ã€‚ã€‚ğŸ˜¢</li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ä»‹ç»&quot;&gt;&lt;a href=&quot;#ä»‹ç»&quot; class=&quot;headerlink&quot; title=&quot;ä»‹ç»&quot;&gt;&lt;/a&gt;ä»‹ç»&lt;/h1&gt;&lt;p&gt;å…ˆä»‹ç»ä¸‹æ•´ä½“ç³»ç»Ÿæ¡†æ¶ï¼Œç³»ç»Ÿåˆ†ä¸ºå‰ç«¯å’Œåç«¯ï¼ŒäºŒè€…é€šè¿‡websocketåè®®è¿›è¡Œé€šä¿¡ã€‚é€šè¿‡è¯·æ±‚æ•°æ®ä¸­çš„codeå­—æ®µæ¥å“åº”ä¸åŒçš„æ“ä½œã€‚&lt;/p&gt;
&lt;</summary>
      
    
    
    
    <category term="Python" scheme="https://guoyujian.github.io/categories/Python/"/>
    
    
    <category term="Python" scheme="https://guoyujian.github.io/tags/Python/"/>
    
    <category term="websocket" scheme="https://guoyujian.github.io/tags/websocket/"/>
    
    <category term="asyncio" scheme="https://guoyujian.github.io/tags/asyncio/"/>
    
  </entry>
  
  <entry>
    <title>Python é¢è¯•é¢˜</title>
    <link href="https://guoyujian.github.io/2023/10/07/Python-%E9%9D%A2%E8%AF%95%E9%A2%98/"/>
    <id>https://guoyujian.github.io/2023/10/07/Python-%E9%9D%A2%E8%AF%95%E9%A2%98/</id>
    <published>2023-10-07T14:48:30.000Z</published>
    <updated>2023-10-07T14:50:40.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>è®°ä¸€æ¬¡Pythoné¢è¯•è¢«é—®åˆ°çš„é¢˜</p></blockquote><h1 id="1"><a href="#1" class="headerlink" title="1"></a>1</h1><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a=&#123;<span class="number">1</span>:<span class="number">2</span>,<span class="number">2</span>:<span class="number">3</span>&#125;</span><br><span class="line">b=a</span><br><span class="line">b.pop(<span class="number">1</span>)</span><br><span class="line"><span class="built_in">print</span>(a)</span><br></pre></td></tr></table></figure><p>é—®ï¼šaçš„è¾“å‡ºæ˜¯ä»€ä¹ˆï¼Ÿ</p><p>ç­”ï¼š<code>&#123;2:3&#125;</code>â€‹</p><h1 id="2"><a href="#2" class="headerlink" title="2"></a>2</h1><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">b=[[]]*<span class="number">2</span>; b[<span class="number">0</span>].append(<span class="number">1</span>); <span class="built_in">print</span>(b)</span><br><span class="line">a=[]; b=[a]*<span class="number">2</span>; b[<span class="number">0</span>].append(<span class="number">1</span>); <span class="built_in">print</span>(b)</span><br><span class="line">a=[]; b=[a, a]; b[<span class="number">0</span>].append(<span class="number">1</span>); <span class="built_in">print</span>(b)</span><br><span class="line">b=[[], []]; b[<span class="number">0</span>].append(<span class="number">1</span>); <span class="built_in">print</span>(b)</span><br></pre></td></tr></table></figure><p>é—®ï¼šè¿™å››ä¸ª<code>b</code>â€‹çš„è¾“å‡ºæ˜¯ä»€ä¹ˆï¼Ÿ</p><p>ç­”ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[[1], [1]]</span><br><span class="line">[[1], [1]]</span><br><span class="line">[[1], [1]]</span><br><span class="line">[[1], []]</span><br></pre></td></tr></table></figure><h1 id="3"><a href="#3" class="headerlink" title="3"></a>3</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a=&quot;123&quot;; b=a; b=b[:-1]; </span><br><span class="line">print(a, b)</span><br></pre></td></tr></table></figure><p>é—®ï¼šè¾“å‡ºï¼Ÿ</p><p>ç­”ï¼š<code>123 12</code>â€‹</p><h1 id="4"><a href="#4" class="headerlink" title="4"></a>4</h1><p>æ¯”è¾ƒä»¥ä¸‹ä¸¤æ®µä»£ç çš„æ‰§è¡Œæ•ˆç‡å’Œå†…å­˜å¼€é”€</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">resÂ = 1</span><br><span class="line">forÂ numÂ in [1,2,3,4]+[6,7,8,9]:</span><br><span class="line">Â Â Â Â resÂ *=Â num</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">importÂ itertools</span><br><span class="line">resÂ = 1</span><br><span class="line">forÂ numÂ inÂ itertools.chain([1,2,3,4], [6,7,8,9]):</span><br><span class="line">Â Â Â Â resÂ *=Â num</span><br></pre></td></tr></table></figure><p><a href="https://docs.python.org/3/library/itertools.html">https://docs.python.org/3/library/itertools.html</a></p><p>ç­”ï¼šé¦–å…ˆç¬¬ä¸€ä¸ªä»£ç éœ€è¦å°†ä¸¤ä¸ªåˆ—è¡¨å’Œå¹¶ä¸ºä¸€ä¸ªåˆ—è¡¨ï¼Œè€Œç¬¬äºŒæ®µä»£ç æ˜¯ç›´æ¥éå†ä¸¤ä¸ªåˆ—è¡¨ï¼Œå…¶æ¬¡itertools.chainè¿”å›çš„æ˜¯ä¸€ä¸ªç”Ÿæˆå™¨ï¼Œæ‰€ä»¥ç¬¬äºŒä¸ªä»£ç çš„æ‰§è¡Œæ•ˆç‡é«˜ï¼Œå†…å­˜å¼€é”€å°ã€‚</p><h1 id="5"><a href="#5" class="headerlink" title="5"></a>5</h1><p>What is the difference between tuple() and list[]ï¼Ÿloop over tuple and listï¼Œwhich one is more effectiveï¼Ÿ</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">if var in [&quot;xxx&quot;, &quot;yyy&quot;]:</span><br><span class="line">if var in (&quot;xxx&quot;, &quot;yyy&quot;):</span><br><span class="line">if var in &#123;&quot;xxx&quot;, &quot;yyy&quot;&#125;:</span><br></pre></td></tr></table></figure><p>Which one above is more efficitive? Note: The value after â€˜inâ€™ is a constant.</p><p>æ—¶é—´å¤æ‚åº¦ï¼štuple O(?) list O(?) set O(?)</p><p>ç­”ï¼štupleæ˜¯ä¸å¯å˜å¯¹è±¡ï¼Œlistæ˜¯å¯å˜å¯¹è±¡ã€‚ç”±äºtupleä¸å¯å˜ï¼Œæ‰€ä»¥ç”³è¯·å†…å­˜ä¸ºè¿ç»­å®šé•¿å†…å­˜ï¼Œè€Œlistç±»ä¼¼äºä¸€ä¸ªé“¾è¡¨ã€‚</p><p>æ‰€ä»¥åœ¨loopä¸­ï¼Œtuple is more effective.</p><p><code>if var in &#123;&quot;xxx&quot;, &quot;yyy&quot;&#125;</code>â€‹ is more effective. å› ä¸ºé›†åˆæŸ¥è¯¢æ—¶é—´å¤æ‚åº¦ä¸ºO(1)ï¼Œtupleå’Œlistä¸ºO(N)</p><h1 id="6"><a href="#6" class="headerlink" title="6"></a>6</h1><p>Python classä¸­å˜é‡åå’Œå‡½æ•°åå‰ç¼€å•ä¸‹åˆ’çº¿å’ŒåŒä¸‹åˆ’çº¿(åç¼€æ²¡æœ‰ä¸‹åˆ’çº¿)åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼ŸFor example,</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">class A:</span><br><span class="line">   def _method1(): pass   //Â What&#x27;sÂ theÂ meaningÂ ofÂ _</span><br><span class="line">   def __method2(): pass  //Â What&#x27;sÂ theÂ meaningÂ ofÂ __</span><br></pre></td></tr></table></figure><p> Whatâ€™s the difference among the concepts protected, public, and private?</p><p>ç­”ï¼šå˜é‡å‰æ²¡æœ‰ä¸‹åˆ’çº¿çš„ä¸ºpublic<br>å˜é‡å‰æœ‰å•ä¸‹åˆ’çº¿ä¸ºprotectedï¼Œè¿™ç§å˜é‡åªèƒ½åœ¨æœ¬ç±»æˆ–è€…å…¶å­ç±»ä¸­è°ƒç”¨ï¼ˆå¦‚æœä½ æƒ³åœ¨å…¶ä»–åœ°æ–¹è°ƒç”¨ä¹Ÿå¯ä»¥ï¼Œä½†æ˜¯ä¼šæœ‰è­¦å‘Šï¼‰<br>å˜é‡å‰æœ‰åŒä¸‹åˆ’çº¿ä¸ºprivateï¼Œè¿™ç§å˜é‡åªèƒ½åœ¨æœ¬ç±»ä¸­è°ƒç”¨ï¼ˆåœ¨å…¶ä»–åœ°æ–¹è°ƒç”¨ä¼šæŠ¥é”™ï¼‰</p><h1 id="7"><a href="#7" class="headerlink" title="7"></a>7</h1><p>åœ¨ç”¨mongoç­‰éå…³ç³»å‹æ•°æ®åº“çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¸å¸Œæœ›æŠŠè„æ•°æ®ã€ç©ºæ•°æ®å­˜è¿›æ•°æ®åº“ï¼Œé€ æˆåé¢çš„æ··ä¹±ã€‚å†™ä¸€ä¸ªå‡½æ•°(Python3)ï¼Œåˆ é™¤json dicté‡Œé¢çš„ç©ºæ•°æ®ï¼ŒåŒ…æ‹¬ç©ºdictï¼Œç©ºlistï¼Œç©ºstringï¼ŒNoneã€‚å‡è®¾è¾“å…¥çš„Python dictä»åˆæ³•jsonè¯»å–, å³keyå¿…ä¸ºstring, valueå¯ä»¥æ˜¯number/string/list/dictã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;&quot;a&quot;: [1,0,&quot;c&quot;, &#123;&quot;x&quot;:1&#125;]&#125; -&gt; &#123;&quot;a&quot;: [1,0,&quot;c&quot;, &#123;&quot;x&quot;:1&#125;]&#125;</span><br><span class="line">&#123;&quot;a&quot;:[1,None]&#125; -&gt; &#123;&quot;a&quot;: [1]&#125;</span><br><span class="line">&#123;&quot;a&quot;: &#123;&quot;a&quot;:[None, &quot;&quot;, &#123;&#125;,&#123;&quot;x&quot;:None&#125;]&#125;&#125; -&gt; None</span><br></pre></td></tr></table></figure><p>ç­”ï¼š</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">clean_json</span>(<span class="params">data: (<span class="params"><span class="built_in">dict</span>,<span class="built_in">list</span>,<span class="built_in">int</span>,<span class="built_in">float</span>,<span class="built_in">str</span>,<span class="literal">None</span></span>)</span>):</span><br><span class="line">    <span class="comment"># put your code here</span></span><br><span class="line">    <span class="keyword">if</span> data <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> data == <span class="string">&#x27;&#x27;</span> <span class="keyword">or</span> data == <span class="built_in">dict</span>() <span class="keyword">or</span> data == []:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(data) == <span class="built_in">list</span>:</span><br><span class="line">        data1 = [item <span class="keyword">for</span> item <span class="keyword">in</span> data <span class="keyword">if</span> clean_json(item) <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>] <span class="comment"># å¤åˆ¶ä¸€ä»½å‡ºæ¥</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data1:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">return</span> data1</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(data) == <span class="built_in">dict</span>:</span><br><span class="line">        data1 = &#123;k: clean_json(v) <span class="keyword">for</span> k, v <span class="keyword">in</span> data.items() <span class="keyword">if</span> clean_json(v) <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>&#125; <span class="comment"># å¤åˆ¶ä¸€ä»½å‡ºæ¥</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data1:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">return</span> data1</span><br><span class="line">    <span class="keyword">return</span> data</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼šä¸èƒ½ç›´æ¥å¯¹åŸæ•°ç»„orå­—å…¸ä½œåˆ é™¤æ“ä½œï¼Œä¼šæŠ¥é”™ï¼</p><p>ä¾‹å¦‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">l = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> l:</span><br><span class="line">    <span class="keyword">if</span> l[i] == <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">del</span> l[i] <span class="comment"># do not do this</span></span><br></pre></td></tr></table></figure><p>â€</p>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;è®°ä¸€æ¬¡Pythoné¢è¯•è¢«é—®åˆ°çš„é¢˜&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;1&quot;&gt;&lt;a href=&quot;#1&quot; class=&quot;headerlink&quot; title=&quot;1&quot;&gt;&lt;/a&gt;1&lt;/h1&gt;&lt;figure class=&quot;highlight p</summary>
      
    
    
    
    <category term="Python" scheme="https://guoyujian.github.io/categories/Python/"/>
    
    <category term="åŸºç¡€" scheme="https://guoyujian.github.io/categories/Python/%E5%9F%BA%E7%A1%80/"/>
    
    
    <category term="Python" scheme="https://guoyujian.github.io/tags/Python/"/>
    
    <category term="é¢è¯•" scheme="https://guoyujian.github.io/tags/%E9%9D%A2%E8%AF%95/"/>
    
  </entry>
  
  <entry>
    <title>Python open3dç‚¹äº‘ç›¸å…³æ“ä½œï¼ˆæŒç»­æ›´æ–°ï¼‰</title>
    <link href="https://guoyujian.github.io/2023/09/16/Python-open3d%E7%82%B9%E4%BA%91%E7%9B%B8%E5%85%B3%E6%93%8D%E4%BD%9C%EF%BC%88%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0%EF%BC%89/"/>
    <id>https://guoyujian.github.io/2023/09/16/Python-open3d%E7%82%B9%E4%BA%91%E7%9B%B8%E5%85%B3%E6%93%8D%E4%BD%9C%EF%BC%88%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0%EF%BC%89/</id>
    <published>2023-09-16T14:26:37.000Z</published>
    <updated>2023-09-16T14:28:06.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Prerequisite"><a href="#Prerequisite" class="headerlink" title="Prerequisite"></a>Prerequisite</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">!pip install open3d</span><br><span class="line">!pip install scipy</span><br><span class="line"><span class="keyword">import</span> open3d <span class="keyword">as</span> o3d</span><br><span class="line"><span class="keyword">from</span> scipy.spatial.transform <span class="keyword">import</span> Rotation <span class="keyword">as</span> R</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br></pre></td></tr></table></figure><h2 id="è¯»å’Œå†™ç‚¹äº‘æ–‡ä»¶"><a href="#è¯»å’Œå†™ç‚¹äº‘æ–‡ä»¶" class="headerlink" title="è¯»å’Œå†™ç‚¹äº‘æ–‡ä»¶"></a>è¯»å’Œå†™ç‚¹äº‘æ–‡ä»¶</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">point_cloud = o3d.io.read_point_cloud(file_path) <span class="comment"># æ”¯æŒçš„æ ¼å¼pcdã€ptsç­‰</span></span><br><span class="line"><span class="comment"># type(point_cloud) == open3d.cpu.pybind.geometry.PointCloud</span></span><br><span class="line"></span><br><span class="line">o3d.io.write_point_cloud(point_cloud, file_path) </span><br></pre></td></tr></table></figure><h2 id="è¯»å–ç‚¹äº‘å¯¹è±¡ä¸­ç‚¹çš„åæ ‡"><a href="#è¯»å–ç‚¹äº‘å¯¹è±¡ä¸­ç‚¹çš„åæ ‡" class="headerlink" title="è¯»å–ç‚¹äº‘å¯¹è±¡ä¸­ç‚¹çš„åæ ‡"></a>è¯»å–ç‚¹äº‘å¯¹è±¡ä¸­ç‚¹çš„åæ ‡</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">np.asarray(point_cloud.points)</span><br></pre></td></tr></table></figure><h2 id="å°†ç‚¹åæ ‡èµ‹å€¼åˆ°ç‚¹äº‘å¯¹è±¡"><a href="#å°†ç‚¹åæ ‡èµ‹å€¼åˆ°ç‚¹äº‘å¯¹è±¡" class="headerlink" title="å°†ç‚¹åæ ‡èµ‹å€¼åˆ°ç‚¹äº‘å¯¹è±¡"></a>å°†ç‚¹åæ ‡èµ‹å€¼åˆ°ç‚¹äº‘å¯¹è±¡</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># points = np.array([[...]])</span></span><br><span class="line"></span><br><span class="line">point_cloud.points = o3d.utility.Vector3dVector(points)</span><br></pre></td></tr></table></figure><h2 id="åˆ›å»ºç‚¹äº‘å¯¹è±¡"><a href="#åˆ›å»ºç‚¹äº‘å¯¹è±¡" class="headerlink" title="åˆ›å»ºç‚¹äº‘å¯¹è±¡"></a>åˆ›å»ºç‚¹äº‘å¯¹è±¡</h2><p>åˆ›å»ºä¸€ä¸ªç©ºçš„ç‚¹äº‘å¯¹è±¡</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">pc = o3d.geometry.PointCloud()</span><br></pre></td></tr></table></figure><h2 id="åˆå¹¶ç‚¹äº‘å¯¹è±¡"><a href="#åˆå¹¶ç‚¹äº‘å¯¹è±¡" class="headerlink" title="åˆå¹¶ç‚¹äº‘å¯¹è±¡"></a>åˆå¹¶ç‚¹äº‘å¯¹è±¡</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ç›´æ¥+</span></span><br><span class="line">pc += point_cloud</span><br></pre></td></tr></table></figure><h2 id="ç‚¹äº‘å¹³ç§»"><a href="#ç‚¹äº‘å¹³ç§»" class="headerlink" title="ç‚¹äº‘å¹³ç§»"></a>ç‚¹äº‘å¹³ç§»</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">point_cloud.translate(translation)  <span class="comment"># åº”ç”¨å¹³ç§»,translation æ˜¯å¹³ç§»å‘é‡</span></span><br></pre></td></tr></table></figure><h2 id="ç‚¹äº‘æ—‹è½¬"><a href="#ç‚¹äº‘æ—‹è½¬" class="headerlink" title="ç‚¹äº‘æ—‹è½¬"></a>ç‚¹äº‘æ—‹è½¬</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">point_cloud.rotate(rotation_matrix, center = (<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>))  <span class="comment"># åº”ç”¨æ—‹è½¬, rotation_matrixæ˜¯æ—‹è½¬çŸ©é˜µ</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œéœ€è¦æ³¨æ„ç¬¬äºŒä¸ªå‚æ•°centeræ˜¯æŒ‡å®šæ—‹è½¬ä¸­å¿ƒï¼Œå¦‚æœä¸ä¼ ï¼Œé»˜è®¤æ—‹è½¬ä¸­å¿ƒæ˜¯ç‚¹äº‘çš„è´¨å¿ƒã€‚</p><p>è€Œä¸€èˆ¬æ¥è¯´ï¼Œæ—‹è½¬ä¸­å¿ƒä¸ºåŸç‚¹</p><h2 id="ç‚¹äº‘ä¸Šè‰²"><a href="#ç‚¹äº‘ä¸Šè‰²" class="headerlink" title="ç‚¹äº‘ä¸Šè‰²"></a>ç‚¹äº‘ä¸Šè‰²</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">point_cloud.paint_uniform_color([<span class="number">0</span>, <span class="number">0</span>, <span class="number">1.0</span>]) <span class="comment"># ä¼ å…¥çš„ä¸‰ä¸ªå€¼åˆ†åˆ«æ˜¯rgb</span></span><br></pre></td></tr></table></figure><h2 id="ç‚¹äº‘å±•ç¤º"><a href="#ç‚¹äº‘å±•ç¤º" class="headerlink" title="ç‚¹äº‘å±•ç¤º"></a>ç‚¹äº‘å±•ç¤º</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">o3d.visualization.draw_geometries([point_cloud])</span><br></pre></td></tr></table></figure><h2 id="å››å…ƒæ•°è½¬æ—‹è½¬çŸ©é˜µ"><a href="#å››å…ƒæ•°è½¬æ—‹è½¬çŸ©é˜µ" class="headerlink" title="å››å…ƒæ•°è½¬æ—‹è½¬çŸ©é˜µ"></a>å››å…ƒæ•°è½¬æ—‹è½¬çŸ©é˜µ</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">quaternion = np.array([ori_x, ori_y, ori_z, ori_w])  <span class="comment"># å®šä¹‰å››å…ƒæ•°</span></span><br><span class="line">rotation_matrix = R.from_quat(quaternion).as_matrix()</span><br></pre></td></tr></table></figure><p>æ³¨æ„å››å…ƒæ•°é¡ºåºæ˜¯xyzwï¼Œåœ¨æœ‰äº›åœ°æ–¹é¡ºåºæ˜¯wxyz</p><h2 id="ç‚¹äº‘ä¸‹é‡‡æ ·"><a href="#ç‚¹äº‘ä¸‹é‡‡æ ·" class="headerlink" title="ç‚¹äº‘ä¸‹é‡‡æ ·"></a>ç‚¹äº‘ä¸‹é‡‡æ ·</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">point_cloud = point_cloud.voxel_down_sample()</span><br></pre></td></tr></table></figure><p>è¿™é‡Œéœ€è¦æ³¨æ„</p><ol><li>éœ€è¦æ¥æ”¶è¿”å›å€¼</li><li>ä¸‹é‡‡æ ·æ˜¯æŒ‡åªä¿ç•™æŸä¸€å¤§å°ç«‹æ–¹ä½“å†…çš„ä¸€ä¸ªç‚¹ã€‚voxel_down_sampleæ–¹æ³•æœ‰ä¸ªé»˜è®¤å€¼å‚æ•°ï¼Œä¸º0.05ã€‚è¿™ä¸ªå‚æ•°å°±è¡¨ç¤ºç«‹æ–¹ä½“çš„å¤§å°ï¼Œå› æ­¤è¿™ä¸ªæ•°è¶Šå¤§ï¼Œä¸‹é‡‡æ ·çš„å¼ºåº¦è¶Šå¼ºï¼Œä¿ç•™çš„ç‚¹å°±è¶Šå°‘ã€‚</li></ol><h2 id="ç»Ÿè®¡æ»¤æ³¢"><a href="#ç»Ÿè®¡æ»¤æ³¢" class="headerlink" title="ç»Ÿè®¡æ»¤æ³¢"></a>ç»Ÿè®¡æ»¤æ³¢</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">point_cloud.remove_statistical_outlier(nb_neighbors=<span class="number">20</span>, std_ratio=<span class="number">2.0</span>)</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•å¯ä»¥å»æ‰è·ç¦»ç‚¹äº‘å¯†é›†å¤„å¾ˆè¿œçš„ç‚¹ã€‚è¯¥æ–¹æ³•æœ‰ä¸¤ä¸ªå‚æ•°</p><ol><li>nb_neighborså…è®¸æŒ‡å®šè¦è€ƒè™‘å¤šå°‘ä¸ªé‚»å±…ï¼Œä»¥ä¾¿è®¡ç®—ç»™å®šç‚¹çš„å¹³å‡è·ç¦»ã€‚</li><li>std_ratioå…è®¸åŸºäºè·¨ç‚¹äº‘çš„å¹³å‡è·ç¦»çš„æ ‡å‡†åå·®æ¥è®¾ç½®é˜ˆå€¼çº§åˆ«ã€‚æ­¤æ•°å­—è¶Šä½ï¼Œè¿‡æ»¤å™¨å°†è¶Šå…·æœ‰æ”»å‡»æ€§ã€‚</li></ol><h2 id="ç­›é€‰ç‚¹äº‘ä¸­çš„ç‚¹"><a href="#ç­›é€‰ç‚¹äº‘ä¸­çš„ç‚¹" class="headerlink" title="ç­›é€‰ç‚¹äº‘ä¸­çš„ç‚¹"></a>ç­›é€‰ç‚¹äº‘ä¸­çš„ç‚¹</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># indices_to_keep =[0,1,2...] ç‚¹çš„ç´¢å¼•</span></span><br><span class="line">point_cloud = point_cloud.select_by_index(indices_to_keep)</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;Prerequisite&quot;&gt;&lt;a href=&quot;#Prerequisite&quot; class=&quot;headerlink&quot; title=&quot;Prerequisite&quot;&gt;&lt;/a&gt;Prerequisite&lt;/h2&gt;&lt;figure class=&quot;highlight python&quot;&gt;</summary>
      
    
    
    
    
  </entry>
  
</feed>
